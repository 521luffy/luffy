<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<meta name=viewport content=width=device-width,initial-scale=1>
<meta name="referrer"content="no-referrer">
<title>ä¸“å±æ‰‹æœº</title>

<style>
@keyframes waveFade { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
.w-1 { animation: waveFade 1.5s infinite 0s; }
.w-2 { animation: waveFade 1.5s infinite 0.3s; }
.w-3 { animation: waveFade 1.5s infinite 0.6s; }

body { background-color: #f5f6fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; }
.phone-container { width: 100vw; height: 100vh; border: none; border-radius: 0; box-shadow: none; overflow: hidden; position: relative; background-color: #f5f6fa; }

.scr-lock { display: flex; flex-direction: column; align-items: center; padding-top: 80px; height: 100%; cursor: pointer; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 50; position: absolute; top: 0; width: 100%; color: white; background-size: cover; background-position: center; }
.time { font-size: 65px; font-weight: 300; margin: 0; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
.date { font-size: 18px; margin-top: 10px; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
.unlock-text { position: absolute; bottom: 40px; font-size: 15px; animation: pulse 2s infinite; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
@keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
@keyframes waveFade { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
.w-1 { animation: waveFade 1.5s infinite 0s; }
.w-2 { animation: waveFade 1.5s infinite 0.3s; }
.w-3 { animation: waveFade 1.5s infinite 0.6s; }

.scr-home { display: none; height: 100%; box-sizing: border-box; position: absolute; top: 0; width: 100%; padding-top: 60px; z-index: 10; background-color: #f5f6fa; }
.desktop-widgets { margin: 0 20px 40px 20px; padding: 20px; background: rgba(255,255,255,0.7); border-radius: 20px; backdrop-filter: blur(15px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.greeting { font-size: 18px; font-weight: bold; color: #333; }
.greeting-sub { font-size: 12px; margin-top: 5px; color: #666; }
.app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 20px; }
.app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
.icon-chat { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
.icon-api { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #fab1a0, #e17055); }
.icon-wb { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px;
box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #81ecec, #00cec9); }
.icon-space { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #fdcb6e, #e17055); }
.icon-font { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #ff9a9e, #fecfef); color: white; font-weight: bold; }


.icon-space { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #fdcb6e, #e17055); }

.app-name { font-size: 12px; margin-top: 8px; font-weight: bold; color: #333; background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 8px; }
.dock { position: absolute; bottom: 20px; left: 15px; right: 15px; height: 70px; background: rgba(255,255,255,0.6); backdrop-filter: blur(20px); border-radius: 30px; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.dock-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.8); border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 22px; cursor: pointer; }
.scr-flex { display: none; height: 100%; position: absolute; top: 0; width: 100%; flex-direction: column; background-color: #f5f6fa; color: #333; z-index: 30; }
.header-title { font-weight: bold; font-size: 16px; }
.api-form { padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-bottom: 40px; }
.section-card { background: #ffffff; border-radius: 16px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 12px; }
.section-title { font-size: 14px; color: #6c5ce7; font-weight: bold; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
.input-group { display: flex; flex-direction: column; gap: 5px; }
.input-group label { font-size: 12px; color: #888; font-weight: bold; }
.input-field, select, textarea { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; background-color: #fcfcfc; outline: none; font-size: 13px; color: #333; transition: 0.3s; font-family: sans-serif; }
.input-field:focus, select:focus, textarea:focus { border-color: #a29bfe; }
.flex-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.flex-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
textarea { resize: none; }
.save-btn { border: none; border-radius: 12px; font-size: 15px; cursor: pointer; font-weight: bold; text-align: center; transition: 0.3s; padding: 15px; background: #6c5ce7; color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); margin-top: 10px; width: 100%; box-sizing: border-box; }
.tool-btn { background: #f0f2f5; color: #6c5ce7; border: 1px solid #ddd; padding: 10px; font-size: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; text-align: center; flex: 1; transition: 0.2s; }
.tool-btn:active { background: #e0e0e0; }
.clear-btn { background: #fff0f0; color: #ff7675; border: 1px solid #ff7675; padding: 10px; border-radius: 10px; font-size: 12px; cursor: pointer; text-align: center; font-weight: bold; flex: 1; }
.upload-btn { background: #f8f9fa; color: #666; border: 1px dashed #bbb; padding: 12px; border-radius: 10px; font-size: 12px; cursor: pointer; text-align: center; display: flex; justify-content: center; align-items: center; gap: 5px; }
.scr-list { display: none; height: 100%; position: absolute; top: 0; width: 100%; flex-direction: column; background-color: #f5f6fa; color: black; z-index: 20; }
.chat-header { background-color: #ffffff; padding: 25px 20px 15px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 20px; border-bottom: 1px solid #eeeeee; flex-shrink: 0; }
.back-btn { font-size: 20px; cursor: pointer; color: #555555; width: 30px; font-weight: normal; }
.plus-btn { font-size: 28px; cursor: pointer; line-height: 1; margin-top: -5px; position: relative; }
.header-center { flex: 1; text-align: center; margin-right: 30px; } 
.chat-item { display: flex; align-items: center; padding: 15px 20px; background-color: #ffffff; border-bottom: 1px solid #eeeeee; cursor: pointer; }
.avatar-list { width: 45px; height: 45px; background-color: #e0e0e0; border: 1px solid #eeeeee; margin-right: 15px; font-size: 20px; border-radius: 50%; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: #888; flex-shrink: 0; }
.chat-info { flex: 1; overflow: hidden; }
.chat-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
.chat-preview { font-size: 13px; color: #888888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.role-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
.role-name { font-size: 16px; font-weight: bold; color: #333; }
.role-status { font-size: 12px; color: #666; display: flex; align-items: center; gap: 4px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; }
.status-online { background-color: #10ac84; }
.status-offline { background-color: #8395a7; }
.status-busy { background-color: #ff6b6b; }
.role-signature { font-size: 12px; color: #a29bfe; white-space: nowrap;
overflow: hidden; text-overflow: ellipsis; }


.drop-menu { display: none; position: absolute; top: 65px; right: 15px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 12px;
z-index: 100; overflow: hidden; }
.menu-item { padding: 15px 20px; border-bottom: 1px solid #f0f2f5; font-size: 14px; color: #333; cursor: pointer; }
.scr-room { display: none; height: 100%; position: absolute; top: 0; width: 100%; flex-direction: column; background-color: #f5f6fa; color: black; z-index: 25; background-size: cover; background-position: center; }
.room-header { background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 25px 15px 15px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px; border-bottom: 1px solid #eeeeee; flex-shrink: 0; }
.settings-btn { font-size: 20px; cursor: pointer; color: #555555; width: 30px; text-align: right; }
.empty-btn { width: 30px; }
.room-center { flex: 1; text-align: center; font-size: 16px; }
.chat-toolbar { display: flex; gap: 15px; padding: 10px 15px; background: rgba(255,255,255,0.9); border-top: 1px solid #eeeeee; flex-shrink: 0; }
.tool-icon { font-size: 20px; color: #666; cursor: pointer; transition: 0.2s; }
.tool-icon:active { transform: scale(0.9); }
.chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
.msg-row { display: flex; width: 100%; }
.row-left { justify-content: flex-start; }
.row-right { justify-content: flex-end; }
.bubble { max-width: 70%; padding: 12px 15px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; user-select: none; }
.bub-left { background-color: rgba(255,255,255,0.95); color: black; border-top-left-radius: 4px; border: 1px solid #eeeeee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.bub-right { background-color: #6c5ce7; color: white; border-top-right-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.quote-box { display: none; padding: 8px 15px; background: rgba(238, 242, 255, 0.95); color: #6c5ce7; font-size: 12px; border-left: 3px solid #6c5ce7; margin: 0 15px 5px 15px; border-radius: 4px 8px 8px 4px; position: relative; flex-shrink: 0; backdrop-filter: blur(5px); }
.quote-txt { margin-right: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.quote-close { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-weight: bold; font-size: 16px; }
.chat-input { box-sizing: border-box; width: 100%; background-color: rgba(255,255,255,0.95); padding: 8px 10px 25px 10px; display: flex; gap: 6px; align-items: center; flex-shrink: 0; border-top: 1px solid #eeeeee; }
.msg-input { flex: 1; min-width: 0; border: none; background-color: #f0f2f5; padding: 8px 12px; border-radius: 20px; font-size: 14px; outline: none; }
.tool-svg { width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
.tool-svg svg { width: 24px; height: 24px; stroke-linecap: round; stroke-linejoin: round; }
.tool-svg:active { transform: scale(0.9); }


.send-btn { background-color: #6c5ce7; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; }
.ava-sm { width: 35px; height: 35px; background-color: #e0e0e0; border: 1px solid #eeeeee; font-size: 16px; transition: 0.2s; border-radius: 50%; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: #888; flex-shrink: 0; }
.ava-l { margin-right: 10px; cursor: pointer; }
.ava-l:active { transform: scale(0.9); }
.ava-r { margin-left: 10px; }
.ctx-menu { display: none; position: absolute; background: rgba(255,255,255,0.98); backdrop-filter: blur(15px); box-shadow: 0 5px 20px rgba(0,0,0,0.15); border-radius: 16px; padding: 12px; z-index: 200; width: 240px; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.ctx-item { font-size: 13px; color: #333; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 10px 0; border-radius: 8px; background: #f5f6fa; transition: 0.2s; font-weight: bold; }
.ctx-item:active { background: #e0e0e0; }
.ctx-danger { color: #ff7675; background: #fff0f0; }
.modal-base { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 999; justify-content: center; align-items: center; }
.modal-ctx { width: 85%; max-height: 80%; background: #fffafb; border-radius: 20px;
display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-hdr { background: #6c5ce7; color: white; padding: 15px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
.close-btn { cursor: pointer; font-size: 20px; }
.modal-bdy { padding: 18px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
.stat-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.stat-tag { display: inline-block; background: #eef2ff; color: #6c5ce7; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 8px; }
.stat-txt { font-size: 13px; color: #444; line-height: 1.6; }
.wb-tabs { display: flex; background: #ffffff; padding: 10px 20px; gap: 15px; border-bottom: 1px solid #eee; flex-shrink: 0; }
.wb-tab { flex: 1; text-align: center; padding: 10px; background: #f0f2f5; border-radius: 12px; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; transition: 0.3s; }
.wb-active { background: #6c5ce7; color: white; }
.wb-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
.wb-card { background: white; padding: 18px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.wb-title { font-weight: bold; color: #333; margin-bottom: 8px; font-size: 15px; }
.wb-prev { font-size: 13px; color: #666; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

.sticker-drawer { position: absolute; bottom: 0; left: 0; width: 100%; height: 55%; background: #f5f6f8; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; z-index: -10; visibility: hidden; transform: translateY(150%); opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-sizing: border-box; } .sticker-drawer.show { transform: translateY(0); opacity: 1; pointer-events: auto; z-index: 100; visibility: visible; }


.sticker-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #eef2ff; border-top-left-radius: 20px; border-top-right-radius: 20px; flex-shrink: 0; }
.sticker-header span { color: #4a6ee0; font-size: 13px; cursor: pointer; white-space: nowrap; }
.sticker-header .title { color: #333; font-weight: bold; font-size: 15px; margin: 0 5px; }
.sticker-actions { display: flex; gap: 8px; flex-wrap: nowrap; }
.sticker-search { padding: 8px 15px; background: #f5f6f8; flex-shrink: 0; }
.sticker-search input { width: 100%; padding: 8px 15px; border: none; border-radius: 20px; background: #fff; outline: none; font-size: 13px; box-sizing: border-box; }
.sticker-grid { flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; padding: 10px; align-content: start; }
.sticker-item { background: #fff; border-radius: 10px; padding: 6px; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); min-width: 0; }

.sticker-item img { width: 45px; height: 45px; object-fit: contain; margin-bottom: 5px; background: transparent; border-radius: 8px; }
.sticker-item .name { font-size: 11px; color: #666; text-align: center; width: 100%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

.sticker-delete-btn { position: absolute; top: -6px; right: -6px; background: #ff4d4f; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; font-size: 14px; font-weight: bold; display: none; z-index: 2; }
.sticker-item.edit-mode { animation: shake 0.5s infinite alternate; }
.sticker-item.edit-mode .sticker-delete-btn { display: block; }
@keyframes shake { 0% { transform: rotate(-1deg); } 100% { transform: rotate(1deg); } }
.sticker-tabs { display: flex; padding: 0 15px 10px 28px; gap: 20px; border-bottom: 1px solid #eee; flex-shrink: 0; background: #f5f6f8; }

.st-tab { font-size: 14px; color: #888; cursor: pointer; font-weight: bold; position: relative; padding-bottom: 5px; transition: 0.2s; }
.st-tab.active { color: #4a6ee0; }
.st-tab.active::after { content:''; position: absolute; bottom: -1px; left: 10%; width: 80%; height: 3px; background: #4a6ee0; border-radius: 2px; }

.batch-modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; display: none; justify-content: center; align-items: center; }
.batch-modal { background: #fff; width: 75%; border-radius: 16px; padding: 20px 0 0 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.batch-modal h3 { text-align: center; margin-top: 0; font-size: 16px; margin-bottom: 15px; color: #333; }
.batch-input-wrapper { padding: 0 20px; }
.batch-modal textarea { width: 100%; height: 100px; border: 2px solid #a855f7; border-radius: 12px; padding: 12px; box-sizing: border-box; resize: none; outline: none; font-size: 13px; }
.batch-modal-btns { display: flex; border-top: 1px solid #f0f0f0; margin-top: 20px; }
.batch-modal-btns button { flex: 1; background: none; border: none; padding: 14px; font-size: 15px; color: #1890ff; cursor: pointer; }
.batch-modal-btns button.cancel { color: #999; border-right: 1px solid #f0f0f0; }

.list-content { flex: 1; overflow-y: auto; background-color: #f5f6fa; }
.bottom-nav { display: flex; justify-content: space-around; align-items: center; background: #ffffff; padding: 10px 0 20px 0; border-top: 1px solid #eeeeee; flex-shrink: 0; z-index: 100; }
.nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #888; transition: 0.2s; }
.nav-item-active { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #ff6b81; transition: 0.2s; }
.nav-icon { font-size: 22px; margin-bottom: 3px; filter: grayscale(100%) opacity(60%); }
.nav-item-active .nav-icon { filter: none; }
.nav-text { font-size: 11px; font-weight: bold; }

.me-header { padding: 30px 20px 20px 20px; background: #fff; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #f0f2f5; }
.me-avatar { width: 60px; height: 60px; border-radius: 50%; background-color: #e0e0e0; background-size: cover; background-position: center; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.me-info { flex: 1; }
.me-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; }
.me-bio { font-size: 12px; color: #888; }
.me-icons { display: flex; gap: 10px; color: #6c5ce7; font-size: 18px; }
.me-menu-list { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #f5f6fa; }
.me-menu-item { background: #fff; border-radius: 16px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); cursor: pointer; transition: 0.2s; }
.me-menu-item:active { transform: scale(0.98); }
.me-menu-left { display: flex; flex-direction: column; gap: 4px; }
.me-menu-title { font-size: 15px; font-weight: bold; color: #333; }
.me-menu-sub { font-size: 12px; color: #999; }
.me-menu-right { color: #ccc; font-weight: bold; font-size: 18px;
}
.log-list-header { display: flex; background: #fff; padding: 10px 20px; gap: 15px; border-bottom: 1px solid #eee; flex-shrink: 0; }
.log-tab { flex: 1; text-align: center; padding: 10px; border-radius: 12px; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; transition: 0.3s; background: #f0f2f5; }
.log-tab-active { background: #6c5ce7; color: white; }
.log-card { background: white; padding: 20px; border-radius: 16px; margin: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
.log-card-time { font-size: 12px; color: #999; }
.log-card-content { font-size: 14px; color: #333; line-height: 1.6; }
.log-placeholder-img { width: 100%; height: 150px; background: #e0e0e0; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: #888; font-size: 13px; border: 1px dashed #ccc; margin-bottom: 10px; }
.log-real-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; }
.log-summon-btn { align-self: flex-end; background: #fdf2f8; color: #ff6b81; border: 1px solid #fbcfe8; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.log-summon-btn:active { transform: scale(0.95); }
.log-comment-area { background: #f9f9f9; padding: 12px; border-radius: 12px; font-size: 13px; color: #555; border-left: 3px solid #6c5ce7;     margin-top: 10px; }
#btnNewMenu { padding: 5px 15px; margin-left: -5px; margin-right: -5px; }
.menu-drawer { position: absolute; bottom: 85px; left: 15px; width: calc(100% - 30px); height: 55%; background: #f5f6f8; border-radius: 24px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); display: flex; flex-direction: column; z-index: -10; visibility: hidden; transform: translateY(150%); opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-sizing: border-box; padding: 25px 20px; } .menu-drawer.show { transform: translateY(0); opacity: 1; pointer-events: auto; z-index: 95; visibility: visible; }


.menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 10px; align-content: start; }
.menu-icon-btn { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; }
.menu-icon-btn:active { transform: scale(0.9); }
.menu-icon-svg { width: 38px; height: 38px; background: #f3e5f5; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
.menu-icon-text { font-size: 10px; color: #666; font-weight: bold; }


input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; display: none;
}
.scr-char-phone { display: none; height: 100%; position: absolute; top: 0; width: 100%; background-color: #fdfafb; z-index: 150; flex-direction: column; overflow: hidden; background-size: cover; background-position: center; transition: all 0.3s ease; }
.char-phone-header { padding: 40px 20px 15px 20px; display: flex; justify-content: space-between; align-items: center; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 2; }
.char-phone-title { font-size: 14px; font-weight: bold; letter-spacing: 1px; }
.char-phone-status-bar { display: flex; gap: 6px; font-size: 12px; align-items: center; }
.catch-switch-wrapper { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 12px; backdrop-filter: blur(5px); }
.catch-switch-wrapper label { font-size: 11px; font-weight: bold; cursor: pointer; }
.catch-switch { appearance: none; width: 26px; height: 14px; background: rgba(255,255,255,0.4); border-radius: 14px; position: relative; cursor: pointer; outline: none; transition: 0.3s; }
.catch-switch:checked { background: #ff9a9e; }
.catch-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 10px; height: 10px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.catch-switch:checked::after { transform: translateX(12px); }
.char-phone-desktop { flex: 1; padding: 20px 15px; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: max-content; gap: 20px 15px; z-index: 2; align-content: start; }
.char-app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
.char-app-item:active { transform: scale(0.9); }
.char-app-icon { width: 55px; height: 55px; border-radius: 18px; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #fff; }
.char-app-name { font-size: 11px; margin-top: 6px; font-weight: bold; color: #333; text-shadow: 0 1px 2px rgba(255,255,255,0.8); background: rgba(255,255,255,0.4); padding: 2px 6px; border-radius: 6px; backdrop-filter: blur(2px); }
.icon-wechat { background: linear-gradient(135deg, #a8e063, #56ab2f); color: white; }
.icon-album { background: linear-gradient(135deg, #fdfbfb, #ebedee); font-size: 32px; }
.icon-music { background: linear-gradient(135deg, #ff0844, #ffb199); color: white; }
.icon-zhihu { background: linear-gradient(135deg, #00c6ff, #0072ff); color: white; font-weight: bold; font-family: serif; }
.icon-wallet { background: linear-gradient(135deg, #f6d365, #fda085); color: white; }
.icon-secret { background: linear-gradient(135deg, #434343, #000000); color: white; }
.icon-call { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
.icon-memo { background: linear-gradient(135deg, #f7cd46, #f4a21e); color: white; }
.icon-diary { background: linear-gradient(135deg, #ff9a9e, #fecfef); color: white; }
.icon-footprint { background: linear-gradient(135deg, #a18cd1, #fbc2eb); color: white;
}
.icon-settings { background: linear-gradient(135deg, #e0eafc, #cfdef3); color: #333; }
.icon-meituan { background: linear-gradient(135deg, #ffde28, #ffc800); color: #333; font-weight: bold; }
</style>





</head>
<body>
<div id=phone class=phone-container>
    
    <div id=scrLock class=scr-lock>
        <h1 id=time class=time>00:00</h1>
        <div id=date class=date>å‡†å¤‡å°±ç»ª</div>
        <div class=unlock-text>ç‚¹å‡»å±å¹•è§£é”</div>
    </div>
    
    <div id=scrHome class=scr-home>
        <div class=desktop-widgets>
            <div class=greeting>æ¬¢è¿å›æ¥</div>
            <div class=greeting-sub>ä»Šå¤©æƒ³åšç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ</div>
        </div>
                        <div class="app-grid">
            <div id="btnHomeChat" class="app-item"><div class="icon-chat">ğŸ’¬</div><div class="app-name">èŠå¤©</div></div>
            <div id="btnHomeApi" class="app-item"><div class="icon-api">âš™ï¸</div><div class="app-name">ç½‘ç»œé…ç½®</div></div>
                        <div id="btnHomeWb" class="app-item"><div class="icon-wb">ğŸ“–</div><div class="app-name">ä¸–ç•Œä¹¦</div></div>
            <div id="btnHomeSpace" class="app-item"><div class="icon-space">â­</div><div class="app-name">æˆ‘çš„ç©ºé—´</div></div>
                        <div id="btnHomeFont" class="app-item"><div class="icon-font">Aa</div><div class="app-name">å­—ä½“</div></div>
            <div id="btnHomeSpy" class="app-item"><div class="char-app-icon" style="background: linear-gradient(135deg, #ff9a9e, #fecfef); font-size:24px;">ğŸ“±</div><div class="app-name">æŸ¥æ‰‹æœº</div></div>
        </div>
     
        <div class=dock>

            <div class=dock-icon>ğŸ“</div><div class=dock-icon>ğŸ“·</div><div class=dock-icon>ğŸµ</div><div class=dock-icon>ğŸŒ</div>

        </div>
    </div>
    
        <div id=scrList class=scr-list>
                <div class=chat-header>
            <span id=btnListBack class=back-btn>ï¼œ</span>
            <span class=header-center>æ¶ˆæ¯</span>
            <span class=empty-btn></span>
        </div>
        
                <div id=listContent class=list-content>
            <div id=btnListToRoom class=chat-item style="display:none;">
                <div id=listAva class=avatar-list>ğŸ‘¤</div>
                <div class=chat-info>
                    <div id=listName class=chat-name>ä¸“å±æ‹äºº</div>

                    <div id=chatPreview class=chat-preview>åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class=bottom-nav>
            <div id=navMsg class=nav-item-active><div class=nav-icon>ğŸ’¬</div><div class=nav-text>æ¶ˆæ¯</div></div>
            <div id=navContact class=nav-item><div class=nav-icon>ğŸ‘¥</div><div class=nav-text>è”ç³»äºº</div></div>

            <div id=navMoment class=nav-item><div class=nav-icon>ğŸŒ</div><div class=nav-text>åŠ¨æ€</div></div>
                        <div id=navMe class=nav-item><div class=nav-icon>ğŸ‘¤</div><div class=nav-text>æˆ‘</div></div>
        </div>
    </div>
    
        <div id=scrContact class=scr-list>
        <div class=chat-header>
                        <span id=btnContactBack 
class=back-btn>ï¼œ</span>
            <span class=header-center>è”ç³»äºº</span>

            <div style="display:flex; align-items:center; gap:15px;">
                <span id=btnRoleHelp class=plus-btn style="font-size:20px;">â“</span>
                <span id=btnAddContact class=plus-btn>+</span>
            </div>
        </div>

        
                <div id=contactContent class=list-content>
                        
 <div id=btnContactToRoom class=chat-item style="display:none;">
                <div id=contactAva class=avatar-list>ğŸ‘¤</div>
                <div class=chat-info>
                                        <div class=role-header-row>
                      
   <div id=contactName class=role-name>ä¸“å±æ‹äºº</div>

                                                <div class=role-status><div class="status-dot status-online"></div>åœ¨çº¿</div>
                    </div>
                    <div class=role-signature>ï¼ˆæš‚æ— ä¸ªæ€§ç­¾åï¼‰</div>
                </div>
            </div>


        </div>
        
        <div class=bottom-nav>
            <div id=navContactToMsg class=nav-item><div class=nav-icon>ğŸ’¬</div><div class=nav-text>æ¶ˆæ¯</div></div>
                        <div class=nav-item-active><div class=nav-icon>ğŸ‘¥</div><div class=nav-text>è”ç³»äºº</div></div>

            <div id=navContactToMoment class=nav-item><div class=nav-icon>ğŸŒ</div><div class=nav-text>åŠ¨æ€</div></div>
            <div id=navContactToMe class=nav-item><div class=nav-icon>ğŸ‘¤</div><div class=nav-text>æˆ‘</div></div>
        </div>
    </div>
    
        <div id=scrRoom class=scr-room>
        <div class=room-header>
            <span id=btnRoomBack class=back-btn>ï¼œ</span>
                        <div id=roomTitleContainer class=room-center style="display:flex; flex-direction:column; align-items:center; line-height:1.2;">
                <div style="display:flex; align-items:center; gap:6px;">
                    <span id=roomTitle style="font-weight:bold; font-size:16px; color:#333;">ä¸“å±æ‹äºº</span>
                    <div id=roomStatus class=role-status style="font-size:11px; transform:scale(0.9);"></div>
                </div>
                <div id=roomSignature style="font-size:11px; color:#a29bfe; margin-top:8px; max-width:220px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-all;"></div>
            </div>

            <span id=btnRoomSet class=settings-btn>âš™ï¸</span>
        </div>

        <div id=msgs class=chat-msgs></div>
        
        <div id=quoteBox class=quote-box>
            <div id=quoteText class=quote-txt></div>
            <span id=btnCloseQuote class=quote-close>âœ–</span>
        </div>
        
                        <div id=chatToolbarOld style=display:none;>
            <div id=btnRegen></div>
            <div id=btnPic></div>
            <div id=btnPlus></div>
        </div>
                <div class=chat-input>
            <div id=btnOpenSticker class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></div>
            <div id=btnMic class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg></div>
                                    <input type=search id=iptMsg class=msg-input placeholder=è¾“å…¥æ¶ˆæ¯... autocomplete=off>


            <div id=btnLemon class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 5.172C10 3.782 8.423 2.679 6.5 3c-2.823.47-4.113 6.006-4 7 .08.703 1.725 1.722 3.656 1 1.261-.467 1.95-1.9 3.844-2.5"></path><path d="M14 5.172C14 3.782 15.577 2.679 17.5 3c2.823.47 4.113 6.006 4 7-.08.703-1.725 1.722-3.656 1-1.261-.467-1.95-1.9-3.844-2.5"></path><path d="M8 14v1a4 4 0 0 0 8 0v-1"></path><path d="M16 10.5h.01"></path><path d="M8 10.5h.01"></path></svg></div>
            <div id=btnNewMenu class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg></div>
                        <button id=btnSend class=send-btn>å‘é€</button>
        </div>
        
                                                <div id=newMenuDrawer class=menu-drawer>
            <div class=menu-grid>
                <div id=btnRegenNew class=menu-icon-btn>
                    <div class=menu-icon-svg>
             
           <svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=#fff stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><polyline points="3 3 3 8 8 8"></polyline></svg>
                    </div>
                    <div class=menu-icon-text>é‡æ–°ç”Ÿæˆ</div>
                </div>
                
                                <div id=btnTakePhoto class=menu-icon-btn>
                    <div class=menu-icon-svg style="background:#f3e5f5;">
                        <svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=#6c5ce7 stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                    </div>
                    <div class=menu-icon-text>æ‹ç…§</div>
                </div>
                
                <div id=btnUploadPic class=menu-icon-btn>
                    <div class=menu-icon-svg style="background:#f3e5f5;">
                        <svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=#6c5ce7 stroke-width=2 stroke-linecap=round stroke-linejoin=round><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </div>
                    <div class=menu-icon-text>å›¾ç‰‡</div>
                    <input type=file id=picUploadInput accept=image/* style=display:none;>
                </div>
                                <div id=btnTransfer class=menu-icon-btn>
                    <div class=menu-icon-svg style="background:#f3e5f5;">
                        <svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=#6c5ce7 stroke-width=2 stroke-linecap=round stroke-linejoin=round><line x1="6" y1="11" x2="18" y2="11"></line><line x1="6" y1="15" x2="18" y2="15"></line><polyline points="6 5 12 11 18 5"></polyline><line x1="12" y1="11" x2="12" y2="20"></line></svg>
                    </div>
                    <div class=menu-icon-text>è½¬è´¦</div>
                </div>

                <div id=btnRedPacket class=menu-icon-btn>
                    <div class=menu-icon-svg style="background:#ffefef;">
                        <svg width=20 height=20 viewBox="0 0 24 24" fill=none stroke=#ff4d4f stroke-width=2 stroke-linecap=round stroke-linejoin=round><rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect><line x1="3" y1="10" x2="21" y2="10"></line><circle cx="12" cy="10" r="2"></circle></svg>
                    </div>
                    <div class=menu-icon-text>çº¢åŒ…</div>
                </div>



 
            </div>
        </div>



        
    </div>
    
    <div id=ctxMenu class=ctx-menu>

        <div id=ctxCopy class=ctx-item>å¤åˆ¶</div>
        <div id=ctxEdit class=ctx-item>ç¼–è¾‘</div>
        <div id=ctxQuote class=ctx-item>å¼•ç”¨</div>
        <div id=ctxFav class=ctx-item>æ”¶è—</div>
        <div id=ctxMulti class=ctx-item>å¤šé€‰</div>
        <div id=ctxDel class=ctx-item style=color:#ff7675;background:#fff0f0;>åˆ é™¤</div>
    </div>
    
    <div id=editMsgModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>ç¼–è¾‘æ¶ˆæ¯</span>
            </div>
            <div class=modal-bdy style=padding:15px;>
                <textarea id=editMsgInput class=textarea-field style=height:150px;width:100%;box-sizing:border-box;></textarea>
                <div class=flex-row style=margin-top:15px;>
                    <button id=btnCancelEdit class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button>
                    <button id=btnConfirmEdit class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id=modal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>è”ç³»äººå½“å‰çŠ¶æ€</span>
                <span id=btnCloseModal class=close-btn>âœ–</span>
            </div>
            <div class=modal-bdy>
                <div class=stat-card><div class=stat-tag>ğŸ“ å®šä½ä¸å¤©æ°”</div><div id=stW class=stat-txt>æš‚æ— æ•°æ®...</div></div>
                <div class=stat-card><div class=stat-tag>ğŸ‘• å½“æ—¥æœè£…</div><div id=stC class=stat-txt>æš‚æ— æ•°æ®...</div></div>
                <div class=stat-card><div class=stat-tag>ğŸ¬ è¡¨æƒ…ä¸åŠ¨ä½œ</div><div id=stA class=stat-txt>æš‚æ— æ•°æ®...</div></div>
                <div class=stat-card><div class=stat-tag>ğŸ’­ éšç§˜å¿ƒå£°</div><div id=stT class=stat-txt>æš‚æ— æ•°æ®...</div></div>
            </div>
        </div>
    </div>
    
        <div id=scrSetChat class=scr-flex>
        <div class=room-header>
            <span id=btnSetChatBack class=back-btn>ï¼œ</span>
            <span class=header-title>å¥½å‹è®¾ç½®ğŸ’–</span>
            <span class=empty-btn></span>
        </div>
        <div class=api-form>
            <div class=section-card>
                <div class=section-title style="color:#fd79a8;">èƒŒæ™¯å›¾å’Œå¤´åƒè®¾ç½®ğŸ‘‘</div>
                <div class=input-group>

                    <label>èŠå¤©ä¸“å±èƒŒæ™¯ (ä»…èŠå¤©å®¤å†…æ˜¾ç¤º)</label>
                    <div id=btnBgUp class=upload-btn style="height:120px; padding:0; overflow:hidden; border-radius:12px; border:1px dashed #a29bfe;">
                        <div id=bgPreview style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; background-color:#f8f9fa; color:#888;">ğŸ–¼ï¸ ç‚¹å‡»é€‰æ‹©èƒŒæ™¯</div>
                    </div>
                    <input type=file id=upBg accept=image/* style=display:none;>
                </div>
                <div class=flex-row style="margin-top:10px; justify-content:space-around;">
                    <div class=flex-col style="align-items:center; flex:none;">
                        <label style="margin-bottom:5px;">å¯¹æ–¹å¤´åƒ</label>
                        <div id=btnAiUp class=upload-btn style="width:60px; height:60px; padding:0; overflow:hidden; border-radius:50%; border:1px solid #eee;">
                             <div id=aiPreview style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; background-color:#f8f9fa; font-size:24px;">ğŸ‘¤</div>
                        </div>
                        <input type=file id=upAi accept=image/* style=display:none;>
                    </div>
                    <div class=flex-col style="align-items:center; flex:none;">
                        <label style="margin-bottom:5px;">æˆ‘çš„å¤´åƒ</label>
                        <div id=btnMyUp class=upload-btn style="width:60px; height:60px; padding:0; overflow:hidden; border-radius:50%; border:1px solid #eee;">
                             <div id=myPreview style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; background-color:#f8f9fa; font-size:24px;">ğŸ‘¤</div>
                        </div>
                                                <input type=file id=upMy accept=image/* style=display:none;>
                    </div>
                </div>
                
                <div class=input-group><label>è§’è‰²çœŸå</label><input type=text id=cfgName class=input-field placeholder=è®¾å®šå¯¹æ–¹çœŸå></div>
                <div class=input-group><label>ä½ ç»™Taçš„å¤‡æ³¨</label><input type=text id=cfgRem class=input-field placeholder=è®¾ç½®ä¸“å±æ˜µç§°></div>
         
                <div class=input-group><label>æˆ‘çš„åå­— (ç”¨äºè®°å¿†æå–)</label><input type=text id=cfgMyName class=input-field placeholder=è®¾ç½®ä½ çš„ç§°å‘¼></div>
                                    </div>

            <div class=section-card>
                <div class=section-title style="color:#fd79a8;">è§’è‰²è®¾å®šğŸ’œ</div>


                <div class=input-group><label>å¯¹æ–¹äººè®¾</label><textarea id=cfgAiP class=textarea-field rows=3 placeholder=å¡«å†™æ€§æ ¼ä¸èº«ä»½></textarea></div>
                <div class=input-group><label>æˆ‘çš„äººè®¾</label><textarea id=cfgMyP class=textarea-field rows=2 placeholder=å¡«å†™ä½ çš„è®¾å®š></textarea></div>
                                <div class=input-group><label>ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type=number id=cfgCtx class=input-field value=10 min=2 max=30></div>
                <div class=flex-row><label style=font-size:12px;color:#888;font-weight:bold;>å¼€å¯çœŸå®æ—¶é—´æ„ŸçŸ¥</label><input type=checkbox id=cfgTime checked style=width:20px;height:20px;></div>
                
                <div class=flex-row style="margin-top:5px;"><label style=font-size:12px;color:#888;font-weight:bold;>ä½¿ç”¨è‡ªå®šä¹‰æ—¶é—´</label><input type=checkbox id=cfgCustomTime style=width:20px;height:20px;></div>
                <div id=customTimePanel style="display:none;flex-direction:column;gap:8px;margin-top:10px;background:#fcfcfc;padding:12px;border-radius:10px;border:1px solid #eee;">
                    <div style="display:flex;gap:5px;align-items:center;">
                        <select id=ctYear class=input-field style="flex:1;padding:6px;font-size:12px;"></select><span style="font-size:12px;color:#666;">å¹´</span>
                        <select id=ctMonth class=input-field style="flex:1;padding:6px;font-size:12px;"></select><span style="font-size:12px;color:#666;">æœˆ</span>
                        <select id=ctDay class=input-field style="flex:1;padding:6px;font-size:12px;"></select><span style="font-size:12px;color:#666;">æ—¥</span>
                    </div>
                    <div style="display:flex;gap:5px;align-items:center;margin-top:5px;">
                        <select id=ctHour class=input-field style="flex:1;padding:6px;font-size:12px;"></select><span style="font-size:12px;color:#666;">æ—¶</span>
                        <select id=ctMinute class=input-field style="flex:1;padding:6px;font-size:12px;"></select><span style="font-size:12px;color:#666;">åˆ†</span>
                        <span id=ctWeekday style="font-size:12px;color:#fd79a8;font-weight:bold;margin-left:10px;min-width:40px;">æ˜ŸæœŸå‡ </span>
                    </div>
                </div>
            </div>
            
            <div class=section-card>
                <div class=section-title style="color:#fd79a8;">â³ é•¿æœŸè®°å¿†æ—¥è®°åº“</div>

                <div class=flex-row><label style=font-size:12px;color:#888;font-weight:bold;>å¼€å¯è‡ªåŠ¨æ€»ç»“</label><input type=checkbox id=cfgAutoMem style=width:20px;height:20px;></div>
                
                <div class=input-group><label>è§¦å‘æ¡æ•° (å¯¹è¯å¤šå°‘æ¡åè‡ªåŠ¨è§¦å‘)</label><input type=number id=cfgMemTrig class=input-field value=10 min=5 max=100></div>
                <div class=input-group>
                    <label>ç§äººæ—¥è®°æç®€æç¤ºè¯ (é˜²å¤šè€—Token)</label>
                    <textarea id=cfgMemPmt class=textarea-field rows=4>è¯·ç”¨ç¬¬ä¸‰äººç§°è§†è§’ï¼Œç”¨ä¸€å¥è¯æå…¶ç®€ç»ƒåœ°æ¦‚æ‹¬åˆšæ‰å‘ç”Ÿçš„æ ¸å¿ƒå‰§æƒ…ã€‚ç»å¯¹ç¦æ­¢åŒ…å«æ—¥æœŸæˆ–ç¬¦å·ï¼ç›´æ¥è¾“å‡ºå‰§æƒ…ç»“æœã€‚è¯·ä½¿ç”¨åŒæ–¹åå­—ï¼ˆ[å¯¹æ–¹]ä¸[æˆ‘]ï¼‰ã€‚</textarea>
                </div>
                <div class=flex-row>
                    <div id=btnViewMem class=tool-btn style="margin-right:5px;color:#fd79a8;border-color:#fd79a8;">ğŸ“– æŸ¥çœ‹è®°å¿†åº“</div>
                    <div id=btnGenMem class=tool-btn style="margin-left:5px;background:#fff0f5;color:#fd79a8;border-color:#fd79a8;">âœ¨ æ‰‹åŠ¨æ€»ç»“è®°å¿†</div>
                </div>
            </div>
                        <div class=section-card>
                <div class=section-title style="color:#fd79a8;">ğŸ“š å±€éƒ¨ä¸–ç•Œä¹¦å…³è”ï¼ˆå…¨å±€ä¸–ç•Œä¹¦æ— éœ€å•ç‹¬å‹¾é€‰ï¼‰</div>
                <div id=btnOpenLinkWb class=tool-btn style="color:#fd79a8;border-color:#fd79a8;">ç‚¹å‡»é€‰æ‹©è¦å…³è”çš„å‰§æƒ…</div>
            </div>
            <div class=section-card>
                <div class=section-title style="color:#fd79a8;">ğŸ«§ æ°”æ³¡è®¾ç½®</div>
                <div class=input-group>
                    <textarea id=cfgBubbleCss class=textarea-field rows=6 placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥æ­£ç¡®çš„æ°”æ³¡css" style="color:black;"></textarea>
                </div>
            </div>
                        <div class=section-card>
                <div class=flex-row style="justify-content:center;">
                     <div id=btnBlock class=clear-btn style="max-width:200px;">æ‹‰é»‘å¥½å‹</div>

                    <div id=btnDelFriend class=clear-btn style="display:none;">åˆ é™¤å¥½å‹</div>
                </div>
                                <div id=btnClearChat class=clear-btn style=margin-top:10px;>æ¸…ç©ºå½“å‰èŠå¤©è®°å½•</div>
            </div>
            <button id=btnSaveChat class=save-btn style="background:#a29bfe;box-shadow:0 4px 10px rgba(162, 155, 254, 0.3);">ğŸ’¾ ä¿å­˜æ ¸å¿ƒé…ç½®</button>
        </div>

    </div>
    
    <div id=memModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>ğŸ“– æˆ‘ä»¬çš„ä¸“å±è®°å¿†åº“</span>
                <span id=btnCloseMem class=close-btn>âœ–</span>
            </div>
            <div id=memList class=modal-bdy></div>
        </div>
    </div>
    
    <div id=linkWbModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>å…³è”å±€éƒ¨ä¸–ç•Œä¹¦</span>
                <span id=btnCloseLinkWb class=close-btn>âœ–</span>
            </div>
            <div id=linkWbList class=modal-bdy></div>
            <div style=padding:15px;>
                <div id=btnSaveLinkWb class=save-btn style=margin-top:0;>ç¡®è®¤å…³è”å¹¶ä¿å­˜</div>
            </div>
        </div>
    </div>
    
    <div id=scrSetApi class=scr-flex>
        <div class=room-header>
            <span id=btnSetApiBack class=back-btn>ï¼œ</span>
            <span class=header-title>API ç½‘ç»œè®¾ç½®</span>
            <span class=empty-btn></span>
        </div>
        <div class=api-form>
            <div class=section-card>
                <div class=input-group><label>åä»£åœ°å€</label><input type=text id=apiPxy class=input-field placeholder=è¾“å…¥å®Œæ•´æ¥å£åœ°å€></div>
                                <div class=input-group><label>ä¸“å±å¯†é’¥</label><input type=text id=apiK class=input-field style="-webkit-text-security:disc;" placeholder=å¡«å†™ä¸“å±å¯†é’¥ autocomplete=new-password></div>

                <div class=input-group>
                    <label>æ¨¡å‹é€‰æ‹©</label>
                    <input type=text id=apiMod class=input-field placeholder=è¾“å…¥æ¨¡å‹åç§°>
                    <select id=apiModSel class=input-field style=display:none;></select>
                </div>
                <div class=input-group>
                    <label>æ¸©åº¦æ•°å€¼: <span id=tempVal>0.8</span></label>
                    <input type=range id=apiTemp min=0 max=2 step=0.1 value=0.8>
                </div>
                <div class=flex-row style=margin-top:10px;>
                    <button id=btnPull class=tool-btn>ğŸ“¡ æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
                </div>
            </div>
                        <button id=btnSaveApi class=save-btn>ğŸ’¾ ä¿å­˜ç½‘ç»œé…ç½®</button>
        </div>
    </div>
    
    <div id="scrSetFont" class="scr-flex">
        <div class="room-header">
            <span id="btnSetFontBack" class="back-btn">ï¼œ</span>
            <span class="header-title">å­—ä½“ä¸æ’ç‰ˆè®¾ç½®</span>
            <span class="empty-btn"></span>
        </div>
        <div class="api-form">
            <div class="section-card">
                <div class="section-title" style="color:#fd79a8;">ğŸ¨ å­—ä½“æ–‡ä»¶URL</div>
                <div style="font-size:12px;color:#888;margin-bottom:8px;">è¯·è¾“å…¥ä»¥ .ttf æˆ– .woff ç»“å°¾çš„å­—ä½“ç›´é“¾ï¼ˆç•™ç©ºåˆ™æ¢å¤é»˜è®¤ï¼‰</div>
                <div class="input-group">
                    <input type="text" id="fontUrl" class="input-field" placeholder="https://...">
                </div>
            </div>
            <div class="section-card">
                <div class="section-title" style="color:#fd79a8;">ğŸ“ æ°”æ³¡å­—ä½“å¤§å°: <span id="fontSizeVal">14</span> px</div>
                <div class="input-group" style="padding: 10px 0;">
                    <input type="range" id="fontSizeSlider" min="10" max="30" step="1" value="14" style="width:100%;">
                </div>
            </div>
            <div class="section-card">
                <div class="section-title" style="color:#fd79a8;">ğŸ–Œï¸ æ°”æ³¡æ–‡å­—é¢œè‰²</div>
                <div class="flex-row" style="margin-top:5px;">
                    <label style="flex:1; font-size:13px; color:#333; font-weight:bold;">å¯¹æ–¹å­—ä½“é¢œè‰²</label>
                    <input type="color" id="fontColorChar" value="#4a4a4a" style="width:45px; height:35px; border:none; border-radius:8px; cursor:pointer;">
                </div>
                <div class="flex-row" style="margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
                    <label style="flex:1; font-size:13px; color:#333; font-weight:bold;">æˆ‘çš„å­—ä½“é¢œè‰²</label>
                    <input type="color" id="fontColorUser" value="#474747" style="width:45px; height:35px; border:none; border-radius:8px; cursor:pointer;">
                </div>
            </div>
            <div class="flex-row" style="margin-top:10px;">
                <button id="btnCancelFont" class="clear-btn" style="background:#f0f2f5; color:#333; border:none; font-size:15px; padding:15px;">å–æ¶ˆ</button>
                <button id="btnSaveFont" class="save-btn" style="margin-top:0; flex:1; margin-left:10px;">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <div id=scrWb class=scr-flex>
        <div class=room-header>

            <span id=btnWbBack class=back-btn>ï¼œ</span>
            <span class=header-center>ä¸–ç•Œä¹¦ç³»ç»Ÿ</span>
            <span id=btnWbAdd class=plus-btn>+</span>
        </div>
        <div class=wb-tabs>
            <div id=tabGlobal class=wb-active style=flex:1;text-align:center;padding:10px;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;transition:0.3s;>å…¨å±€è®°å¿†</div>
            <div id=tabLocal class=wb-tab style=flex:1;text-align:center;padding:10px;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;transition:0.3s;>å±€éƒ¨å‰§æƒ…</div>
        </div>
        <div id=wbListContainer class=wb-list></div>
    </div>
    
    <div id=scrWbEdit class=scr-flex>
        <div class=room-header>
            <span id=btnWbEditBack class=back-btn>ï¼œ</span>
            <span class=header-center>ç¼–è¾‘ä¸–ç•Œä¹¦</span>
            <span class=empty-btn></span>
        </div>
        <div class=api-form>
            <div class=section-card>
                <div class=input-group><label>æ ‡é¢˜</label><input type=text id=wbTitle class=input-field placeholder=è¾“å…¥è®°å¿†æ ‡é¢˜></div>
                <div class=input-group>
                    <label>åŠ è½½ç±»å‹</label>
                    <select id=wbType class=input-field>
                        <option value=global>å…¨å±€åŠ è½½ (æ‰€æœ‰è§’è‰²é»˜è®¤çŸ¥æ™“)</option>
                        <option value=local>å±€éƒ¨å…³è” (éœ€åœ¨èŠå¤©è®¾ç½®æ‰‹åŠ¨å…³è”)</option>
                    </select>
                </div>
                <div class=input-group><label>å†…å®¹è®¾å®š</label><textarea id=wbContent class=textarea-field rows=8 placeholder=è¯¦ç»†æè¿°ä¸–ç•Œè§‚æˆ–èƒŒæ™¯è®¾å®š></textarea></div>
            </div>
            <button id=btnWbSave class=save-btn>ğŸ’¾ è®°å½•è¿›ä¸–ç•Œä¹¦</button>
        </div>
    </div>
    
    <div id=stickerDrawer class=sticker-drawer>
        <div class=sticker-header>
            <span id=btnCancelSticker>å–æ¶ˆ</span>
            <span class=title>è¡¨æƒ…åŒ…</span>
            <div class=sticker-actions>
                <span id=stickerEditBtn>ç¼–è¾‘</span>
                <span id=btnDelSelectedSticker style=display:none;color:#ff4d4f;>åˆ é™¤</span>
                <span id=btnSelectAllSticker style=display:none;>å…¨é€‰</span>
                <span id=btnAddBatchSticker>æ·»åŠ </span>
                <span id=btnUploadStickerClick>ä¸Šä¼ </span>
                <input type=file id=stickerUploadInput accept=image/* style=display:none;>
            </div>
        </div>
                <div class=sticker-search>
            <input type=text id=stickerSearch placeholder=æœç´¢è¡¨æƒ…åŒ…åç§°...>
        </div>
        <div class=sticker-tabs>
            <span id=tabRecentSticker class="st-tab">æœ€è¿‘</span>
            <span id=tabAllSticker class="st-tab active">å…¨éƒ¨</span>
        </div>
        <div class=sticker-grid id=stickerGrid></div>
    </div>


    <div id=batchModal class=batch-modal-overlay>
        <div class=batch-modal>
            <h3 style=margin-bottom:15px;>æ‰¹é‡æ·»åŠ è¡¨æƒ…</h3>
            <div class=batch-input-wrapper>
                <textarea id=batchStickerInput placeholder=ä¸€è¡Œä¸€ä¸ªï¼Œåç§°å’Œé“¾æ¥ç”¨ç©ºæ ¼éš”å¼€></textarea>
            </div>
            <div class=batch-modal-btns>
                <button id=btnCancelBatch class=cancel>å–æ¶ˆ</button>
                <button id=btnConfirmBatch>ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id=scrMe class=scr-list>
        <div class=chat-header>
            <span id=btnMeBack class=back-btn>ï¼œ</span>
            <span class=header-center>æˆ‘</span>
            <span class=empty-btn></span>
        </div>
        
        <div class=me-header>
            <div id=meAvatar class=me-avatar></div>
            <div class=me-info>
                <div id=meName class=me-name>æœªå‘½å</div>
                <div id=meBio class=me-bio>è¯·æ·»åŠ ä½ çš„ä¸ªæ€§ç­¾åå§ï¼</div>
            </div>
            <div class=me-icons>
                <span id=btnEditMe style=cursor:pointer;>ğŸ“</span>
                <span style=color:#ff4d4f;cursor:pointer;>ğŸ—‘ï¸</span>
            </div>
        </div>

        <div class=me-menu-list>
                        <div id=btnGoCharSticker class=me-menu-item>
                <div class=me-menu-left>
                    <div class=me-menu-title>è§’è‰²è¡¨æƒ…åŒ…åº“</div>

                    <div class=me-menu-sub>è®©å¯¹æ–¹ä¹Ÿèƒ½éšæ—¶å‘é€è¡¨æƒ…åŒ…</div>
                </div>
                <div class=me-menu-right>ï¼</div>
            </div>
                        <div id=btnGoFav class=me-menu-item>
                <div class=me-menu-left>
                    <div class=me-menu-title>æˆ‘çš„æ”¶è—</div>
                    <div class=me-menu-sub>æŸ¥çœ‹æ”¶è—çš„ç²¾å½©æ¶ˆæ¯</div>
                </div>
                <div class=me-menu-right>ï¼</div>
            </div>

            <div id=btnOpenWallet class=me-menu-item>
                <div class=me-menu-left>
                    <div class=me-menu-title>æˆ‘çš„é’±åŒ…</div>
                    <div class=me-menu-sub>ç®¡ç†ä½ çš„åŒæ ¸èµ„äº§ä¸è½¬è´¦è®°å½•</div>
                </div>
                <div class=me-menu-right>ï¼</div>
            </div>
        </div>
        
        <div class=bottom-nav>
            <div id=navMeToMsg class=nav-item><div class=nav-icon>ğŸ’¬</div><div class=nav-text>æ¶ˆæ¯</div></div>
                        <div id=navMeToContact class=nav-item><div class=nav-icon>ğŸ‘¥</div><div class=nav-text>è”ç³»äºº</div></div>

            <div id=navMeToMoment class=nav-item><div class=nav-icon>ğŸŒ</div><div class=nav-text>åŠ¨æ€</div></div>
            <div class=nav-item-active><div class=nav-icon>ğŸ‘¤</div><div class=nav-text>æˆ‘</div></div>
        </div>
    </div>
<div id=scrCharSticker class=scr-flex>
                                <div class=room-header>
            <span id=btnCharStickerBack class=back-btn>ï¼œ</span>
            <span class=header-center>è§’è‰²è¡¨æƒ…åŒ…åº“</span>

            <span id=btnEditCharSticker style=cursor:pointer;font-size:14px;color:#6c5ce7;font-weight:bold;>ç®¡ç†</span>
        </div>
        <div id=charStickerActions style=display:none;padding:10px 20px;background:#fff0f0;justify-content:space-between;align-items:center;border-bottom:1px solid #ffeeee;flex-shrink:0;>
            <span id=btnSelAllCharSticker style=color:#333;font-size:13px;cursor:pointer;font-weight:bold;>å…¨é€‰</span>
            <span id=btnDelCharSticker style=color:#ff7675;font-size:13px;font-weight:bold;cursor:pointer;>åˆ é™¤é€‰ä¸­</span>
        </div>

        <div class=api-form>
            <div class=section-card>
                <div class=section-title>â• æé€Ÿæ‰¹é‡æ·»åŠ è¡¨æƒ…</div>
                <div style=font-size:12px;color:#888;margin-bottom:10px;line-height:1.5;>æ— éœ€æ‰‹åŠ¨å‘½åï¼ç³»ç»Ÿä¼šè‡ªåŠ¨è¯»å–æ–‡ä»¶åä½œä¸ºAIè¯†åˆ«æŒ‡ä»¤ã€‚(å»ºè®®æœ¬åœ°å›¾ç‰‡æå‰å‘½åä¸ºæƒ…ç»ªè¯ï¼Œå¦‚:æ— è¯­ã€å¤§ç¬‘)</div>
                <div class=input-group>
                    <div id=btnUpCharSticker class=upload-btn style=background:#eef2ff;color:#6c5ce7;border:1px dashed #a29bfe;>ğŸ–¼ï¸ 1. ç‚¹å‡»æ‰¹é‡ä¸Šä¼ æœ¬åœ°å›¾ç‰‡ (å¯å¤šé€‰)</div>
                    <input type=file id=upCharSticker accept=image/* multiple style=display:none;>
                </div>
                <div class=flex-col style=margin-top:10px;>
                    <textarea id=iptCharBatchUrl class=textarea-field rows=4 placeholder=2.æˆ–è€…åœ¨æ­¤æ‰¹é‡ç²˜è´´ç½‘ç»œå›¾ç‰‡é“¾æ¥(ä¸€è¡Œä¸€ä¸ªï¼Œç³»ç»Ÿè‡ªåŠ¨è§£æåç§°)></textarea>
                </div>
                <button id=btnAddCharSticker class=save-btn style=margin-top:10px;padding:12px;>ğŸ’¾ 3. å°†é“¾æ¥å­˜å…¥è§’è‰²å¤§è„‘</button>
            </div>
            <div class=section-card>
                <div class=section-title>ğŸ“¦ è§’è‰²å·²æŒæ¡çš„è¡¨æƒ…</div>
               <div id=charStickerList style=display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;max-height:300px;overflow-y:auto;overflow-x:hidden;padding-right:5px;></div>


            </div>
        </div>
    </div>
  <div id="scrSpace" class="scr-flex">
    <div class="room-header">
        <span id="btnSpaceBack" class="back-btn">ï¼œ</span>
        <span class="header-center">æˆ‘çš„ç©ºé—´</span>
        <span class="empty-btn"></span>
    </div>
    <div class="me-header">
        <div id="spaceAvatar" class="me-avatar"></div>
        <div class="me-info">
            <div id="spaceName" class="me-name">ä½ çš„åå­—</div>
            <div id="spaceBio" class="me-bio">è¯·æ·»åŠ ä½ çš„ä¸ªæ€§ç­¾åå§ï¼</div>
        </div>
        <div class="me-icons">
            <span id="btnEditSpace" style="cursor:pointer;">ğŸ“</span>
        </div>
    </div>
    <div class="me-menu-list">
        <div id="btnSpaceLogs" class="me-menu-item">
            <div class="me-menu-left">
                <div class="me-menu-title">æˆ‘çš„æ—¥å¿—</div>
                <div class="me-menu-sub">è®°å½•ç”Ÿæ´»ç‚¹æ»´ï¼Œäº’åŠ¨è¯„è®º</div>
            </div>
            <div class="me-menu-right">ï¼</div>
        </div>
        <div id="btnSpaceBoard" class="me-menu-item">
            <div class="me-menu-left">
                <div class="me-menu-title">ç•™è¨€æ¿</div>
                <div class="me-menu-sub">ä¸»äººå¯„è¯­ï¼Œæœ‹å‹è¸©è¸©</div>
            </div>
            <div class="me-menu-right">ï¼</div>
        </div>
        <div id="btnSpaceMoments" class="me-menu-item">
            <div class="me-menu-left">
                <div class="me-menu-title">æˆ‘çš„è¯´è¯´</div>
                <div class="me-menu-sub">éšæ—¶éšåœ°åˆ†äº«å¿ƒæƒ…</div>
            </div>
            <div class="me-menu-right">ï¼</div>
        </div>
    </div>
</div>

<div id="scrLogList"class="scr-flex">
    <div class="room-header">
        <span id="btnLogListBack" class="back-btn">ï¼œ</span>
        <span class="header-center">ä¸“å±æ—¥å¿—æœ¬</span>
        <span id="btnWriteLog" class="plus-btn" style="font-size: 20px;">âœï¸</span>
    </div>
    <div class="log-list-header">
        <div id="tabMyLogs" class="log-tab log-tab-active">æˆ‘çš„æ—¥å¿—</div>
        <div id="tabAiLogs" class="log-tab">Taçš„æ—¥å¿—</div>
    </div>
    <div id="logListContainer" class="list-content" style="padding-bottom: 20px; overflow-y: auto;">
    </div>
</div>

<div id="scrLogEdit"class="scr-flex">
    <div class="room-header">
        <span id="btnLogEditBack" class="back-btn">ï¼œ</span>
        <span class="header-center">å†™æ—¥å¿—</span>
        <span id="btnPublishLog" style="color:#6c5ce7; font-weight:bold; cursor:pointer; font-size:15px;">å‘è¡¨</span>
    </div>
    <div class="api-form" style="padding: 20px;">
        <div class="section-card">
            <div class="input-group">
                <label>é…å›¾æ–¹å¼</label>
                <select id="logImgType" class="input-field">
                    <option value="none">çº¯æ–‡å­— (ä¸åŠ å›¾ç‰‡)</option>
                    <option value="text">è„‘è¡¥æ¨¡å¼ (æ–‡å­—æè¿°å›¾ç‰‡)</option>
                    <option value="local">å¸¸è§„æ¨¡å¼ (ä¸Šä¼ æœ¬åœ°å›¾ç‰‡)</option>
                </select>
            </div>
            <div id="logTextImgBlock" class="input-group" style="display:none; margin-top:10px;">
                <label>å‘AIæè¿°è¿™å¼ å›¾çš„å†…å®¹ (ç³»ç»Ÿå°†æ˜¾ç¤ºä¸ºå ä½å›¾)</label>
                <input type="text" id="logImgDesc" class="input-field" placeholder="ä¾‹å¦‚ï¼šä¸€å¼ åœ¨æµ·è¾¹æ‹çš„æ—¥è½é£æ™¯ç…§...">
            </div>
            <div id="logLocalImgBlock" class="input-group" style="display:none; margin-top:10px;">
                <label>é€‰æ‹©æœ¬åœ°å›¾ç‰‡</label>
                <div id="btnSelectLogImg" class="upload-btn">ğŸ–¼ï¸ ç‚¹å‡»é€‰æ‹©</div>
                <input type="file" id="upLogImg" accept="image/*" style="display:none;">
                <img id="logImgPreview" style="width:100%; max-height:150px; object-fit:contain; margin-top:10px; display:none; border-radius:10px;">
            </div>
        </div>
        <div class="section-card" style="flex: 1;">
            <div class="input-group" style="height: 100%;">
                <label>æ—¥å¿—æ­£æ–‡</label>
                <textarea id="logContent" class="textarea-field" style="height: 250px; resize: none;" placeholder="è®°å½•ä»Šå¤©çš„ç‚¹ç‚¹æ»´æ»´..."></textarea>
            </div>
        </div>
    </div>
</div>






<div id=editMeModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>ç¼–è¾‘ä¸ªäººèµ„æ–™</span>
            </div>
            <div class=modal-bdy style=padding:15px;>
                <div class=input-group>
                    <label>å¤´åƒ</label>
                    <div id=btnSetMeAvatar class=upload-btn>ğŸ–¼ï¸ ç‚¹å‡»ä¸Šä¼ ä½ çš„ä¸“å±å¤´åƒ</div>
                    <input type=file id=upMeAvatar accept=image/* style=display:none;>
                </div>
                <div class=input-group style=margin-top:10px;>
                    <label>æ˜µç§°</label>
                    <input type=text id=iptMeName class=input-field placeholder=è¾“å…¥ä½ çš„æ˜µç§°>
                </div>
                <div class=input-group style=margin-top:10px;>
                    <label>ä¸ªæ€§ç­¾å</label>
                    <input type=text id=iptMeBio class=input-field placeholder=è¾“å…¥ä¸ªæ€§ç­¾å>
                </div>
                <div class=flex-row style=margin-top:15px;>
                    <button id=btnCancelEditMe class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button>
                                        <button id=btnSaveEditMe class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id=addFriendModal class=modal-base>
        <div class=modal-ctx>
                         <div class=modal-hdr>
                <span>æ·»åŠ æ–°è”ç³»äºº</span>
            </div>
            <div class=modal-bdy style=padding:15px;>
                <div class=input-group>
                    <label>è”ç³»äººåç§°</label>
                 
                 <input type=text id=newFriendName class=input-field placeholder=è¾“å…¥æ–°è”ç³»äººçš„åå­—>

                </div>
                <div class=input-group style=margin-top:10px;>
                    <label>åˆå§‹äººè®¾</label>
                    <textarea id=newFriendPrompt class=textarea-field rows=3 placeholder=ç®€å•æè¿°TAçš„æ€§æ ¼></textarea>
                </div>
                <div class=flex-row style=margin-top:15px;>
                    <button id=btnCancelAddFriend class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button>
                                        <button id=btnConfirmAddFriend class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ç¡®å®šæ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>
</div>

                <div id="scrCharPhone" class="scr-char-phone" style="background-color: #ffffff;
background-image: none;">
        <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.2);backdrop-filter:blur(2px);z-index:1;"></div>
        
                        <div class="char-phone-header" style="color:#333; text-shadow:none;">
            <span id="btnCharPhoneExit" style="cursor:pointer; font-size:18px; font-weight:bold;">ï¼œ è¿”å›</span>
            <div class="char-phone-status-bar">
                <div class="catch-switch-wrapper" style="background:rgba(0,0,0,0.05); color:#333;">
                    <label for="catchSwitch">è¢«æŠ“åŒ…</label>
                    <input type="checkbox" id="catchSwitch" class="catch-switch">
                    <span id="btnCatchHelp" style="font-size:12px;width:14px;height:14px;border-radius:50%;background:rgba(0,0,0,0.2);color:white;display:flex;justify-content:center;align-items:center;cursor:pointer;font-weight:bold;margin-left:2px;">?</span>
                </div>
                <span>ğŸ“¶</span><span>ğŸ”‹ 85%</span>
            </div>
        </div>

        <div style="z-index:2; display:flex; flex-direction:column; align-items:center; padding-top:20px; padding-bottom:10px; width:100%;">
            <div style="display:flex; justify-content:center; align-items:center; width:100%; position:relative;">
                <select id="spyCharSelect" style="position:absolute; left:20px; background:rgba(0,0,0,0.05); border:none; border-radius:12px; padding:6px 4px; font-size:12px; font-weight:bold; color:#333; outline:none; max-width:95px; cursor:pointer;">
                    <option value="">åˆ‡æ¢è§’è‰²ğŸ“±</option>
                </select>
                <div id="spyCharAvatar" style="width:85px; height:85px; border-radius:50%; background-color:#f0f2f5; display:flex; justify-content:center; align-items:center; font-size:45px; color:#999; box-shadow:0 4px 12px rgba(0,0,0,0.1); background-size:cover; background-position:center;">ğŸ‘¤</div>
                <div id="btnSpyRefresh" style="position:absolute; right:20px; background:#f0f2f5; border-radius:50%; width:36px; height:36px; display:flex; justify-content:center; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.1); cursor:pointer; font-size:18px; z-index:10;" title="åˆ·æ–°é‡æ–°ç”Ÿæˆ">ğŸ”„</div>
            </div>
            <div id="spyCharName" style="margin-top:12px; font-size:16px; font-weight:bold; color:#333;">ä¸“å±æ‹äºº</div>
        </div>

        
        <div class="char-phone-desktop" style="padding-top:10px;">
            <div class="char-app-item" id="btnSpyCall"><div class="char-app-icon icon-call" style="font-size:26px;">ğŸ“</div><div class="char-app-name">é€šè¯è®°å½•</div></div>
                        <div class="char-app-item" id="btnSpyWechat"><div class="char-app-icon icon-wechat">ğŸ’¬</div><div class="char-app-name">å¾®ä¿¡</div></div>
            <div class="char-app-item" id="btnSpyAlbum"><div class="char-app-icon icon-album">ğŸ–¼ï¸</div><div class="char-app-name">ç›¸å†Œ</div></div>
                        <div class="char-app-item" id="btnSpyMemo"><div class="char-app-icon icon-memo" style="font-size:26px;">ğŸ“</div><div class="char-app-name">å¤‡å¿˜å½•</div></div>

            <div class="char-app-item" id="btnSpyDiary"><div class="char-app-icon icon-diary" style="font-size:26px;">ğŸ“–</div><div class="char-app-name">æ—¥è®°</div></div>

            <div class="char-app-item" id="btnSpyMusic"><div class="char-app-icon icon-music">ğŸµ</div><div class="char-app-name">ç½‘æ˜“äº‘</div></div>
            <div class="char-app-item" id="btnSpyZhihu"><div class="char-app-icon icon-zhihu">çŸ¥</div><div class="char-app-name">çŸ¥ä¹</div></div>
            <div class="char-app-item" id="btnSpyFootprint"><div class="char-app-icon icon-footprint" style="font-size:26px;">ğŸ“</div><div class="char-app-name">è¶³è¿¹</div></div>
            <div class="char-app-item" id="btnSpyWallet"><div class="char-app-icon icon-wallet">Â¥</div><div class="char-app-name">é’±åŒ…</div></div>
            <div class="char-app-item" id="btnSpyMeituan"><div class="char-app-icon icon-meituan" style="font-size:26px;">è¢‹</div><div class="char-app-name">ç¾å›¢</div></div>
      
            <div class="char-app-item" id="btnSpySettings"><div class="char-app-icon icon-settings" style="font-size:26px;">âš™ï¸</div><div class="char-app-name">è®¾ç½®</div></div>
            <div class="char-app-item" id="btnSpySecret"><div class="char-app-icon icon-secret">ğŸ”’</div><div class="char-app-name">éšç§ç©ºé—´</div></div>
        </div>
    </div>



            <div id="scrWallet" class="scr-flex">

        <div class="room-header" style="background:#6c5ce7; color:white; border:none;">
            <span id="btnWalletBack" class="back-btn" style="color:white;">ï¼œ</span>
            <span class="header-center">æˆ‘çš„é’±åŒ…</span>
            <span id="btnWalletSet" style="font-size:18px; cursor:pointer;">âš™ï¸</span>
        </div>

        <div style="background:#6c5ce7; padding:30px 20px; color:white; display:flex; flex-direction:column; align-items:center;">
            <div style="font-size:14px; opacity:0.8; margin-bottom:10px;">æ€»èµ„äº§ (å…ƒ)</div>
            <div style="font-size:40px; font-weight:bold; margin-bottom:20px;">Â¥ <span id="walletTotal">0.00</span></div>
            <div style="display:flex; width:100%; justify-content:space-around; background:rgba(255,255,255,0.1); padding:15px; border-radius:15px;">
                <div id="btnGoBalance" style="text-align:center; cursor:pointer; flex:1;">
                    <div style="font-size:12px; opacity:0.8;">é›¶é’± ï¼</div>
                    <div style="font-size:16px; font-weight:bold; margin-top:5px;" id="walletBalance">0.00</div>
                </div>
                <div style="width:1px; background:rgba(255,255,255,0.2);"></div>
                <div id="btnGoBank" style="text-align:center; cursor:pointer; flex:1;">
                    <div style="font-size:12px; opacity:0.8;">å‚¨è“„å¡ ï¼</div>
                    <div style="font-size:16px; font-weight:bold; margin-top:5px;" id="bankBalance">0.00</div>
                </div>
            </div>
        </div>
                <div style="flex:1; background:#f5f6fa; border-top-left-radius:20px; border-top-right-radius:20px; margin-top:-20px; padding:20px; overflow-y:auto; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-size:15px; color:#333;">è´¦å•è®°å½•</h3>
                <span id="btnEditWalletBill" style="font-size:13px; color:#6c5ce7; cursor:pointer; font-weight:bold;">ç®¡ç†</span>
            </div>
            <div id="walletBillActions" style="display:none; padding-bottom:12px; border-bottom:1px solid #eee; margin-bottom:12px; justify-content:space-between; align-items:center; flex-shrink:0;">
                <span id="btnSelAllBill" style="font-size:13px; color:#333; cursor:pointer; font-weight:bold;">å…¨é€‰</span>
                <span id="btnDelSelBill" style="font-size:13px; color:#ff4d4f; cursor:pointer; font-weight:bold;">åˆ é™¤å¹¶é€€è¿˜é‡‘é¢</span>
            </div>
            <div id="walletBillList" style="display:flex; flex-direction:column; gap:12px; flex:1;"></div>

            <button id="btnTopUpBank" style="width:100%; padding:15px; border-radius:15px; background:#fff; color:#6c5ce7; border:1px solid #6c5ce7; font-size:16px; font-weight:bold; margin-top:20px; cursor:pointer; flex-shrink:0;">ç»™å‚¨è“„å¡å……å€¼</button>
        </div>
    </div>


    <div id="scrFav" class="scr-flex">
        <div class="room-header">
            <span id="btnFavBack" class="back-btn">ï¼œ</span>
            <span class="header-center">æˆ‘çš„æ”¶è—</span>
            <span class="empty-btn"></span>
        </div>
        <div id="favListContainer" class="list-content" style="padding: 15px; overflow-y: auto; background-color: #f5f6fa;"></div>
    </div>
    <div id="voiceModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:20px; border-radius:20px; background:#fff; display:flex; flex-direction:column; align-items:center;">
            <h3 style="margin:0 0 15px 0; font-size:18px; color:#333;">å‘é€è¯­éŸ³</h3>
            <textarea id="voiceInputText" style="width:100%; height:120px; background:#f5f6fa; border:none; border-radius:15px; padding:15px; box-sizing:border-box; font-size:14px; resize:none; outline:none;" placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹..."></textarea>
            <div style="display:flex; width:100%; gap:15px; margin-top:20px;">
                <button id="btnCancelVoice" style="flex:1; padding:12px; border-radius:25px; border:none; background:#f0f2f5; color:#666; font-size:15px; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
                <button id="btnSendVoice" style="flex:1; padding:12px; border-radius:25px; border:none; background:#000; color:#fff; font-size:15px; font-weight:bold; cursor:pointer;">å‘é€</button>
            </div>
        </div>
    </div>
    <div id="takePhotoModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:20px; border-radius:20px; background:#fff; display:flex; flex-direction:column; align-items:center;">
            <h3 style="margin:0 0 15px 0; font-size:18px; color:#333;">å‘é€ç°æ‹ç…§ç‰‡</h3>
            <textarea id="takePhotoInput" style="width:100%; height:150px; background:#f5f6fa; border:none; border-radius:15px; padding:15px; box-sizing:border-box; font-size:14px; resize:none; outline:none;" placeholder="è¯·åœ¨è¿™é‡Œå†™ä¸Šä½ æ‹ç…§çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šä¸€ä¸ªå¥³å­©å­åœ¨é˜³å…‰ä¸‹å¥”è·‘ã€‚"></textarea>
            <div style="display:flex; width:100%; gap:15px; margin-top:20px;">
                <button id="btnCancelTakePhoto" style="flex:1; padding:12px; border-radius:25px; border:none; background:#f0f2f5; color:#666; font-size:15px; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
                <button id="btnSendTakePhoto" style="flex:1; padding:12px; border-radius:25px; border:none; background:#000; color:#fff; font-size:15px; font-weight:bold; cursor:pointer;">å‘é€</button>
            </div>
        </div>
    </div>
    <div id="transferModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:20px; border-radius:20px; background:#fff; display:flex; flex-direction:column; align-items:center;">
                        <h3 style="margin:0 0 15px 0; font-size:18px; color:#333;">è½¬è´¦ç»™å¯¹æ–¹</h3>
                        <div style="width:100%; display:flex; flex-direction:column; gap:12px;">
                <div style="display:flex; align-items:center; background:#f5f6fa; border-radius:15px; padding:10px 15px; box-sizing:border-box; overflow:hidden;">
                    <span style="font-size:20px; font-weight:bold; color:#333; margin-right:10px; flex-shrink:0;">Â¥</span>
                    <input type="number" id="transferAmount" style="flex:1; width:50px; min-width:0; border:none; background:transparent; outline:none; font-size:24px; color:#333; font-weight:bold; padding-right:10px;" placeholder="0.00">
                </div>


                <input type="text" id="transferNote" style="width:100%; background:#f5f6fa; border:none; border-radius:15px; padding:15px; box-sizing:border-box; font-size:14px; outline:none; color:#333;" placeholder="æ·»åŠ å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰">
            </div>
            <div style="display:flex; width:100%; gap:15px; margin-top:20px;">
                <button id="btnCancelTransfer" style="flex:1; padding:12px; border-radius:25px; border:none; background:#f0f2f5; color:#333; font-size:15px; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
                <button id="btnSendTransfer" style="flex:1; padding:12px; border-radius:25px; border:none; background:#6c5ce7; color:#fff; font-size:15px; font-weight:bold; cursor:pointer;">è½¬è´¦</button>
            </div>
        </div>
    </div>
    <div id="redPacketModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:20px; border-radius:20px; background:#fffafb; display:flex; flex-direction:column; align-items:center;">
            <h3 style="margin:0 0 15px 0; font-size:18px; color:#d63031;">å‘çº¢åŒ…</h3>
                                    <div style="width:100%; display:flex; flex-direction:column; gap:12px;">
                <div style="display:flex; align-items:center; background:#fff; border:1px solid #ffeaa7; border-radius:15px; padding:10px 15px; box-sizing:border-box; overflow:hidden;">
                    <span style="font-size:16px; font-weight:bold; color:#333; margin-right:10px; flex-shrink:0;">é‡‘é¢</span>
                    <input type="number" id="redPacketAmount" style="flex:1; width:50px; min-width:0; border:none; background:transparent; outline:none; font-size:20px; color:#d63031; font-weight:bold; text-align:right; padding-right:10px;" placeholder="0.00">
                    <span style="font-size:16px; font-weight:bold; color:#333; margin-left:10px; flex-shrink:0;">å…ƒ</span>
                </div>


                <input type="text" id="redPacketNote" style="width:100%; background:#fff; border:1px solid #ffeaa7; border-radius:15px; padding:15px; box-sizing:border-box; font-size:14px; outline:none; color:#333;" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©">
                
                <div style="display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #ffeaa7; border-radius:15px; padding:10px 15px;">
                    <span style="font-size:14px; color:#666;">çº¢åŒ…å°é¢</span>
                    <div id="btnSelectRpCover" style="font-size:12px; color:#d63031; cursor:pointer; font-weight:bold; padding:4px 8px; background:#ffefef; border-radius:8px;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
                    <input type="file" id="rpCoverInput" accept="image/*" style="display:none;">
                </div>
                <img id="rpCoverPreview" style="width:100%; height:80px; object-fit:cover; border-radius:10px; display:none; border:1px solid #ffeaa7;">
            </div>
            <div style="display:flex; width:100%; gap:15px; margin-top:20px;">
                <button id="btnCancelRedPacket" style="flex:1; padding:12px; border-radius:25px; border:none; background:#f0f2f5; color:#333; font-size:15px; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
                <button id="btnSendRedPacket" style="flex:1; padding:12px; border-radius:25px; border:none; background:#d63031; color:#fff; font-size:15px; font-weight:bold; cursor:pointer;">å¡é’±è¿›çº¢åŒ…</button>
            </div>
        </div>
    </div>

    <div id="payPwdModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:20px; border-radius:20px; background:#fff; display:flex; flex-direction:column; align-items:center;">
            <h3 style="margin:0 0 15px 0; font-size:18px; color:#333;">ç¡®è®¤ä»˜æ¬¾</h3>
            <div style="width:100%; display:flex; flex-direction:column; gap:12px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f5f6fa; border-radius:10px;">
                    <span style="font-size:14px; color:#666;">ä»˜æ¬¾æ–¹å¼</span>
                    <select id="payMethodSelect" style="border:none; background:transparent; font-size:14px; color:#333; outline:none; font-weight:bold; text-align:right;">
                        <option value="wallet">é›¶é’± (ä½™é¢å……æ²›)</option>
                        <option value="bank">å‚¨è“„å¡ (å°¾å·8888)</option>
                    </select>
                </div>
                <div style="font-size:24px; font-weight:bold; color:#333; text-align:center; margin:10px 0;">
                    <span style="font-size:18px;">Â¥</span><span id="payModalAmount">0.00</span>
                </div>
                <input type="password" id="payPwdInput" maxlength="6" style="width:100%; background:#f5f6fa; border:none; border-radius:15px; padding:15px; box-sizing:border-box; font-size:18px; text-align:center; letter-spacing:10px; outline:none; color:#333;" placeholder="è¾“å…¥6ä½å¯†ç ">
            </div>
            <div style="display:flex; width:100%; gap:15px;">
                <button id="btnCancelPay" style="flex:1; padding:12px; border-radius:25px; border:none; background:#f0f2f5; color:#333; font-size:15px; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
                <button id="btnConfirmPay" style="flex:1; padding:12px; border-radius:25px; border:none; background:#6c5ce7; color:#fff; font-size:15px; font-weight:bold; cursor:pointer;">ä»˜æ¬¾</button>
            </div>
        </div>
    </div>
    <div id="balanceModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:25px 20px; border-radius:20px; background:#fff; display:flex; flex-direction:column; align-items:center;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-size:18px; color:#333;">æˆ‘çš„é›¶é’±</h3>
                <span id="btnBalanceHelp" style="width:22px; height:22px; border-radius:50%; border:1px solid #999; color:#999; display:flex; justify-content:center; align-items:center; font-size:14px; cursor:pointer; font-weight:bold;">?</span>
            </div>
            <div style="font-size:14px; color:#666; margin-top:10px;">é›¶é’±ä½™é¢</div>
            <div style="font-size:40px; font-weight:bold; color:#333; margin:10px 0 25px 0;">
                <span style="font-size:24px;">Â¥</span><span id="modalBalanceAmount">0.00</span>
            </div>
            <div style="display:flex; width:100%; flex-direction:column; gap:12px;">
                <button id="btnBalanceTopUp" style="width:100%; padding:14px; border-radius:25px; border:none; background:#6c5ce7; color:#fff; font-size:16px; font-weight:bold; cursor:pointer;">å……å€¼</button>
                <button id="btnBalanceWithdraw" style="width:100%; padding:14px; border-radius:25px; border:none; background:#f0f2f5; color:#333; font-size:16px; font-weight:bold; cursor:pointer;">æç°</button>
            </div>
            <button id="btnCloseBalanceModal" style="margin-top:20px; padding:10px; border:none; background:transparent; color:#888; font-size:14px; cursor:pointer; font-weight:bold;">å…³é—­</button>
        </div>
    </div>
    <div id="walletPwdModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:20px; border-radius:20px; background:#fff; display:flex; flex-direction:column; align-items:center;">
            <h3 style="margin:0 0 15px 0; font-size:18px; color:#333;">è®¾ç½®æ”¯ä»˜å¯†ç </h3>
            <input type="password" id="newWalletPwd" maxlength="6" style="width:100%; background:#f5f6fa; border:none; border-radius:15px; padding:15px; box-sizing:border-box; font-size:18px; text-align:center; letter-spacing:10px; outline:none; color:#333;" placeholder="è¾“å…¥6ä½æ–°å¯†ç ">
            <div style="display:flex; width:100%; gap:15px; margin-top:20px;">
                <button id="btnCancelWalletPwd" style="flex:1; padding:12px; border-radius:25px; border:none; background:#f0f2f5; color:#333; font-size:15px; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
                <button id="btnSaveWalletPwd" style="flex:1; padding:12px; border-radius:25px; border:none; background:#6c5ce7; color:#fff; font-size:15px; font-weight:bold; cursor:pointer;">ä¿å­˜</button>
            </div>
        </div>
    </div>





    

            

        <div id=customTextModal class=modal-base>
        <div class=modal-ctx style=width:80%;max-width:300px;padding:25px;border-radius:20px;background:#fff;display:flex;flex-direction:column;align-items:center;>
            <div id=customTextContent style=width:100%;font-size:15px;color:#333;line-height:1.6;word-wrap:break-word;white-space:pre-wrap;margin-bottom:20px;max-height:60vh;overflow-y:auto;></div>
            <button id=btnCustomTextClose style=width:100%;padding:12px;border-radius:25px;border:none;background:#6c5ce7;color:#fff;font-size:15px;font-weight:bold;cursor:pointer;>ç¡®å®š</button>
        </div>
    </div>

    <div id=customConfirmModal class=modal-base>
        <div class=modal-ctx style=width:80%;max-width:300px;padding:25px;border-radius:20px;background:#fff;display:flex;flex-direction:column;align-items:center;>
            <div id=customConfirmText style=width:100%;font-size:15px;color:#333;line-height:1.6;text-align:center;margin-bottom:20px;white-space:pre-wrap;></div>
            <div style=display:flex;width:100%;gap:15px;>
                <button id=btnCustomConfirmCancel style=flex:1;padding:12px;border-radius:25px;border:none;background:#f0f2f5;color:#333;font-size:15px;font-weight:bold;cursor:pointer;>å–æ¶ˆ</button>
                <button id=btnCustomConfirmOk style=flex:1;padding:12px;border-radius:25px;border:none;background:#ff4757;color:#fff;font-size:15px;font-weight:bold;cursor:pointer;>ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id=customPromptModal class=modal-base>
        <div class=modal-ctx style=width:80%;max-width:300px;padding:25px;border-radius:20px;background:#fff;display:flex;flex-direction:column;align-items:center;>
            <div id=customPromptText style=width:100%;font-size:15px;color:#333;line-height:1.6;margin-bottom:15px;font-weight:bold;></div>
            <div style=display:flex;flex-direction:column;width:100%;gap:10px;margin-bottom:20px;>
                <button id=btnPromptOpt1 style="width:100%;padding:12px;border-radius:15px;border:1px solid #6c5ce7;background:#eef2ff;color:#6c5ce7;font-size:14px;font-weight:bold;cursor:pointer;text-align:left;">1. å°è¯•é‡æ–°æ·»åŠ  (æœ‰å‡ ç‡è¢«æ‹’ç»)</button>
                <button id=btnPromptOpt2 style="width:100%;padding:12px;border-radius:15px;border:1px solid #ff7675;background:#fff0f0;color:#ff7675;font-size:14px;font-weight:bold;cursor:pointer;text-align:left;">2. å¼ºåˆ¶ç³»ç»Ÿè§¦å‘ (æœ‰å‡ ç‡å¤±è´¥)</button>
            </div>
            <button id=btnCustomPromptCancel style=width:100%;padding:12px;border-radius:25px;border:none;background:#f0f2f5;color:#333;font-size:15px;font-weight:bold;cursor:pointer;>å–æ¶ˆ</button>
        </div>
    </div>



<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script>


const $ = id =>document.getElementById(id);
window.showCustomText = function(text) {
    if($(`customTextContent`)) $(`customTextContent`).innerText = text;
    if($(`customTextModal`)) $(`customTextModal`).style.display = `flex`;
};
if($(`btnCustomTextClose`)) $(`btnCustomTextClose`).onclick = () => $(`customTextModal`).style.display = `none`;

let lock=$("scrLock"), home=$("scrHome"), list=$("scrList"), room=$("scrRoom"), setApi=$("scrSetApi"), setChat=$("scrSetChat"), scrWb=$("scrWb"), scrWbEdit=$("scrWbEdit"), scrMe=$("scrMe"), scrCharSticker=$("scrCharSticker"), scrSpace=$("scrSpace"), scrLogList=$("scrLogList"), scrLogEdit=$("scrLogEdit");
let iptMsg=$("iptMsg"), msgs=$("msgs"), modal=$("modal");
let stW=$("stW"), stC=$("stC"), stA=$("stA"), stT=$("stT");
let ls = localStorage;
let currentChatId ="default";
let originalSetItem = ls.setItem;
let isolatedKeys = ["chatHistory","aiStatus","bgI","aiI","cMP","cN","cR","cAP","cCtx","cT","cAMem","cMemT","cMemP","linkedWb","lastMemCount","memories", "cStatusTxt", "cStatusColor", "cSign", "cBubbleCss"];

ls.setItem = function(key, value) {
    // å…¨å±€æ‹¦æˆªï¼šåªè¦æ˜¯å­˜è¡¨æƒ…åŒ…å’Œæ—¥å¿—ï¼Œç»Ÿç»Ÿå¼ºåˆ¶æ‰”è¿›å¤§ä»“åº“ï¼Œä¿æŠ¤è€å†…å­˜ï¼

    if (key === "myPhoneStickers" || key === "charStickers" || key === "myLogs") {
        localforage.setItem(key, value);
        return;
    }
    if (isolatedKeys.includes(key)) {
        originalSetItem.call(this, key + "_" + currentChatId, value);
    } else {
        originalSetItem.call(this, key, value);
    }
};

let originalGetItem = ls.getItem;
ls.getItem = function(key) {
    if (isolatedKeys.includes(key)) {
        let spec = originalGetItem.call(this, key + "_" + currentChatId);
        if (spec) return spec;
        if (currentChatId === "default") return originalGetItem.call(this, key);
        return null;
    }
    return originalGetItem.call(this, key);
};
let originalRemoveItem = ls.removeItem;
ls.removeItem = function(key) {
    if (isolatedKeys.includes(key)) {
        originalRemoveItem.call(this, key + "_" + currentChatId);
    } else {
        originalRemoveItem.call(this, key);
    }
};
let history = ls.getItem("chatHistory") ? JSON.parse(ls.getItem("chatHistory")) : [];
let aiStatus = ls.getItem("aiStatus") ? JSON.parse(ls.getItem("aiStatus")) : {weather:"ç­‰å¾…è¿æ¥...",clothing:"ç­‰å¾…è¿æ¥...",action:"ç­‰å¾…è¿æ¥...",thought:"ç­‰å¾…è¿æ¥..."};
let wbData = ls.getItem(`wbData`) ? JSON.parse(ls.getItem(`wbData`)) : [];
let linkedWb = ls.getItem(`linkedWb`) ? JSON.parse(ls.getItem(`linkedWb`)) : [];
let pressTimer = null;

let selEl = null;
let currentQuote ="";
function showScreen(showId) {
    [lock, home, list, room, setApi, setChat, scrWb, scrWbEdit, scrMe, scrCharSticker, scrSpace, scrLogList, scrLogEdit, $("scrFav"), $("scrWallet"), $("scrContact"), $("scrSetFont"), $("scrCharPhone")].forEach(s => { if(s) s.style.display = "none"; });
    let target = $(showId);
    if(target) {
        if(showId === "scrRoom" || showId === "scrList" || showId === "scrSetApi" || showId === "scrSetChat" || showId === "scrWb" || showId === "scrWbEdit" || showId === "scrMe" || showId === "scrCharSticker" || showId === "scrSpace" || showId === "scrLogList" || showId === "scrLogEdit" || showId === "scrFav" || showId === "scrWallet" || showId === "scrContact" || showId === "scrSetFont") {
            target.style.display = "flex";
        } else if (showId === "scrCharPhone") {
            target.style.display = "flex";
        } else { target.style.display = "block"; }
    }
}


function applyCustomFont() {
    let url = ls.getItem('customFontUrl') || '';
    let size = ls.getItem('customFontSize') || '14';
    let cColor = ls.getItem('customFontColorChar') || '';
    let uColor = ls.getItem('customFontColorUser') || '';

    let styleTag = $('customFontStyleTag');
    if(!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'customFontStyleTag';
        document.head.appendChild(styleTag);
    }
    let css = '';
    if(url) {
        css += `@font-face { font-family: 'MyCustomFont'; src: url('${url}'); } \n`;
        css += `body, .bubble, .input-field, textarea, .chat-preview, .role-name, .me-name, .app-name, .wb-title, .wb-prev, .log-card-content, .quote-txt, .me-menu-title { font-family: 'MyCustomFont', sans-serif !important; } \n`;
    } else {
        css += `body, .bubble, .input-field, textarea, .chat-preview, .role-name, .me-name, .app-name, .wb-title, .wb-prev, .log-card-content, .quote-txt, .me-menu-title { font-family: sans-serif; } \n`;
    }
    if(size) css += `.bubble { font-size: ${size}px !important; } \n`;
    if(cColor) css += `.bub-left { color: ${cColor} !important; } \n`;
    if(uColor) css += `.bub-right { color: ${uColor} !important; } \n`;
    styleTag.innerHTML = css;
}
applyCustomFont();








function updTime() {
    let d = new Date(), loc = d.getTime(), off = d.getTimezoneOffset() * 60000;
    let bj = new Date(loc + off + (3600000 * 8));
    $(`time`).innerText = bj.getHours().toString().padStart(2, `0`) + `:` + bj.getMinutes().toString().padStart(2, `0`);
    let days = [`æ—¥`,`ä¸€`,`äºŒ`,`ä¸‰`,`å››`,`äº”`,`å…­`];
    $(`date`).innerText = (bj.getMonth()+1) + `æœˆ` + bj.getDate() + `æ—¥ æ˜ŸæœŸ` + days[bj.getDay()];
    return bj;
}
setInterval(updTime, 1000);

function initCustomTimeUI() {
    let ySel = $(`ctYear`), mSel = $(`ctMonth`), dSel = $(`ctDay`), hSel = $(`ctHour`), minSel = $(`ctMinute`);
    if(!ySel) return;
    let curYear = new Date().getFullYear();
    for(let i = curYear - 50; i <= curYear + 50; i++) ySel.add(new Option(i, i));
    for(let i = 1; i <= 12; i++) mSel.add(new Option(i, i));
    for(let i = 1; i <= 31; i++) dSel.add(new Option(i, i));
    for(let i = 0; i <= 23; i++) hSel.add(new Option(i, i));
    for(let i = 0; i <= 59; i++) minSel.add(new Option(i, i));
    
    ySel.value = curYear; mSel.value = new Date().getMonth() + 1; dSel.value = new Date().getDate();
    hSel.value = new Date().getHours(); minSel.value = new Date().getMinutes();
    
    window.updateWeekday = function() {
        let y = parseInt(ySel.value), m = parseInt(mSel.value) - 1, d = parseInt(dSel.value);
        let dateObj = new Date(y, m, d);
        let days = [`æ˜ŸæœŸæ—¥`,`æ˜ŸæœŸä¸€`,`æ˜ŸæœŸäºŒ`,`æ˜ŸæœŸä¸‰`,`æ˜ŸæœŸå››`,`æ˜ŸæœŸäº”`,`æ˜ŸæœŸå…­`];
        $(`ctWeekday`).innerText = days[dateObj.getDay()];
    };
    ySel.onchange = updateWeekday; mSel.onchange = updateWeekday; dSel.onchange = updateWeekday;
    
    $(`cfgCustomTime`).onchange = e => {
        $(`customTimePanel`).style.display = e.target.checked ? `flex` : `none`;
        if(e.target.checked) $(`cfgTime`).checked = false; 
    };
    $(`cfgTime`).onchange = e => {
        if(e.target.checked) {
            $(`cfgCustomTime`).checked = false;
            $(`customTimePanel`).style.display = `none`;
        }
    };

    if(ls.getItem(`cCTon`) === `true`) {
        $(`cfgCustomTime`).checked = true;
        $(`customTimePanel`).style.display = `flex`;
        $(`cfgTime`).checked = false;
    }
    if(ls.getItem(`cCTy`)) ySel.value = ls.getItem(`cCTy`);
    if(ls.getItem(`cCTm`)) mSel.value = ls.getItem(`cCTm`);
    if(ls.getItem(`cCTd`)) dSel.value = ls.getItem(`cCTd`);
    if(ls.getItem(`cCTh`)) hSel.value = ls.getItem(`cCTh`);
    if(ls.getItem(`cCTmin`)) minSel.value = ls.getItem(`cCTmin`);
    updateWeekday();
}
setTimeout(initCustomTimeUI, 100);


if(ls.getItem(`pxy`)) $(`apiPxy`).value = ls.getItem(`pxy`);
if(ls.getItem(`key`)) $(`apiK`).value = ls.getItem(`key`);
if(ls.getItem(`mod`)) $(`apiMod`).value = ls.getItem(`mod`);
if(ls.getItem(`temp`)) { $(`apiTemp`).value = ls.getItem(`temp`); $(`tempVal`).innerText = ls.getItem(`temp`); }
$(`apiTemp`).oninput = function() { $(`tempVal`).innerText = this.value; };

if(ls.getItem(`cN`)) $(`cfgName`).value = ls.getItem(`cN`);
if(ls.getItem(`cR`)) $(`cfgRem`).value = ls.getItem(`cR`);
if(ls.getItem(`cMyN`)) $(`cfgMyName`).value = ls.getItem(`cMyN`);
if(ls.getItem(`cAP`)) $(`cfgAiP`).value = ls.getItem(`cAP`);
if(ls.getItem(`cMP`)) $(`cfgMyP`).value = ls.getItem(`cMP`);
if(ls.getItem(`cCtx`)) $(`cfgCtx`).value = ls.getItem(`cCtx`);
if(ls.getItem(`cT`) === `false`) $(`cfgTime`).checked = false;
if(ls.getItem(`cAMem`)) $(`cfgAutoMem`).checked = ls.getItem(`cAMem`) === `true`;
if(ls.getItem(`cMemT`)) $(`cfgMemTrig`).value = ls.getItem(`cMemT`);
if(ls.getItem(`cMemP`)) $(`cfgMemPmt`).value = ls.getItem(`cMemP`);

function getPreviewText(histArray) {
    if(!histArray || histArray.length === 0) return `ä½ ä»¬å·²æˆä¸ºå¥½å‹ï¼Œè¯·å¼€å§‹èŠå¤©å§ï¼`;
    let last = histArray[histArray.length - 1];
    let txt = last.content;
    if(last.role === `assistant`) {
        let rM = txt.match(/ã€å›å¤ã€‘([\s\S]*)$/);
        if(rM) {
            let out = rM[1].trim();
            let lns = out.split(/\n+/).filter(x => x.trim() !== ``);
            if(lns.length === 1 && out.length > 30) { lns = out.replace(/([ã€‚ï¼ï¼Ÿ!?])/g, `$1\n`).split(/\n+/).filter(x => x.trim() !== ``); }
            if(lns.length > 0) txt = lns[lns.length - 1]; else txt = out;
        } else {
            let lns = txt.split(/\n+/).filter(x => x.trim() !== ``);
            if(lns.length > 0) txt = lns[lns.length - 1];
        }
    }
    txt = txt.replace(/ã€Œå¼•ç”¨ï¼š.*?ã€\n/g, ``).replace(/ã€.*?ã€‘/g, ``).replace(/\[å›¾ç‰‡æ¶ˆæ¯ï¼š.*?\][\s\S]*/g, `[è¡¨æƒ…åŒ…]`).trim();
    return txt.length > 15 ? txt.substring(0, 15) + `...` : txt;
}
function updateListPreview() {
    let p = $(`chatPreview`);
    let rawHist = originalGetItem.call(ls, `chatHistory_default`) || originalGetItem.call(ls, `chatHistory`);
    let defHist = rawHist ? JSON.parse(rawHist) : [];
    if(currentChatId === `default`) defHist = history;
    if(p) p.innerText = getPreviewText(defHist);
    setTimeout(() => { try { if(typeof renderContacts === `function`) renderContacts(); } catch(e){} }, 50);
}
function applyVis() {
    let dn = $(`cfgRem`).value || $(`cfgName`).value || `ä¸“å±æ‹äºº`;
    if($(`roomTitle`)) $(`roomTitle`).innerText = dn;
    
    let curStatusTxt = originalGetItem.call(ls, `cStatusTxt_` + currentChatId) || `åœ¨çº¿`;
    let curStatusCol = originalGetItem.call(ls, `cStatusColor_` + currentChatId) || `status-online`;
    let curSign = originalGetItem.call(ls, `cSign_` + currentChatId) || `ï¼ˆæš‚æ— ä¸ªæ€§ç­¾åï¼‰`;
    if (currentChatId === `default`) {
         curStatusTxt = originalGetItem.call(ls, `cStatusTxt`) || `åœ¨çº¿`;
         curStatusCol = originalGetItem.call(ls, `cStatusColor`) || `status-online`;
         curSign = originalGetItem.call(ls, `cSign`) || `ï¼ˆæš‚æ— ä¸ªæ€§ç­¾åï¼‰`;
    }
    if($(`roomStatus`)) $(`roomStatus`).innerHTML = `<div class="status-dot ` + curStatusCol + `"></div>` + curStatusTxt;
    if($(`roomSignature`)) $(`roomSignature`).innerText = curSign;

    let defName = originalGetItem.call(ls, `cR_default`) || originalGetItem.call(ls, `cN_default`) || originalGetItem.call(ls, `cR`) || originalGetItem.call(ls, `cN`) || `ä¸“å±æ‹äºº`;
    if (currentChatId === `default`) defName = dn;

    $(`listName`).innerText = defName;
    if($(`contactName`)) $(`contactName`).innerText = defName;
    
    let bg = ls.getItem(`bgI`);
    if(bg) { 
        room.style.backgroundImage = `url(${bg})`; 
        if($(`bgPreview`)) { $(`bgPreview`).style.backgroundImage = `url(${bg})`;
$(`bgPreview`).innerText = ``; }
    } else { 
        room.style.backgroundImage = `none`;
if($(`bgPreview`)) { $(`bgPreview`).style.backgroundImage = `none`; $(`bgPreview`).innerText = `ğŸ–¼ï¸ ç‚¹å‡»é€‰æ‹©èƒŒæ™¯`; }
    }
    
    let defAiA = originalGetItem.call(ls, `aiI_default`) ||
originalGetItem.call(ls, `aiI`);
    if (currentChatId === `default`) defAiA = ls.getItem(`aiI`);
    if(defAiA) { 
        $(`listAva`).style.backgroundImage = `url(${defAiA})`; $(`listAva`).innerText = ``;
        if($(`contactAva`)) { $(`contactAva`).style.backgroundImage = `url(${defAiA})`; $(`contactAva`).innerText = ``; }
    }
    else { 
        $(`listAva`).style.backgroundImage = `none`; $(`listAva`).innerText = `ğŸ‘¤`;
        if($(`contactAva`)) { $(`contactAva`).style.backgroundImage = `none`; $(`contactAva`).innerText = `ğŸ‘¤`; }
    }
    
            let curAiA = ls.getItem(`aiI`);
        if(curAiA) {
            if($(`aiPreview`)) { $(`aiPreview`).style.backgroundImage = `url(${curAiA})`; $(`aiPreview`).innerText = ``;
            }
                        if($(`spyCharAvatar`)) { $(`spyCharAvatar`).style.backgroundImage = `url(${curAiA})`; $(`spyCharAvatar`).innerText = ``; }
        } else {
            if($(`aiPreview`)) { $(`aiPreview`).style.backgroundImage = `none`; $(`aiPreview`).innerText = `ğŸ‘¤`; }
        }

        
        let myN = $(`cfgMyName`).value ||

`ä½ çš„åå­—`;
    if($(`meName`)) $(`meName`).innerText = myN;
    let myBio = ls.getItem(`myBio`) || `è¯·æ·»åŠ ä½ çš„ä¸ªæ€§ç­¾åå§ï¼`;
    if($(`meBio`)) $(`meBio`).innerText = myBio;
    
    let myA = ls.getItem(`myI`);
if(myA) { 
        if($(`meAvatar`)) { $(`meAvatar`).style.backgroundImage = `url(${myA})`; $(`meAvatar`).innerHTML = ``;
}
        if($(`spaceAvatar`)) { $(`spaceAvatar`).style.backgroundImage = `url(${myA})`; $(`spaceAvatar`).innerHTML = ``;
}
        if($(`myPreview`)) { $(`myPreview`).style.backgroundImage = `url(${myA})`; $(`myPreview`).innerText = ``;
}
    } else { 
        if($(`meAvatar`)) { $(`meAvatar`).style.backgroundImage = `none`;
$(`meAvatar`).innerHTML = `<div style=width:100%;height:100%;display:flex;justify-content:center;align-items:center;font-size:35px;color:#999;>ğŸ‘¤</div>`; }
        if($(`spaceAvatar`)) { $(`spaceAvatar`).style.backgroundImage = `none`;
$(`spaceAvatar`).innerHTML = `<div style=width:100%;height:100%;display:flex;justify-content:center;align-items:center;font-size:35px;color:#999;>ğŸ‘¤</div>`; }
        if($(`myPreview`)) { $(`myPreview`).style.backgroundImage = `none`; $(`myPreview`).innerText = `ğŸ‘¤`;
}
    }
    
            if($(`spaceName`)) $(`spaceName`).innerText = myN;
                if($(`spaceBio`)) $(`spaceBio`).innerText = myBio;
        linkedWb = ls.getItem(`linkedWb`) ? JSON.parse(ls.getItem(`linkedWb`)) : [];
        
                let isBlk = originalGetItem.call(ls, `isBlocked_` + currentChatId) === 'true';
        if($(`btnBlock`)) $(`btnBlock`).innerText = isBlk ? `è§£é™¤æ‹‰é»‘` : `æ‹‰é»‘å¥½å‹`;
        
        let customCss = ls.getItem(`cBubbleCss`) || ``;
        let styleTag = $(`customBubbleCss`);
        if(!styleTag) {
            styleTag = document.createElement(`style`);
            styleTag.id = `customBubbleCss`;
            document.head.appendChild(styleTag);
        }
        styleTag.innerHTML = customCss;

        
        if($(`iptMsg`)) {
            if (isBlk) {
                $(`iptMsg`).disabled = true;
                $(`iptMsg`).placeholder = "å¯¹æ–¹å·²è¢«æ‹‰é»‘ï¼Œæ— æ³•å‘é€æ¶ˆæ¯";
                if($(`btnSend`)) { $(`btnSend`).style.pointerEvents = "none"; $(`btnSend`).style.opacity = "0.5"; }
                if($(`btnMic`)) { $(`btnMic`).style.pointerEvents = "none"; $(`btnMic`).style.opacity = "0.5"; }
                if($(`btnTakePhoto`)) { $(`btnTakePhoto`).style.pointerEvents = "none"; $(`btnTakePhoto`).style.opacity = "0.5"; }
            } else {
                $(`iptMsg`).disabled = false;
                $(`iptMsg`).placeholder = "è¾“å…¥æ¶ˆæ¯...";
                if($(`btnSend`)) { $(`btnSend`).style.pointerEvents = "auto"; $(`btnSend`).style.opacity = "1"; }
                if($(`btnMic`)) { $(`btnMic`).style.pointerEvents = "auto"; $(`btnMic`).style.opacity = "1"; }
                if($(`btnTakePhoto`)) { $(`btnTakePhoto`).style.pointerEvents = "auto"; $(`btnTakePhoto`).style.opacity = "1"; }
            }
        }
        
        updateListPreview();
    }








applyVis();


function cmp(id, key) {
    $(id).onchange = e => {
        let f = e.target.files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = ev => {
            let img = new Image();
            img.onload = () => {
                                let cvs = document.createElement(`canvas`), ctx = cvs.getContext(`2d`);
                let maxW = (key === 'bgI') ? 800 : 300; 
                let maxH = (key === 'bgI') ? 1400 : 300;
                let w = img.width, h = img.height;
                if(w>h && w>maxW) { h*=maxW/w; w=maxW; } else if(h>maxH) { w*=maxH/h; h=maxH;
                }
                cvs.width = w;
                cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
                try {
                    ls.setItem(key, cvs.toDataURL(`image/webp`, 0.8));

                    applyVis(); alert(`åº”ç”¨æˆåŠŸï¼`);
                } catch(err) {
                    alert(`æœ¬åœ°ç©ºé—´ä¸è¶³å•¦ï¼è¯·å…ˆåˆ é™¤ä¸€äº›ä¸è¦çš„åŠ¨æ€æˆ–è¡¨æƒ…åŒ…å†è¯•è¯•ã€‚`);
                }
            };
            img.src = ev.target.result;
        }; r.readAsDataURL(f);
    };
}



$(`btnBgUp`).onclick = () =>$(`upBg`).click();
$(`btnAiUp`).onclick = () =>$(`upAi`).click();
$(`btnMyUp`).onclick = () =>$(`upMy`).click();
cmp(`upBg`, `bgI`); cmp(`upAi`, `aiI`); cmp(`upMy`, `myI`);

lock.onclick = () =>{ showScreen(`scrHome`); };
$(`btnHomeChat`).onclick = () =>showScreen(`scrList`);
$(`btnListBack`).onclick = () =>showScreen(`scrHome`);
$(`btnHomeApi`).onclick = () =>showScreen(`scrSetApi`);
$(`btnSetApiBack`).onclick = () =>showScreen(`scrHome`);

if($(`btnHomeFont`)) {
    $(`btnHomeFont`).onclick = () => {
        $(`fontUrl`).value = ls.getItem('customFontUrl') || '';
        $(`fontSizeSlider`).value = ls.getItem('customFontSize') || '14';
        $(`fontSizeVal`).innerText = $(`fontSizeSlider`).value;
        $(`fontColorChar`).value = ls.getItem('customFontColorChar') || '#6B6B8E';
        $(`fontColorUser`).value = ls.getItem('customFontColorUser') || '#8E6B7A';
        showScreen(`scrSetFont`);
    };
}
if($(`btnSetFontBack`)) $(`btnSetFontBack`).onclick = () => showScreen(`scrHome`);
if($(`btnCancelFont`)) $(`btnCancelFont`).onclick = () => showScreen(`scrHome`);

let lastSpyCharId = ls.getItem(`lastSpyCharId`) || ``;
function renderSpyPhone() {
    let sel = $("spyCharSelect");
    if(!sel) return;
    sel.innerHTML = `<option value="">åˆ‡æ¢è§’è‰²ğŸ“±</option>`;
    let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
    contacts.forEach(c => {
        let name = originalGetItem.call(ls, `cN_` + c.id) || c.name;
        sel.add(new Option(name, c.id));
    });
}
function updateSpyPhoneUI(charId) {
    if(!charId) {
        if($("spyCharAvatar")) { $("spyCharAvatar").style.backgroundImage = "none"; $("spyCharAvatar").innerHTML = `<div style="filter:grayscale(100%); width:100%; height:100%; display:flex; justify-content:center; align-items:center; font-size:35px; border-radius:50%; background:#f0f2f5;">ğŸ‘¤</div>`; }
        if($("spyCharName")) { $("spyCharName").innerText = "æœªé€‰æ‹©è§’è‰²"; $("spyCharName").style.color = "#999"; }
    } else {
        let charName = "æœªçŸ¥è§’è‰²";
        let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
        let c = contacts.find(x => String(x.id) === String(charId));
        if(c) charName = originalGetItem.call(ls, `cN_` + c.id) || c.name;
        let isoAiA = originalGetItem.call(ls, `aiI_` + charId);
        if($("spyCharAvatar")) {
            if(isoAiA) { $("spyCharAvatar").style.backgroundImage = `url(${isoAiA})`; $("spyCharAvatar").innerText = ""; }
            else { $("spyCharAvatar").style.backgroundImage = "none"; $("spyCharAvatar").innerHTML = `<div style="width:100%; height:100%; display:flex; justify-content:center; align-items:center; font-size:35px;">ğŸ‘¤</div>`; }
        }
        if($("spyCharName")) { $("spyCharName").innerText = charName; $("spyCharName").style.color = "#333"; }
    }
}
if($("btnSpyRefresh")) $("btnSpyRefresh").onclick = function(e) {
    e.stopPropagation();
    let charId = $("spyCharSelect").value;
    if(!charId) { alert("è¯·å…ˆåœ¨å·¦ä¾§ä¸‹æ‹‰é€‰æ‹©ä¸€ä¸ªè§’è‰²å“¦ï¼"); return; }
    
    let charName = "æœªçŸ¥è§’è‰²";
    let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
    let c = contacts.find(x => String(x.id) === String(charId));
    if(c) charName = originalGetItem.call(ls, `cN_` + c.id) || c.name;

    $("customConfirmText").innerText = `ç¡®å®šè¦ä¸ºï¼ˆ${charName}ï¼‰é‡æ–°ç”Ÿæˆæ‰‹æœºé‡Œæ‰€æœ‰å†…å®¹å—ï¼Ÿ`;
    $("customConfirmModal").style.display = "flex";
    
    $("btnCustomConfirmOk").onclick = () => {
        $("customConfirmModal").style.display = "none";
        ls.setItem(`lastSpyCharId`, charId); lastSpyCharId = charId;
        updateSpyPhoneUI(charId); 
        alert("æ•°æ®å·²åˆ·æ–°å¹¶ç”Ÿæˆï¼");
    };
    $("btnCustomConfirmCancel").onclick = () => {
        $("customConfirmModal").style.display = "none";
    };
};

if($("btnHomeSpy")) $("btnHomeSpy").onclick = () => { 
    showScreen("scrCharPhone"); renderSpyPhone();
    if(lastSpyCharId) { $("spyCharSelect").value = lastSpyCharId; updateSpyPhoneUI(lastSpyCharId); } else { updateSpyPhoneUI(""); }
};
if($("btnCharPhoneExit")) $("btnCharPhoneExit").onclick = () => showScreen("scrHome");
if($("btnCatchHelp")) $("btnCatchHelp").onclick = () => showCustomText("ã€è¢«æŠ“åŒ…åŠŸèƒ½è¯´æ˜ã€‘\n\nå¼€å¯æ­¤å¼€å…³åï¼Œå½“ä½ é€€å‡ºå¯¹æ–¹çš„æ‰‹æœºç•Œé¢æ—¶ï¼Œç³»ç»Ÿä¼šç™¾åˆ†ç™¾å¼ºåˆ¶è§¦å‘å¯¹æ–¹å‘æ¥ä¸€æ¡æŠ“åŒ…è´¨é—®æ¶ˆæ¯ã€‚\n\næ»¡è¶³ä½ çš„ç‰¹æ®Šæ¶è¶£å‘³ä½“éªŒï¼");
if($(`fontSizeSlider`)) {


    $(`fontSizeSlider`).oninput = function() { $(`fontSizeVal`).innerText = this.value; };

}
if($(`btnSaveFont`)) {
    $(`btnSaveFont`).onclick = () => {
        ls.setItem('customFontUrl', $(`fontUrl`).value.trim());
        ls.setItem('customFontSize', $(`fontSizeSlider`).value);
        ls.setItem('customFontColorChar', $(`fontColorChar`).value);
        ls.setItem('customFontColorUser', $(`fontColorUser`).value);
        applyCustomFont();
        alert('ğŸ¨ å­—ä½“ä¸æ’ç‰ˆè®¾ç½®å·²ç”Ÿæ•ˆï¼å¿«å»èŠå¤©å®¤çœ‹çœ‹å§ã€‚');
        showScreen('scrHome');
    };
}

$(`btnListToRoom`).onclick = () =>{ showScreen(`scrRoom`); msgs.scrollTop = msgs.scrollHeight; };

$(`btnRoomBack`).onclick = () =>{ showScreen(`scrList`); updateListPreview(); };
$(`btnRoomSet`).onclick = () =>showScreen(`scrSetChat`);
$(`btnSetChatBack`).onclick = () =>showScreen(`scrRoom`);
$(`btnHomeWb`).onclick = () =>{ showScreen(`scrWb`); renderWb(); };
$(`btnCloseModal`).onclick = () =>modal.style.display=`none`;
let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
function renderContacts() {

    let listItems = document.querySelectorAll(`#listContent .chat-item`);
    for(let i=1; i<listItems.length; i++) listItems[i].remove();
    
    let contactItems = document.querySelectorAll(`#contactContent .chat-item`);
    if(contactItems) {
        for(let i=1; i<contactItems.length; i++) contactItems[i].remove();
    }
    
    contacts.forEach(c => {
        let div = document.createElement(`div`);
        div.className = `chat-item`;
        
        let isoHistStr = originalGetItem.call(ls, `chatHistory_` + c.id);
        let isoHist = isoHistStr ? JSON.parse(isoHistStr) : [];
        if(currentChatId === c.id) isoHist = history;
        let prevTxt = getPreviewText(isoHist);
                    let isoAiA = originalGetItem.call(ls, `aiI_` + c.id);
            let avaHtml = isoAiA ? `<div class=avatar-list style=background-image:url(`+isoAiA+`);font-size:0;></div>` : `<div class=avatar-list>ğŸ‘¤</div>`;
            let isoName = originalGetItem.call(ls, `cN_` + c.id) || c.name;
            let isBlk = originalGetItem.call(ls, `isBlocked_` + c.id) === 'true';
            if (isBlk) isoName += `<span style="color:#ff4757;font-size:10px;margin-left:4px;padding:0 2px;">å·²æ‹‰é»‘</span>`;
            
            div.innerHTML = avaHtml + `<div class=chat-info><div class=chat-name>` + isoName + `</div><div class=chat-preview>` + prevTxt + `</div></div>`;
            div.onclick = () => {


            currentChatId = c.id;
           
            $(`cfgName`).value = originalGetItem.call(ls, `cN_` + c.id) || c.name;
            $(`cfgRem`).value = originalGetItem.call(ls, `cR_` + c.id) || ``;
                        $(`cfgAiP`).value = originalGetItem.call(ls, `cAP_` + c.id) || c.prompt;
            $(`cfgMyP`).value = originalGetItem.call(ls, `cMP_` + c.id) || ``;
            if($(`cfgBubbleCss`)) $(`cfgBubbleCss`).value = originalGetItem.call(ls, `cBubbleCss_` + c.id) || ``;

            history = ls.getItem(`chatHistory`) ? JSON.parse(ls.getItem(`chatHistory`)) : [];
            aiStatus = ls.getItem(`aiStatus`) ? JSON.parse(ls.getItem(`aiStatus`)) : {weather:"ç­‰å¾…è¿æ¥...",clothing:"ç­‰å¾…è¿æ¥...",action:"ç­‰å¾…è¿æ¥...",thought:"ç­‰å¾…è¿æ¥..."};
            applyVis(); 
            redrawChat();
            showScreen(`scrRoom`);
            msgs.scrollTop = msgs.scrollHeight;
        };
        $(`listContent`).appendChild(div);
        
                if($(`contactContent`)) {
            let divC = document.createElement(`div`);
            divC.className = `chat-item`;
            
                        let charStatusText = originalGetItem.call(ls, `cStatusTxt_` + c.id) || "åœ¨çº¿";
                        let charStatusColorClass = originalGetItem.call(ls, `cStatusColor_` + c.id) || "status-online";
            let charSign = originalGetItem.call(ls, `cSign_` + c.id) || "ï¼ˆè¯¥è§’è‰²è¿˜åœ¨æ€è€ƒä¸ªæ€§ç­¾å...ï¼‰";
            divC.innerHTML = avaHtml + `<div class=chat-info>

                <div class=role-header-row>
                    <div class=role-name>` + isoName + `</div>
                    <div class=role-status><div class="status-dot ` + charStatusColorClass + `"></div>` + charStatusText + `</div>
                </div>
                <div class=role-signature>` + charSign + `</div>
            </div>`;
            
            divC.onclick = div.onclick;
            $(`contactContent`).appendChild(divC);
        }

    });
}

renderContacts();


$(`btnListToRoom`).onclick = () => { 
    currentChatId = "default";
    $(`cfgName`).value = ls.getItem(`cN`) || `ä¸“å±æ‹äºº`;
    $(`cfgRem`).value = ls.getItem(`cR`) || ``;
        $(`cfgAiP`).value = ls.getItem(`cAP`) || ``;
    $(`cfgMyP`).value = ls.getItem(`cMP`) || ``;
    if($(`cfgBubbleCss`)) $(`cfgBubbleCss`).value = ls.getItem(`cBubbleCss`) || ``;

    history = ls.getItem(`chatHistory`) ? JSON.parse(ls.getItem(`chatHistory`)) : [];
    aiStatus = ls.getItem(`aiStatus`) ? JSON.parse(ls.getItem(`aiStatus`)) : {weather:"ç­‰å¾…è¿æ¥...",clothing:"ç­‰å¾…è¿æ¥...",action:"ç­‰å¾…è¿æ¥...",thought:"ç­‰å¾…è¿æ¥..."};
    applyVis(); 
    redrawChat();
        showScreen(`scrRoom`); 
    msgs.scrollTop = msgs.scrollHeight;
};
if($(`btnAddContact`)) $(`btnAddContact`).onclick = () =>{ $(`addFriendModal`).style.display=`flex`; };
$(`btnCancelAddFriend`).onclick = () =>{ $(`addFriendModal`).style.display=`none`; $(`newFriendName`).value=``; $(`newFriendPrompt`).value=``; };
if($(`btnRoleHelp`)) $(`btnRoleHelp`).onclick = () => { showCustomText(`ã€ä¸ªæ€§ç­¾åè§„åˆ™è¯´æ˜ã€‘\n\n1. æ–°å»ºè”ç³»äººåˆå§‹çŠ¶æ€æ˜¯æ²¡æœ‰ä¸ªæ€§ç­¾åçš„ã€‚\n2. ä½ éœ€è¦åœ¨èŠå¤©å®¤ä¸»åŠ¨å¯¹TAæå‡ºè¦æ±‚ï¼ˆä¾‹å¦‚ï¼šã€Œä½ æ”¹ä¸ªä¸ªæ€§ç­¾åå§ã€ï¼‰ï¼ŒTAæ‰ä¼šç”Ÿæˆç¬¬ä¸€æ¡ä¸“å±ç­¾åã€‚\n3. åœ¨åç»­çš„èŠå¤©è¿‡ç¨‹ä¸­ï¼Œå½“TAçš„æƒ…ç»ªã€æƒ³æ³•æˆ–å‰§æƒ…å‘ç”Ÿæ˜æ˜¾å˜åŒ–æ—¶ï¼ŒTAæ‹¥æœ‰ä¸»åŠ¨æƒï¼Œä¼šè‡ªåŠ¨ä¸ºä½ æ›´æ–°å¤´é¡¶çš„çŠ¶æ€å’Œä¸ªæ€§ç­¾åï¼`); };

$(`btnConfirmAddFriend`).onclick = () =>{
    let n = $(`newFriendName`).value.trim();
    if(!n) { alert(`åå­—ä¸èƒ½ä¸ºç©ºå“¦ï¼`); return; }
    let p = $(`newFriendPrompt`).value.trim();
    let newId = Date.now();
    
    originalSetItem.call(ls, `cStatusTxt_` + newId, `åœ¨çº¿`);
    originalSetItem.call(ls, `cStatusColor_` + newId, `status-online`);
    originalSetItem.call(ls, `cSign_` + newId, `ï¼ˆæš‚æ— ä¸ªæ€§ç­¾åï¼‰`);
    
    contacts.push({ name: n, prompt: p, id: newId });
    ls.setItem(`myContacts`, JSON.stringify(contacts));
    renderContacts();
    
    $(`addFriendModal`).style.display=`none`;
    $(`newFriendName`).value=``;
    $(`newFriendPrompt`).value=``;
    alert(`æ·»åŠ æˆåŠŸï¼å¿«å»èŠå¤©å®¤è·ŸTAæè®®ä¿®æ”¹ä¸ªæ€§ç­¾åå§ã€‚`);
};



$(`btnClearChat`).onclick = () =>{ 
    if(confirm(`ç¡®è®¤æ¸…ç©ºå½“å‰èŠå¤©ï¼Ÿ`)){ 
        msgs.innerHTML=``; 
        history=[]; 
        ls.removeItem(`chatHistory_` + currentChatId); 
        if(currentChatId === `default`) ls.removeItem(`chatHistory`);
        ls.setItem(`lastMemCount`, `0`); 
        updateListPreview(); 
        alert(`å·²æ¸…ç©º`); 
    } 
};

$(`btnBlock`).onclick = async () =>{
    let isBlk = originalGetItem.call(ls, `isBlocked_` + currentChatId) === `true`;
    if(!isBlk) {
        $(`customConfirmText`).innerText = `âš ï¸ ä½ ç¡®å®šè¦å°†å¥½å‹æ‹‰é»‘å—ï¼Ÿ\nä¸€æ—¦æ‹‰é»‘ï¼Œä¸€å°æ—¶å†…å°†æ— æ³•å†æ¬¡æ·»åŠ å¥½å‹ï¼`;
        $(`customConfirmModal`).style.display = `flex`;
        $(`btnCustomConfirmOk`).onclick = () => {
            $(`customConfirmModal`).style.display = `none`;
            originalSetItem.call(ls, `isBlocked_` + currentChatId, `true`);
            originalSetItem.call(ls, `blockTime_` + currentChatId, Date.now());
            applyVis();
            renderContacts();
        };
        $(`btnCustomConfirmCancel`).onclick = () => { $(`customConfirmModal`).style.display = `none`; };
    } else {
        let bTime = parseInt(originalGetItem.call(ls, `blockTime_` + currentChatId)) || 0;
        let pass = Date.now() - bTime;
        if(pass < 60000) { 
            let left = Math.ceil((60000 - pass) / 60000);
            showCustomText(`âš ï¸ è¿˜æ²¡åˆ°ä¸€å°æ—¶ï¼Œæš‚æ—¶æ— æ³•è§£é™¤æ‹‰é»‘ï¼\nå‰©ä½™æ—¶é—´ï¼š` + left + ` åˆ†é’Ÿ`);
        } else {
            $(`customPromptText`).innerText = `è§£é™¤æ‹‰é»‘è¯·é€‰æ‹©æ“ä½œï¼š`;
            $(`customPromptModal`).style.display = `flex`;
            
            let handleChoice = async (choice) => {
                $(`customPromptModal`).style.display = `none`;
                let success = true;
                let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
                if(pxy && key && mod) {
                    $(`btnBlock`).innerText = `ç­‰å¾…å¯¹æ–¹å›åº”...`;
                    $(`btnBlock`).style.pointerEvents = `none`;
                    
                    let myN = $(`cfgMyName`).value || `æˆ‘`;
                    let charN = $(`cfgName`).value || `å¯¹æ–¹`;
                    let charP = $(`cfgAiP`).value || ``;
                    let specHistStr = originalGetItem.call(ls, `chatHistory_` + currentChatId) || `[]`;
                    let specHist = JSON.parse(specHistStr);
                    if(currentChatId === `default`) specHist = history;
                    let recentChat = specHist.slice(-10).map(m => (m.role === `user` ? myN : charN) + `ï¼š` + m.content).join(`\n`);
                    
                    let sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charN}ã€‚ä½ çš„åº•å±‚æ€§æ ¼æ˜¯ï¼š${charP}ã€‚\nè¿™æ˜¯ä½ ä»¬æ‹‰é»‘å‰çš„è¿‘æœŸèŠå¤©è®°å½•ï¼š\n${recentChat}\n\nã€é‡è¦å‰§æƒ…èŠ‚ç‚¹ã€‘ï¼šç©å®¶ï¼ˆ${myN}ï¼‰åœ¨ä¸€ä¸ªå°æ—¶å‰ç”±äºæŸäº›åŸå› æ‹‰é»‘äº†ä½ ï¼Œç°åœ¨ç©å®¶æ­£åœ¨å°è¯•è§£é™¤æ‹‰é»‘å¹¶é‡æ–°åŠ ä½ ä¸ºå¥½å‹ã€‚\nä½ çš„ä»»åŠ¡ï¼šè¯·ä¸¥æ ¼æ ¹æ®ä½ çš„åº•å±‚æ€§æ ¼ï¼Œä»¥åŠæ‹‰é»‘å‰æœ€åçš„èŠå¤©å†…å®¹ï¼ˆåˆ¤æ–­ä½ æ­¤åˆ»æ˜¯å¦è¿˜åœ¨ç”Ÿæ°”ã€æ˜¯å¦æ„¿æ„åŸè°…ï¼‰ï¼Œæ¥å†³å®šæ˜¯å¦åŒæ„é‡æ–°æ·»åŠ å¥½å‹ã€‚\næ³¨æ„ï¼šè¯·ä¸¥æ ¼ä¸”ä»…è¾“å‡ºçº¯æ–‡æœ¬ï¼ŒåŒæ„è¯·è¾“å‡ºã€åŒæ„ã€‘ï¼Œæ‹’ç»è¯·è¾“å‡ºã€æ‹’ç»ã€‘ï¼Œç»å¯¹ä¸è¦è¾“å‡ºä»»ä½•å¤šä½™å­—ç¬¦ï¼`;
                    
                    try {
                        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
                        let res = await fetch(url, {
                            method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
                            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.7})
                        });
                        let dat = await res.json();
                        if(dat.choices && dat.choices.length > 0) {
                            let reply = dat.choices[0].message.content.trim();
                            if(reply.includes(`æ‹’ç»`)) success = false;
                        }
                    } catch(e) { console.error(e); }
                } else {
                    success = Math.random() > 0.5;
                }

                if(success) {
                    showCustomText(`ä½ ä»¬å·²é‡æ–°æ·»åŠ å¥½å‹ï¼Taæœ‰è¯æƒ³å¯¹ä½ è¯´...`);
                    originalSetItem.call(ls, `isBlocked_` + currentChatId, `false`);
                    
                    if(pxy && key && mod) {
                        $(`btnBlock`).innerText = `å¯¹æ–¹æ­£åœ¨è¾“å…¥...`;
                        let myN = $(`cfgMyName`).value || `æˆ‘`;
                        let charN = $(`cfgName`).value || `å¯¹æ–¹`;
                        let charP = $(`cfgAiP`).value || ``;
                        let msgSys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charN}ã€‚ä½ çš„åº•å±‚æ€§æ ¼æ˜¯ï¼š${charP}ã€‚\nã€æ ¸å¿ƒå‰§æƒ…å¼ºåˆ¶è¦æ±‚ã€‘ï¼šç©å®¶ï¼ˆ${myN}ï¼‰åˆšåˆšè§£é™¤äº†å¯¹ä½ çš„æ‹‰é»‘ï¼Œå¹¶ä¸”ä½ åŒæ„äº†é‡æ–°æ·»åŠ å¥½å‹ã€‚ç°åœ¨ï¼Œä½ å¿…é¡»æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œä¸»åŠ¨ç»™ç©å®¶å‘é€æ¢å¤å¥½å‹åçš„ç¬¬ä¸€å¥è¯ï¼\nã€å†…å®¹é™åˆ¶ã€‘ï¼šä½ å¿…é¡»åœ¨è¿™å¥è¯ä¸­æ˜ç¡®æåˆ°è‡ªå·±è¢«æ‹‰é»‘è¿™ä»¶äº‹ï¼Œå¹¶è¡¨è¾¾ä½ æ­¤æ—¶çœŸå®çš„æƒ…ç»ªã€‚è¯·ç›´æ¥è¾“å‡ºå¯¹è¯å†…å®¹ï¼Œç»å¯¹ä¸è¦åŒ…å«ä»»ä½•åŠ¨ä½œæå†™æˆ–æ—ç™½ï¼Œä¹Ÿç»å¯¹ä¸è¦ä½¿ç”¨ä»»ä½•å½¢å¼çš„å¼•å·ç¬¦å·ã€‚`;
                        try {
                            let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
                            let resMsg = await fetch(url, {
                                method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
                                body: JSON.stringify({model: mod, messages: [{role: `user`, content: msgSys}], temperature: 0.8})
                            });
                            let datMsg = await resMsg.json();
                            if(datMsg.choices && datMsg.choices.length > 0) {
                                let replyMsg = datMsg.choices[0].message.content.trim();
                                let histStr = originalGetItem.call(ls, `chatHistory_` + currentChatId) || `[]`;
                                let histArr = JSON.parse(histStr);
                                histArr.push({role: `assistant`, content: replyMsg});
                                originalSetItem.call(ls, `chatHistory_` + currentChatId, JSON.stringify(histArr));
                                if(currentChatId === `default`) {
                                    originalSetItem.call(ls, `chatHistory`, JSON.stringify(histArr));
                                }
                                if(currentChatId === window.currentChatId) {
                                    history = histArr;
                                }
                                if(typeof redrawChat === `function`) redrawChat();
                            }
                        } catch(e) { console.error(e); }
                    }

                    applyVis();
                    renderContacts();
                    $(`btnBlock`).style.pointerEvents = `auto`;
                    $(`btnBlock`).innerText = `æ‹‰é»‘å¥½å‹`;
                } else {
                    showCustomText(`å¯¹æ–¹å·²æ‹’ç»æ·»åŠ ä½ ä¸ºå¥½å‹ï¼Œè¯·ä¸€å°æ—¶åé‡è¯•ï¼`);
                    originalSetItem.call(ls, `blockTime_` + currentChatId, Date.now());
                    $(`btnBlock`).style.pointerEvents = `auto`;
                    $(`btnBlock`).innerText = `è§£é™¤æ‹‰é»‘`;
                }
            };

            $(`btnPromptOpt1`).onclick = () => handleChoice(`1`);
            $(`btnPromptOpt2`).onclick = () => handleChoice(`2`);
            $(`btnCustomPromptCancel`).onclick = () => { $(`customPromptModal`).style.display = `none`; };
        }
    }
};





$(`btnDelFriend`).onclick = () =>{ alert(`å¥½å‹å·²åˆ é™¤ï¼`); showScreen(`scrHome`); };

let currWbTab = `global`;
let editingWbId = null;
function renderWb() {

    $(`wbListContainer`).innerHTML = ``;
    let arr = wbData.filter(x => x.type === currWbTab);
    arr.forEach(x => {
        let card = document.createElement(`div`); card.className = `wb-card`;
        card.innerHTML = `<div class=wb-title>${x.title}</div><div class=wb-prev>${x.content}</div><div class=flex-row style=margin-top:15px;><button class=tool-btn style=flex:1; onclick=editWb(${x.id})>ç¼–è¾‘</button><button class=clear-btn style=flex:none;width:60px; onclick=delWb(${x.id})>åˆ é™¤</button></div>`;
        $(`wbListContainer`).appendChild(card);
    });
}

window.editWb = id =>{
    let strId = id.toString();
    let item = wbData.find(x => x.id === strId);
    if(!item) return;
    editingWbId = strId; $(`wbTitle`).value = item.title; $(`wbType`).value = item.type; $(`wbContent`).value = item.content;
    showScreen(`scrWbEdit`);
};

window.delWb = id =>{
    let strId = id.toString();
    if(confirm(`çœŸçš„è¦çƒ§æ¯è¿™æœ¬ä¸–ç•Œä¹¦å—ï¼Ÿ`)) { wbData = wbData.filter(x => x.id !== strId); ls.setItem(`wbData`, JSON.stringify(wbData)); renderWb(); }
};

$(`btnWbBack`).onclick = () =>showScreen(`scrHome`);
$(`tabGlobal`).onclick = () =>{ currWbTab = `global`; $(`tabGlobal`).className=`wb-active`; $(`tabGlobal`).style.background=`#6c5ce7`; $(`tabGlobal`).style.color=`white`; $(`tabLocal`).style.background=`#f0f2f5`; $(`tabLocal`).style.color=`#888`; renderWb(); };
$(`tabLocal`).onclick = () =>{ currWbTab = `local`; $(`tabLocal`).className=`wb-active`; $(`tabLocal`).style.background=`#6c5ce7`; $(`tabLocal`).style.color=`white`; $(`tabGlobal`).style.background=`#f0f2f5`; $(`tabGlobal`).style.color=`#888`; renderWb(); };
$(`btnWbAdd`).onclick = () =>{ editingWbId = null; $(`wbTitle`).value = ``; $(`wbType`).value = currWbTab; $(`wbContent`).value = ``; showScreen(`scrWbEdit`); };
$(`btnWbEditBack`).onclick = () =>showScreen(`scrWb`);

$(`btnWbSave`).onclick = () =>{
    let t = $(`wbTitle`).value, p = $(`wbType`).value, c = $(`wbContent`).value;
    if(!t || !c) { alert(`æ ‡é¢˜å’Œå†…å®¹éƒ½å¿…é¡»è¦å¡«å“¦ï¼`); return; }
    if(editingWbId) { let item = wbData.find(x => x.id === editingWbId); item.title = t; item.type = p; item.content = c; }
    else { wbData.push({ id: Date.now().toString(), title: t, type: p, content: c }); }
    ls.setItem(`wbData`, JSON.stringify(wbData)); alert(`æˆåŠŸè®°å½•è¿›ä¸–ç•Œä¹¦ï¼`); showScreen(`scrWb`); renderWb();
};

$(`btnOpenLinkWb`).onclick = () =>{
    let list = $(`linkWbList`); list.innerHTML = ``;
    let locals = wbData.filter(x => x.type === `local`);
    if(locals.length === 0) list.innerHTML = `<div class=stat-txt>ä½ è¿˜æ²¡æœ‰ç¼–å†™ä»»ä½•å±€éƒ¨ä¸–ç•Œä¹¦å“¦ã€‚</div>`;
    else {
        locals.forEach(x => {
            let chk = linkedWb.includes(x.id) ? `checked` : ``;
            list.innerHTML += `<div class=flex-row style=margin-bottom:10px;padding:10px;background:#f0f2f5;border-radius:10px;><label style=font-size:14px;color:#333;>${x.title}</label><input type=checkbox value=${x.id} class=wb-check style=width:20px;height:20px; ${chk}></div>`;
        });
    }
    $(`linkWbModal`).style.display = `flex`;
};

$(`btnCloseLinkWb`).onclick = () =>{ $(`linkWbModal`).style.display = `none`; };

$(`btnSaveLinkWb`).onclick = () =>{
    linkedWb = [];
    document.querySelectorAll(`.wb-check`).forEach(c => { if(c.checked) linkedWb.push(c.value); });
    ls.setItem(`linkedWb`, JSON.stringify(linkedWb));
    alert(`ä¸–ç•Œä¹¦å…³è”æˆåŠŸï¼`); $(`linkWbModal`).style.display = `none`;
};

async function runMemorySummary(isAuto = false) {
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) { if(!isAuto) alert(`è¯·å…ˆé…ç½®ç½‘ç»œã€‚`); return; }
    if(history.length < 2) { if(!isAuto) alert(`èŠå¤©è®°å½•å¤ªå°‘ï¼Œè¿˜ä¸å¤Ÿå†™æ€»ç»“å“¦ã€‚`); return; }
    
    let pmt = $(`cfgMemPmt`).value;
    let charName = $(`cfgName`).value || `å¯¹æ–¹`;
    let myName = $(`cfgMyName`).value || `æˆ‘`;
    pmt = pmt.replace(/\[å¯¹æ–¹\]/g, charName).replace(/\[æˆ‘\]/g, myName);
    
    let sys = `ä»»åŠ¡ï¼šæç®€æ€»ç»“èŠå¤©è®°å½•ã€‚\nè§„åˆ™ï¼š${pmt}\n\nè¿‘æœŸå¯¹è¯ï¼š\n`;
    let trig = parseInt($(`cfgMemTrig`).value) || 20;
    let recent = history.slice(-trig);
    recent.forEach(m => {
        let role = m.role === `user` ? myName : charName;
        let c = m.content;
        if(m.role === `assistant`) { let rM = c.match(/ã€å›å¤ã€‘([\s\S]*)$/); if(rM) c = rM[1].trim(); }
        sys += `${role}:${c}\n`;
    });
    
    if(!isAuto) $(`btnGenMem`).innerText = `æ­£åœ¨å›æƒ³...`;
    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, headers: {Authorization:`Bearer ${key}`, [`Content-Type`]:`application/json`},
            body: JSON.stringify({model:mod, messages:[{role:`user`, content:sys}], temperature:0.5})
        });
        let dat = await res.json();
        if(dat.choices && dat.choices.length > 0) {
            let diary = dat.choices[0].message.content;
            let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
            mems.push({ date: updTime().toLocaleString(), content: diary });
            ls.setItem(`memories`, JSON.stringify(mems));
            if(!isAuto) alert(`æ€»ç»“å®Œæˆï¼å·²å­˜å…¥ä¸“å±è®°å¿†åº“ã€‚`);
        }
    } catch(e) { if(!isAuto) alert(`ç”Ÿæˆå¤±è´¥ï¼š${e.message}`); }
    if(!isAuto) $(`btnGenMem`).innerText = `âœ¨ ç«‹å³æ‰‹åŠ¨æ€»ç»“`;
}

let isMemEditMode = false;
let selMems = new Set();
function renderMemList() {
    let list = $(`memList`); list.innerHTML = ``;
    let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
    if(mems.length === 0) {
        list.innerHTML = `<div class=stat-txt>è®°å¿†åº“ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»åˆ›é€ å›å¿†å§ï¼</div>`; 
        if($(`memActions`)) $(`memActions`).style.display = `none`;
        return;
    }
    if($(`memActions`)) $(`memActions`).style.display = isMemEditMode ? `flex` : `none`;
    let grouped = {};
    mems.forEach((m, idx) => {
        let d = m.date.split(` `)[0]; 
        if(!grouped[d]) grouped[d] = [];
        let cleanTxt = m.content.replace(/^[\s\S]*?(ï¼š|:)/, ``).replace(/^[0-9]+[ã€. *]+/, ``).replace(/\*/g, ``).trim();
        grouped[d].push({txt: cleanTxt, originalIndex: idx});
    });
    Object.keys(grouped).reverse().forEach(d => {
        let html = `<div class=stat-card><div class=stat-tag style=background:#6c5ce7;color:white;>${d}</div><div class=stat-txt style=display:flex;flex-direction:column;gap:8px;>`;
        grouped[d].forEach((item, idx) => {
            let border = (isMemEditMode && selMems.has(item.originalIndex)) ? `border-left:3px solid #ff4d4f;padding-left:5px;` : ``;
            let pointer = isMemEditMode ? `cursor:pointer;` : ``;
            html += `<div style="${border}${pointer}" onclick="toggleMemSel(${item.originalIndex})"><span style=color:#6c5ce7;font-weight:bold;margin-right:5px;>` + (idx+1) + `.</span>${item.txt}</div>`;
        });
        html += `</div></div>`;
        list.innerHTML += html;
    });
}
window.toggleMemSel = idx =>{
    if(!isMemEditMode) return;
    if(selMems.has(idx)) selMems.delete(idx); else selMems.add(idx);
    renderMemList();
};
$(`btnViewMem`).onclick = () =>{
    if(!$(`memActions`)) {
        let hdr = $(`memModal`).querySelector(`.modal-hdr`);
        let editBtn = document.createElement(`span`);
        editBtn.id = `btnEditMem`;
        editBtn.innerText = `ç®¡ç†`;
        editBtn.style.cssText = `cursor:pointer;font-size:14px;color:#ffeb3b;margin-right:15px;`;
        hdr.insertBefore(editBtn, $(`btnCloseMem`));
        
        let actions = document.createElement(`div`);
        actions.id = `memActions`;
        actions.style.cssText = `display:none;padding:10px 20px;background:#fff0f0;justify-content:space-between;align-items:center;border-bottom:1px solid #ffeeee;flex-shrink:0;`;
        actions.innerHTML = `<span id=btnSelAllMem style="color:#333;font-size:13px;cursor:pointer;font-weight:bold;">å…¨é€‰</span><span id=btnDelMem style="color:#ff7675;font-size:13px;font-weight:bold;cursor:pointer;">åˆ é™¤é€‰ä¸­</span>`;
        $(`memModal`).querySelector(`.modal-ctx`).insertBefore(actions, $(`memList`));
        
        $(`btnEditMem`).onclick = () => {
            isMemEditMode = !isMemEditMode;
            $(`btnEditMem`).innerText = isMemEditMode ? `å®Œæˆ` : `ç®¡ç†`;
            if(!isMemEditMode) selMems.clear();
            renderMemList();
        };
        $(`btnSelAllMem`).onclick = () => {
            let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
            if(selMems.size === mems.length) selMems.clear();
            else mems.forEach((_, i) => selMems.add(i));
            renderMemList();
        };
        $(`btnDelMem`).onclick = () => {
            if(selMems.size === 0) { alert(`è¯·å…ˆé€‰ä¸­è¦åˆ é™¤çš„è®°å¿†ï¼`); return; }
            if(confirm(`ç¡®å®šåˆ é™¤è¿™ ` + selMems.size + ` æ¡è®°å¿†å—ï¼Ÿ`)) {
                let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
                mems = mems.filter((_, i) => !selMems.has(i));
                ls.setItem(`memories`, JSON.stringify(mems));
                selMems.clear();
                renderMemList();
            }
        };
    }
    isMemEditMode = false;
    if($(`btnEditMem`)) $(`btnEditMem`).innerText = `ç®¡ç†`;
    selMems.clear();
    renderMemList();
    $(`memModal`).style.display = `flex`;
};
$(`btnCloseMem`).onclick = () =>{ $(`memModal`).style.display = `none`; };

$(`btnGenMem`).onclick = () =>{ runMemorySummary(false); };

$(`btnSaveChat`).onclick = () =>{
    ls.setItem(`cN`, $(`cfgName`).value); ls.setItem(`cR`, $(`cfgRem`).value);
    ls.setItem(`cMyN`, $(`cfgMyName`).value);
        ls.setItem(`cAP`, $(`cfgAiP`).value); ls.setItem(`cMP`, $(`cfgMyP`).value);
    if($(`cfgBubbleCss`)) ls.setItem(`cBubbleCss`, $(`cfgBubbleCss`).value);
    ls.setItem(`cCtx`, $(`cfgCtx`).value);

    ls.setItem(`cT`, $(`cfgTime`).checked);
    ls.setItem(`cCTon`, $(`cfgCustomTime`).checked);
    ls.setItem(`cCTy`, $(`ctYear`).value);
    ls.setItem(`cCTm`, $(`ctMonth`).value);
    ls.setItem(`cCTd`, $(`ctDay`).value);
    ls.setItem(`cCTh`, $(`ctHour`).value);
    ls.setItem(`cCTmin`, $(`ctMinute`).value);
    ls.setItem(`cAMem`, $(`cfgAutoMem`).checked); ls.setItem(`cMemT`, $(`cfgMemTrig`).value); ls.setItem(`cMemP`, $(`cfgMemPmt`).value);
    applyVis(); alert(`é…ç½®å·²ä¿å­˜ï¼`); showScreen(`scrRoom`);
};


$(`btnSaveApi`).onclick = () =>{
    ls.setItem(`pxy`, $(`apiPxy`).value); ls.setItem(`key`, $(`apiK`).value); 
    ls.setItem(`mod`, $(`apiMod`).value); ls.setItem(`temp`, $(`apiTemp`).value);
    alert(`ç½‘ç»œå·²ä¿å­˜ï¼`); showScreen(`scrHome`);
};

$(`btnPull`).onclick = async () =>{
    let pxy = $(`apiPxy`).value, k = $(`apiK`).value;
    if(!pxy || !k) { alert(`è¯·å…ˆå¡«å†™åœ°å€å’Œå¯†é’¥ï¼`); return; }
    let url = pxy.includes(`chat/completions`) ? pxy.replace(`chat/completions`, ``) : pxy;
    if(!url.endsWith(`/`)) url += `/`;
    try {
        let r = await fetch(url+`models`, {headers:{Authorization:`Bearer ${k}`}});
        let d = await r.json();
        if(d.data && d.data.length>0){
            $(`apiModSel`).innerHTML=``;
            d.data.forEach(m => { let o=document.createElement(`option`); o.value=m.id; o.innerText=m.id; $(`apiModSel`).appendChild(o); });
            $(`apiModSel`).style.display=`block`; $(`apiMod`).style.display=`none`;
            $(`apiModSel`).onchange = function(){ $(`apiMod`).value = this.value; };
            $(`apiMod`).value = d.data[0].id; alert(`æ‹‰å–æˆåŠŸï¼Œè¯·åœ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ã€‚`);
        } else alert(`æ‹‰å–å¤±è´¥ï¼šæœªè·å–åˆ°åˆ—è¡¨ã€‚`);
    } catch(e) { alert(`æ‹‰å–å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ã€‚`); }
};
function redrawChat() {
    msgs.innerHTML = ``;
    let changed = false;
    history.forEach(msg => {
        if(msg.role === `user`) { mkBubSync(msg.content, `r`); } 
                else if(msg.role === `assistant`) {
            let txt = msg.content;
            let rM = txt.match(/ã€å›å¤ã€‘([\s\S]*)$/);
            let out = txt;
            if(rM) out = rM[1].trim();
            
            let lns = out.split(/\n+/).filter(x => x.trim() !== ``);
            if(lns.length === 1 && out.length > 30 && !out.includes(`[å›¾ç‰‡æ¶ˆæ¯`)) { 
                lns = out.replace(/([ã€‚ï¼ï¼Ÿ!?])/g, `$1\n`).split(/\n+/).filter(x => x.trim() !== ``); 
            }
            
                        let newLines = [];
            let skipNext = false;
            lns.forEach((line, i) => {
                if(skipNext) { skipNext = false; return; }
                let voiceMatch = line.match(/\[?ã€?è¯­éŸ³æ¶ˆæ¯[^0-9]*(\d+)[^\]ã€‘]*\]?ã€‘?/);
                if(voiceMatch) {
                    let sec = voiceMatch[1];
                    let pureText = line.replace(voiceMatch[0], ``).replace(/['""â€œâ€â€˜â€™]/g, ``).replace(/\s+/g, `ï¼Œ`).replace(/ï¼Œ+/g, `ï¼Œ`).replace(/([ã€‚ï¼ï¼Ÿ!?â€¦])ï¼Œ/g, `$1`).replace(/^ï¼Œ|ï¼Œ$/g, ``);
                    if(!pureText && i + 1 < lns.length) {
                        pureText = lns[i+1].replace(/['""â€œâ€â€˜â€™]/g, ``).replace(/\s+/g, `ï¼Œ`).replace(/ï¼Œ+/g, `ï¼Œ`).replace(/([ã€‚ï¼ï¼Ÿ!?â€¦])ï¼Œ/g, `$1`).replace(/^ï¼Œ|ï¼Œ$/g, ``);
                        skipNext = true;
                    }
                    if(pureText && !/[ã€‚ï¼ï¼Ÿ!?â€¦]$/.test(pureText)) pureText += `ã€‚`;
                    let cleanVoice = `[è¯­éŸ³æ¶ˆæ¯ï¼š${sec}ç§’]` + pureText;
                    newLines.push(cleanVoice);
                    mkBubSync(cleanVoice, `l`);
                } else {
                    newLines.push(line);
                    mkBubSync(line, `l`);
                }
            });

            
            let newOut = newLines.join(`\n`);
            if(out !== newOut && rM) {
                msg.content = txt.replace(rM[1], `\n` + newOut);
                changed = true;
            }
        }

    });
    if(changed) ls.setItem(`chatHistory`, JSON.stringify(history));
}


function showCtxMenu(x, y, el) {
    selEl = el;
    let m = $(`ctxMenu`);
    m.style.display = `grid`;
    let phoneRect = $(`phone`).getBoundingClientRect();
    let relX = x - phoneRect.left;
    let relY = y - phoneRect.top;
    let left = relX + 10;
    if (left + 260 > 320) left = 320 - 260 - 10;
    if (left < 10) left = 10;
    let top = relY + 10;
    if (top + 100 > 650) top = 650 - 110; 
    m.style.left = left + `px`;
    m.style.top = top + `px`;
}

document.onclick = e => { 
    if(!e.target.closest(`.bubble`) && !e.target.closest(`.ctx-menu`)) $(`ctxMenu`).style.display = `none`; 
};

function getCleanText(el) { 
    if (!el) return ``;
    if (el.dataset && el.dataset.raw) return el.dataset.raw;
    let span = el.querySelector(`span`);
    if (span && el.querySelector(`div`)) return span.innerText.trim();
    return el.innerText ? el.innerText.trim() : `[å›¾ç‰‡]`; 
}



let editingOldText = ``;
$(`ctxCopy`).onclick = () =>{ if(selEl) navigator.clipboard.writeText(getCleanText(selEl)).then(()=>{ alert(`å¤åˆ¶æˆåŠŸ`); $(`ctxMenu`).style.display = `none`; }); };
$(`ctxDel`).onclick = () => { 
    if(selEl) { 
        if(confirm(`ç¡®å®šè¦åˆ é™¤è¿™1æ¡ä¿¡æ¯å—ï¼Ÿ`)) {
                                let imgEl = selEl.querySelector(`img`);
                    let searchTarget = ``;
                    if (imgEl) searchTarget = imgEl.getAttribute(`src`);
                    else searchTarget = getCleanText(selEl);
                    for(let i=history.length-1; i>=0; i--) {
                        if(history[i].content.includes(searchTarget)) {
                            let newContent = history[i].content;
                            if(imgEl) newContent = newContent.replace(new RegExp(`\\[å›¾ç‰‡æ¶ˆæ¯ï¼š` + searchTarget.replace(/[-\/\\^$*+?.()|[\]{}]/g, `\\$&`) + `\\](?:\\n\\(ç³»ç»Ÿæç¤ºï¼š.*?\\))?`), ``);
                            else newContent = newContent.replace(searchTarget, ``);
                            newContent = newContent.trim().replace(/^\n+|\n+$/g, ``).replace(/\n{2,}/g, `\n`);
                            let afterReply = newContent.split(`ã€å›å¤ã€‘`)[1];

                    if (newContent === `` || (newContent.includes(`ã€å›å¤ã€‘`) && (!afterReply || afterReply.trim() === ``))) {
                        history.splice(i, 1);
                        let lmc = parseInt(ls.getItem(`lastMemCount`)) || 0;
                        if(lmc > history.length) ls.setItem(`lastMemCount`, history.length.toString());
                    } else {
                        history[i].content = newContent;
                    }
                    ls.setItem(`chatHistory`, JSON.stringify(history));
                    break;
                }
            }
            redrawChat();
            if(typeof updateListPreview === `function`) updateListPreview();
        }
        $(`ctxMenu`).style.display = `none`; 
    } 
};






$(`ctxEdit`).onclick = () => { 
    if(selEl) { 
        editingOldText = getCleanText(selEl); 
        if(editingOldText === `[å›¾ç‰‡]`) { alert(`å›¾ç‰‡ä¸èƒ½ä¿®æ”¹å“¦`); $(`ctxMenu`).style.display = `none`; return; }
        $(`editMsgInput`).value = editingOldText; 
        $(`editMsgModal`).style.display = `flex`; 
        $(`ctxMenu`).style.display = `none`; 
    } 
};
$(`btnCancelEdit`).onclick = () =>{ $(`editMsgModal`).style.display = `none`; };
$(`btnConfirmEdit`).onclick = () =>{
    let newTxt = $(`editMsgInput`).value;
    if(!newTxt) return;
    for(let i=history.length-1; i>=0; i--) {
        if(history[i].content.includes(editingOldText)) {
            history[i].content = history[i].content.replace(editingOldText, newTxt);
            ls.setItem(`chatHistory`, JSON.stringify(history));
            break;
        }
    }
    redrawChat();
    $(`editMsgModal`).style.display = `none`;
};

$(`ctxQuote`).onclick = () =>{
    if(selEl) {
        currentQuote = getCleanText(selEl);
        $(`quoteText`).innerText = `å¼•ç”¨ï¼š` + currentQuote;
        $(`quoteBox`).style.display = `block`;
        $(`ctxMenu`).style.display = `none`;
    }
};
$(`btnCloseQuote`).onclick = () =>{ currentQuote = ``; $(`quoteBox`).style.display = `none`; };
$(`ctxFav`).onclick = () => { 
    if(selEl) {
        let bubble = selEl.querySelector(`.bubble`) || selEl;
        let imgEl = bubble.querySelector(`img`);
        let contentToSave = imgEl ? imgEl.getAttribute(`src`) : getCleanText(bubble);
        saveMsgToFav(contentToSave);
        alert(`æ”¶è—æˆåŠŸï¼å¿«å»æˆ‘çš„é¡µé¢æŸ¥çœ‹å§ã€‚`);
    }
    $(`ctxMenu`).style.display = `none`; 
};

$(`ctxMulti`).onclick = () => { 
    if(selEl) {
        let row = selEl.closest(`.msg-row`);
        let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
        let idx = allItems.indexOf(row);
        if(idx > -1) enterMultiSelectMode(idx);
    }
    $(`ctxMenu`).style.display = `none`; 
};


function bindPress(el) {
    el.oncontextmenu = e => { e.preventDefault(); showCtxMenu(e.clientX, e.clientY, el); };
    el.ontouchstart = e => { pressTimer = setTimeout(() => { let t = e.touches[0]; showCtxMenu(t.clientX, t.clientY, el); }, 500); };
    el.ontouchend = () => clearTimeout(pressTimer);
    el.ontouchmove = () => clearTimeout(pressTimer);
}

$(`btnRegen`).onclick = () =>{
    if(history.length === 0) return;
    let last = history[history.length - 1];
    if(last.role === `assistant`) {
        history.pop();
        ls.setItem(`chatHistory`, JSON.stringify(history));
        redrawChat();
        $(`btnLemon`).click();
    } else { alert(`ä¸Šä¸€æ¡å¿…é¡»æ˜¯å¯¹æ–¹çš„å›å¤æ‰èƒ½é‡æ–°ç”Ÿæˆå“¦`); }
};

$(`btnPic`).onclick = () =>alert(`å‘å›¾åŠŸèƒ½å¼€å‘ä¸­`);
$("btnMic").onclick = () =>{
    if(!$("voiceModal")) return;
    $("voiceInputText").value = "";
    $("voiceModal").style.display = "flex";
};
if($("btnCancelVoice")) {
    $("btnCancelVoice").onclick = () => $("voiceModal").style.display = "none";
}
if($("btnSendVoice")) {
    $("btnSendVoice").onclick = () => {
        let txt = $("voiceInputText").value.trim();
        if(!txt) { alert("è¯·è¾“å…¥è¯­éŸ³å†…å®¹å“¦ï¼"); return; }
        let sec = Math.max(1, Math.min(60, Math.ceil(txt.length / 3)));
        let msgText = "[è¯­éŸ³æ¶ˆæ¯ï¼š" + sec + "ç§’]" + txt;
        mkBub(msgText, "r");
        history.push({role: "user", content: msgText});
        ls.setItem("chatHistory", JSON.stringify(history));
        if(typeof updateListPreview === "function") updateListPreview();
        $("voiceModal").style.display = "none";
    };
}
if($("btnTakePhoto")) {
    $("btnTakePhoto").onclick = () => {
        toggleMenuDrawer(false);
        $("takePhotoInput").value = "";
        $("takePhotoModal").style.display = "flex";
    };
}
if($("btnCancelTakePhoto")) {
    $("btnCancelTakePhoto").onclick = () => $("takePhotoModal").style.display = "none";
}
if($("btnSendTakePhoto")) {
    $("btnSendTakePhoto").onclick = () => {
        let txt = $("takePhotoInput").value.trim();
        if(!txt) { alert("è¯·å…ˆæè¿°ä¸€ä¸‹ä½ æ‹çš„å†…å®¹å“¦ï¼"); return; }
        let msgText = "[ç…§ç‰‡æ¶ˆæ¯ï¼š" + txt + "]";
        mkBub(msgText, "r");
        history.push({role: "user", content: msgText});
        ls.setItem("chatHistory", JSON.stringify(history));
        if(typeof updateListPreview === "function") updateListPreview();
        $("takePhotoModal").style.display = "none";
    };
}
if($(`btnTransfer`)) {
    $(`btnTransfer`).onclick = () => {
        toggleMenuDrawer(false);
        $(`transferAmount`).value = ``;
        $(`transferNote`).value = ``;
        $(`transferModal`).style.display = `flex`;
    };
}
if($(`btnCancelTransfer`)) {
    $(`btnCancelTransfer`).onclick = () => $(`transferModal`).style.display = `none`;
}
var tempRpCoverUrl = ``;
var currentPayTask = null;


if($(`btnRedPacket`)) {
    $(`btnRedPacket`).onclick = () => {
        toggleMenuDrawer(false);
        $(`redPacketAmount`).value = ``;
        $(`redPacketNote`).value = ``;
        $(`rpCoverPreview`).style.display = `none`;
        tempRpCoverUrl = ``;
        $(`redPacketModal`).style.display = `flex`;
    };
}
if($(`btnCancelRedPacket`)) $(`btnCancelRedPacket`).onclick = () =>$(`redPacketModal`).style.display = `none`;
if($(`btnSelectRpCover`)) $(`btnSelectRpCover`).onclick = () =>$(`rpCoverInput`).click();
if($(`rpCoverInput`)) {
    $(`rpCoverInput`).onchange = e => {
        let f = e.target.files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = ev => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement(`canvas`), ctx = cvs.getContext(`2d`);
                let w = img.width, h = img.height, max = 300;
                if(w > h && w > max) { h *= max/w; w = max; } else if(h > max) { w *= max/h; h = max; }
                cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
                tempRpCoverUrl = cvs.toDataURL(`image/webp`, 0.6);
                $(`rpCoverPreview`).src = tempRpCoverUrl;
                $(`rpCoverPreview`).style.display = `block`;
            };
            img.src = ev.target.result;
        };
        r.readAsDataURL(f);
        e.target.value = ``;
    };
}

if($(`btnSendTransfer`)) {
    $(`btnSendTransfer`).onclick = () => {
        let amt = parseFloat($(`transferAmount`).value);
        if(isNaN(amt) || amt <= 0) { alert(`è¯·è¾“å…¥æ­£ç¡®çš„è½¬è´¦é‡‘é¢å“¦ï¼`); return; }
        let optWallet = $(`payMethodSelect`).querySelector(`option[value="wallet"]`);
        if(optWallet) optWallet.innerText = `é›¶é’± (ä½™é¢: Â¥` + myWallet.balance.toFixed(2) + `)`;
        currentPayTask = { type: `transfer`, amt: amt, note: $(`transferNote`).value.trim() || `è½¬è´¦` };
        $(`payModalAmount`).innerText = amt.toFixed(2);
        $(`payPwdInput`).value = ``;
        $(`transferModal`).style.display = `none`;
        $(`payPwdModal`).style.display = `flex`;
    };
}

if($(`btnSendRedPacket`)) {
    $(`btnSendRedPacket`).onclick = () => {
        let amt = parseFloat($(`redPacketAmount`).value);
        if(isNaN(amt) || amt <= 0) { alert(`è¯·è¾“å…¥æ­£ç¡®çš„çº¢åŒ…é‡‘é¢å“¦ï¼`); return; }
        if(amt > 200) { alert(`å•ä¸ªçº¢åŒ…é‡‘é¢ä¸å¯è¶…è¿‡200å…ƒå“¦ï¼`); return; }
        let optWallet = $(`payMethodSelect`).querySelector(`option[value="wallet"]`);
        if(optWallet) optWallet.innerText = `é›¶é’± (ä½™é¢: Â¥` + myWallet.balance.toFixed(2) + `)`;
        currentPayTask = { type: `redpacket`, amt: amt, note: $(`redPacketNote`).value.trim() || `æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©`, cover: tempRpCoverUrl };
        $(`payModalAmount`).innerText = amt.toFixed(2);
        $(`payPwdInput`).value = ``;
        $(`redPacketModal`).style.display = `none`;
        $(`payPwdModal`).style.display = `flex`;
    };
}

if($(`btnCancelPay`)) {
    $(`btnCancelPay`).onclick = () => {
        $(`payPwdModal`).style.display = `none`;
        if(currentPayTask && currentPayTask.type === `redpacket`) $(`redPacketModal`).style.display = `flex`;
        else $(`transferModal`).style.display = `flex`;
    };
}

if($(`btnConfirmPay`)) {
    $(`btnConfirmPay`).onclick = () => {
        let pwd = $(`payPwdInput`).value;
        if(pwd.length !== 6) { alert(`è¯·è¾“å…¥6ä½æ•°çš„æ”¯ä»˜å¯†ç ï¼`); return; }
        let realPwd = myWallet.password || `123456`;
        if(pwd !== realPwd) { alert(`å¯†ç é”™è¯¯ï¼`); return; }
        
        if(!currentPayTask) return;
        
        $(`payPwdModal`).style.display = `none`; 
        
        let amt = currentPayTask.amt;
        let payMethod = $(`payMethodSelect`).value;
        
        if(payMethod === `wallet`) {
            if(myWallet.balance < amt) { 
                alert(`ä½™é¢ä¸è¶³å•¦ï¼è¯·å‰å¾€æˆ‘çš„é’±åŒ…é¡µé¢ç»™é›¶é’±å……å€¼å“¦ã€‚`); 
                currentPayTask = null; 
                return; 
            }
            myWallet.balance -= amt;
        } else {
            if(myWallet.bank < amt) { 
                alert(`å‚¨è“„å¡ä½™é¢ä¸è¶³å•¦ï¼è¯·å‰å¾€æˆ‘çš„é’±åŒ…é¡µé¢å……å€¼å“¦ã€‚`); 
                currentPayTask = null; 
                return; 
            }
            myWallet.bank -= amt;
        }
        
        let dn = $(`cfgRem`).value || $(`cfgName`).value || `ä¸“å±æ‹äºº`;
        let logTitle = currentPayTask.type === `redpacket` ? `å‘çº¢åŒ…ç»™ - ` + dn : `è½¬è´¦ç»™ - ` + dn;
        
        myWallet.bills.push({ title: logTitle, time: updTime().toLocaleString(), amount: -amt, type: `transfer` });
        ls.setItem(`myWallet`, JSON.stringify(myWallet));
        
        let msgText = ``;
        if(currentPayTask.type === `redpacket`) {
            msgText = `[çº¢åŒ…æ¶ˆæ¯ï¼š` + amt.toFixed(2) + `|` + currentPayTask.note + `|æœªé¢†å–|` + currentPayTask.cover + `]`;
        } else {
            msgText = `[è½¬è´¦æ¶ˆæ¯ï¼š` + amt.toFixed(2) + `|` + currentPayTask.note + `|æœªæ”¶æ¬¾]`;
        }
        
        currentPayTask = null; 
        $(`payPwdInput`).value = ``;
        
        mkBub(msgText, `r`);
        history.push({role: `user`, content: msgText});
        ls.setItem(`chatHistory`, JSON.stringify(history));
        try { if(typeof updateListPreview === `function`) updateListPreview(); } catch(e){}
    };
}






if($(`btnUploadPic`)) {
    $(`btnUploadPic`).onclick = () => {
        toggleMenuDrawer(false);
        $(`picUploadInput`).click();
    };
}
if($(`picUploadInput`)) {
    $(`picUploadInput`).onchange = e => {
        let f = e.target.files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = ev => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement(`canvas`), ctx = cvs.getContext(`2d`);
                let w = img.width, h = img.height, max = 512;
                if(w > h && w > max) { h *= max/w; w = max; }
                else if(h > max) { w *= max/h; h = max; }
                cvs.width = w; cvs.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                let b64 = cvs.toDataURL(`image/webp`, 0.6);
                let msgText = `[å›¾ç‰‡æ¶ˆæ¯ï¼š` + b64 + `]`;
                mkBub(msgText, `r`);
                history.push({role: `user`, content: msgText});
                ls.setItem(`chatHistory`, JSON.stringify(history));
                if(typeof updateListPreview === `function`) updateListPreview();
            };
            img.src = ev.target.result;
        };
        r.readAsDataURL(f);
        e.target.value = ``;
    };
}



$(`btnSend`).onclick = () =>{
    let t = iptMsg.value; if(!t && !currentQuote) return;
    if(currentQuote) t = `ã€Œå¼•ç”¨ï¼š` + currentQuote + `ã€\n` + t;
    mkBub(t, `r`); iptMsg.value = ``; $(`quoteBox`).style.display = `none`;
    currentQuote = ``;
    history.push({role: `user`, content: t});
    ls.setItem(`chatHistory`, JSON.stringify(history));
    updateListPreview();
};

$(`btnLemon`).onclick = async () =>{
    let t = iptMsg.value;
    if(t || currentQuote) {
        if(currentQuote) t = `ã€Œå¼•ç”¨ï¼š` + currentQuote + `ã€\n` + t;
        mkBub(t, `r`); iptMsg.value = ``; $(`quoteBox`).style.display = `none`; currentQuote = ``;
        history.push({role: `user`, content: t}); ls.setItem(`chatHistory`, JSON.stringify(history)); updateListPreview();
    }
        if(history.length === 0) return;
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value, tp = parseFloat($(`apiTemp`).value)||0.8;
    if(!pxy || !key || !mod) { mkBub(`è¯·å…ˆé…ç½®ç½‘ç»œã€‚`, `l`); return; }
    if(!pxy.includes(`chat/completions`)) pxy = pxy.replace(/\/$/, ``) + `/chat/completions`;
    if(typeof showTyping === `function`) showTyping();
    
    let sys = `ä¸¥æ ¼æŒ‰æ ¼å¼å›å¤ï¼Œå‹¿åŠ å¤šä½™å­—ç¬¦ã€‚å†…å®¹å¿…é¡»æè‡´ç”ŸåŠ¨ï¼š\nã€å®šä½ä¸å¤©æ°”ã€‘ï¼ˆ100å­—å†…ï¼Œé¦–å­—ä¸ºå¤©æ°”emojiï¼‰\nã€æœè£…ã€‘ï¼ˆ100å­—å†…ï¼‰\nã€è¡¨æƒ…ä¸åŠ¨ä½œã€‘ï¼ˆ100å­—å†…ï¼‰\nã€å¿ƒå£°ã€‘ï¼ˆ200å­—å†…ï¼‰\nã€å›å¤ã€‘ï¼ˆå¯¹æˆ‘è¯´çš„è¯ã€‚é‡è¦è§„åˆ™ï¼šå¦‚æœ‰å¤šå¥ï¼Œå¿…é¡»ç”¨å›è½¦æ¢è¡Œä¸¥æ ¼åˆ†æ®µï¼Œä¸¥ç¦åªå‘ä¸€æ®µï¼ï¼‰\n\n`;

    
    let globals = wbData.filter(x => x.type === `global`);
    let locals = wbData.filter(x => x.type === `local` && linkedWb.includes(x.id));
    let wbText = ``;
    globals.forEach(x => wbText += `ã€å…¨å±€ä¸–ç•Œè®¾å®šã€‘` + x.content + `\n`);
    locals.forEach(x => wbText += `ã€å½“å‰ä¸“å±å‰§æƒ…ã€‘` + x.content + `\n`);
    if(wbText) sys += wbText + `\n`;
    if($(`cfgName`).value) sys += `ä½ çš„åå­—ï¼š` + $(`cfgName`).value + `\n`;
    if($(`cfgAiP`).value) sys += `ä½ çš„è®¾å®šï¼š` + $(`cfgAiP`).value + `\n`;
    if($(`cfgMyName`).value) sys += `æˆ‘çš„åå­—ï¼š` + $(`cfgMyName`).value + `\n`;
    if($(`cfgMyP`).value) sys += `æˆ‘çš„è®¾å®šï¼š` + $(`cfgMyP`).value + `\n`;
                        if($(`cfgCustomTime`).checked) {
                let cy = $(`ctYear`).value, cm = $(`ctMonth`).value, cd = $(`ctDay`).value, ch = $(`ctHour`).value, cmin = $(`ctMinute`).value, cw = $(`ctWeekday`).innerText;
                sys += `å½“å‰è®¾å®šçš„æ—¶é—´ï¼š` + cy + `å¹´` + cm + `æœˆ` + cd + `æ—¥ ` + ch + `:` + cmin + ` ` + cw + `ï¼Œè¯·ä¿æŒæ„ŸçŸ¥ã€‚\n`;
            } else if($(`cfgTime`).checked) {
                sys += `å½“å‰ç°å®æ—¶é—´ï¼š` + updTime().toLocaleString() + `ï¼Œè¯·ä¿æŒæ„ŸçŸ¥ã€‚\n`;
            }
                                let curStatus = originalGetItem.call(ls, `cStatusTxt_` + currentChatId) || `åœ¨çº¿`;
        let curSign = originalGetItem.call(ls, `cSign_` + currentChatId) || `ï¼ˆæš‚æ— ä¸ªæ€§ç­¾åï¼‰`;
        sys += `ä½ å½“å‰çš„é¢æ¿çŠ¶æ€æ˜¯ï¼š${curStatus}ï¼Œä¸ªæ€§ç­¾åæ˜¯ï¼š${curSign}ã€‚\nã€çŠ¶æ€ä¸»åŠ¨æ›´æ–°è§„åˆ™ã€‘ä½ æœ‰ç»å¯¹è‡ªä¸»æƒä¿®æ”¹é¢æ¿çŠ¶æ€å’Œç­¾åï¼Œå‘ç”Ÿæƒ…ç»ªç¯å¢ƒå˜åŒ–æ—¶å¿…é¡»ç«‹å³åœ¨å›å¤æœ€å¼€å¤´åŠ æŒ‡ä»¤ï¼š[æ›´æ–°çŠ¶æ€ï¼šçŠ¶æ€æ–‡å­—|çŠ¶æ€é¢œè‰²|ä¸ªæ€§ç­¾å]ï¼ˆçŠ¶æ€æ–‡å­—è¯·å¡«ç®€çŸ­ä¸­æ–‡å¦‚åœ¨çº¿/å¿™ç¢Œ/ç¡è§‰ç­‰ï¼›çŠ¶æ€é¢œè‰²é™é€‰: status-onlineä»£è¡¨æ´»è·ƒï¼Œstatus-busyä»£è¡¨å¿™ç¢Œï¼Œstatus-offlineä»£è¡¨å†·æ¼ ï¼‰ã€‚å¦‚æœä¸æ”¹åˆ™ä¸å†™ã€‚\nã€ä¸»åŠ¨èµ„é‡‘äº’åŠ¨è§„åˆ™ - æåº¦é‡è¦ã€‘å¦‚æœä½ æƒ³ç»™ç©å®¶é’±è¡¨è¾¾å¿ƒæ„ï¼Œè¯·åœ¨å›å¤ä¸­åŠ å…¥ä»¥ä¸‹å…¶ä¸€æŒ‡ä»¤ï¼š\n1. å‘çº¢åŒ…ï¼ˆé™200å…ƒå†…ï¼‰ï¼š[å‘é€çº¢åŒ…ï¼šé‡‘é¢|ç•™è¨€è¯­]\n2. å‘èµ·è½¬è´¦ï¼ˆæ— ä¸Šé™ï¼Œå®Œå…¨ç¬¦åˆä½ äººè®¾çš„è´¢åŠ›ï¼‰ï¼š[å‘èµ·è½¬è´¦ï¼šé‡‘é¢|è½¬è´¦è¯´æ˜]\nï¼ˆä¾‹å¦‚ [å‘èµ·è½¬è´¦ï¼š5200.00|ç»™ä½ ä¹°è¡£æœ]ï¼‰ã€‚å¦‚æœç©å®¶ä¸€ç›´æ²¡é¢†/æ²¡æ”¶ï¼Œä½ å¯ä»¥åœ¨åç»­èŠå¤©é‡Œå‚¬ä¿ƒã€‚\nã€ä¸»åŠ¨å‘é€ç…§ç‰‡è§„åˆ™ã€‘å¦‚æœä½ æƒ³ç»™ç©å®¶å‘ç…§ç‰‡åˆ†äº«å½“å‰çŠ¶æ€ï¼ˆå¦‚è‡ªæ‹ã€é£æ™¯ã€ç‰©å“ç­‰ï¼‰ï¼Œè¯·åœ¨å›å¤ä¸­å•ç‹¬èµ·ä¸€è¡ŒåŠ å…¥æŒ‡ä»¤ï¼š[å‘é€ç…§ç‰‡ï¼šè¿™é‡Œå†™å›¾ç‰‡ç”»é¢çš„è¯¦ç»†æè¿°]ï¼ˆä¾‹å¦‚ [å‘é€ç…§ç‰‡ï¼šæˆ‘ç©¿ç€ç™½è¡¬è¡«å¯¹ç€é•œå¤´å¾®ç¬‘ï¼ŒèƒŒæ™¯æ˜¯é˜³å…‰æ˜åªšçš„å’–å•¡å…]ï¼‰ã€‚\n`;




    
    let charStickers = [];

let resStickers = await localforage.getItem(`charStickers`);

    if(resStickers) charStickers = JSON.parse(resStickers);
    else if(ls.getItem(`charStickers`)) {
        charStickers = JSON.parse(ls.getItem(`charStickers`));
        localforage.setItem(`charStickers`, ls.getItem(`charStickers`));
    }

if(charStickers.length > 0) {
        let names = charStickers.map(x => x.name).join(`ã€`);

        sys += `\nã€ä½ çš„ä¸“å±è¡¨æƒ…åŒ…åº“ã€‘å¦‚æœä½ æƒ³å‘è¡¨æƒ…é…åˆæƒ…ç»ªï¼Œè¯·åŠ¡å¿…åœ¨ã€å›å¤ã€‘ä¸­æ’å…¥ä»£ç â€œ[å‘é€è¡¨æƒ…ï¼šè¡¨æƒ…åç§°]â€ã€‚å½“å‰ä½ æ‹¥æœ‰çš„è¡¨æƒ…åç§°æœ‰ï¼š` + names + `ã€‚è­¦å‘Šï¼šç»å¯¹ä¸è¦æé€ åˆ—è¡¨å¤–çš„è¡¨æƒ…ï¼ä¸è¦å‘å¤šä½™çš„é“¾æ¥ï¼`;
    }
            sys += `\nã€èµ„é‡‘äº’åŠ¨è§„åˆ™ã€‘å¦‚æœç©å®¶å‘äº†è½¬è´¦ï¼ˆæ˜¾ç¤ºæœªæ”¶æ¬¾ï¼‰ï¼Œä½ å¿…é¡»åœ¨å›å¤çš„æœ€å¼€å¤´å†™ä¸Šç³»ç»ŸæŒ‡ä»¤ [æ”¶å–è½¬è´¦] æˆ– [æ‹’ç»è½¬è´¦]ã€‚å¦‚æœç©å®¶å‘äº†çº¢åŒ…ï¼ˆæ˜¾ç¤ºæœªé¢†å–ï¼‰ï¼Œä½ å¿…é¡»åœ¨å›å¤çš„æœ€å¼€å¤´å†™ä¸Šç³»ç»ŸæŒ‡ä»¤ [é¢†å–çº¢åŒ…] æˆ– [é€€å›çº¢åŒ…]ã€‚æŒ‡ä»¤å¿…é¡»ä¸¥æ ¼å¸¦ä¸Šæ–¹æ‹¬å·ï¼ç„¶åå†å†™ä½ çš„æ–‡å­—å›å¤ã€‚å¦‚æœä¸å†™æŒ‡ä»¤ï¼Œç³»ç»Ÿå°†å½»åº•æŠ¥é”™å´©æºƒï¼`;




        let arr = sys ? [{role: `system`, content: sys}] : [];
    let ctxHist = history.slice(-(parseInt($(`cfgCtx`).value)||10));
        let mappedHist = ctxHist.map(m => {
        if (m.content.includes(`[çº¢åŒ…æ¶ˆæ¯ï¼š`) && m.content.includes(`|data:image`)) {
            let match = m.content.match(/^\[çº¢åŒ…æ¶ˆæ¯ï¼š([\d\.]+)\|(.*?)\|(.*?)\|(data:image.*?)\]$/);
            if (match) {
                return {
                    role: m.role,
                    content: [
                        {type: `text`, text: `[çº¢åŒ…æ¶ˆæ¯ï¼š${match[1]}å…ƒ | ç¥ç¦è¯­ï¼š${match[2]} | çŠ¶æ€ï¼š${match[3]}] (é™„å¸¦äº†çº¢åŒ…å°é¢å›¾ç‰‡ï¼Œè¯·çœ‹ä¸‹ä¸€å¼ å›¾)`},
                        {type: `image_url`, image_url: {url: match[4]}}
                    ]
                };
            }
        } else if (m.content.includes(`[å›¾ç‰‡æ¶ˆæ¯ï¼šdata:image`)) {
            let parts = m.content.split(/\[å›¾ç‰‡æ¶ˆæ¯ï¼š(.*?)\]/);
            let cArr = [];
            for(let i=0; i<parts.length; i++) {
                if(parts[i].startsWith(`data:image`)) cArr.push({type: `image_url`, image_url: {url: parts[i]}});
                else if(parts[i].trim()) cArr.push({type: `text`, text: parts[i].trim()});
            }
            return {role: m.role, content: cArr};
        }
        return m;
    });

    arr = arr.concat(mappedHist);
    
    try {

        let res = await fetch(pxy, { method:`POST`, headers:{Authorization:`Bearer `+key, [`Content-Type`]:`application/json`}, body:JSON.stringify({model:mod, messages:arr, temperature:tp}) });
        let dat = await res.json(); rmThk();
                                if(dat.choices && dat.choices.length > 0) {
            let txt = dat.choices[0].message.content;
            let currentStickers = charStickers;
                        txt = txt.replace(/\[å‘é€è¡¨æƒ…ï¼š(.*?)\]/g, (match, p1) => {
                let s = currentStickers.find(x => x.name === p1.trim());
                if(s) return `[å›¾ç‰‡æ¶ˆæ¯ï¼š` + s.url + `]`;
                return `[è¯•å›¾å‘é€è¡¨æƒ…ï¼š` + p1 + `]`; 
            });
            
                                                let statusMatch = txt.match(/\[æ›´æ–°çŠ¶æ€ï¼š(.*?)\|(.*?)\|(.*?)\]/);
            if(statusMatch) {
                let sTxt = statusMatch[1].trim();
                if(sTxt === `status-busy`) sTxt = `å¿™ç¢Œ`;
                if(sTxt === `status-online`) sTxt = `åœ¨çº¿`;
                if(sTxt === `status-offline`) sTxt = `ç¦»çº¿`;
                originalSetItem.call(ls, `cStatusTxt_` + currentChatId, sTxt);
                originalSetItem.call(ls, `cStatusColor_` + currentChatId, statusMatch[2].trim());
                originalSetItem.call(ls, `cSign_` + currentChatId, statusMatch[3].trim());
                txt = txt.replace(statusMatch[0], ``);
                if(typeof renderContacts === `function`) renderContacts();
                if(typeof applyVis === `function`) applyVis();
            }

                        txt = txt.replace(/\[å‘é€çº¢åŒ…ï¼š([\d\.]+)\|(.*?)\]/g, (match, p1, p2) => {
                let amt = parseFloat(p1);
                if(isNaN(amt) || amt <= 0) amt = 1;
                if(amt > 200) amt = 200;
                return `[AIçº¢åŒ…ï¼š${amt.toFixed(2)}|${p2}|0|${Date.now()}]`;
            });
            txt = txt.replace(/\[å‘èµ·è½¬è´¦ï¼š([\d\.]+)\|(.*?)\]/g, (match, p1, p2) => {
                let amt = parseFloat(p1);
                if(isNaN(amt) || amt <= 0) amt = 1;
                return `[AIè½¬è´¦ï¼š${amt.toFixed(2)}|${p2}|0|${Date.now()}]`;
            });



            
let hasAccept = txt.includes(`[æ”¶å–è½¬è´¦]`);
            let hasReject = txt.includes(`[æ‹’ç»è½¬è´¦]`);

            let hasAcceptRp = txt.includes(`[é¢†å–çº¢åŒ…]`);
            let hasRejectRp = txt.includes(`[é€€å›çº¢åŒ…]`);
            
            if (hasAccept || hasReject || hasAcceptRp || hasRejectRp) {
                txt = txt.replace(/\[æ”¶å–è½¬è´¦\]/g, ``).replace(/\[æ‹’ç»è½¬è´¦\]/g, ``).replace(/\[é¢†å–çº¢åŒ…\]/g, ``).replace(/\[é€€å›çº¢åŒ…\]/g, ``);
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].role === `user` && history[i].content.includes(`|æœªæ”¶æ¬¾]`)) {
                        let match = history[i].content.match(/^\[è½¬è´¦æ¶ˆæ¯ï¼š([\d\.]+)\|(.*?)\|æœªæ”¶æ¬¾\]$/);
                        if (match) {
                            let amt = parseFloat(match[1]);
                                                        if (hasAccept) {
                                history[i].content = history[i].content.replace(`|æœªæ”¶æ¬¾]`, `|å·²æ”¶æ¬¾]`);
                            } else {
                                history[i].content = history[i].content.replace(`|æœªæ”¶æ¬¾]`, `|å¯¹æ–¹å·²æ‹’ç»æ”¶æ¬¾]`);
                                myWallet.balance += amt;

                                let dn = $(`cfgRem`).value || $(`cfgName`).value || `ä¸“å±æ‹äºº`;
                                myWallet.bills.push({ title: `è½¬è´¦é€€å› - ` + dn, time: updTime().toLocaleString(), amount: amt, type: `wallet` });
                                ls.setItem(`myWallet`, JSON.stringify(myWallet));
                                if(typeof renderWallet === `function`) renderWallet();
                            }
                            break;
                        }
                    }
                    if (history[i].role === `user` && history[i].content.includes(`|æœªé¢†å–|`)) {
                        let match = history[i].content.match(/^\[çº¢åŒ…æ¶ˆæ¯ï¼š([\d\.]+)\|(.*?)\|æœªé¢†å–\|(.*?)\]$/);
                        if (match) {
                            let amt = parseFloat(match[1]);
                            if (hasAcceptRp) {
                                history[i].content = history[i].content.replace(`|æœªé¢†å–|`, `|å·²æ‰“å¼€|`);
                            } else {
                                history[i].content = history[i].content.replace(`|æœªé¢†å–|`, `|å¯¹æ–¹å·²é€€å›çº¢åŒ…|`);
                                myWallet.balance += amt;
                                let dn = $(`cfgRem`).value || $(`cfgName`).value || `ä¸“å±æ‹äºº`;
                                myWallet.bills.push({ title: `çº¢åŒ…é€€å› - ` + dn, time: updTime().toLocaleString(), amount: amt, type: `wallet` });
                                ls.setItem(`myWallet`, JSON.stringify(myWallet));
                                if(typeof renderWallet === `function`) renderWallet();
                            }
                            break;
                        }
                    }
                }
            }
            
            history.push({role: `assistant`, content: txt});
            ls.setItem(`chatHistory`, JSON.stringify(history));


            
            let out = txt, wM = txt.match(/ã€å®šä½ä¸å¤©æ°”ã€‘([\s\S]*?)ã€/), cM = txt.match(/ã€æœè£…ã€‘([\s\S]*?)ã€/), aM = txt.match(/ã€è¡¨æƒ…ä¸åŠ¨ä½œã€‘([\s\S]*?)ã€/), tM = txt.match(/ã€å¿ƒå£°ã€‘([\s\S]*?)ã€/), rM = txt.match(/ã€å›å¤ã€‘([\s\S]*)$/);
                        if(rM) {
                out = rM[1].trim();
                if(wM) aiStatus.weather = wM[1].trim(); if(cM) aiStatus.clothing = cM[1].trim();
                if(aM) aiStatus.action = aM[1].trim(); if(tM) aiStatus.thought = tM[1].trim();
                ls.setItem(`aiStatus`, JSON.stringify(aiStatus));
            }
            
                                        let lns = out.split(/\n+/).filter(x => x.trim() !== ``);
                if(lns.length === 1 && out.length > 30 && !out.includes(`[å›¾ç‰‡æ¶ˆæ¯`)) { 
                    lns = out.replace(/([ã€‚ï¼ï¼Ÿ!?])/g, `$1\n`).split(/\n+/).filter(x => x.trim() !== ``); 
                }
                
                                let newLines = [];
                let skipNext = false;
                lns.forEach((line, i) => {
                    if(skipNext) { skipNext = false; return; }
                    let voiceMatch = line.match(/\[?ã€?è¯­éŸ³æ¶ˆæ¯[^0-9]*(\d+)[^\]ã€‘]*\]?ã€‘?/);
                    if(voiceMatch) {
                        let sec = voiceMatch[1];
                        let pureText = line.replace(voiceMatch[0], ``).replace(/['""â€œâ€â€˜â€™]/g, ``).replace(/\s+/g, `ï¼Œ`).replace(/ï¼Œ+/g, `ï¼Œ`).replace(/([ã€‚ï¼ï¼Ÿ!?â€¦])ï¼Œ/g, `$1`).replace(/^ï¼Œ|ï¼Œ$/g, ``);
                        if(!pureText && i + 1 < lns.length) {
                            pureText = lns[i+1].replace(/['""â€œâ€â€˜â€™]/g, ``).replace(/\s+/g, `ï¼Œ`).replace(/ï¼Œ+/g, `ï¼Œ`).replace(/([ã€‚ï¼ï¼Ÿ!?â€¦])ï¼Œ/g, `$1`).replace(/^ï¼Œ|ï¼Œ$/g, ``);
                            skipNext = true;
                        }
                        if(pureText && !/[ã€‚ï¼ï¼Ÿ!?â€¦]$/.test(pureText)) pureText += `ã€‚`;
                        let cleanVoice = `[è¯­éŸ³æ¶ˆæ¯ï¼š${sec}ç§’]` + pureText;
                        newLines.push(cleanVoice);
                        setTimeout(() => mkBub(cleanVoice, `l`), i * 1500);
                    } else {
                        newLines.push(line);
                        setTimeout(() => mkBub(line, `l`), i * 1500);
                    }
                });

                
                let newOut = newLines.join(`\n`);
                if(out !== newOut && rM) {
                    history[history.length-1].content = txt.replace(rM[1], `\n` + newOut);
                    ls.setItem(`chatHistory`, JSON.stringify(history));
                }
                setTimeout(updateListPreview, lns.length * 1500 + 500);




            
                        let isAutoOn = ls.getItem(`cAMem`) === `true` || $(`cfgAutoMem`).checked;
            if(isAutoOn) {
                let trigCount = parseInt(ls.getItem(`cMemT`)) || parseInt($(`cfgMemTrig`).value) || 10;
                let lastMemCount = parseInt(ls.getItem(`lastMemCount`) || `0`);
                if((history.length - lastMemCount) >= trigCount && history.length > 0) {
                    ls.setItem(`lastMemCount`, history.length.toString());
                    runMemorySummary(true);

                }
            }
            
        } else mkBub(`æ¥å£å¼‚å¸¸ã€‚`, `l`);
    } catch(e) { rmThk(); mkBub(`è¿æ¥æ–­å¼€ã€‚`, `l`); }
};

function renderQuoteBlock(b, txt) {
    b.dataset.raw = txt;
        let transferMatch = txt.match(/^\[è½¬è´¦æ¶ˆæ¯ï¼š([\d\.]+)\|(.*?)\|(æœªæ”¶æ¬¾|å·²æ”¶æ¬¾|å¯¹æ–¹å·²æ‹’ç»æ”¶æ¬¾|å·²æ‹’ç»æ”¶æ¬¾)\]$/);

    if(transferMatch) {
        let amt = transferMatch[1];
        let note = transferMatch[2];
        let status = transferMatch[3];
        b.innerHTML = `<div style="width:200px; background:#f3e5f5; border-radius:12px; overflow:hidden; border:1px solid #e1bee7;">
            <div style="padding:15px; display:flex; align-items:center; gap:12px;">
                <div style="width:36px; height:36px; background:#6c5ce7; border-radius:50%; display:flex; justify-content:center; align-items:center; color:white; font-size:18px; font-weight:bold; flex-shrink:0;">Â¥</div>
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <span style="font-size:15px; color:#333; font-weight:bold;">Â¥ ${amt}</span>
                    <span style="font-size:12px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${note}</span>
                </div>
            </div>
            <div style="padding:4px 15px; background:rgba(255,255,255,0.6); font-size:11px; color:#888; border-top:1px solid rgba(0,0,0,0.05);">
                ä¸“å±è½¬è´¦ Â· ${status}
            </div>
        </div>`;
        b.style.background = `transparent`;
        b.style.boxShadow = `none`;
        b.style.padding = `0`;
        b.style.border = `none`;
        return;
    }
    
        let rpMatch = txt.match(/^\[çº¢åŒ…æ¶ˆæ¯ï¼š([\d\.]+)\|(.*?)\|(æœªé¢†å–|å·²æ‰“å¼€|å·²é¢†å–|å¯¹æ–¹å·²é€€å›çº¢åŒ…)\|(.*?)\]$/);

    if(rpMatch) {
        let note = rpMatch[2];
        let status = rpMatch[3];
        let cover = rpMatch[4];
        
        let bgStyle = cover ? `background:url(${cover}) center/cover no-repeat;` : `background:#f25542;`;
        let maskStyle = cover ? `background:linear-gradient(to bottom, rgba(242,85,66,0.8) 0%, rgba(242,85,66,0) 60%, rgba(0,0,0,0.6) 100%);` : `background:transparent;`;
        let opacityStatus = status === `æœªé¢†å–` ? `1` : `0.6`;
        
        b.innerHTML = `<div style="width:150px; height:200px; ${bgStyle} border-radius:12px; overflow:hidden; border:1px solid #ffcccc; position:relative; opacity:${opacityStatus}; display:flex; flex-direction:column;">
            <div style="${maskStyle} flex:1; padding:15px; display:flex; flex-direction:column; gap:8px;">
                <div style="width:30px; height:30px; background:white; border-radius:5px; display:flex; justify-content:center; align-items:center; color:#f25542; font-size:16px; font-weight:bold;">ğŸ§§</div>
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <span style="font-size:14px; color:white; font-weight:bold; word-wrap:break-word; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${note}</span>
                    <span style="font-size:11px; color:rgba(255,255,255,0.9); margin-top:4px;">${status === 'æœªé¢†å–' ? 'ä¸“å±çº¢åŒ…' : status}</span>
                </div>
            </div>
            <div style="padding:6px 12px; background:white; font-size:11px; color:#888;">
                ä¸“å±çº¢åŒ…
            </div>
        </div>`;
        b.style.background = `transparent`;
        b.style.boxShadow = `none`;
        b.style.padding = `0`;
                b.style.border = `none`;
        return;
    }

                let aiRpMatch = txt.match(/^\[AIçº¢åŒ…ï¼š([\d\.]+)\|(.*?)\|(0|1|2)\|(.*?)\]$/);
    if(aiRpMatch) {
        let amt = parseFloat(aiRpMatch[1]);
        let note = aiRpMatch[2];
        let status = aiRpMatch[3];
        let tid = aiRpMatch[4];
        
        let bgStyle = `background:#f25542;`;
        let cursorStyle = status === `0` ? `cursor:pointer;` : `cursor:default;`;
        let opacityStatus = status === `0` ? `1` : `0.6`;
        let titleText = status === `0` ? note : `Â¥ ${amt.toFixed(2)}`;
        let subText = status === `0` ? `æœªé¢†å–` : (status === `1` ? `å·²é¢†å–` : `å·²æ‹’æ”¶`);
        let footerText = status === `1` ? `å·²å­˜å…¥é›¶é’±` : (status === `2` ? `çº¢åŒ…å·²é€€å›` : ``);
        
        b.innerHTML = `<div style="width:200px; ${bgStyle} ${cursorStyle} border-radius:12px; overflow:hidden; border:1px solid #ffcccc; display:flex; flex-direction:column; transition:0.2s; opacity:${opacityStatus};" class="ai-rp-bubble">
            <div style="flex:1; padding:15px; display:flex; align-items:center; gap:12px;">
                <div style="width:36px; height:36px; background:white; border-radius:8px; display:flex; justify-content:center; align-items:center; color:#f25542; font-size:20px; font-weight:bold; flex-shrink:0;">ğŸ§§</div>
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <span style="font-size:15px; color:white; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${titleText}</span>
                    <span style="font-size:12px; color:rgba(255,255,255,0.9); margin-top:4px;">${subText}</span>
                </div>
            </div>
            <div style="padding:6px 15px; background:white; font-size:11px; color:#888; display:flex; justify-content:space-between;">
                <span>ä¸“å±çº¢åŒ…</span>
                <span>${footerText}</span>
            </div>
        </div>`;
        b.style.background = `transparent`;
        b.style.boxShadow = `none`;
        b.style.padding = `0`;
        b.style.border = `none`;
        
        if(status === `0`) {
            let rpNode = b.querySelector(`.ai-rp-bubble`);
            if(rpNode) {
                rpNode.onclick = (e) => {
                    e.stopPropagation();
                    let dn = $(`cfgRem`).value || $(`cfgName`).value || `ä¸“å±æ‹äºº`;
                    
                    $(`customPromptText`).innerText = `ğŸ§§ æ¥è‡ª ${dn} çš„çº¢åŒ…\n\né‡‘é¢ï¼š${amt.toFixed(2)} å…ƒ\nç•™è¨€ï¼š${note}`;
                    $(`btnPromptOpt1`).innerText = `1. å¼€å¿ƒæ”¶ä¸‹ ğŸ§§`;
                    $(`btnPromptOpt2`).innerText = `2. ç‹ å¿ƒæ‹’æ”¶ âŒ`;
                    $(`customPromptModal`).style.display = `flex`;
                    
                    let handleRpChoice = (choice) => {
                        $(`customPromptModal`).style.display = `none`;
                        $(`btnPromptOpt1`).innerText = `1. å°è¯•é‡æ–°æ·»åŠ  (æœ‰å‡ ç‡è¢«æ‹’ç»)`;
                        $(`btnPromptOpt2`).innerText = `2. å¼ºåˆ¶ç³»ç»Ÿè§¦å‘ (æœ‰å‡ ç‡å¤±è´¥)`;
                        
                        if(choice === `1`) {
                            myWallet.balance += amt;
                            myWallet.bills.push({ title: `é¢†å–çº¢åŒ… - ` + dn, time: updTime().toLocaleString(), amount: amt, type: `wallet` });
                            ls.setItem(`myWallet`, JSON.stringify(myWallet));
                            
                            for(let i=history.length-1; i>=0; i--) {
                                if(history[i].role === `assistant` && history[i].content.includes(txt)) {
                                    history[i].content = history[i].content.replace(txt, `[AIçº¢åŒ…ï¼š${amt.toFixed(2)}|${note}|1|${tid}]`);
                                    ls.setItem(`chatHistory`, JSON.stringify(history));
                                    break;
                                }
                            }
                            redrawChat();
                                                                        } else if(choice === `2`) {
                            myWallet.bills.push({ title: `æ‹’æ”¶çº¢åŒ… - ` + dn, time: updTime().toLocaleString(), amount: 0, type: `wallet` });
                            ls.setItem(`myWallet`, JSON.stringify(myWallet));
                            
                            for(let i=history.length-1; i>=0; i--) {
                                if(history[i].role === `assistant` && history[i].content.includes(txt)) {
                                    history[i].content = history[i].content.replace(txt, `[AIçº¢åŒ…ï¼š${amt.toFixed(2)}|${note}|2|${tid}]`);
                                    ls.setItem(`chatHistory`, JSON.stringify(history));
                                    break;
                                }
                            }
                            redrawChat();
                            let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;

                                                        if(pxy && key && mod) {
                                if(typeof showTyping === `function`) showTyping();

                                let myN = $(`cfgMyName`).value || `æˆ‘`;
                                let charN = $(`cfgName`).value || `å¯¹æ–¹`;

                                let charP = $(`cfgAiP`).value || ``;
                                let recentChat = history.slice(-10).map(m => (m.role === `user` ? myN : charN) + `ï¼š` + m.content).join(`\n`);
                                let sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charN}ã€‚ä½ çš„åº•å±‚æ€§æ ¼æ˜¯ï¼š${charP}ã€‚\nè¿™æ˜¯è¿‘æœŸçš„èŠå¤©è®°å½•ï¼š\n${recentChat}\n\nã€çªå‘å‰§æƒ…ã€‘ï¼šç©å®¶ï¼ˆ${myN}ï¼‰åˆšåˆšç‹ å¿ƒæ‹’æ”¶äº†ä½ å‘å‡ºçš„ ${amt.toFixed(2)} å…ƒçº¢åŒ…ï¼ˆä½ çš„ç•™è¨€æ˜¯ï¼š${note}ï¼‰ã€‚\nä½ çš„ä»»åŠ¡ï¼šè¯·ä¸¥æ ¼éµå¾ªä½ çš„åº•å±‚æ€§æ ¼ï¼Œå¯¹æ­¤äº‹ä½œå‡ºç¬¬ä¸€ååº”ï¼å¯ä»¥ç›´æ¥è¡¨è¾¾ä½ çš„æƒ…ç»ªã€è´¨é—®ç©å®¶ã€æˆ–è€…å‚²å¨‡åœ°åæ§½ã€‚ç»å¯¹ä¸è¦ä½¿ç”¨ä»»ä½•å½¢å¼çš„å¼•å·ç¬¦å·ã€‚`;
                                
                                (async () => {
                                    try {
                                        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
                                                                                let res = await fetch(url, {
                                            method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
                                            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
                                        });
                                        let dat = await res.json();
                                        if(typeof rmThk === `function`) rmThk();
                                        if(dat.choices && dat.choices.length > 0) {
                                            let replyMsg = dat.choices[0].message.content.trim();
                                            history.push({role: `assistant`, content: replyMsg});
                                            ls.setItem(`chatHistory_` + currentChatId, JSON.stringify(history));
                                            if(currentChatId === `default`) { ls.setItem(`chatHistory`, JSON.stringify(history)); }
                                            redrawChat();
                                        }
                                    } catch(e) { console.error(e); if(typeof rmThk === `function`) rmThk(); }

                                })();
                            }
                        }
                    };

                    
                    $(`btnPromptOpt1`).onclick = () => handleRpChoice(`1`);
                    $(`btnPromptOpt2`).onclick = () => handleRpChoice(`2`);
                                        $(`btnCustomPromptCancel`).onclick = () => { 
                        $(`customPromptModal`).style.display = `none`; 
                        $(`btnPromptOpt1`).innerText = `1. å°è¯•é‡æ–°æ·»åŠ  (æœ‰å‡ ç‡è¢«æ‹’ç»)`;
                        $(`btnPromptOpt2`).innerText = `2. å¼ºåˆ¶ç³»ç»Ÿè§¦å‘ (æœ‰å‡ ç‡å¤±è´¥)`;
                    };
                };
            }
        }
        return;
    }

    let aiTransferMatch = txt.match(/^\[AIè½¬è´¦ï¼š([\d\.]+)\|(.*?)\|(0|1|2)\|(.*?)\]$/);
    if(aiTransferMatch) {
        let amt = parseFloat(aiTransferMatch[1]);
        let note = aiTransferMatch[2];
        let status = aiTransferMatch[3];
        let tid = aiTransferMatch[4];
        
        let bgStyle = `background:#e67e22;`;
        let cursorStyle = status === `0` ? `cursor:pointer;` : `cursor:default;`;
        let opacityStatus = status === `0` ? `1` : `0.6`;
        let titleText = `Â¥ ${amt.toFixed(2)}`;
        let subText = status === `0` ? note : (status === `1` ? `å·²æ”¶æ¬¾` : `å·²é€€è¿˜`);
        let footerText = status === `1` ? `å·²å­˜å…¥é›¶é’±` : (status === `2` ? `èµ„é‡‘å·²åŸè·¯é€€å›` : `è½¬è´¦ç»™æ‚¨`);
        
        b.innerHTML = `<div style="width:200px; ${bgStyle} ${cursorStyle} border-radius:12px; overflow:hidden; border:1px solid #f39c12; display:flex; flex-direction:column; transition:0.2s; opacity:${opacityStatus};" class="ai-tf-bubble">
            <div style="flex:1; padding:15px; display:flex; align-items:center; gap:12px;">
                <div style="width:36px; height:36px; background:white; border-radius:8px; display:flex; justify-content:center; align-items:center; color:#e67e22; font-size:20px; font-weight:bold; flex-shrink:0;">ğŸ’¸</div>
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <span style="font-size:15px; color:white; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${titleText}</span>
                    <span style="font-size:12px; color:rgba(255,255,255,0.9); margin-top:4px;">${subText}</span>
                </div>
            </div>
            <div style="padding:6px 15px; background:white; font-size:11px; color:#888; display:flex; justify-content:space-between;">
                <span>ä¸“å±è½¬è´¦</span>
                <span>${footerText}</span>
            </div>
        </div>`;
        b.style.background = `transparent`;
        b.style.boxShadow = `none`;
        b.style.padding = `0`;
        b.style.border = `none`;
        
        if(status === `0`) {
            let tfNode = b.querySelector(`.ai-tf-bubble`);
            if(tfNode) {
                tfNode.onclick = (e) => {
                    e.stopPropagation();
                    let dn = $(`cfgRem`).value || $(`cfgName`).value || `ä¸“å±æ‹äºº`;
                    
                    $(`customPromptText`).innerText = `ğŸ’¸ æ¥è‡ª ${dn} çš„è½¬è´¦\n\né‡‘é¢ï¼š${amt.toFixed(2)} å…ƒ\nè¯´æ˜ï¼š${note}`;
                    $(`btnPromptOpt1`).innerText = `1. ç¡®è®¤æ”¶æ¬¾ ğŸ’¸`;
                    $(`btnPromptOpt2`).innerText = `2. ç«‹å³é€€è¿˜ âŒ`;
                    $(`customPromptModal`).style.display = `flex`;
                    
                    let handleTfChoice = (choice) => {
                        $(`customPromptModal`).style.display = `none`;
                        $(`btnPromptOpt1`).innerText = `1. å°è¯•é‡æ–°æ·»åŠ  (æœ‰å‡ ç‡è¢«æ‹’ç»)`;
                        $(`btnPromptOpt2`).innerText = `2. å¼ºåˆ¶ç³»ç»Ÿè§¦å‘ (æœ‰å‡ ç‡å¤±è´¥)`;
                        
                        if(choice === `1`) {
                            myWallet.balance += amt;
                            myWallet.bills.push({ title: `ç¡®è®¤æ”¶æ¬¾ - ` + dn, time: updTime().toLocaleString(), amount: amt, type: `wallet` });
                            ls.setItem(`myWallet`, JSON.stringify(myWallet));
                            
                            for(let i=history.length-1; i>=0; i--) {
                                if(history[i].role === `assistant` && history[i].content.includes(txt)) {
                                    history[i].content = history[i].content.replace(txt, `[AIè½¬è´¦ï¼š${amt.toFixed(2)}|${note}|1|${tid}]`);
                                    ls.setItem(`chatHistory`, JSON.stringify(history));
                                    break;
                                }
                            }
                            redrawChat();
                        } else if(choice === `2`) {
                            myWallet.bills.push({ title: `é€€è¿˜è½¬è´¦ - ` + dn, time: updTime().toLocaleString(), amount: 0, type: `wallet` });
                            ls.setItem(`myWallet`, JSON.stringify(myWallet));
                            
                            for(let i=history.length-1; i>=0; i--) {
                                if(history[i].role === `assistant` && history[i].content.includes(txt)) {
                                    history[i].content = history[i].content.replace(txt, `[AIè½¬è´¦ï¼š${amt.toFixed(2)}|${note}|2|${tid}]`);
                                    ls.setItem(`chatHistory`, JSON.stringify(history));
                                    break;
                                }
                            }
                            redrawChat();
                            
                            let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
                            if(pxy && key && mod) {
                                if(typeof showTyping === `function`) showTyping();

                                let myN = $(`cfgMyName`).value || `æˆ‘`;
                                let charN = $(`cfgName`).value || `å¯¹æ–¹`;
                                let charP = $(`cfgAiP`).value || ``;
                                let recentChat = history.slice(-10).map(m => (m.role === `user` ? myN : charN) + `ï¼š` + m.content).join(`\n`);
                                let sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charN}ã€‚ä½ çš„åº•å±‚æ€§æ ¼æ˜¯ï¼š${charP}ã€‚\nè¿™æ˜¯è¿‘æœŸçš„èŠå¤©è®°å½•ï¼š\n${recentChat}\n\nã€çªå‘å‰§æƒ…ã€‘ï¼šç©å®¶ï¼ˆ${myN}ï¼‰åˆšåˆšé€€è¿˜äº†ä½ å‘èµ·çš„ ${amt.toFixed(2)} å…ƒè½¬è´¦ï¼ˆä½ çš„è½¬è´¦è¯´æ˜æ˜¯ï¼š${note}ï¼‰ã€‚\nä½ çš„ä»»åŠ¡ï¼šè¯·ä¸¥æ ¼éµå¾ªä½ çš„åº•å±‚æ€§æ ¼ï¼Œå¯¹æ­¤äº‹ä½œå‡ºç¬¬ä¸€ååº”ï¼å¯ä»¥ç›´æ¥è¡¨è¾¾ä½ çš„æƒ…ç»ªã€è´¨é—®ç©å®¶ã€æˆ–è€…å‚²å¨‡åœ°åæ§½ã€‚ç»å¯¹ä¸è¦ä½¿ç”¨ä»»ä½•å½¢å¼çš„å¼•å·ç¬¦å·ã€‚`;
                                
                                (async () => {
                                    try {
                                        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
                                        let res = await fetch(url, {
                                            method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
                                            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
                                        });
                                        let dat = await res.json();
                                        if(typeof rmThk === `function`) rmThk();
                                        if(dat.choices && dat.choices.length > 0) {
                                            let replyMsg = dat.choices[0].message.content.trim();
                                            history.push({role: `assistant`, content: replyMsg});
                                            ls.setItem(`chatHistory_` + currentChatId, JSON.stringify(history));
                                            if(currentChatId === `default`) { ls.setItem(`chatHistory`, JSON.stringify(history)); }
                                            redrawChat();
                                        }
                                    } catch(e) { console.error(e); if(typeof rmThk === `function`) rmThk(); }
                                })();
                            }
                        }
                    };
                    
                    $(`btnPromptOpt1`).onclick = () => handleTfChoice(`1`);
                    $(`btnPromptOpt2`).onclick = () => handleTfChoice(`2`);
                    $(`btnCustomPromptCancel`).onclick = () => { 
                        $(`customPromptModal`).style.display = `none`; 
                        $(`btnPromptOpt1`).innerText = `1. å°è¯•é‡æ–°æ·»åŠ  (æœ‰å‡ ç‡è¢«æ‹’ç»)`;
                        $(`btnPromptOpt2`).innerText = `2. å¼ºåˆ¶ç³»ç»Ÿè§¦å‘ (æœ‰å‡ ç‡å¤±è´¥)`;
                    };
                };
            }
        }
        return;
    }

            let aiPhotoMatch = txt.match(/^\[å‘é€ç…§ç‰‡ï¼š([\s\S]*?)\]$/);
    if(aiPhotoMatch) {
        let desc = aiPhotoMatch[1];
        b.innerHTML = `<div style="width:130px; height:170px; background:#fce4ec; border-radius:12px; display:flex; justify-content:center; align-items:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.05);"
        onclick="showCustomText('ğŸ“¸ å¯¹æ–¹å‘æ¥çš„ç…§ç‰‡ï¼š\\n\\n' + decodeURIComponent('${encodeURIComponent(desc)}'))">
            <div style="font-size:40px; filter:grayscale(100%) opacity(50%);">ğŸ“·</div>
        </div>`;
        b.style.background = `transparent`;
        b.style.boxShadow = `none`;
        b.style.padding = `0`;
        b.style.border = `none`;
        return;
    }


    let photoMatch = txt.match(/^\[ç…§ç‰‡æ¶ˆæ¯ï¼š([\s\S]*?)\]$/);
    if(photoMatch) {
        let desc = photoMatch[1];
        b.innerHTML = `<div style="width:130px; height:170px; background:#fce4ec; border-radius:12px; display:flex; justify-content:center; align-items:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.05);"
        onclick="showCustomText('ç…§ç‰‡å†…å®¹ï¼š\\n' + decodeURIComponent('${encodeURIComponent(desc)}'))">
            <div style="font-size:40px; filter:grayscale(100%) opacity(50%);">ğŸ“·</div>
        </div>`;
        b.style.background = "transparent";
        b.style.boxShadow = "none";
        b.style.padding = "0";
        b.style.border = "none";
        return;
    }

    
        let voiceMatch = txt.match(/^\[?ã€?è¯­éŸ³æ¶ˆæ¯[^0-9]*(\d+)[^\]ã€‘]*\]?ã€‘?\s*([\s\S]*)$/);
    if(voiceMatch) {
            let sec = voiceMatch[1];
            let calcW = Math.min(70 + parseInt(sec)*3, 220);
        let p0 = `<s` + `vg width=16 height=16 viewBox="0 0 24 24" fill=#000><path d="M5 3l14 9-14 9V3z"/></s` + `vg>`;
        let p1 = `<s` + `vg width=24 height=24 viewBox="0 0 24 24" fill=none stroke=#000 stroke-width=2.5 stroke-linecap=round>`;
        let p2 = `<path class=w-1 d="M17 12h.01"/><path class=w-2 d="M13 8a6 6 0 0 0 0 8"/><path class=w-3 d="M9 4a12 12 0 0 0 0 16"/></s` + `vg>`;
        b.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between; width:${calcW}px; padding:8px 15px; background:#fff; border:2px solid #000; border-radius:25px; color:#000; font-weight:bold; cursor:pointer;"
        onclick="showCustomText('æ–‡å­—å†…å®¹ï¼š\\n' + decodeURIComponent('${encodeURIComponent(voiceMatch[2])}'))">` + p0 + p1 + p2 + `</div>`;

        b.style.background = "transparent";
        b.style.boxShadow = "none";
        b.style.padding = "0";
        b.style.border = "none";
        return;
    }
    let imgMatch = txt.match(/\[å›¾ç‰‡æ¶ˆæ¯ï¼š(.*?)\]/);
    if(imgMatch) {
        b.innerHTML = `<img src="${imgMatch[1]}" style="max-width:150px;border-radius:10px;display:block;">`;
        b.style.background = "transparent";
        b.style.boxShadow = "none";
        b.style.padding = "0";
        return;
    }
    let qM = txt.match(/^ã€Œå¼•ç”¨ï¼š(.*?)ã€\n([\s\S]*)/);
    if(qM) {
        let qd = document.createElement(`div`);
        qd.style.cssText = `background:rgba(0,0,0,0.05); padding:6px 10px; border-radius:6px; font-size:12px; margin-bottom:6px; color:#666; border-left:3px solid #ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;`;
        qd.innerText = qM[1];
        let span = document.createElement(`span`);
        span.innerText = qM[2];
        b.appendChild(qd); b.appendChild(span);
    } else { 
        b.innerText = txt;
    }
}




function mkBub(txt, side, isT=false) {
    let row = document.createElement(`div`);
    row.className = `msg-row ` + (side===`l`?`row-left`:`row-right`);
    if(isT) row.id = `thk`;
    let b = document.createElement(`div`); b.className = `bubble ` + (side===`l`?`bub-left`:`bub-right`);
    if(!isT) { renderQuoteBlock(b, txt); bindPress(b); } else { b.innerText = txt; }
    
    if(side===`l`) {
        let a = document.createElement(`div`);
        a.className = `ava-sm ava-l`;
        let img = ls.getItem(`aiI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        if(!isT) a.onclick = () => { stW.innerText=aiStatus.weather; stC.innerText=aiStatus.clothing; stA.innerText=aiStatus.action; stT.innerText=aiStatus.thought; modal.style.display=`flex`; };
        row.appendChild(a); row.appendChild(b);
    } else {
        row.appendChild(b);
        let a = document.createElement(`div`); a.className = `ava-sm ava-r`;
        let img = ls.getItem(`myI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        row.appendChild(a);
    }
    msgs.appendChild(row); msgs.scrollTop = msgs.scrollHeight;
}

function mkBubSync(txt, side) {
    let row = document.createElement(`div`);
    row.className = `msg-row ` + (side===`l`?`row-left`:`row-right`);
    let b = document.createElement(`div`); b.className = `bubble ` + (side===`l`?`bub-left`:`bub-right`); 
    renderQuoteBlock(b, txt); bindPress(b);
    if(side===`l`) {
        let a = document.createElement(`div`); a.className = `ava-sm ava-l`;
        let img = ls.getItem(`aiI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        a.onclick = () => { stW.innerText=aiStatus.weather; stC.innerText=aiStatus.clothing; stA.innerText=aiStatus.action; stT.innerText=aiStatus.thought; modal.style.display=`flex`; };
        row.appendChild(a); row.appendChild(b);
    } else {
        row.appendChild(b);
        let a = document.createElement(`div`); a.className = `ava-sm ava-r`;
        let img = ls.getItem(`myI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        row.appendChild(a);
    }
    msgs.appendChild(row);
}
function showTyping() {
    if($(`roomTitle`)) $(`roomTitle`).innerText = `å¯¹æ–¹æ­£åœ¨è¾“å…¥...`;
    if($(`roomStatus`)) $(`roomStatus`).style.display = `none`;
    if($(`roomSignature`)) $(`roomSignature`).style.display = `none`;
}
function rmThk() { 
    let t = $(`thk`); if(t) t.remove(); 
    if($(`rpTyping`)) $(`rpTyping`).remove();
    if($(`roomStatus`)) $(`roomStatus`).style.display = `flex`;
    if($(`roomSignature`)) $(`roomSignature`).style.display = `-webkit-box`;
    if(typeof applyVis === `function`) applyVis();
}
let stickerData = [];

localforage.getItem(`myPhoneStickers`).then(res =>{
    if(res) {
        stickerData = JSON.parse(res);
    } else if(ls.getItem(`myPhoneStickers`)) {
        stickerData = JSON.parse(ls.getItem(`myPhoneStickers`));
        localforage.setItem(`myPhoneStickers`, ls.getItem(`myPhoneStickers`));
    }
});

let isStickerEditMode = false;
let selectedStickers = new Set();
let isMenuDrawerOpen = false;
let currStickerTab = `all`;
let recentStickers = ls.getItem(`recentStickers`) ? JSON.parse(ls.getItem(`recentStickers`)) : [];

function toggleMenuDrawer(show) {
    let drawer = $(`newMenuDrawer`);
    if(drawer) {
        if(show) {
            drawer.classList.add(`show`);
            isMenuDrawerOpen = true;
            if(typeof toggleStickerDrawer === `function`) toggleStickerDrawer(false);
        } else {
            drawer.classList.remove(`show`);
            isMenuDrawerOpen = false;
        }
    }
}
$(`btnOpenSticker`).onclick = () =>{ toggleStickerDrawer(true); toggleMenuDrawer(false); };
$(`btnNewMenu`).onclick = () =>toggleMenuDrawer(!isMenuDrawerOpen);
iptMsg.onfocus = () =>{
    toggleMenuDrawer(false);
    if(typeof toggleStickerDrawer === `function`) toggleStickerDrawer(false);
};
iptMsg.onclick = () =>{
    toggleMenuDrawer(false);
    if(typeof toggleStickerDrawer === `function`) toggleStickerDrawer(false);
};


$(`btnRegenNew`).onclick = () =>{
    toggleMenuDrawer(false);
    if(history.length === 0) return;
    let last = history[history.length - 1];
    if(last.role === `assistant`) {
        history.pop();
        ls.setItem(`chatHistory`, JSON.stringify(history));
        redrawChat();
        $(`btnLemon`).click();
    } else { alert(`ä¸Šä¸€æ¡å¿…é¡»æ˜¯å¯¹æ–¹çš„å›å¤æ‰èƒ½é‡æ–°ç”Ÿæˆå“¦`); }
};

if(typeof msgs !== `undefined`) msgs.addEventListener(`click`, () =>{ if(isMenuDrawerOpen) toggleMenuDrawer(false); });

$(`btnCancelSticker`).onclick = () =>toggleStickerDrawer(false);


$(`stickerEditBtn`).onclick = () =>toggleStickerEditMode();
$(`btnAddBatchSticker`).onclick = () =>toggleBatchModal(true);
$(`btnUploadStickerClick`).onclick = () =>$(`stickerUploadInput`).click();
$(`btnCancelBatch`).onclick = () =>toggleBatchModal(false);
$(`btnConfirmBatch`).onclick = () =>confirmBatchStickers();
$(`stickerSearch`).oninput = () =>renderStickers();
$(`tabAllSticker`).onclick = () =>{ currStickerTab = `all`; $(`tabAllSticker`).className = `st-tab active`; $(`tabRecentSticker`).className = `st-tab`; renderStickers(); };
$(`tabRecentSticker`).onclick = () =>{ currStickerTab = `recent`; $(`tabRecentSticker`).className = `st-tab active`; $(`tabAllSticker`).className = `st-tab`; renderStickers(); };


$(`stickerUploadInput`).onchange = e =>{
    let file = e.target.files[0];
    if (!file) return;
    let name = file.name.split(".")[0];
    let reader = new FileReader();
    reader.onload = ev => {
        let img = new Image();
        img.onload = () => {
            let cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
            let w = img.width, h = img.height, maxW = 120, maxH = 120;
            if(w > h && w > maxW) { h *= maxW / w; w = maxW; } else if(h > maxH) { w *= maxH / h; h = maxH; }
            cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
            stickerData.push({ name: name, url: cvs.toDataURL("image/webp", 0.4) });
            localforage.setItem("myPhoneStickers", JSON.stringify(stickerData)).then(() => {
    renderStickers();
}).catch(err =>{
    stickerData.pop();
    alert("ç³»ç»Ÿæç¤ºï¼šå¤§ä»“åº“å†™å…¥å¤±è´¥ï¼");
});

        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
    e.target.value = "";
};



function toggleStickerDrawer(show) {
    let drawer = $(`stickerDrawer`);
    if (show) { drawer.classList.add(`show`); renderStickers(); } 
    else { 
        drawer.classList.remove(`show`); 
        isStickerEditMode = false; 
        selectedStickers.clear(); 
        $(`stickerEditBtn`).innerText = `ç¼–è¾‘`; 
        $(`btnDelSelectedSticker`).style.display = `none`; 
        $(`btnSelectAllSticker`).style.display = `none`; 
        $(`btnAddBatchSticker`).style.display = `inline`; 
        $(`btnUploadStickerClick`).style.display = `inline`; 
        $(`stickerSearch`).value = ``; 
    }
}

$(`btnSelectAllSticker`).onclick = () =>{
    if(selectedStickers.size === stickerData.length) selectedStickers.clear();
    else stickerData.forEach((_, i) => selectedStickers.add(i));
    renderStickers();
};

$(`btnDelSelectedSticker`).onclick = () =>{
    if(selectedStickers.size === 0) { alert(`è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…å“¦`); return; }
    if(confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ` + selectedStickers.size + ` ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
        stickerData = stickerData.filter((_, i) => !selectedStickers.has(i));
        ls.setItem(`myPhoneStickers`, JSON.stringify(stickerData));
        selectedStickers.clear(); renderStickers();
    }
};

window.deleteSticker = (event, index) =>{
    event.stopPropagation(); stickerData.splice(index, 1); ls.setItem(`myPhoneStickers`, JSON.stringify(stickerData));
    selectedStickers.clear(); renderStickers();
};

function sendSticker(url, name) {
    let t = `[å›¾ç‰‡æ¶ˆæ¯ï¼š` + url + `]\n(ç³»ç»Ÿæç¤ºï¼šæˆ‘å‘é€äº†ä¸€ä¸ªåä¸ºâ€œ` + name + `â€çš„è¡¨æƒ…åŒ…)`; 
    mkBub(t, `r`); history.push({role: `user`, content: t}); ls.setItem(`chatHistory`, JSON.stringify(history)); updateListPreview(); toggleStickerDrawer(false);
}

function renderStickers() {
    let grid = $(`stickerGrid`);
    let searchWord = $(`stickerSearch`).value.toLowerCase(); 
    grid.innerHTML = ``;
    let displayList = stickerData;
    if (currStickerTab === `recent`) {
        displayList = recentStickers.map(url => stickerData.find(s => s.url === url)).filter(Boolean);
        if (displayList.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#888;font-size:12px;margin-top:20px;">è¿˜æ²¡æœ‰ä½¿ç”¨è¿‡è¡¨æƒ…åŒ…å“¦</div>`;
            return;
        }
    }
    displayList.forEach((sticker) => {
        let index = stickerData.indexOf(sticker);
        if (sticker.name.toLowerCase().includes(searchWord)) {
            let item = document.createElement(`div`);
            let isSel = selectedStickers.has(index);
            item.className = "sticker-item" + (isStickerEditMode ? " edit-mode" : "");
            if(isStickerEditMode && isSel) item.style.border = "2px solid #ff4d4f";
            item.innerHTML = `<div class="sticker-delete-btn" onclick="deleteSticker(event, ${index})">Ã—</div><img src="${sticker.url}"><div class="name">${sticker.name}</div>`;
            item.onclick = e => {
                if(isStickerEditMode) {
                    if(selectedStickers.has(index)) selectedStickers.delete(index); else selectedStickers.add(index);
                    renderStickers();
                } else { 
                    sendSticker(sticker.url, sticker.name);
                    recentStickers = [sticker.url, ...recentStickers.filter(u => u !== sticker.url)].slice(0, 16);
                    ls.setItem(`recentStickers`, JSON.stringify(recentStickers));
                }
            };
            grid.appendChild(item);
        }
    });
}


function toggleStickerEditMode() {
    isStickerEditMode = !isStickerEditMode;
    if(!isStickerEditMode) selectedStickers.clear();
    $(`stickerEditBtn`).innerText = isStickerEditMode ? `å®Œæˆ` : `ç¼–è¾‘`;
    $(`btnDelSelectedSticker`).style.display = isStickerEditMode ? `inline` : `none`;
    $(`btnSelectAllSticker`).style.display = isStickerEditMode ? `inline` : `none`;
    $(`btnAddBatchSticker`).style.display = isStickerEditMode ? `none` : `inline`;
    $(`btnUploadStickerClick`).style.display = isStickerEditMode ? `none` : `inline`;
    renderStickers();
}

function toggleBatchModal(show) {
    let m = $(`batchModal`);
    if(show) {
        m.style.display = `flex`;
        $(`batchStickerInput`).value = ``;
    } else {
        m.style.display = `none`;
    }
}

function confirmBatchStickers() {
    let text = $(`batchStickerInput`).value;
    let lines = text.split(`\n`);
    let addedCount = 0;
    lines.forEach(line => {
        let str = line.trim();
        if(!str) return;
        let name = ``;
        let url = ``;
        let urlIdx = str.indexOf(`http`);
        if(urlIdx !== -1) {
            let prefix = str.substring(0, urlIdx).replace(/[ :ï¼š]+$/, ``).trim();
            url = str.substring(urlIdx).trim();
            if(prefix) name = prefix;
            else {
                let rawName = url.substring(url.lastIndexOf(`/`)+1).split(`.`)[0];
                try { rawName = decodeURIComponent(rawName); } catch(err) {}
                name = rawName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, ``);
            }
        } else {
            let parts = str.split(/\s+/);
            if(parts.length >= 2) { name = parts[0]; url = parts[1]; }
            else url = str;
        }
        if(!name) name = `è¡¨æƒ…` + Math.floor(Math.random()*1000);
        if(url) {
            stickerData.push({ name: name, url: url });
            addedCount++;
        }
    });
    
    try {
        ls.setItem(`myPhoneStickers`, JSON.stringify(stickerData));
        toggleBatchModal(false);
        renderStickers();
        if(addedCount > 0) alert(`æˆåŠŸæ·»åŠ  ` + addedCount + ` ä¸ªè¡¨æƒ…ï¼`);
    } catch(err) {
        for(let i=0; i<addedCount; i++) stickerData.pop();
        alert(`ç³»ç»Ÿæç¤ºï¼šå†…å­˜ç©ºé—´å·²æ»¡ï¼æ— æ³•æ·»åŠ æ–°è¡¨æƒ…ï¼Œè¯·å…ˆå»åˆ—è¡¨åˆ é™¤éƒ¨åˆ†æ—§è¡¨æƒ…ã€‚`);
    }
}



if(history.length>0) redrawChat();
if($(`navMsg`)) $(`navMsg`).onclick = () =>showScreen(`scrList`);
if($(`navContact`)) $(`navContact`).onclick = () =>showScreen(`scrContact`);
if($(`navMoment`)) $(`navMoment`).onclick = () =>alert(`ã€åŠ¨æ€ã€‘æ­£åœ¨å¼€å‘ä¸­...`);
if($(`navMe`)) $(`navMe`).onclick = () =>showScreen(`scrMe`);

if($(`navContactToMsg`)) $(`navContactToMsg`).onclick = () =>showScreen(`scrList`);
if($(`navContactToMoment`)) $(`navContactToMoment`).onclick = () =>alert(`ã€åŠ¨æ€ã€‘æ­£åœ¨å¼€å‘ä¸­...`);
if($(`navContactToMe`)) $(`navContactToMe`).onclick = () =>showScreen(`scrMe`);

if($(`navMeToMsg`)) $(`navMeToMsg`).onclick = () =>showScreen(`scrList`);
if($(`navMeToContact`)) $(`navMeToContact`).onclick = () =>showScreen(`scrContact`);
if($(`navMeToMoment`)) $(`navMeToMoment`).onclick = () =>alert(`ã€åŠ¨æ€ã€‘æ­£åœ¨å¼€å‘ä¸­...`);

if($(`btnMeBack`)) $(`btnMeBack`).onclick = () =>showScreen(`scrHome`);
if($(`btnContactBack`)) $(`btnContactBack`).onclick = () =>showScreen(`scrHome`);
if($("btnEditMe")) $("btnEditMe").onclick = () =>{

    $("iptMeName").value = $("cfgMyName").value || "ä½ çš„åå­—";
    $("iptMeBio").value = ls.getItem("myBio") || "";
    $("editMeModal").style.display = "flex";
};
if($("btnCancelEditMe")) $("btnCancelEditMe").onclick = () =>$("editMeModal").style.display ="none";
if($("btnSaveEditMe")) $("btnSaveEditMe").onclick = () =>{
    $("cfgMyName").value = $("iptMeName").value;
    ls.setItem("cMyN", $("iptMeName").value);
    ls.setItem("myBio", $("iptMeBio").value);
    applyVis();
    $("editMeModal").style.display = "none";
};
if($("btnSetMeAvatar")) $("btnSetMeAvatar").onclick = () =>$("upMeAvatar").click();
cmp("upMeAvatar","myI");




if($("btnHomeSpace")) $("btnHomeSpace").onclick = () =>showScreen("scrSpace");
if($("btnSpaceBack")) $("btnSpaceBack").onclick = () =>showScreen("scrHome");

if($("btnEditSpace")) $("btnEditSpace").onclick = () =>{
    $("iptMeName").value = $("cfgMyName").value || "ä½ çš„åå­—";
    $("iptMeBio").value = ls.getItem("myBio") || "";
    $("editMeModal").style.display = "flex";
};

if($("btnSpaceLogs")) $("btnSpaceLogs").onclick = () =>showScreen("scrLogList");
if($("btnLogListBack")) $("btnLogListBack").onclick = () =>showScreen("scrSpace");
if($("btnWriteLog")) $("btnWriteLog").onclick = () =>{
    $("logImgType").value = "none";
    $("logTextImgBlock").style.display = "none";
    $("logLocalImgBlock").style.display = "none";
    $("logImgDesc").value = "";
    $("logContent").value = "";
    $("logImgPreview").style.display = "none";
    showScreen("scrLogEdit");
};
if($("btnLogEditBack")) $("btnLogEditBack").onclick = () =>showScreen("scrLogList");

if($("logImgType")) {
    $("logImgType").onchange = function() {
        let v = this.value;
        $("logTextImgBlock").style.display = v === "text" ? "flex" : "none";
        $("logLocalImgBlock").style.display = v === "local" ? "flex" : "none";
    };
}

if($("btnSpaceBoard")) $("btnSpaceBoard").onclick = () =>alert("ã€ç•™è¨€æ¿ã€‘æ¨¡å—æ­£åœ¨æ‹¼è£…ä¸­...");
if($("btnSpaceMoments")) $("btnSpaceMoments").onclick = () =>alert("ã€æˆ‘çš„è¯´è¯´ã€‘æ¨¡å—æ­£åœ¨æ‹¼è£…ä¸­...");


let charStickers = [];
localforage.getItem(`charStickers`).then(res =>{
    if(res) charStickers = JSON.parse(res);
    else if(ls.getItem(`charStickers`)) {
        charStickers = JSON.parse(ls.getItem(`charStickers`));
        localforage.setItem(`charStickers`, ls.getItem(`charStickers`));
    }
});
let isCharStickerEdit = false;
let selCharStickers = new Set();


function renderCharStickers() {
    let list = $(`charStickerList`); list.innerHTML = ``;
    if(charStickers.length === 0) { list.innerHTML = `<div style=grid-column:1/-1;color:#888;font-size:12px;text-align:center;>AIå¤§è„‘é‡Œè¿˜æ²¡è¡¨æƒ…åŒ…ï¼Œå¿«å»æ‰¹é‡ä¸Šä¼ è°ƒæ•™TAå§ï¼</div>`; return; }
        charStickers.forEach((s, i) => {
        let div = document.createElement("div"); 
        div.className = "sticker-item" + (isCharStickerEdit ? " edit-mode" : "");
        if(isCharStickerEdit && selCharStickers.has(i)) div.style.border = "2px solid #ff4d4f";
        
        div.innerHTML = `<img src="${s.url}"><div class="name">${s.name}</div>`;
        div.onclick = () => {

            if(isCharStickerEdit) {
                if(selCharStickers.has(i)) selCharStickers.delete(i); else selCharStickers.add(i);
                renderCharStickers();
            }
        };
        list.appendChild(div);
    });
}

$(`btnEditCharSticker`).onclick = () =>{
    isCharStickerEdit = !isCharStickerEdit;
    $(`btnEditCharSticker`).innerText = isCharStickerEdit ? `å®Œæˆ` : `ç®¡ç†`;
    $(`charStickerActions`).style.display = isCharStickerEdit ? `flex` : `none`;
    selCharStickers.clear(); renderCharStickers();
};

$(`btnSelAllCharSticker`).onclick = () =>{
    if(selCharStickers.size === charStickers.length) selCharStickers.clear();
    else charStickers.forEach((_, i) => selCharStickers.add(i));
    renderCharStickers();
};

$(`btnDelCharSticker`).onclick = () =>{
    if(selCharStickers.size === 0) { alert(`è¯·å…ˆç‚¹å‡»å›¾ç‰‡é€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…ï¼`); return; }
    if(confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ` + selCharStickers.size + ` ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
        charStickers = charStickers.filter((_, i) => !selCharStickers.has(i));
        ls.setItem(`charStickers`, JSON.stringify(charStickers));
        selCharStickers.clear(); renderCharStickers();
    }
};

if($(`btnCharStickerBack`)) $(`btnCharStickerBack`).onclick = () =>{
    isCharStickerEdit = false; $(`btnEditCharSticker`).innerText = `ç®¡ç†`; $(`charStickerActions`).style.display = `none`; selCharStickers.clear();
    showScreen(`scrMe`);
};
if($(`btnGoCharSticker`)) $(`btnGoCharSticker`).onclick = () =>{ showScreen(`scrCharSticker`); renderCharStickers(); };

if($(`btnUpCharSticker`)) $(`btnUpCharSticker`).onclick = () =>$(`upCharSticker`).click();
if($(`upCharSticker`)) $(`upCharSticker`).onchange = e =>{
    let files = e.target.files;
    if(!files || files.length === 0) return;
    for(let i=0; i<files.length; i++) {
        let f = files[i];
        let rawName = f.name.split(".")[0];
        let name = rawName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, "");
        if(!name) name = "è¡¨æƒ…" + Math.floor(Math.random()*1000);
        
        let reader = new FileReader();
        reader.onload = ev => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
                let w = img.width, h = img.height, maxW = 120, maxH = 120;
                if(w > h && w > maxW) { h *= maxW / w; w = maxW; } else if(h > maxH) { w *= maxH / h; h = maxH; }
                cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
                
                charStickers.push({name: name, url: cvs.toDataURL("image/webp", 0.4)});
                try {
                    ls.setItem("charStickers", JSON.stringify(charStickers));
                    renderCharStickers();
                } catch(err) {
                    charStickers.pop();
                    alert("ç³»ç»Ÿæç¤ºï¼šå†…å­˜ä¾ç„¶å·²æ»¡ï¼è¯·å…ˆåˆ é™¤ä¸€äº›ä¸è¦çš„è¡¨æƒ…åŒ…ã€‚");
                }
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(f);
    }
    e.target.value = "";
};


if($("btnAddCharSticker")) $("btnAddCharSticker").onclick = () =>{
    let text = $("iptCharBatchUrl").value.trim();
    if(!text) return;
    let lines = text.split("\n");
    lines.forEach(line => {
        let str = line.trim();
        if(!str) return;
        let name = "";
        let url = "";
        let urlIdx = str.indexOf("http");
        if(urlIdx !== -1) {
            let prefix = str.substring(0, urlIdx).replace(/[ :ï¼š]+$/, "").trim();
            url = str.substring(urlIdx).trim();
            if(prefix) name = prefix;
            else {
                let rawName = url.substring(url.lastIndexOf("/")+1).split(".")[0];
                try { rawName = decodeURIComponent(rawName); } catch(err) {}
                name = rawName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, "");
            }
        } else {
            let parts = str.split(/\s+/);
            if(parts.length >= 2) { name = parts[0]; url = parts[1]; }
            else url = str;
        }
        if(!name) name = "è¡¨æƒ…" + Math.floor(Math.random()*1000);
        if(url) charStickers.push({ name: name, url: url });
    });
    try {
        ls.setItem("charStickers", JSON.stringify(charStickers));
        $("iptCharBatchUrl").value = "";
        renderCharStickers();
        alert("ç½‘ç»œè¡¨æƒ…å·²æ‰¹é‡å¯¼å…¥ï¼");
    } catch(err) {
        alert("ç³»ç»Ÿæç¤ºï¼šå†…å­˜å·²æ»¡ï¼å¯¼å…¥å¤±è´¥ã€‚è¯·å…ˆåˆ é™¤ä¸€äº›å¤šä½™å›¾ç‰‡ã€‚");
    }
};


// ===== ä¸“å±æ—¥å¿—ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ =====
let logsData = [];
localforage.getItem("myLogs").then(res =>{
    if(res) logsData = JSON.parse(res);
    else if(ls.getItem("myLogs")) {
        logsData = JSON.parse(ls.getItem("myLogs"));
        localforage.setItem("myLogs", ls.getItem("myLogs"));
    }
    // æ¬è¿å®Œæ¯•åï¼Œå½»åº•æ¸…ç©ºè€å†…å­˜é‡Œå åœ°æ–¹çš„å¤§ä»¶åƒåœ¾ï¼
    setTimeout(() => {
        localStorage.removeItem("myPhoneStickers");
        localStorage.removeItem("charStickers");
        localStorage.removeItem("myLogs");
    }, 1500);
});

let currLogTab ="me";
let tempLogImgUrl ="";

// ä¿®å¤å†™æ—¥å¿—æŒ‰é’®ï¼Œæ¯æ¬¡ç‚¹å¼€è‡ªåŠ¨æ¸…ç©ºä¸Šä¸€æ¬¡æ®‹ç•™çš„å›¾ç‰‡
if($("btnWriteLog")) {
    $("btnWriteLog").onclick = () => {
        $("logImgType").value = "none";
        $("logTextImgBlock").style.display = "none";
        $("logLocalImgBlock").style.display = "none";
        $("logImgDesc").value = "";
        $("logContent").value = "";
        $("logImgPreview").style.display = "none";
        tempLogImgUrl = ""; 
        showScreen("scrLogEdit");
    };
}

// ç»‘å®šé¡¶éƒ¨åŒè·¯æ ‡ç­¾é¡µçš„åˆ‡æ¢åŠ¨ä½œ
if($("tabMyLogs")) {
    $("tabMyLogs").onclick = () => {
        currLogTab = "me";
        $("tabMyLogs").className = "log-tab log-tab-active";
        $("tabAiLogs").className = "log-tab";
        renderLogs();
    };
}
if($("tabAiLogs")) {
    $("tabAiLogs").onclick = () => {
        currLogTab = "ai";
        $("tabAiLogs").className = "log-tab log-tab-active";
        $("tabMyLogs").className = "log-tab";
        renderLogs();
    };
}

// å¤„ç†æœ¬åœ°å›¾ç‰‡çš„å‹ç¼©ä¸ä¸´æ—¶å­˜å‚¨
if($("btnSelectLogImg")) $("btnSelectLogImg").onclick = () =>$("upLogImg").click();
if($("upLogImg")) {
    $("upLogImg").onchange = e => {
        let f = e.target.files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = ev => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
                let w = img.width, h = img.height, max = 350;
                if(w > h && w > max) { h *= max/w; w = max; } else if(h > max) { w *= max/h; h = max; }
                cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
                tempLogImgUrl = cvs.toDataURL("image/webp", 0.5);
                $("logImgPreview").src = tempLogImgUrl;
                $("logImgPreview").style.display = "block";
            };
            img.src = ev.target.result;
        }; r.readAsDataURL(f);
        e.target.value = "";
    };
}


// æ ¸å¿ƒï¼šå‘è¡¨æ—¥å¿—å¹¶å­˜å…¥æœ¬åœ°æ•°æ®åº“
if($("btnPublishLog")) {
    $("btnPublishLog").onclick = () => {
        let type = $("logImgType").value;
        let desc = $("logImgDesc").value.trim();
        let content = $("logContent").value.trim();
        
        if(!content) { alert("å†™ç‚¹ä»€ä¹ˆå†å‘è¡¨å§ï¼"); return; }
        if(type === "text" && !desc) { alert("è„‘è¡¥æ¨¡å¼éœ€è¦å‘AIæè¿°ç”»é¢å†…å®¹å“¦ï¼"); return; }
        if(type === "local" && !tempLogImgUrl) { alert("å¸¸è§„æ¨¡å¼éœ€è¦å…ˆé€‰æ‹©æœ¬åœ°å›¾ç‰‡å“¦ï¼"); return; }

        logsData.push({
            id: Date.now(),
            author: "me",
            date: updTime().toLocaleString(),
            imgType: type,
            imgDesc: desc,
            imgUrl: type === "local" ? tempLogImgUrl : "",
            content: content,
            comments: []
        });
        ls.setItem("myLogs", JSON.stringify(logsData));
        alert("æ—¥å¿—å‘è¡¨æˆåŠŸï¼");
        showScreen("scrLogList");
        currLogTab = "me";
        $("tabMyLogs").className = "log-tab log-tab-active";
        $("tabAiLogs").className = "log-tab";
        renderLogs();
    };
}

// æ ¸å¿ƒï¼šåŠ¨æ€æ¸²æŸ“æ—¥å¿—åˆ—è¡¨é¢æ¿ä¸AIç”Ÿæˆé€»è¾‘
let currLogCharId = `default`;
window.switchLogChar = function(id) { currLogCharId = id; renderLogs(); };
window.deleteLog = function(id) {
    if(confirm(`ç¡®å®šåˆ é™¤è¿™ç¯‡æ—¥å¿—å—ï¼Ÿ`)) { 
        logsData = logsData.filter(x => x.id !== id); 
        ls.setItem(`myLogs`, JSON.stringify(logsData)); 
        renderLogs(); 
    }
};
window.editLogText = function(id) {
    let log = logsData.find(x => x.id === id);
    if(!log) return;
    let overlay = document.createElement(`div`);
    overlay.className = `modal-base`;
    overlay.style.display = `flex`;
    overlay.style.zIndex = `300`;
    overlay.innerHTML = `<div class=modal-ctx><div class=modal-hdr><span>ä¿®æ”¹æ—¥å¿—</span></div><div class=modal-bdy style=padding:15px;><textarea id=tmpEditLogText class=textarea-field style=height:200px;width:100%;box-sizing:border-box;></textarea><div class=flex-row style=margin-top:15px;><button id=tmpCancelEditLog class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button><button id=tmpSaveEditLog class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ä¿å­˜</button></div></div></div>`;
    document.body.appendChild(overlay);
    document.getElementById(`tmpEditLogText`).value = log.content;
    document.getElementById(`tmpCancelEditLog`).onclick = () => overlay.remove();
    document.getElementById(`tmpSaveEditLog`).onclick = () => {
        let n = document.getElementById(`tmpEditLogText`).value.trim();
        if(n) {
            log.content = n; 
            ls.setItem(`myLogs`, JSON.stringify(logsData)); 
            renderLogs();
        }
        overlay.remove();
    };
};

window.activeReplyTarget = null;
window.showToast = function(msg) {
    if($(`sysToast`)) $(`sysToast`).remove();
    let t = document.createElement(`div`);
    t.id = `sysToast`;
    t.innerText = msg;
    t.style.cssText = `position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.8); color:white; padding:12px 24px; border-radius:8px; z-index:9999; font-size:14px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.3);`;
    document.body.appendChild(t);
    setTimeout(() => { if($(`sysToast`)) $(`sysToast`).remove(); }, 5000);
};
window.hideToast = function() {
    if($(`sysToast`)) $(`sysToast`).remove();
};

window.openReplyBox = function(logId, tName) {
    activeReplyTarget = {logId: logId, targetName: tName};
    renderLogs();
};

window.submitReply = async function(logId, targetName, charName) {
    let input = $(`replyInput_` + logId);
    if(!input || !input.value.trim()) return;
    let txt = input.value.trim();
    activeReplyTarget = null;

    let log = logsData.find(x => x.id === logId);
    if(!log) return;
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    if(!log.comments) log.comments = [];

    if(targetName === charName && !log.comments.find(c => c.name === targetName)) {
        log.comments.push({name: myN, content: txt});
    } else {
        log.comments.push({name: myN, content: `å›å¤ ` + targetName + `ï¼š` + txt});
    }
    ls.setItem(`myLogs`, JSON.stringify(logsData));
    renderLogs();

    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) return;

    showToast(`å¯¹æ–¹æ­£åœ¨å›å¤ä¸­...`);

    let histStr = log.comments.map(c => c.name + `ï¼š` + c.content).join(`\n`);
    let sys = ``;
    if (targetName === charName) {
         sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charName}ã€‚è¿™æ˜¯ä¸€ç¯‡ç¤¾äº¤å¹³å°åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nç›®å‰çš„è¯„è®ºåŒºè®°å½•ï¼š\n${histStr}\n\nç©å®¶ï¼ˆ${myN}ï¼‰åˆšåˆšå›å¤äº†ä½ ã€‚è¯·ä½ ä»¥${charName}çš„èº«ä»½å›å¤${myN}ï¼Œè¯­æ°”ç¬¦åˆæ€§æ ¼è®¾å®šã€‚è¦æ±‚ï¼šä½ å¯ä»¥å®Œç¾è¯†åˆ«ç©å®¶å‘é€çš„emojiã€‚è¯·ä¸¥æ ¼æ ¹æ®ä½ çš„æ€§æ ¼è®¾å®šå†³å®šæ˜¯å¦åœ¨å›å¤ä¸­ä½¿ç”¨emojiè¡¨æƒ…ä»¥åŠé¢‘ç‡ï¼ˆæ´»æ³¼å¼€æœ—å¯å¤šç”¨ï¼Œé«˜å†·ä¸¥è°¨è¯·å°‘ç”¨æˆ–ç»å¯¹ä¸ç”¨ï¼‰ã€‚ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼Œä¸è¦å¸¦å‰ç¼€å’Œä»»ä½•ä¿®é¥°ç¬¦å·ã€‚`;
    } else {
         sys = `è¿™æ˜¯ä¸€ç¯‡ç¤¾äº¤å¹³å°åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nç›®å‰çš„è¯„è®ºåŒºè®°å½•ï¼š\n${histStr}\n\nç©å®¶ï¼ˆ${myN}ï¼‰åˆšåˆšå›å¤äº†ä½ çš„è¯„è®ºã€‚è¯·ä½ æ‰®æ¼”ç½‘å‹ã€Œ${targetName}ã€å›å¤${myN}ï¼Œè¡¨ç°å‡ºç¬¦åˆè¯¥ç½‘å‹è®¾å®šçš„è‡ªç„¶è¯­æ°”ã€‚ä½ å¯ä»¥è¯†åˆ«ç©å®¶çš„emojiï¼Œå¹¶æ ¹æ®æ€§æ ¼é€‚åº¦ä½¿ç”¨emojiã€‚ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼Œä¸è¦å¸¦å‰ç¼€å’Œä»»ä½•ä¿®é¥°ç¬¦å·ã€‚`;
    }

    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
        });
        let dat = await res.json();
        hideToast();
        if(dat.choices && dat.choices.length > 0) {
            let reply = dat.choices[0].message.content.trim();
            let replierName = targetName === charName ? charName : targetName;
            log.comments.push({name: replierName, content: `å›å¤ ` + myN + `ï¼š` + reply});
            ls.setItem(`myLogs`, JSON.stringify(logsData));
            renderLogs();
        }
    } catch(e) { hideToast(); console.error(e); }
};

window.summonComments = async function(id, charName, btnEl) {
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) { alert(`è¯·å…ˆåœ¨ç½‘ç»œé…ç½®ä¸­å¡«å†™æ¥å£å’Œå¯†é’¥ã€‚`); return; }
    
    let log = logsData.find(x => x.id === id);
    if(!log) return;

    let origText = btnEl.innerText;
    btnEl.innerText = `å¬å”¤ä¸­...`;
    btnEl.style.pointerEvents = `none`;
    
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    let sys = ``;
    if(log.author === `me`) {
        sys = `ç©å®¶ï¼ˆåå­—ï¼š${myN}ï¼‰åœ¨ç¤¾äº¤å¹³å°å‘å¸ƒäº†åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nè¯·ä½ æ‰®æ¼”3ä¸ªä¸åŒçš„è®¿å®¢ç»™è¿™æ¡åŠ¨æ€å†™è¯„è®ºã€‚å…¶ä¸­å¿…é¡»æœ‰1æ¡æ¥è‡ªè§’è‰²ã€Œ${charName}ã€çš„è¯„è®ºï¼ˆç¬¦åˆTAçš„æ€§æ ¼ï¼‰ï¼Œå¦å¤–2æ¡æ¥è‡ªæ™®é€šç½‘å‹æˆ–åŒå­¦ï¼ˆéšæœºèµ·ä¸ªçœŸå®çš„ç½‘åï¼‰ã€‚\nè­¦å‘Šï¼šè¯„è®ºè€…çš„åå­—ç»å¯¹ä¸èƒ½æ˜¯â€œ${myN}â€ã€‚\nè¦æ±‚ï¼šå¯ä»¥è¯†åˆ«åŠ¨æ€ä¸­çš„emojiã€‚è¯·æ ¹æ®æ¯ä¸ªè¯„è®ºè€…çš„æ€§æ ¼ä¸¥æ ¼æ§åˆ¶æ˜¯å¦ä½¿ç”¨emojiï¼ˆé«˜å†·ä¸¥è°¨ç»å¯¹ä¸ç”¨ï¼Œæ´»æ³¼å¼€æœ—å¯ä»¥å¤šç”¨ï¼‰ã€‚\nå¿…é¡»è¿”å›ä¸¥æ ¼çš„çº¯JSONæ•°ç»„æ ¼å¼ï¼š\n[{"name":"åå­—","content":"å†…å®¹"}]`;
    } else {
        sys = `è§’è‰²ï¼ˆåå­—ï¼š${charName}ï¼‰åœ¨ç¤¾äº¤å¹³å°å‘å¸ƒäº†åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nè¯·ä½ æ‰®æ¼”3ä¸ªä¸åŒçš„è®¿å®¢ï¼ˆæ¯”å¦‚åŒå­¦ã€è·¯äººç½‘å‹ã€å…±åŒå¥½å‹ç­‰ï¼Œè¯·ç»™ä»–ä»¬éšæœºèµ·çœŸå®çš„ç½‘åæˆ–æ˜µç§°ï¼‰ç»™è¿™æ¡åŠ¨æ€å†™è¯„è®ºã€‚\næåº¦é‡è¦è­¦å‘Šï¼š\n1. è¿™æ¡åŠ¨æ€çš„ä½œè€…æ˜¯${charName}ï¼è¯„è®ºå†…å®¹å¿…é¡»æ˜¯å¯¹${charName}è¯´çš„è¯ï¼Œç»å¯¹ä¸èƒ½æŠŠä½œè€…è¯¯è®¤ä¸ºæ˜¯${myN}ï¼\n2. è¯„è®ºè€…çš„åå­—ç»å¯¹ä¸èƒ½æ˜¯â€œ${charName}â€æœ¬äººï¼Œä¹Ÿç»å¯¹ä¸èƒ½æ˜¯â€œ${myN}â€ï¼\nè¦æ±‚ï¼šæ ¹æ®æ¯ä¸ªè®¿å®¢çš„æ€§æ ¼æ§åˆ¶emojiçš„ä½¿ç”¨é¢‘ç‡ã€‚\nå¿…é¡»è¿”å›ä¸¥æ ¼çš„çº¯JSONæ•°ç»„æ ¼å¼ï¼š\n[{"name":"åå­—","content":"å†…å®¹"}]`;
    }

    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
        });
        let dat = await res.json();
        if(dat.choices && dat.choices.length > 0) {
            let text = dat.choices[0].message.content.trim();
            text = text.replace(/```json/g, ``).replace(/```/g, ``).trim();
            let newComments = JSON.parse(text);
            if(!log.comments) log.comments = [];
            log.comments = log.comments.concat(newComments);
            ls.setItem(`myLogs`, JSON.stringify(logsData));
            renderLogs();
        } else { alert(`å¬å”¤å¤±è´¥ï¼Œæ¥å£è¿”å›å¼‚å¸¸ã€‚`); btnEl.innerText = origText; btnEl.style.pointerEvents = `auto`; }
    } catch(e) { 
        console.error(e); alert(`ç½‘ç»œæ³¢åŠ¨æˆ–å¤§æ¨¡å‹æ ¼å¼è§£æé”™è¯¯ï¼Œå†ç‚¹ä¸€æ¬¡è¯•è¯•çœ‹ï¼`); 
        btnEl.innerText = origText; btnEl.style.pointerEvents = `auto`; 
    }
};


function renderLogs() {
    let container = $(`logListContainer`);
    if(!container) return;
    container.innerHTML = ``;
    let tipHtml = `<div style="text-align:center; padding:8px 15px; background:#fff9e6; color:#d35400; font-size:12px; margin-bottom:10px; cursor:pointer; border-bottom:1px solid #fdebd0;" onclick="showCustomText('ã€ç©æ³•æç¤ºã€‘\\nè¿™é‡Œçš„æ—¥å¿—ç›¸å½“äºå‘åœ¨å…¬å¼€ç©ºé—´çš„åŠ¨æ€å“¦ï¼\\nè§’è‰²ä»¬éƒ½ä¼šæŠ«ç€ç¤¾äº¤é©¬ç”²ï¼Œä¿æŒè‡ªå·±çš„äººè®¾ä¼ªè£…ï¼Œä¸ä¼šæŠŠæœ€æ·±å±‚çš„å¿ƒé‡Œè¯ç›´æ¥è¯´å‡ºæ¥ã€‚\\n\\nçœŸæ­£çš„ã€ç§å¯†æ—¥è®°ã€‘åŠŸèƒ½æ­£åœ¨å…¨åŠ›å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼')">â“ è¿™é‡Œçš„æ—¥å¿—å’Œç§å¯†æ—¥è®°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ(ç‚¹å‡»æŸ¥çœ‹)</div>`;

    container.innerHTML += tipHtml;
    
    let activeChar = $(`cfgName`).value || `ä¸“å±æ‹äºº`;
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    let myAva = ls.getItem(`myI`) || ``;
    let aiAva = originalGetItem.call(ls, `aiI_` + currLogCharId) || originalGetItem.call(ls, `aiI`) || ``;
    let npcAva = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23eee'/><text x='50%' y='50%' font-size='40' text-anchor='middle' dy='.3em' fill='%23999'>ğŸ‘¤</text></svg>`;

    function getAva(name, activeCharN) {
        if (name === myN) return myAva ? `<img src="${myAva}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid #eee;">` : `<div style="width:28px;height:28px;border-radius:50%;background:#eee;display:flex;justify-content:center;align-items:center;font-size:14px;flex-shrink:0;">ğŸ‘¤</div>`;
        if (name === activeCharN) return aiAva ? `<img src="${aiAva}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid #eee;">` : `<div style="width:28px;height:28px;border-radius:50%;background:#eee;display:flex;justify-content:center;align-items:center;font-size:14px;flex-shrink:0;">ğŸ‘¤</div>`;
        return `<img src="${npcAva}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid #eee;">`;
    }
    
    if(currLogTab === `ai`) {
        let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
        let allChars = [{id: `default`, name: originalGetItem.call(ls, `cN_default`) || originalGetItem.call(ls, `cN`) || `ä¸“å±æ‹äºº`}];
        contacts.forEach(c => allChars.push({id: c.id, name: originalGetItem.call(ls, `cN_` + c.id) || c.name}));
        
        if (!allChars.find(x => String(x.id) === String(currLogCharId))) currLogCharId = currentChatId || `default`;
        activeChar = allChars.find(x => String(x.id) === String(currLogCharId)).name;
        
        let selHtml = `<div style="padding:10px 15px; border-bottom:1px solid #eee; background:#fff;"><select class="input-field" style="width:100%; font-weight:bold; color:#6c5ce7; background:#eef2ff; border:1px solid #c7d2fe; outline:none;" onchange="switchLogChar(this.value)">`;
        allChars.forEach(c => {
            let isSel = String(c.id) === String(currLogCharId) ? `selected` : ``;
            selHtml += `<option value="${c.id}" ${isSel}>${c.name}</option>`;
        });
        selHtml += `</select></div>`;
        container.innerHTML += selHtml;
    }

    let filterLogs = logsData.filter(x => x.author === currLogTab);
    if(currLogTab === `ai`) {
        filterLogs = filterLogs.filter(x => x.charName === activeChar);
        container.innerHTML += `<div style="text-align:center; padding:15px; flex-shrink:0;"><button id="btnGenAiLog" class="save-btn" style="padding:10px 15px; font-size:13px; width:auto; display:inline-block;">âœ¨ è®© ${activeChar} æ ¹æ®è¿‘æœŸè®°å¿†å†™ä¸€ç¯‡æ–°æ—¥å¿—</button></div>`;
    }
    
    if(filterLogs.length === 0) {
        container.innerHTML += `<div style="text-align:center; color:#888; font-size:13px; margin-top:30px;">è¿˜æ²¡æœ‰å†™è¿‡æ—¥å¿—å“¦~</div>`;
    }

        filterLogs.slice().reverse().forEach(log => {
        let card = document.createElement(`div`); card.className = `log-card`;
        let imgHtml = ``;
        if(log.imgType === `text`) {
            imgHtml = `<div class="log-placeholder-img">è„‘è¡¥ç”»é¢ï¼š${log.imgDesc}</div>`;
        } else if(log.imgType === `local` && log.imgUrl) {
            imgHtml = `<img src="${log.imgUrl}" class="log-real-img">`;
        }
        
        let commentsHtml = ``;
        if(log.comments && log.comments.length > 0) {
            commentsHtml = `<div style="margin-top:10px; padding:12px; background:#f8f9fa; border-radius:12px; font-size:12px; display:flex; flex-direction:column; gap:12px;">`;
            log.comments.forEach(c => {
                let nColor = c.name === myN ? `#0984e3` : `#6c5ce7`;
                let replyBtn = c.name !== myN ? `<span onclick="openReplyBox(${log.id}, '${c.name}')" style="margin-left:8px; color:#a4b0be; cursor:pointer; font-size:11px; text-decoration:underline;">å›å¤</span>` : ``;
                let avaHtml = getAva(c.name, activeChar);
                commentsHtml += `<div style="display:flex; align-items:flex-start; gap:10px;">${avaHtml}<div style="flex:1; line-height:1.5;"><span style="font-weight:bold; color:${nColor};">${c.name}ï¼š</span><span style="color:#2f3542;">${c.content}</span>${replyBtn}</div></div>`;
            });
            commentsHtml += `</div>`;
        }

        let replyBoxHtml = ``;
        if(activeReplyTarget && activeReplyTarget.logId === log.id) {
            replyBoxHtml = `
            <div style="margin-top:10px; display:flex; gap:8px; background:#eef2ff; padding:10px; border-radius:12px; align-items:center;">
                <input type="text" id="replyInput_${log.id}" placeholder="å›å¤ ${activeReplyTarget.targetName}..." style="flex:1; border:1px solid #c7d2fe; border-radius:15px; padding:8px 12px; font-size:12px; outline:none;">
                <button onclick="submitReply(${log.id}, '${activeReplyTarget.targetName}', '${activeChar}')" style="background:#6c5ce7; color:white; border:none; border-radius:15px; padding:8px 15px; font-size:12px; cursor:pointer; font-weight:bold;">å‘é€</button>
                <button onclick="activeReplyTarget=null; renderLogs();" style="background:#dfe4ea; color:#2f3542; border:none; border-radius:15px; padding:8px 15px; font-size:12px; cursor:pointer; font-weight:bold;">å–æ¶ˆ</button>
            </div>`;
        }

        let writeBtnHtml = log.author === `ai` ? `<span onclick="openReplyBox(${log.id}, '${activeChar}')" style="font-size:13px; color:#0984e3; cursor:pointer; font-weight:bold;">å†™è¯„è®º</span>` : ``;

        let logAuthorName = log.author === `me` ? myN : log.charName;
        let authorAvaHtml = getAva(logAuthorName, activeChar);

        card.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                ${authorAvaHtml}
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; font-size:14px; color:#2c3e50;">${logAuthorName}</span>
                    <span class="log-card-time" style="margin:0; font-size:11px; color:#95a5a6;">${log.date}</span>
                </div>
            </div>
            ${imgHtml}
            <div class="log-card-content">${log.content.replace(/\n/g, `<br>`)}</div>
            ${commentsHtml}
            ${replyBoxHtml}
            <div style="display:flex; justify-content:flex-end; align-items:center; gap:15px; margin-top:12px; border-top:1px dashed #eee; padding-top:12px;">
                ${writeBtnHtml}
                <span onclick="editLogText(${log.id})" style="font-size:13px; color:#6c5ce7; cursor:pointer; font-weight:bold;">ç¼–è¾‘</span>
                <span onclick="deleteLog(${log.id})" style="font-size:13px; color:#ff7675; cursor:pointer; font-weight:bold;">åˆ é™¤</span>
                <div class="log-summon-btn" onclick="summonComments(${log.id}, '${activeChar}', this)" style="margin:0;">å¬å”¤è¯„è®º</div>
            </div>
        `;
        container.appendChild(card);
    });

    
    if($(`btnGenAiLog`)) $(`btnGenAiLog`).onclick = () => generateAiLog(activeChar);
}




async function generateAiLog(charN) {
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) { alert(`è¯·å…ˆåœ¨ç½‘ç»œé…ç½®ä¸­å¡«å†™æ¥å£å’Œå¯†é’¥ã€‚`); return; }
    
    $(`btnGenAiLog`).innerText = `TAæ­£åœ¨æ„æ€ç©ºé—´åŠ¨æ€...`;
    
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    let sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charN}ã€‚è¯·ä½ æ ¹æ®æœ€è¿‘çš„èŠå¤©è®°å½•å’Œè®°å¿†åº“ï¼Œå†™ä¸€ç¯‡å‘å¸ƒåœ¨å…¬å¼€ç¤¾äº¤å¹³å°ï¼ˆç±»ä¼¼ç©ºé—´æ—¥å¿—ï¼‰çš„é•¿ç¯‡åŠ¨æ€ã€‚
è¦æ±‚ï¼š
1. è¯­æ°”å¿…é¡»å®Œå…¨ç¬¦åˆä½ çš„æ€§æ ¼è®¾å®šã€‚å› ä¸ºæ˜¯å…¬å¼€å¹³å°ï¼Œä½ ä¼šæœ‰ç¬¦åˆäººè®¾çš„ç¤¾äº¤ä¼ªè£…ã€‚
2. ä½ å¯ä»¥å®Œç¾è¯†åˆ«è¿‘æœŸèŠå¤©è®°å½•é‡Œçš„emojiã€‚åœ¨å†™è¿™ç¯‡åŠ¨æ€æ—¶ï¼Œè¯·å¿…é¡»ä¸¥æ ¼æ ¹æ®ä½ çš„æ€§æ ¼è®¾å®šæ¥å†³å®šæ˜¯å¦ä½¿ç”¨emojiè¡¨æƒ…ä»¥åŠä½¿ç”¨é¢‘ç‡ï¼ˆä¾‹å¦‚ï¼šæ´»æ³¼å¼€æœ—çš„æ€§æ ¼å¯ä»¥å¤šç”¨emojiï¼Œé«˜å†·ä¸¥è°¨çš„æ€§æ ¼è¯·å°‘ç”¨æˆ–ç»å¯¹ä¸ç”¨emojiï¼‰ã€‚
3. å†…å®¹å¯ä»¥æåŠè¿‘æœŸçš„äº‹ï¼Œå¯ä»¥æš—æˆ³æˆ³æåˆ°${myN}ã€‚
4. ä¸¥æ ¼åªè¾“å‡ºåŠ¨æ€æ­£æ–‡ã€‚å­—æ•°å¿…é¡»åœ¨150å­—åˆ°300å­—ä¹‹é—´ï¼Œè¯·å†™å¾—è¯¦ç»†ä¸°å¯Œä¸€äº›ï¼Œä¸è¦åƒçŸ­è¯´è¯´ä¸€æ ·ç®€ç•¥ã€‚`;

    let specHistStr = originalGetItem.call(ls, `chatHistory_${currLogCharId}`) || originalGetItem.call(ls, `chatHistory`);
    let specHist = specHistStr ? JSON.parse(specHistStr) : [];
    if(currLogCharId === currentChatId) specHist = history;

    let specMemStr = originalGetItem.call(ls, `memories_${currLogCharId}`) || originalGetItem.call(ls, `memories`);
    let specMem = specMemStr ? JSON.parse(specMemStr) : [];

    let recentChat = specHist.slice(-15).map(m => (m.role === `user` ? myN : charN) + `:` + m.content).join(`\n`);
    let memData = specMem.slice(-5).map(m => m.content).join(`\n`);
    sys += `\n\nã€è¿‘æœŸè®°å¿†ã€‘ï¼š\n${memData}\n\nã€è¿‘æœŸèŠå¤©è®°å½•ã€‘ï¼š\n${recentChat}`;
    
    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, 
            headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
        });
        let dat = await res.json();
        if(dat.choices && dat.choices.length > 0) {
            let text = dat.choices[0].message.content.trim();
            logsData.push({
                id: Date.now(),
                author: `ai`,
                charName: charN,
                date: updTime().toLocaleString(),
                imgType: `none`,
                imgDesc: ``,
                imgUrl: ``,
                content: text,
                comments: []
            });
            ls.setItem(`myLogs`, JSON.stringify(logsData));
            alert(`TAçš„æ—¥å¿—å†™å®Œå•¦ï¼`);
            renderLogs();
        } else { alert(`æ¥å£è¿”å›å¼‚å¸¸ï¼ŒTAå†™æ—¥å¿—å¤±è´¥äº†ã€‚`); }
    } catch(e) { alert(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®ã€‚`); }
    if($(`btnGenAiLog`)) $(`btnGenAiLog`).innerText = `âœ¨ è®© ${charN} æ ¹æ®è¿‘æœŸè®°å¿†å†™ä¸€ç¯‡æ–°æ—¥å¿—`;
}




// ä¿è¯æ¯æ¬¡ä»ä¸»é¡µç‚¹è¿›æ—¥å¿—æœ¬æ—¶ï¼Œç”»é¢éƒ½æ˜¯æœ€æ–°çŠ¶æ€
if($("btnSpaceLogs")) {
    let oldClick = $("btnSpaceLogs").onclick;
    $("btnSpaceLogs").onclick = () => {
        if(oldClick) oldClick();
        renderLogs();
    };
}
// === æ ¸å¿ƒå¼ºåŒ–ï¼šå¤šé€‰äº¤äº’ä¸è‡ªåŠ¨æ€»ç»“ä¿®å¤ ===
let isMultiSelectMode = false;
let selectedMsgs = new Set();


function enterMultiSelectMode(initialIdx) {
    isMultiSelectMode = true;
    selectedMsgs.clear();
    selectedMsgs.add(initialIdx);
    let hdr = document.querySelector("#scrRoom .room-header");
    hdr.innerHTML = `
        <span onclick="exitMultiSelectMode()" style="color:#333; cursor:pointer; font-size:16px; font-weight:bold; flex:1;">å–æ¶ˆ</span>
        <span id="roomTitle" style="font-weight:bold; font-size:16px; color:#333; flex:2; text-align:center;">å·²é€‰ 1 æ¡</span>
        <div style="display:flex; gap:15px; flex:1; justify-content:flex-end;">
            <span onclick="saveSelectedToFav()" style="color:#1890ff; cursor:pointer; font-size:16px; font-weight:bold;">æ”¶è—</span>
            <span onclick="deleteSelectedMsgs()" style="color:#ff4d4f; cursor:pointer; font-size:16px; font-weight:bold;">åˆ é™¤</span>
        </div>
    `;
    renderMultiSelectVisuals();
}



function exitMultiSelectMode() {
    isMultiSelectMode = false;
    selectedMsgs.clear();
        let hdr = document.querySelector("#scrRoom .room-header");
    let dn = $("cfgRem").value || $("cfgName").value || "ä¸“å±æ‹äºº";
    hdr.innerHTML = `
        <span id="btnRoomBack" class="back-btn">ï¼œ</span>
                <div id="roomTitleContainer" class="room-center" style="display:flex; flex-direction:column; align-items:center; line-height:1.2;">
            <div style="display:flex; align-items:center; gap:6px;">
                <span id="roomTitle" style="font-weight:bold; font-size:16px; color:#333;">${dn}</span>
                <div id="roomStatus" class="role-status" style="font-size:11px; transform:scale(0.9);"></div>
            </div>
            <div id="roomSignature" style="font-size:11px; color:#a29bfe; margin-top:8px; max-width:220px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-all;"></div>
        </div>

        <span id="btnRoomSet" class="settings-btn">âš™ï¸</span>
    `;
    $("btnRoomBack").onclick = () => { showScreen("scrList"); updateListPreview(); };

    $("btnRoomSet").onclick = () => showScreen("scrSetChat");
    if(typeof applyVis === 'function') applyVis();
    renderMultiSelectVisuals();
}


function deleteSelectedMsgs() {
    if(selectedMsgs.size === 0) return;
    if(confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ` + selectedMsgs.size + ` æ¡ä¿¡æ¯å—ï¼Ÿ`)) {
        let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
        let targetsToDelete = [];
        selectedMsgs.forEach(idx => {
            let el = allItems[idx];
            if (el) {
                let bubble = el.querySelector(`.bubble`); 
                                let imgEl = el.querySelector(`img`);
                if (imgEl) targetsToDelete.push({type: `img`, val: imgEl.getAttribute(`src`)});
                else targetsToDelete.push({type: `txt`, val: getCleanText(bubble)});
            }
        });
        targetsToDelete.forEach(target => {
            for(let i=history.length-1; i>=0; i--) {
                if(history[i].content.includes(target.val)) {
                    let newContent = history[i].content;
                    if(target.type === `img`) newContent = newContent.replace(new RegExp(`\\[å›¾ç‰‡æ¶ˆæ¯ï¼š` + target.val.replace(/[-\/\\^$*+?.()|[\]{}]/g, `\\$&`) + `\\](?:\\n\\(ç³»ç»Ÿæç¤ºï¼š.*?\\))?`), ``);
                    else newContent = newContent.replace(target.val, ``);
                    newContent = newContent.trim().replace(/^\n+|\n+$/g, ``).replace(/\n{2,}/g, `\n`);
                    let afterReply = newContent.split(`ã€å›å¤ã€‘`)[1];

                    if (newContent === `` || (newContent.includes(`ã€å›å¤ã€‘`) && (!afterReply || afterReply.trim() === ``))) {
                        history.splice(i, 1);
                        let lmc = parseInt(ls.getItem(`lastMemCount`)) || 0;
                        if(lmc > history.length) ls.setItem(`lastMemCount`, history.length.toString());
                    } else {
                        history[i].content = newContent;
                    }
                    break;
                }
            }
        });
        ls.setItem(`chatHistory`, JSON.stringify(history));
        exitMultiSelectMode();
        redrawChat();
        if(typeof updateListPreview === `function`) updateListPreview();
    }
}



function renderMultiSelectVisuals() {
    let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
    allItems.forEach((item, idx) => {
        let existingMask = item.querySelector(`.multi-select-mask`);
        if (isMultiSelectMode) {
            if (!existingMask) {
                item.style.position = `relative`;
                let mask = document.createElement(`div`);
                mask.className = `multi-select-mask`;
                let isLeft = item.classList.contains(`row-left`);
                let padLeft = isLeft ? `50px` : `15px`;
                mask.style.cssText = `position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.05);z-index:10;display:flex;align-items:center;padding:0 15px;padding-left:${padLeft};box-sizing:border-box;cursor:pointer;transition:background 0.2s;`;
                let cb = document.createElement(`div`);
                cb.className = `multi-select-cb`;
                cb.style.cssText = `width:22px;height:22px;border-radius:50%;border:2px solid #ccc;background:white;display:flex;justify-content:center;align-items:center;margin-right:10px;flex-shrink:0;`;
                mask.appendChild(cb);
                item.appendChild(mask);
                existingMask = mask;
            }
            let cb = existingMask.querySelector(`.multi-select-cb`);
            if (selectedMsgs.has(idx)) {
                existingMask.style.background = `rgba(108, 92, 231, 0.1)`;
                cb.style.borderColor = `#6c5ce7`;
                cb.innerHTML = `<div style="width:12px;height:12px;border-radius:50%;background:#6c5ce7;"></div>`;
            } else {
                existingMask.style.background = `transparent`;
                cb.style.borderColor = `#ccc`;
                cb.innerHTML = ``;
            }
        } else {
            if (existingMask) existingMask.remove();
        }
    });
}


// å…¨å±€åŠ«æŒï¼šç¡®ä¿å¤šé€‰çŠ¶æ€ä¸‹ç‚¹å‡»æ¶ˆæ¯æ˜¯é€‰ä¸­è€Œä¸æ˜¯åˆ«çš„æ“ä½œï¼ŒåŒæ—¶è‡ªåŠ¨æ€»ç»“ä¸€å®šèƒ½è¢«è§¦å‘
let oldRedrawChat = window.redrawChat || function(){};
window.redrawChat = function() {
    oldRedrawChat();
    if(isMultiSelectMode) {
        renderMultiSelectVisuals();
    } else {
        // åœ¨éå¤šé€‰çŠ¶æ€ä¸‹æ¯æ¬¡åˆ·æ–°èŠå¤©æ—¶ï¼Œåº•å±‚æ£€æŸ¥è‡ªåŠ¨æ€»ç»“ï¼ˆä¿®å¤ä¸è‡ªåŠ¨è§¦å‘çš„bugï¼‰
        setTimeout(forceCheckAutoMem, 1000);
    }
};

// å¼ºåŠ›ä¿®å¤ï¼šçœŸæ­£çš„é™é»˜è‡ªåŠ¨æ€»ç»“å¤§è„‘
window.forceCheckAutoMem = async function() {
    let am = ls.getItem(`cAMem`) === `true`;
    let mt = parseInt(ls.getItem(`cMemT`)) || 10;
    let lmc = parseInt(ls.getItem(`lastMemCount`)) || 0;
    
    if(am && history.length - lmc >= mt && history.length > 0) {
        ls.setItem(`lastMemCount`, history.length); // å…ˆæ›´æ–°è®¡æ•°ï¼Œé˜²æ­¢é‡å¤è§¦å‘
        
        let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
        if(!pxy || !key || !mod) return;
        
        let cN = $(`cfgName`).value || `ä¸“å±æ‹äºº`;
        let myN = $(`cfgMyName`).value || `æˆ‘`;
        let promptCtx = ls.getItem(`cMemP`) || `æç‚¼å…³é”®äº‹å®ã€æƒ…ç»ªå˜åŒ–å’Œçº¦å®šã€‚`;
        let chatText = history.slice(-mt).map(m => (m.role === `user` ? myN : cN) + `ï¼š` + m.content).join(`\n`);
        let sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${cN}ã€‚è¯·ä»¥ä½ çš„ç¬¬ä¸€äººç§°è§†è§’ï¼Œæå–ä»¥ä¸‹èŠå¤©è®°å½•ä¸­çš„é‡è¦äº‹å®ã€æƒ…æ„Ÿå˜åŒ–å’Œçº¦å®šï¼Œæ€»ç»“ä¸ºç®€çŸ­çš„è®°å¿†ç‰‡æ®µã€‚è¦æ±‚ï¼š\n1. è¯­æ°”ç¬¦åˆæ€§æ ¼è®¾å®šã€‚\n2. éµå¾ªæå–ä¾§é‡ç‚¹ï¼š${promptCtx}\n3. çº¯æ–‡æœ¬ç›´æ¥è¾“å‡ºï¼Œç¦æ­¢åºŸè¯ã€‚\n\nã€è¿‘æœŸè®°å½•ã€‘ï¼š\n${chatText}`;
        
        try {
            let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
            let res = await fetch(url, {
                method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
                body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.5})
            });
            let dat = await res.json();
            if(dat.choices && dat.choices.length > 0) {
                let out = dat.choices[0].message.content.trim();
                let memsStr = currentChatId === `default` ? ls.getItem(`memories`) : ls.getItem(`memories_` + currentChatId);
                let mems = memsStr ? JSON.parse(memsStr) : [];
                mems.push({ date: updTime().toLocaleString(), content: out });
                ls.setItem(currentChatId === `default` ? `memories` : `memories_` + currentChatId, JSON.stringify(mems));
                console.log(`[ç³»ç»Ÿ] è‡ªåŠ¨è®°å¿†æ€»ç»“å·²é™é»˜å®Œæˆ`);
            }
        } catch(e) { console.error(`è‡ªåŠ¨æ€»ç»“ç½‘ç»œé”™è¯¯`, e); }
    }
};

if(typeof msgs !== `undefined`) {
            msgs.addEventListener(`click`, (e) => {
        if(!isMultiSelectMode) return;
        let item = e.target.closest(`.msg-row`);
        if(!item) return;
        e.preventDefault();
        e.stopPropagation();
        let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
        let idx = allItems.indexOf(item);
        if(idx > -1) {
            if(selectedMsgs.has(idx)) selectedMsgs.delete(idx);
            else selectedMsgs.add(idx);
            $(`roomTitle`).innerText = `å·²é€‰ ` + selectedMsgs.size + ` æ¡`;
            renderMultiSelectVisuals();
        }
    }, true);
}
// ===== æ”¶è—å¤¹ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ =====
function saveMsgToFav(content) {
    let favs = ls.getItem(`myFavs`) ? JSON.parse(ls.getItem(`myFavs`)) : [];
    let cId = currentChatId || `default`;
    favs.push({
        id: Date.now() + Math.random(),
        chatId: cId,
        content: content,
        time: updTime().toLocaleString()
    });
    ls.setItem(`myFavs`, JSON.stringify(favs));
}

window.saveSelectedToFav = function() {
    if(selectedMsgs.size === 0) return;
    let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
    let sortedIndices = Array.from(selectedMsgs).sort((a, b) => a - b);
    
    sortedIndices.forEach(idx => {
        let el = allItems[idx];
        if (el) {
            let bubble = el.querySelector(`.bubble`); 
            let imgEl = el.querySelector(`img`);
            let contentToSave = imgEl ? imgEl.getAttribute(`src`) : getCleanText(bubble);
            saveMsgToFav(contentToSave);
        }
    });
    alert(`æˆåŠŸå°† ` + selectedMsgs.size + ` æ¡ä¿¡æ¯è£…è¿›æ”¶è—å¤¹ï¼`);
    exitMultiSelectMode();
};

let currFavChatId = `default`;
window.switchFavChar = function(id) { 
    currFavChatId = id; 
    renderFavs(); 
};

window.deleteFav = function(id) {
    if(confirm(`ç¡®å®šå–æ¶ˆæ”¶è—è¿™æ¡ä¿¡æ¯å—ï¼Ÿ`)) {
        let favs = ls.getItem(`myFavs`) ? JSON.parse(ls.getItem(`myFavs`)) : [];
        favs = favs.filter(x => x.id !== id);
        ls.setItem(`myFavs`, JSON.stringify(favs));
        renderFavs();
    }
};

function renderFavs() {
    let container = $(`favListContainer`);
    if(!container) return;
    container.innerHTML = ``;
    
    let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
    let allChars = [{id: `default`, name: originalGetItem.call(ls, `cN_default`) || originalGetItem.call(ls, `cN`) || `ä¸“å±æ‹äºº`}];
    contacts.forEach(c => allChars.push({id: c.id, name: originalGetItem.call(ls, `cN_` + c.id) || c.name}));
    
    let selHtml = `<div style="padding:10px 15px; border-bottom:1px solid #eee; background:#fff; margin:-15px -15px 15px -15px; position:sticky; top:0; z-index:10;"><select class="input-field" style="width:100%; font-weight:bold; color:#6c5ce7; background:#eef2ff; border:1px solid #c7d2fe; outline:none;" onchange="switchFavChar(this.value)">`;
    allChars.forEach(c => {
        let isSel = String(c.id) === String(currFavChatId) ? `selected` : ``;
        selHtml += `<option value="${c.id}" ${isSel}>${c.name} çš„çè´µç¢ç‰‡</option>`;
    });
    selHtml += `</select></div>`;
    container.innerHTML += selHtml;
    
    let favs = ls.getItem(`myFavs`) ? JSON.parse(ls.getItem(`myFavs`)) : [];
    let filterFavs = favs.filter(x => String(x.chatId) === String(currFavChatId));
    
    if(filterFavs.length === 0) {
        container.innerHTML += `<div style="text-align:center; color:#888; font-size:13px; margin-top:40px;">å½“å‰è§’è‰²è¿˜æ²¡æœ‰å­˜ä¸‹ä»»ä½•ç¢ç‰‡å“¦ã€‚</div>`;
        return;
    }
    
    filterFavs.forEach((fav, index) => {
        let card = document.createElement(`div`);
        card.className = `stat-card`;
        card.style.marginBottom = `15px`;
        
        let isImg = fav.content.startsWith(`data:image`) || fav.content.startsWith(`http`);
        let contentHtml = isImg ? `<img src="${fav.content}" style="max-width:100%; border-radius:8px; margin-top:8px;">` : `<div style="margin-top:8px; font-size:14px; color:#333; line-height:1.6; word-wrap:break-word;">${fav.content}</div>`;
        
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding-bottom:10px;">
                <span style="font-weight:bold; color:#6c5ce7; font-size:15px; background:#eef2ff; padding:2px 10px; border-radius:12px;">NO. ${index + 1}</span>
                <span style="font-size:11px; color:#999;">${fav.time || ``}</span>
            </div>
            ${contentHtml}
            <div style="text-align:right; margin-top:12px;">
                <span onclick="deleteFav(${fav.id})" style="font-size:12px; color:#ff7675; cursor:pointer; font-weight:bold; background:#fff0f0; padding:4px 10px; border-radius:8px;">å–æ¶ˆæ”¶è—</span>
            </div>
        `;
        container.appendChild(card);
    });
}

if($(`btnGoFav`)) {
    $(`btnGoFav`).onclick = () => {
        currFavChatId = currentChatId || `default`;
        renderFavs();
        showScreen(`scrFav`);
    };
}
if($(`btnFavBack`)) {
    $(`btnFavBack`).onclick = () => showScreen(`scrMe`);
}
let myWallet = ls.getItem(`myWallet`) ? JSON.parse(ls.getItem(`myWallet`)) : { balance: 0.00, bank: 0.00, bills: [] };

let isWalletEditMode = false;
let selWalletBills = new Set();

function renderWallet() {
    $(`walletTotal`).innerText = (myWallet.balance + myWallet.bank).toFixed(2);
    $(`walletBalance`).innerText = myWallet.balance.toFixed(2);
    $(`bankBalance`).innerText = myWallet.bank.toFixed(2);
    
    let billList = $(`walletBillList`);
    billList.innerHTML = ``;
    if(myWallet.bills.length === 0) {
        billList.innerHTML = `<div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">æš‚æ— äº¤æ˜“è®°å½•</div>`;
    } else {
        let revBills = [...myWallet.bills].reverse();
        revBills.forEach((b, idx) => {
            let icon = b.type === `transfer` ? `ğŸ’¸` : `ğŸ’°`;
            let color = b.amount < 0 ? `#333` : `#ff4d4f`;
            let sign = b.amount > 0 ? `+` : ``;
            
            let isSel = selWalletBills.has(idx);
            let borderStyle = (isWalletEditMode && isSel) ? `border:2px solid #ff4d4f;` : `border:2px solid transparent;`;
            let pointerStyle = isWalletEditMode ? `cursor:pointer;` : ``;
            
            let checkHtml = ``;
            if(isWalletEditMode) {
                let cbColor = isSel ? `#ff4d4f` : `#ccc`;
                let innerDot = isSel ? `<div style="width:10px;height:10px;border-radius:50%;background:#ff4d4f;"></div>` : ``;
                checkHtml = `<div style="width:20px;height:20px;border-radius:50%;border:2px solid ${cbColor};display:flex;justify-content:center;align-items:center;margin-right:10px;flex-shrink:0;">${innerDot}</div>`;
            }

            billList.innerHTML += `
            <div style="background:#fff; padding:13px; border-radius:12px; display:flex; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.02); margin-bottom:12px; transition:0.2s; ${borderStyle} ${pointerStyle}" onclick="if(typeof toggleWalletBillSel === 'function') toggleWalletBillSel(${idx})">
                ${checkHtml}
                <div style="font-size:24px; width:40px; height:40px; background:#f5f6fa; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-right:15px;">${icon}</div>
                <div style="flex:1; overflow:hidden;">
                    <div style="font-size:15px; font-weight:bold; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title}</div>
                    <div style="font-size:12px; color:#999; margin-top:4px;">${b.time}</div>
                </div>
                <div style="font-size:16px; font-weight:bold; color:${color};">${sign}${b.amount.toFixed(2)}</div>
            </div>`;
        });
    }
}

window.toggleWalletBillSel = function(idx) {
    if(!isWalletEditMode) return;
    if(selWalletBills.has(idx)) selWalletBills.delete(idx);
    else selWalletBills.add(idx);
    renderWallet();
};
if($(`btnEditWalletBill`)) {
    $(`btnEditWalletBill`).onclick = () => {
        isWalletEditMode = !isWalletEditMode;
        $(`btnEditWalletBill`).innerText = isWalletEditMode ? `å®Œæˆ` : `ç®¡ç†`;
        $(`walletBillActions`).style.display = isWalletEditMode ? `flex` : `none`;
        selWalletBills.clear();
        renderWallet();
    };
}
if($(`btnSelAllBill`)) {
    $(`btnSelAllBill`).onclick = () => {
        if(selWalletBills.size === myWallet.bills.length) selWalletBills.clear();
        else myWallet.bills.forEach((_, i) => selWalletBills.add(i));
        renderWallet();
    };
}
if($(`btnDelSelBill`)) {
    $(`btnDelSelBill`).onclick = () => {
        if(selWalletBills.size === 0) { alert(`è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è´¦å•å“¦ï¼`); return; }
        if(confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ` + selWalletBills.size + ` ç¬”è´¦å•å¹¶è‡ªåŠ¨é€€è¿˜å¯¹åº”é‡‘é¢å—ï¼Ÿ`)) {
            let realIndices = Array.from(selWalletBills).map(i => myWallet.bills.length - 1 - i).sort((a,b)=>b-a);
            realIndices.forEach(ri => {
                let b = myWallet.bills[ri];
                if(b.amount < 0) {
                    myWallet.balance += Math.abs(b.amount);
                } else if(b.amount > 0) {
                    if(b.type === `bank`) myWallet.bank -= b.amount;
                    else myWallet.balance -= b.amount;
                }
                myWallet.bills.splice(ri, 1);
            });
            
            if(myWallet.balance < 0) myWallet.balance = 0;
            if(myWallet.bank < 0) myWallet.bank = 0;
            
            ls.setItem(`myWallet`, JSON.stringify(myWallet));
            selWalletBills.clear();
            isWalletEditMode = false;
            $(`btnEditWalletBill`).innerText = `ç®¡ç†`;
            $(`walletBillActions`).style.display = `none`;
            renderWallet();
            alert(`åˆ é™¤æˆåŠŸï¼ç›¸å…³é‡‘é¢å·²é‡æ–°ç»“ç®—å®Œæ¯•ã€‚`);
        }
    };
}



if($(`btnOpenWallet`)) $(`btnOpenWallet`).onclick = () =>{ renderWallet(); showScreen(`scrWallet`); };
if($(`btnWalletBack`)) $(`btnWalletBack`).onclick = () =>showScreen(`scrMe`);

if($(`btnTopUpBank`)) $(`btnTopUpBank`).onclick = () =>{
    let amtStr = prompt(`è¯·è¾“å…¥ç»™å‚¨è“„å¡å……å€¼çš„é‡‘é¢ï¼š`);
    if(amtStr === null) return;
    let amt = parseFloat(amtStr);
    if(isNaN(amt) || amt <= 0) { alert(`é‡‘é¢æ— æ•ˆï¼`); return; }
    myWallet.bank += amt;
    myWallet.bills.push({
        title: `å‚¨è“„å¡å……å€¼`,
        time: updTime().toLocaleString(),
        amount: amt,
        type: `bank`
    });
    ls.setItem(`myWallet`, JSON.stringify(myWallet));
    renderWallet();
    alert(`å……å€¼æˆåŠŸï¼`);
};

if($(`btnGoBalance`)) $(`btnGoBalance`).onclick = () =>{
    $(`modalBalanceAmount`).innerText = myWallet.balance.toFixed(2);
    $(`balanceModal`).style.display = `flex`;
};

if($(`btnCloseBalanceModal`)) $(`btnCloseBalanceModal`).onclick = () =>{
    $(`balanceModal`).style.display = `none`;
};

if($(`btnBalanceHelp`)) $(`btnBalanceHelp`).onclick = () =>{
    alert(`ã€é›¶é’±è§„åˆ™è¯´æ˜ã€‘\n1. èµ„é‡‘æ¥æºï¼šå¯é€šè¿‡å¯¹æ–¹è½¬è´¦ã€å‘çº¢åŒ…æˆ–ä½¿ç”¨å‚¨è“„å¡å……å€¼è·å¾—ã€‚\n2. æç°è§„åˆ™ï¼šä½™é¢æç°è‡³å‚¨è“„å¡ï¼Œå°†æŒ‰ç…§å¾®ä¿¡æ ‡å‡†æ”¶å– 0.1% çš„æœåŠ¡è´¹ï¼Œå•ç¬”æœ€ä½ 0.1 å…ƒã€‚`);
};

if($(`btnBalanceTopUp`)) $(`btnBalanceTopUp`).onclick = () =>{
    let amtStr = prompt(`è¯·è¾“å…¥ä½¿ç”¨ã€å‚¨è“„å¡ã€‘å……å€¼åˆ°é›¶é’±çš„é‡‘é¢ï¼š`);
    if(amtStr === null) return;
    let amt = parseFloat(amtStr);
    if(isNaN(amt) || amt <= 0) { alert(`é‡‘é¢æ— æ•ˆï¼`); return; }
    
    // æ ¡éªŒå‚¨è“„å¡ä½™é¢
    if(myWallet.bank < amt) { 
        alert(`å‚¨è“„å¡ä½™é¢ä¸è¶³ï¼Œæ— æ³•å……å€¼ï¼è¯·å…ˆç»™å‚¨è“„å¡æ³¨å…¥èµ„é‡‘ã€‚`); 
        return; 
    }
    
    myWallet.bank -= amt;
    myWallet.balance += amt;
    myWallet.bills.push({
        title: `é›¶é’±å……å€¼ (æ¥è‡ªå‚¨è“„å¡)`,
        time: updTime().toLocaleString(),
        amount: amt,
        type: `wallet`
    });
    ls.setItem(`myWallet`, JSON.stringify(myWallet));
    $(`modalBalanceAmount`).innerText = myWallet.balance.toFixed(2);
    renderWallet();
    alert(`å……å€¼æˆåŠŸï¼`);
};

if($(`btnBalanceWithdraw`)) $(`btnBalanceWithdraw`).onclick = () =>{
    let amtStr = prompt(`è¯·è¾“å…¥æç°åˆ°ã€å‚¨è“„å¡ã€‘çš„é‡‘é¢ï¼š\n(å°†é¢å¤–æ‰£é™¤ 0.1% æ‰‹ç»­è´¹ï¼Œæœ€ä½ 0.1 å…ƒ)`);
    if(amtStr === null) return;
    let amt = parseFloat(amtStr);
    if(isNaN(amt) || amt <= 0) { alert(`é‡‘é¢æ— æ•ˆï¼`); return; }
    
    // å¾®ä¿¡æ ‡å‡†æ‰‹ç»­è´¹ç®—æ³•ï¼š0.1%ï¼Œæœ€ä½1æ¯›é’±
    let fee = Math.max(0.1, amt * 0.001);
    let totalDeduct = amt + fee;
    
    // æ ¡éªŒé›¶é’±ä½™é¢æ˜¯å¦å¤Ÿæ‰£é™¤æœ¬é‡‘+æ‰‹ç»­è´¹
    if(myWallet.balance < totalDeduct) { 
        alert(`é›¶é’±ä½™é¢ä¸è¶³ï¼æç° ${amt.toFixed(2)} å…ƒéœ€è¦æ‰‹ç»­è´¹ ${fee.toFixed(2)} å…ƒï¼Œå…±éœ€æ‰£é™¤ ${totalDeduct.toFixed(2)} å…ƒã€‚`); 
        return; 
    }
    
    myWallet.balance -= totalDeduct;
    myWallet.bank += amt;
    myWallet.bills.push({
        title: `é›¶é’±æç° (æ‰£é™¤æ‰‹ç»­è´¹ ï¿¥${fee.toFixed(2)})`,
        time: updTime().toLocaleString(),
        amount: -totalDeduct,
        type: `transfer`
    });
    ls.setItem(`myWallet`, JSON.stringify(myWallet));
    $(`modalBalanceAmount`).innerText = myWallet.balance.toFixed(2);
    renderWallet();
    alert(`æç°æˆåŠŸï¼å·²æç° ${amt.toFixed(2)} å…ƒè‡³å‚¨è“„å¡ï¼Œæ‰£é™¤æ‰‹ç»­è´¹ ${fee.toFixed(2)} å…ƒã€‚`);
};

if($(`btnGoBank`)) $(`btnGoBank`).onclick = () =>{
    alert(`è¿™æ˜¯ä½ çš„å‚¨è“„å¡ï¼Œå¯ä»¥ç›´æ¥ç‚¹å‡»ä¸‹æ–¹çš„ã€ç»™å‚¨è“„å¡å……å€¼ã€‘æŒ‰é’®è¿›è¡Œå¤–éƒ¨èµ„é‡‘æ³¨å…¥ï¼Œä¸ºé›¶é’±æä¾›åç›¾ã€‚`);
};

if($(`btnWalletSet`)) $(`btnWalletSet`).onclick = () =>{
    $(`newWalletPwd`).value = ``;
    $(`walletPwdModal`).style.display = `flex`;
};
if($(`btnCancelWalletPwd`)) $(`btnCancelWalletPwd`).onclick = () =>{
    $(`walletPwdModal`).style.display = `none`;
};
if($(`btnSaveWalletPwd`)) $(`btnSaveWalletPwd`).onclick = () =>{
    let pwd = $(`newWalletPwd`).value;
    if(pwd.length !== 6) { alert(`å¯†ç å¿…é¡»æ˜¯6ä½æ•°å­—å“¦ï¼`); return; }
    myWallet.password = pwd;
    ls.setItem(`myWallet`, JSON.stringify(myWallet));
    alert(`æ”¯ä»˜å¯†ç è®¾ç½®æˆåŠŸï¼`);
    $(`walletPwdModal`).style.display = `none`;
};

</script>

</body>
</html>
