<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8>
<meta name=viewport content=width=device-width,initial-scale=1>
<meta name="referrer" content="no-referrer">
<title>ä¸“å±æ‰‹æœº</title>

<style>
@keyframes waveFade { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
.w-1 { animation: waveFade 1.5s infinite 0s; }
.w-2 { animation: waveFade 1.5s infinite 0.3s; }
.w-3 { animation: waveFade 1.5s infinite 0.6s; }

body { background-color: #f5f6fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; }
.phone-container { width: 100vw; height: 100vh; border: none; border-radius: 0; box-shadow: none; overflow: hidden; position: relative; background-color: #f5f6fa; }

.scr-lock { display: flex; flex-direction: column; align-items: center; padding-top: 80px; height: 100%; cursor: pointer; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 50; position: absolute; top: 0; width: 100%; color: white; background-size: cover; background-position: center; }
.time { font-size: 65px; font-weight: 300; margin: 0; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
.date { font-size: 18px; margin-top: 10px; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
.unlock-text { position: absolute; bottom: 40px; font-size: 15px; animation: pulse 2s infinite; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
@keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
@keyframes waveFade { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
.w-1 { animation: waveFade 1.5s infinite 0s; }
.w-2 { animation: waveFade 1.5s infinite 0.3s; }
.w-3 { animation: waveFade 1.5s infinite 0.6s; }

.scr-home { display: none; height: 100%; box-sizing: border-box; position: absolute; top: 0; width: 100%; padding-top: 60px; z-index: 10; background-color: #f5f6fa; }
.desktop-widgets { margin: 0 20px 40px 20px; padding: 20px; background: rgba(255,255,255,0.7); border-radius: 20px; backdrop-filter: blur(15px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.greeting { font-size: 18px; font-weight: bold; color: #333; }
.greeting-sub { font-size: 12px; margin-top: 5px; color: #666; }
.app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 20px; }
.app-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
.icon-chat { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
.icon-api { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #fab1a0, #e17055); }
.icon-wb { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #81ecec, #00cec9); }
.icon-space { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #fdcb6e, #e17055); }

.icon-space { width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: linear-gradient(135deg, #fdcb6e, #e17055); }

.app-name { font-size: 12px; margin-top: 8px; font-weight: bold; color: #333; background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 8px; }
.dock { position: absolute; bottom: 20px; left: 15px; right: 15px; height: 70px; background: rgba(255,255,255,0.6); backdrop-filter: blur(20px); border-radius: 30px; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.dock-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.8); border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 22px; cursor: pointer; }
.scr-flex { display: none; height: 100%; position: absolute; top: 0; width: 100%; flex-direction: column; background-color: #f5f6fa; color: #333; z-index: 30; }
.header-title { font-weight: bold; font-size: 16px; }
.api-form { padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-bottom: 40px; }
.section-card { background: #ffffff; border-radius: 16px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 12px; }
.section-title { font-size: 14px; color: #6c5ce7; font-weight: bold; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
.input-group { display: flex; flex-direction: column; gap: 5px; }
.input-group label { font-size: 12px; color: #888; font-weight: bold; }
.input-field, select, textarea { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; background-color: #fcfcfc; outline: none; font-size: 13px; color: #333; transition: 0.3s; font-family: sans-serif; }
.input-field:focus, select:focus, textarea:focus { border-color: #a29bfe; }
.flex-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.flex-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
textarea { resize: none; }
.save-btn { border: none; border-radius: 12px; font-size: 15px; cursor: pointer; font-weight: bold; text-align: center; transition: 0.3s; padding: 15px; background: #6c5ce7; color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); margin-top: 10px; width: 100%; box-sizing: border-box; }
.tool-btn { background: #f0f2f5; color: #6c5ce7; border: 1px solid #ddd; padding: 10px; font-size: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; text-align: center; flex: 1; transition: 0.2s; }
.tool-btn:active { background: #e0e0e0; }
.clear-btn { background: #fff0f0; color: #ff7675; border: 1px solid #ff7675; padding: 10px; border-radius: 10px; font-size: 12px; cursor: pointer; text-align: center; font-weight: bold; flex: 1; }
.upload-btn { background: #f8f9fa; color: #666; border: 1px dashed #bbb; padding: 12px; border-radius: 10px; font-size: 12px; cursor: pointer; text-align: center; display: flex; justify-content: center; align-items: center; gap: 5px; }
.scr-list { display: none; height: 100%; position: absolute; top: 0; width: 100%; flex-direction: column; background-color: #f5f6fa; color: black; z-index: 20; }
.chat-header { background-color: #ffffff; padding: 25px 20px 15px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 20px; border-bottom: 1px solid #eeeeee; flex-shrink: 0; }
.back-btn { font-size: 20px; cursor: pointer; color: #555555; width: 30px; font-weight: normal; }
.plus-btn { font-size: 28px; cursor: pointer; line-height: 1; margin-top: -5px; position: relative; }
.header-center { flex: 1; text-align: center; margin-right: 30px; } 
.chat-item { display: flex; align-items: center; padding: 15px 20px; background-color: #ffffff; border-bottom: 1px solid #eeeeee; cursor: pointer; }
.avatar-list { width: 45px; height: 45px; background-color: #e0e0e0; border: 1px solid #eeeeee; margin-right: 15px; font-size: 20px; border-radius: 50%; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: #888; flex-shrink: 0; }
.chat-info { flex: 1; overflow: hidden; }
.chat-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
.chat-preview { font-size: 13px; color: #888888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.drop-menu { display: none; position: absolute; top: 65px; right: 15px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 12px; z-index: 100; overflow: hidden; }
.menu-item { padding: 15px 20px; border-bottom: 1px solid #f0f2f5; font-size: 14px; color: #333; cursor: pointer; }
.scr-room { display: none; height: 100%; position: absolute; top: 0; width: 100%; flex-direction: column; background-color: #f5f6fa; color: black; z-index: 25; background-size: cover; background-position: center; }
.room-header { background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 25px 15px 15px 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px; border-bottom: 1px solid #eeeeee; flex-shrink: 0; }
.settings-btn { font-size: 20px; cursor: pointer; color: #555555; width: 30px; text-align: right; }
.empty-btn { width: 30px; }
.room-center { flex: 1; text-align: center; font-size: 16px; }
.chat-toolbar { display: flex; gap: 15px; padding: 10px 15px; background: rgba(255,255,255,0.9); border-top: 1px solid #eeeeee; flex-shrink: 0; }
.tool-icon { font-size: 20px; color: #666; cursor: pointer; transition: 0.2s; }
.tool-icon:active { transform: scale(0.9); }
.chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
.msg-row { display: flex; width: 100%; }
.row-left { justify-content: flex-start; }
.row-right { justify-content: flex-end; }
.bubble { max-width: 70%; padding: 12px 15px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; user-select: none; }
.bub-left { background-color: rgba(255,255,255,0.95); color: black; border-top-left-radius: 4px; border: 1px solid #eeeeee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.bub-right { background-color: #6c5ce7; color: white; border-top-right-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.quote-box { display: none; padding: 8px 15px; background: rgba(238, 242, 255, 0.95); color: #6c5ce7; font-size: 12px; border-left: 3px solid #6c5ce7; margin: 0 15px 5px 15px; border-radius: 4px 8px 8px 4px; position: relative; flex-shrink: 0; backdrop-filter: blur(5px); }
.quote-txt { margin-right: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.quote-close { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-weight: bold; font-size: 16px; }
.chat-input { box-sizing: border-box; width: 100%; background-color: rgba(255,255,255,0.95); padding: 8px 10px 25px 10px; display: flex; gap: 6px; align-items: center; flex-shrink: 0; border-top: 1px solid #eeeeee; }
.msg-input { flex: 1; min-width: 0; border: none; background-color: #f0f2f5; padding: 8px 12px; border-radius: 20px; font-size: 14px; outline: none; }
.tool-svg { width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
.tool-svg svg { width: 24px; height: 24px; stroke-linecap: round; stroke-linejoin: round; }
.tool-svg:active { transform: scale(0.9); }


.send-btn { background-color: #6c5ce7; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; }
.ava-sm { width: 35px; height: 35px; background-color: #e0e0e0; border: 1px solid #eeeeee; font-size: 16px; transition: 0.2s; border-radius: 50%; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: #888; flex-shrink: 0; }
.ava-l { margin-right: 10px; cursor: pointer; }
.ava-l:active { transform: scale(0.9); }
.ava-r { margin-left: 10px; }
.ctx-menu { display: none; position: absolute; background: rgba(255,255,255,0.98); backdrop-filter: blur(15px); box-shadow: 0 5px 20px rgba(0,0,0,0.15); border-radius: 16px; padding: 12px; z-index: 200; width: 240px; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.ctx-item { font-size: 13px; color: #333; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 10px 0; border-radius: 8px; background: #f5f6fa; transition: 0.2s; font-weight: bold; }
.ctx-item:active { background: #e0e0e0; }
.ctx-danger { color: #ff7675; background: #fff0f0; }
.modal-base { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 100; justify-content: center; align-items: center; }
.modal-ctx { width: 85%; max-height: 80%; background: #fffafb; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-hdr { background: #6c5ce7; color: white; padding: 15px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
.close-btn { cursor: pointer; font-size: 20px; }
.modal-bdy { padding: 18px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
.stat-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.stat-tag { display: inline-block; background: #eef2ff; color: #6c5ce7; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 8px; }
.stat-txt { font-size: 13px; color: #444; line-height: 1.6; }
.wb-tabs { display: flex; background: #ffffff; padding: 10px 20px; gap: 15px; border-bottom: 1px solid #eee; flex-shrink: 0; }
.wb-tab { flex: 1; text-align: center; padding: 10px; background: #f0f2f5; border-radius: 12px; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; transition: 0.3s; }
.wb-active { background: #6c5ce7; color: white; }
.wb-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
.wb-card { background: white; padding: 18px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.wb-title { font-weight: bold; color: #333; margin-bottom: 8px; font-size: 15px; }
.wb-prev { font-size: 13px; color: #666; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

.sticker-drawer { position: absolute; bottom: 0; left: 0; width: 100%; height: 55%; background: #f5f6f8; border-top-left-radius: 20px; border-top-right-radius: 20px;
box-shadow: 0 -4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; z-index: 100; transform: translateY(150%); opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
box-sizing: border-box; }
.sticker-drawer.show { transform: translateY(0); opacity: 1; pointer-events: auto; }

.sticker-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #eef2ff; border-top-left-radius: 20px; border-top-right-radius: 20px; flex-shrink: 0; }
.sticker-header span { color: #4a6ee0; font-size: 13px; cursor: pointer; white-space: nowrap; }
.sticker-header .title { color: #333; font-weight: bold; font-size: 15px; margin: 0 5px; }
.sticker-actions { display: flex; gap: 8px; flex-wrap: nowrap; }
.sticker-search { padding: 8px 15px; background: #f5f6f8; flex-shrink: 0; }
.sticker-search input { width: 100%; padding: 8px 15px; border: none; border-radius: 20px; background: #fff; outline: none; font-size: 13px; box-sizing: border-box; }
.sticker-grid { flex: 1; min-height: 0; overflow-y: auto; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 10px 15px 20px 15px; align-content: start; }
.sticker-item { background: #fff; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
.sticker-item img { width: 65px; height: 65px; object-fit: contain; margin-bottom: 8px; background:#f0f2f5; border-radius:8px; }
.sticker-item .name { font-size: 12px; color: #666; text-align: center; width: 100%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.sticker-delete-btn { position: absolute; top: -6px; right: -6px; background: #ff4d4f; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; font-size: 14px; font-weight: bold; display: none; z-index: 2; }
.sticker-item.edit-mode { animation: shake 0.5s infinite alternate; }
.sticker-item.edit-mode .sticker-delete-btn { display: block; }
@keyframes shake { 0% { transform: rotate(-1deg); } 100% { transform: rotate(1deg); } }
.sticker-footer { padding: 10px 15px; background: #fff; border-top: 1px solid #eee; flex-shrink: 0; box-sizing: border-box; }
.category-btn { background: #1890ff; color: #fff; border: none; padding: 6px 18px; border-radius: 15px; font-size: 12px; }
.batch-modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; display: none; justify-content: center; align-items: center; }
.batch-modal { background: #fff; width: 75%; border-radius: 16px; padding: 20px 0 0 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.batch-modal h3 { text-align: center; margin-top: 0; font-size: 16px; margin-bottom: 15px; color: #333; }
.batch-input-wrapper { padding: 0 20px; }
.batch-modal textarea { width: 100%; height: 100px; border: 2px solid #a855f7; border-radius: 12px; padding: 12px; box-sizing: border-box; resize: none; outline: none; font-size: 13px; }
.batch-modal-btns { display: flex; border-top: 1px solid #f0f0f0; margin-top: 20px; }
.batch-modal-btns button { flex: 1; background: none; border: none; padding: 14px; font-size: 15px; color: #1890ff; cursor: pointer; }
.batch-modal-btns button.cancel { color: #999; border-right: 1px solid #f0f0f0; }

.list-content { flex: 1; overflow-y: auto; background-color: #f5f6fa; }
.bottom-nav { display: flex; justify-content: space-around; align-items: center; background: #ffffff; padding: 10px 0 20px 0; border-top: 1px solid #eeeeee; flex-shrink: 0; z-index: 100; }
.nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #888; transition: 0.2s; }
.nav-item-active { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #ff6b81; transition: 0.2s; }
.nav-icon { font-size: 22px; margin-bottom: 3px; filter: grayscale(100%) opacity(60%); }
.nav-item-active .nav-icon { filter: none; }
.nav-text { font-size: 11px; font-weight: bold; }

.me-header { padding: 30px 20px 20px 20px; background: #fff; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #f0f2f5; }
.me-avatar { width: 60px; height: 60px; border-radius: 50%; background-color: #e0e0e0; background-size: cover; background-position: center; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.me-info { flex: 1; }
.me-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; }
.me-bio { font-size: 12px; color: #888; }
.me-icons { display: flex; gap: 10px; color: #6c5ce7; font-size: 18px; }
.me-menu-list { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #f5f6fa; }
.me-menu-item { background: #fff; border-radius: 16px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); cursor: pointer; transition: 0.2s; }
.me-menu-item:active { transform: scale(0.98); }
.me-menu-left { display: flex; flex-direction: column; gap: 4px; }
.me-menu-title { font-size: 15px; font-weight: bold; color: #333; }
.me-menu-sub { font-size: 12px; color: #999; }
.me-menu-right { color: #ccc; font-weight: bold; font-size: 18px;
}
.log-list-header { display: flex; background: #fff; padding: 10px 20px; gap: 15px; border-bottom: 1px solid #eee; flex-shrink: 0; }
.log-tab { flex: 1; text-align: center; padding: 10px; border-radius: 12px; font-size: 14px; font-weight: bold; color: #888; cursor: pointer; transition: 0.3s; background: #f0f2f5; }
.log-tab-active { background: #6c5ce7; color: white; }
.log-card { background: white; padding: 20px; border-radius: 16px; margin: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
.log-card-time { font-size: 12px; color: #999; }
.log-card-content { font-size: 14px; color: #333; line-height: 1.6; }
.log-placeholder-img { width: 100%; height: 150px; background: #e0e0e0; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: #888; font-size: 13px; border: 1px dashed #ccc; margin-bottom: 10px; }
.log-real-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; }
.log-summon-btn { align-self: flex-end; background: #fdf2f8; color: #ff6b81; border: 1px solid #fbcfe8; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.log-summon-btn:active { transform: scale(0.95); }
.log-comment-area { background: #f9f9f9; padding: 12px; border-radius: 12px; font-size: 13px; color: #555; border-left: 3px solid #6c5ce7;     margin-top: 10px; }
#btnNewMenu { padding: 5px 15px; margin-left: -5px; margin-right: -5px; }
.menu-drawer { position: absolute; bottom: 85px; left: 15px;
width: calc(100% - 30px); height: 55%; background: #f5f6f8; border-radius: 24px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); display: flex; flex-direction: column;
z-index: 95; transform: translateY(150%); opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-sizing: border-box; padding: 25px 20px; }
.menu-drawer.show { transform: translateY(0); opacity: 1; pointer-events: auto; }

.menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 10px; align-content: start; }
.menu-icon-btn { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; }
.menu-icon-btn:active { transform: scale(0.9); }
.menu-icon-svg { width: 38px; height: 38px; background: #f3e5f5; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
.menu-icon-text { font-size: 10px; color: #666; font-weight: bold; }


input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; display: none; }

</style>


</head>
<body>
<div id=phone class=phone-container>
    
    <div id=scrLock class=scr-lock>
        <h1 id=time class=time>00:00</h1>
        <div id=date class=date>å‡†å¤‡å°±ç»ª</div>
        <div class=unlock-text>ç‚¹å‡»å±å¹•è§£é”</div>
    </div>
    
    <div id=scrHome class=scr-home>
        <div class=desktop-widgets>
            <div class=greeting>æ¬¢è¿å›æ¥</div>
            <div class=greeting-sub>ä»Šå¤©æƒ³åšç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ</div>
        </div>
                        <div class="app-grid">
            <div id="btnHomeChat" class="app-item"><div class="icon-chat">ğŸ’¬</div><div class="app-name">èŠå¤©</div></div>
            <div id="btnHomeApi" class="app-item"><div class="icon-api">âš™ï¸</div><div class="app-name">ç½‘ç»œé…ç½®</div></div>
            <div id="btnHomeWb" class="app-item"><div class="icon-wb">ğŸ“–</div><div class="app-name">ä¸–ç•Œä¹¦</div></div>
            <div id="btnHomeSpace" class="app-item"><div class="icon-space">â­</div><div class="app-name">æˆ‘çš„ç©ºé—´</div></div>
        </div>


        <div class=dock>
            <div class=dock-icon>ğŸ“</div><div class=dock-icon>ğŸ“·</div><div class=dock-icon>ğŸµ</div><div class=dock-icon>ğŸŒ</div>
        </div>
    </div>
    
    <div id=scrList class=scr-list>
        <div class=chat-header>
            <span id=btnListBack class=back-btn>ï¼œ</span>
            <span class=header-center>æ¶ˆæ¯</span>
            <span id=btnAddMenu class=plus-btn>+</span>
        </div>
        <div id=chatMenu class=drop-menu>
            <div class=menu-item>æ·»åŠ å¥½å‹</div>
            <div class=menu-item>æ–°å»ºç¾¤èŠ</div>
            <div class=menu-item>æ–°å»ºåˆ†ç»„</div>
            <div class=menu-item>æ‰«ä¸€æ‰«</div>
        </div>
        
        <div id=listContent class=list-content>
            <div id=btnListToRoom class=chat-item>
                <div id=listAva class=avatar-list>ğŸ‘¤</div>
                <div class=chat-info>
                    <div id=listName class=chat-name>ä¸“å±æ‹äºº</div>
                    <div id=chatPreview class=chat-preview>åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class=bottom-nav>
            <div id=navMsg class=nav-item-active><div class=nav-icon>ğŸ’¬</div><div class=nav-text>æ¶ˆæ¯</div></div>
            <div id=navContact class=nav-item><div class=nav-icon>ğŸ‘¥</div><div class=nav-text>è§’è‰²</div></div>
            <div id=navMoment class=nav-item><div class=nav-icon>ğŸŒ</div><div class=nav-text>åŠ¨æ€</div></div>
            <div id=navMe class=nav-item><div class=nav-icon>ğŸ‘¤</div><div class=nav-text>æˆ‘</div></div>
        </div>
    </div>
    
    <div id=scrRoom class=scr-room>
        <div class=room-header>
            <span id=btnRoomBack class=back-btn>ï¼œ</span>
            <span id=roomTitle class=room-center>ä¸“å±æ‹äºº</span>
            <span id=btnRoomSet class=settings-btn>âš™ï¸</span>
        </div>
        <div id=msgs class=chat-msgs></div>
        
        <div id=quoteBox class=quote-box>
            <div id=quoteText class=quote-txt></div>
            <span id=btnCloseQuote class=quote-close>âœ–</span>
        </div>
        
                        <div id=chatToolbarOld style=display:none;>
            <div id=btnRegen></div>
            <div id=btnPic></div>
            <div id=btnPlus></div>
        </div>
                <div class=chat-input>
            <div id=btnOpenSticker class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></div>
            <div id=btnMic class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg></div>
                                    <input type=search id=iptMsg class=msg-input placeholder=è¾“å…¥æ¶ˆæ¯... autocomplete=off>


            <div id=btnLemon class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 5.172C10 3.782 8.423 2.679 6.5 3c-2.823.47-4.113 6.006-4 7 .08.703 1.725 1.722 3.656 1 1.261-.467 1.95-1.9 3.844-2.5"></path><path d="M14 5.172C14 3.782 15.577 2.679 17.5 3c2.823.47 4.113 6.006 4 7-.08.703-1.725 1.722-3.656 1-1.261-.467-1.95-1.9-3.844-2.5"></path><path d="M8 14v1a4 4 0 0 0 8 0v-1"></path><path d="M16 10.5h.01"></path><path d="M8 10.5h.01"></path></svg></div>
            <div id=btnNewMenu class=tool-svg><svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg></div>
                        <button id=btnSend class=send-btn>å‘é€</button>
        </div>
        
                        <div id=newMenuDrawer class=menu-drawer>
            <div class=menu-grid>
                <div id=btnRegenNew class=menu-icon-btn>
                    <div class=menu-icon-svg>
                        <svg width=16 height=16 viewBox="0 0 24 24" fill=none stroke=#fff stroke-width=2 stroke-linecap=round stroke-linejoin=round><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><polyline points="3 3 3 8 8 8"></polyline></svg>
                    </div>
                    <div class=menu-icon-text>é‡æ–°ç”Ÿæˆ</div>
                </div>
            </div>
        </div>


        
    </div>
    
    <div id=ctxMenu class=ctx-menu>

        <div id=ctxCopy class=ctx-item>å¤åˆ¶</div>
        <div id=ctxEdit class=ctx-item>ç¼–è¾‘</div>
        <div id=ctxQuote class=ctx-item>å¼•ç”¨</div>
        <div id=ctxFav class=ctx-item>æ”¶è—</div>
        <div id=ctxMulti class=ctx-item>å¤šé€‰</div>
        <div id=ctxDel class=ctx-item style=color:#ff7675;background:#fff0f0;>åˆ é™¤</div>
    </div>
    
    <div id=editMsgModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>ç¼–è¾‘æ¶ˆæ¯</span>
            </div>
            <div class=modal-bdy style=padding:15px;>
                <textarea id=editMsgInput class=textarea-field style=height:150px;width:100%;box-sizing:border-box;></textarea>
                <div class=flex-row style=margin-top:15px;>
                    <button id=btnCancelEdit class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button>
                    <button id=btnConfirmEdit class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id=modal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>è§’è‰²å½“å‰çŠ¶æ€</span>
                <span id=btnCloseModal class=close-btn>âœ–</span>
            </div>
            <div class=modal-bdy>
                <div class=stat-card><div class=stat-tag>ğŸ“ å®šä½ä¸å¤©æ°”</div><div id=stW class=stat-txt>æš‚æ— æ•°æ®...</div></div>
                <div class=stat-card><div class=stat-tag>ğŸ‘• å½“æ—¥æœè£…</div><div id=stC class=stat-txt>æš‚æ— æ•°æ®...</div></div>
                <div class=stat-card><div class=stat-tag>ğŸ¬ è¡¨æƒ…ä¸åŠ¨ä½œ</div><div id=stA class=stat-txt>æš‚æ— æ•°æ®...</div></div>
                <div class=stat-card><div class=stat-tag>ğŸ’­ éšç§˜å¿ƒå£°</div><div id=stT class=stat-txt>æš‚æ— æ•°æ®...</div></div>
            </div>
        </div>
    </div>
    
    <div id=scrSetChat class=scr-flex>
        <div class=room-header>
            <span id=btnSetChatBack class=back-btn>ï¼œ</span>
            <span class=header-title>âœ¨ èŠå¤©è®¾ç½® âœ¨</span>
            <span class=empty-btn></span>
        </div>
        <div class=api-form>
                        <div class=section-card>
                <div class=section-title>ğŸ¨ å¤–è§‚ä¸ä¸ªæ€§åŒ–</div>
                <div class=input-group>
                    <label>èŠå¤©ä¸“å±èƒŒæ™¯ (ä»…èŠå¤©å®¤å†…æ˜¾ç¤º)</label>
                    <div id=btnBgUp class=upload-btn style="height:120px; padding:0; overflow:hidden; border-radius:12px; border:1px dashed #a29bfe;">
                        <div id=bgPreview style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; background-color:#f8f9fa; color:#888;">ğŸ–¼ï¸ ç‚¹å‡»é€‰æ‹©èƒŒæ™¯</div>
                    </div>
                    <input type=file id=upBg accept=image/* style=display:none;>
                </div>
                <div class=flex-row style="margin-top:10px; justify-content:space-around;">
                    <div class=flex-col style="align-items:center; flex:none;">
                        <label style="margin-bottom:5px;">å¯¹æ–¹å¤´åƒ</label>
                        <div id=btnAiUp class=upload-btn style="width:60px; height:60px; padding:0; overflow:hidden; border-radius:50%; border:1px solid #eee;">
                             <div id=aiPreview style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; background-color:#f8f9fa; font-size:24px;">ğŸ‘¤</div>
                        </div>
                        <input type=file id=upAi accept=image/* style=display:none;>
                    </div>
                    <div class=flex-col style="align-items:center; flex:none;">
                        <label style="margin-bottom:5px;">æˆ‘çš„å¤´åƒ</label>
                        <div id=btnMyUp class=upload-btn style="width:60px; height:60px; padding:0; overflow:hidden; border-radius:50%; border:1px solid #eee;">
                             <div id=myPreview style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; background-color:#f8f9fa; font-size:24px;">ğŸ‘¤</div>
                        </div>
                        <input type=file id=upMy accept=image/* style=display:none;>
                    </div>
                </div>
            </div>

            <div class=section-card>
                <div class=section-title>ğŸ“ åŸºç¡€èµ„æ–™</div>
                <div class=input-group><label>è§’è‰²çœŸå</label><input type=text id=cfgName class=input-field placeholder=è®¾å®šå¯¹æ–¹çœŸå></div>
                <div class=input-group><label>å¤‡æ³¨å</label><input type=text id=cfgRem class=input-field placeholder=è®¾ç½®ä¸“å±æ˜µç§°></div>
                <div class=input-group><label>æˆ‘çš„åå­— (ç”¨äºè®°å¿†æå–)</label><input type=text id=cfgMyName class=input-field placeholder=è®¾ç½®ä½ çš„ç§°å‘¼></div>
            </div>
            <div class=section-card>
                <div class=section-title>ğŸ§  AI å¤§è„‘ä¸è®¾å®š</div>
                <div class=input-group><label>å¯¹æ–¹äººè®¾</label><textarea id=cfgAiP class=textarea-field rows=3 placeholder=å¡«å†™æ€§æ ¼ä¸èº«ä»½></textarea></div>
                <div class=input-group><label>æˆ‘çš„äººè®¾</label><textarea id=cfgMyP class=textarea-field rows=2 placeholder=å¡«å†™ä½ çš„è®¾å®š></textarea></div>
                <div class=input-group><label>ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type=number id=cfgCtx class=input-field value=10 min=2 max=30></div>
                <div class=flex-row><label style=font-size:12px;color:#888;font-weight:bold;>å¼€å¯æ—¶é—´æ„ŸçŸ¥</label><input type=checkbox id=cfgTime checked style=width:20px;height:20px;></div>
            </div>
            
            <div class=section-card>
                <div class=section-title>â³ é•¿æœŸè®°å¿†æ—¥è®°åº“</div>
                <div class=flex-row><label style=font-size:12px;color:#888;font-weight:bold;>å¼€å¯è‡ªåŠ¨æ€»ç»“</label><input type=checkbox id=cfgAutoMem style=width:20px;height:20px;></div>
                
                <div class=input-group><label>è§¦å‘æ¡æ•° (å¯¹è¯å¤šå°‘æ¡åè‡ªåŠ¨è§¦å‘)</label><input type=number id=cfgMemTrig class=input-field value=10 min=5 max=100></div>
                <div class=input-group>
                    <label>ç§äººæ—¥è®°æç®€æç¤ºè¯ (é˜²å¤šè€—Token)</label>
                    <textarea id=cfgMemPmt class=textarea-field rows=4>è¯·ç”¨ç¬¬ä¸‰äººç§°è§†è§’ï¼Œç”¨ä¸€å¥è¯æå…¶ç®€ç»ƒåœ°æ¦‚æ‹¬åˆšæ‰å‘ç”Ÿçš„æ ¸å¿ƒå‰§æƒ…ã€‚ç»å¯¹ç¦æ­¢åŒ…å«æ—¥æœŸæˆ–ç¬¦å·ï¼ç›´æ¥è¾“å‡ºå‰§æƒ…ç»“æœã€‚è¯·ä½¿ç”¨åŒæ–¹åå­—ï¼ˆ[å¯¹æ–¹]ä¸[æˆ‘]ï¼‰ã€‚</textarea>
                </div>
                <div class=flex-row>
                    <div id=btnViewMem class=tool-btn style=margin-right:5px;>ğŸ“– æŸ¥çœ‹è®°å¿†åº“</div>
                    <div id=btnGenMem class=tool-btn style=margin-left:5px;background:#eef2ff;>âœ¨ ç«‹å³æ‰‹åŠ¨æ€»ç»“</div>
                </div>
            </div>
            <div class=section-card>
                <div class=section-title>ğŸ“š å±€éƒ¨ä¸–ç•Œä¹¦å…³è”</div>
                <div id=btnOpenLinkWb class=tool-btn>ç‚¹å‡»é€‰æ‹©è¦å…³è”çš„å‰§æƒ…</div>
            </div>
            <div class=section-card>
                <div class=section-title>âš ï¸ å±é™©æ“ä½œ</div>
                <div class=flex-row>
                    <div id=btnBlock class=clear-btn>æ‹‰é»‘å¥½å‹</div>
                    <div id=btnDelFriend class=clear-btn>åˆ é™¤å¥½å‹</div>
                </div>
                <div id=btnClearChat class=clear-btn style=margin-top:10px;>æ¸…ç©ºå½“å‰èŠå¤©è®°å½•</div>
            </div>
            <button id=btnSaveChat class=save-btn>ğŸ’¾ ä¿å­˜æ ¸å¿ƒé…ç½®</button>
        </div>
    </div>
    
    <div id=memModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>ğŸ“– æˆ‘ä»¬çš„ä¸“å±è®°å¿†åº“</span>
                <span id=btnCloseMem class=close-btn>âœ–</span>
            </div>
            <div id=memList class=modal-bdy></div>
        </div>
    </div>
    
    <div id=linkWbModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>å…³è”å±€éƒ¨ä¸–ç•Œä¹¦</span>
                <span id=btnCloseLinkWb class=close-btn>âœ–</span>
            </div>
            <div id=linkWbList class=modal-bdy></div>
            <div style=padding:15px;>
                <div id=btnSaveLinkWb class=save-btn style=margin-top:0;>ç¡®è®¤å…³è”å¹¶ä¿å­˜</div>
            </div>
        </div>
    </div>
    
    <div id=scrSetApi class=scr-flex>
        <div class=room-header>
            <span id=btnSetApiBack class=back-btn>ï¼œ</span>
            <span class=header-title>API ç½‘ç»œè®¾ç½®</span>
            <span class=empty-btn></span>
        </div>
        <div class=api-form>
            <div class=section-card>
                <div class=input-group><label>åä»£åœ°å€</label><input type=text id=apiPxy class=input-field placeholder=è¾“å…¥å®Œæ•´æ¥å£åœ°å€></div>
                                <div class=input-group><label>ä¸“å±å¯†é’¥</label><input type=text id=apiK class=input-field style="-webkit-text-security:disc;" placeholder=å¡«å†™ä¸“å±å¯†é’¥ autocomplete=new-password></div>

                <div class=input-group>
                    <label>æ¨¡å‹é€‰æ‹©</label>
                    <input type=text id=apiMod class=input-field placeholder=è¾“å…¥æ¨¡å‹åç§°>
                    <select id=apiModSel class=input-field style=display:none;></select>
                </div>
                <div class=input-group>
                    <label>æ¸©åº¦æ•°å€¼: <span id=tempVal>0.8</span></label>
                    <input type=range id=apiTemp min=0 max=2 step=0.1 value=0.8>
                </div>
                <div class=flex-row style=margin-top:10px;>
                    <button id=btnPull class=tool-btn>ğŸ“¡ æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
                </div>
            </div>
            <button id=btnSaveApi class=save-btn>ğŸ’¾ ä¿å­˜ç½‘ç»œé…ç½®</button>
        </div>
    </div>
    
    <div id=scrWb class=scr-flex>
        <div class=room-header>
            <span id=btnWbBack class=back-btn>ï¼œ</span>
            <span class=header-center>ä¸–ç•Œä¹¦ç³»ç»Ÿ</span>
            <span id=btnWbAdd class=plus-btn>+</span>
        </div>
        <div class=wb-tabs>
            <div id=tabGlobal class=wb-active style=flex:1;text-align:center;padding:10px;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;transition:0.3s;>å…¨å±€è®°å¿†</div>
            <div id=tabLocal class=wb-tab style=flex:1;text-align:center;padding:10px;border-radius:12px;font-size:14px;font-weight:bold;cursor:pointer;transition:0.3s;>å±€éƒ¨å‰§æƒ…</div>
        </div>
        <div id=wbListContainer class=wb-list></div>
    </div>
    
    <div id=scrWbEdit class=scr-flex>
        <div class=room-header>
            <span id=btnWbEditBack class=back-btn>ï¼œ</span>
            <span class=header-center>ç¼–è¾‘ä¸–ç•Œä¹¦</span>
            <span class=empty-btn></span>
        </div>
        <div class=api-form>
            <div class=section-card>
                <div class=input-group><label>æ ‡é¢˜</label><input type=text id=wbTitle class=input-field placeholder=è¾“å…¥è®°å¿†æ ‡é¢˜></div>
                <div class=input-group>
                    <label>åŠ è½½ç±»å‹</label>
                    <select id=wbType class=input-field>
                        <option value=global>å…¨å±€åŠ è½½ (æ‰€æœ‰è§’è‰²é»˜è®¤çŸ¥æ™“)</option>
                        <option value=local>å±€éƒ¨å…³è” (éœ€åœ¨èŠå¤©è®¾ç½®æ‰‹åŠ¨å…³è”)</option>
                    </select>
                </div>
                <div class=input-group><label>å†…å®¹è®¾å®š</label><textarea id=wbContent class=textarea-field rows=8 placeholder=è¯¦ç»†æè¿°ä¸–ç•Œè§‚æˆ–èƒŒæ™¯è®¾å®š></textarea></div>
            </div>
            <button id=btnWbSave class=save-btn>ğŸ’¾ è®°å½•è¿›ä¸–ç•Œä¹¦</button>
        </div>
    </div>
    
    <div id=stickerDrawer class=sticker-drawer>
        <div class=sticker-header>
            <span id=btnCancelSticker>å–æ¶ˆ</span>
            <span class=title>è¡¨æƒ…åŒ…</span>
            <div class=sticker-actions>
                <span id=stickerEditBtn>ç¼–è¾‘</span>
                <span id=btnDelSelectedSticker style=display:none;color:#ff4d4f;>åˆ é™¤</span>
                <span id=btnSelectAllSticker style=display:none;>å…¨é€‰</span>
                <span id=btnAddBatchSticker>æ·»åŠ </span>
                <span id=btnUploadStickerClick>ä¸Šä¼ </span>
                <input type=file id=stickerUploadInput accept=image/* style=display:none;>
            </div>
        </div>
        <div class=sticker-search>
            <input type=text id=stickerSearch placeholder=æœç´¢è¡¨æƒ…åŒ…åç§°...>
        </div>
        <div class=sticker-grid id=stickerGrid></div>
        <div class=sticker-footer>
            <button class=category-btn>æœªåˆ†ç±»</button>
        </div>
    </div>

    <div id=batchModal class=batch-modal-overlay>
        <div class=batch-modal>
            <h3 style=margin-bottom:15px;>æ‰¹é‡æ·»åŠ è¡¨æƒ…</h3>
            <div class=batch-input-wrapper>
                <textarea id=batchStickerInput placeholder=ä¸€è¡Œä¸€ä¸ªï¼Œåç§°å’Œé“¾æ¥ç”¨ç©ºæ ¼éš”å¼€></textarea>
            </div>
            <div class=batch-modal-btns>
                <button id=btnCancelBatch class=cancel>å–æ¶ˆ</button>
                <button id=btnConfirmBatch>ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id=scrMe class=scr-list>
        <div class=chat-header>
            <span id=btnMeBack class=back-btn>ï¼œ</span>
            <span class=header-center>æˆ‘</span>
            <span class=empty-btn></span>
        </div>
        
        <div class=me-header>
            <div id=meAvatar class=me-avatar></div>
            <div class=me-info>
                <div id=meName class=me-name>æœªå‘½å</div>
                <div id=meBio class=me-bio>è¯·æ·»åŠ ä½ çš„ä¸ªæ€§ç­¾åå§ï¼</div>
            </div>
            <div class=me-icons>
                <span id=btnEditMe style=cursor:pointer;>ğŸ“</span>
                <span style=color:#ff4d4f;cursor:pointer;>ğŸ—‘ï¸</span>
            </div>
        </div>

        <div class=me-menu-list>
            <div id=btnGoCharSticker class=me-menu-item>
                <div class=me-menu-left>
                    <div class=me-menu-title>è§’è‰²è¡¨æƒ…åŒ…åº“</div>
                    <div class=me-menu-sub>è®©å¯¹æ–¹ä¹Ÿèƒ½éšæ—¶å‘é€è¡¨æƒ…åŒ…</div>
                </div>
                <div class=me-menu-right>ï¼</div>
            </div>
                        <div id=btnGoFav class=me-menu-item>
                <div class=me-menu-left>
                    <div class=me-menu-title>æˆ‘çš„æ”¶è—</div>
                    <div class=me-menu-sub>æŸ¥çœ‹æ”¶è—çš„ç²¾å½©æ¶ˆæ¯</div>
                </div>
                <div class=me-menu-right>ï¼</div>
            </div>

            <div id=btnOpenWallet class=me-menu-item>
                <div class=me-menu-left>
                    <div class=me-menu-title>æˆ‘çš„é’±åŒ…</div>
                    <div class=me-menu-sub>ç®¡ç†ä½ çš„åŒæ ¸èµ„äº§ä¸è½¬è´¦è®°å½•</div>
                </div>
                <div class=me-menu-right>ï¼</div>
            </div>
        </div>
        
        <div class=bottom-nav>
            <div id=navMeToMsg class=nav-item><div class=nav-icon>ğŸ’¬</div><div class=nav-text>æ¶ˆæ¯</div></div>
            <div id=navMeToContact class=nav-item><div class=nav-icon>ğŸ‘¥</div><div class=nav-text>è§’è‰²</div></div>
            <div id=navMeToMoment class=nav-item><div class=nav-icon>ğŸŒ</div><div class=nav-text>åŠ¨æ€</div></div>
            <div class=nav-item-active><div class=nav-icon>ğŸ‘¤</div><div class=nav-text>æˆ‘</div></div>
        </div>
    </div>
<div id=scrCharSticker class=scr-flex>
                <div class=room-header>
            <span id=btnCharStickerBack class=back-btn>ï¼œ</span>
            <span class=header-center>è§’è‰²è¡¨æƒ…åŒ…åº“</span>
            <span id=btnEditCharSticker style=cursor:pointer;font-size:14px;color:#6c5ce7;font-weight:bold;>ç®¡ç†</span>
        </div>
        <div id=charStickerActions style=display:none;padding:10px 20px;background:#fff0f0;justify-content:space-between;align-items:center;border-bottom:1px solid #ffeeee;flex-shrink:0;>
            <span id=btnSelAllCharSticker style=color:#333;font-size:13px;cursor:pointer;font-weight:bold;>å…¨é€‰</span>
            <span id=btnDelCharSticker style=color:#ff7675;font-size:13px;font-weight:bold;cursor:pointer;>åˆ é™¤é€‰ä¸­</span>
        </div>

        <div class=api-form>
            <div class=section-card>
                <div class=section-title>â• æé€Ÿæ‰¹é‡æ·»åŠ è¡¨æƒ…</div>
                <div style=font-size:12px;color:#888;margin-bottom:10px;line-height:1.5;>æ— éœ€æ‰‹åŠ¨å‘½åï¼ç³»ç»Ÿä¼šè‡ªåŠ¨è¯»å–æ–‡ä»¶åä½œä¸ºAIè¯†åˆ«æŒ‡ä»¤ã€‚(å»ºè®®æœ¬åœ°å›¾ç‰‡æå‰å‘½åä¸ºæƒ…ç»ªè¯ï¼Œå¦‚:æ— è¯­ã€å¤§ç¬‘)</div>
                <div class=input-group>
                    <div id=btnUpCharSticker class=upload-btn style=background:#eef2ff;color:#6c5ce7;border:1px dashed #a29bfe;>ğŸ–¼ï¸ 1. ç‚¹å‡»æ‰¹é‡ä¸Šä¼ æœ¬åœ°å›¾ç‰‡ (å¯å¤šé€‰)</div>
                    <input type=file id=upCharSticker accept=image/* multiple style=display:none;>
                </div>
                <div class=flex-col style=margin-top:10px;>
                    <textarea id=iptCharBatchUrl class=textarea-field rows=4 placeholder=2.æˆ–è€…åœ¨æ­¤æ‰¹é‡ç²˜è´´ç½‘ç»œå›¾ç‰‡é“¾æ¥(ä¸€è¡Œä¸€ä¸ªï¼Œç³»ç»Ÿè‡ªåŠ¨è§£æåç§°)></textarea>
                </div>
                <button id=btnAddCharSticker class=save-btn style=margin-top:10px;padding:12px;>ğŸ’¾ 3. å°†é“¾æ¥å­˜å…¥è§’è‰²å¤§è„‘</button>
            </div>
            <div class=section-card>
                <div class=section-title>ğŸ“¦ è§’è‰²å·²æŒæ¡çš„è¡¨æƒ…</div>
               <div id=charStickerList style=display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-height:300px;overflow-y:auto;padding-right:5px;></div>
            </div>
        </div>
    </div>
  <div id="scrSpace" class="scr-flex">
    <div class="room-header">
        <span id="btnSpaceBack" class="back-btn">ï¼œ</span>
        <span class="header-center">æˆ‘çš„ç©ºé—´</span>
        <span class="empty-btn"></span>
    </div>
    <div class="me-header">
        <div id="spaceAvatar" class="me-avatar"></div>
        <div class="me-info">
            <div id="spaceName" class="me-name">ä½ çš„åå­—</div>
            <div id="spaceBio" class="me-bio">è¯·æ·»åŠ ä½ çš„ä¸ªæ€§ç­¾åå§ï¼</div>
        </div>
        <div class="me-icons">
            <span id="btnEditSpace" style="cursor:pointer;">ğŸ“</span>
        </div>
    </div>
    <div class="me-menu-list">
        <div id="btnSpaceLogs" class="me-menu-item">
            <div class="me-menu-left">
                <div class="me-menu-title">æˆ‘çš„æ—¥å¿—</div>
                <div class="me-menu-sub">è®°å½•ç”Ÿæ´»ç‚¹æ»´ï¼Œäº’åŠ¨è¯„è®º</div>
            </div>
            <div class="me-menu-right">ï¼</div>
        </div>
        <div id="btnSpaceBoard" class="me-menu-item">
            <div class="me-menu-left">
                <div class="me-menu-title">ç•™è¨€æ¿</div>
                <div class="me-menu-sub">ä¸»äººå¯„è¯­ï¼Œæœ‹å‹è¸©è¸©</div>
            </div>
            <div class="me-menu-right">ï¼</div>
        </div>
        <div id="btnSpaceMoments" class="me-menu-item">
            <div class="me-menu-left">
                <div class="me-menu-title">æˆ‘çš„è¯´è¯´</div>
                <div class="me-menu-sub">éšæ—¶éšåœ°åˆ†äº«å¿ƒæƒ…</div>
            </div>
            <div class="me-menu-right">ï¼</div>
        </div>
    </div>
</div>

<div id="scrLogList" class="scr-flex">
    <div class="room-header">
        <span id="btnLogListBack" class="back-btn">ï¼œ</span>
        <span class="header-center">ä¸“å±æ—¥å¿—æœ¬</span>
        <span id="btnWriteLog" class="plus-btn" style="font-size: 20px;">âœï¸</span>
    </div>
    <div class="log-list-header">
        <div id="tabMyLogs" class="log-tab log-tab-active">æˆ‘çš„æ—¥å¿—</div>
        <div id="tabAiLogs" class="log-tab">Taçš„æ—¥å¿—</div>
    </div>
    <div id="logListContainer" class="list-content" style="padding-bottom: 20px; overflow-y: auto;">
    </div>
</div>

<div id="scrLogEdit" class="scr-flex">
    <div class="room-header">
        <span id="btnLogEditBack" class="back-btn">ï¼œ</span>
        <span class="header-center">å†™æ—¥å¿—</span>
        <span id="btnPublishLog" style="color:#6c5ce7; font-weight:bold; cursor:pointer; font-size:15px;">å‘è¡¨</span>
    </div>
    <div class="api-form" style="padding: 20px;">
        <div class="section-card">
            <div class="input-group">
                <label>é…å›¾æ–¹å¼</label>
                <select id="logImgType" class="input-field">
                    <option value="none">çº¯æ–‡å­— (ä¸åŠ å›¾ç‰‡)</option>
                    <option value="text">è„‘è¡¥æ¨¡å¼ (æ–‡å­—æè¿°å›¾ç‰‡)</option>
                    <option value="local">å¸¸è§„æ¨¡å¼ (ä¸Šä¼ æœ¬åœ°å›¾ç‰‡)</option>
                </select>
            </div>
            <div id="logTextImgBlock" class="input-group" style="display:none; margin-top:10px;">
                <label>å‘AIæè¿°è¿™å¼ å›¾çš„å†…å®¹ (ç³»ç»Ÿå°†æ˜¾ç¤ºä¸ºå ä½å›¾)</label>
                <input type="text" id="logImgDesc" class="input-field" placeholder="ä¾‹å¦‚ï¼šä¸€å¼ åœ¨æµ·è¾¹æ‹çš„æ—¥è½é£æ™¯ç…§...">
            </div>
            <div id="logLocalImgBlock" class="input-group" style="display:none; margin-top:10px;">
                <label>é€‰æ‹©æœ¬åœ°å›¾ç‰‡</label>
                <div id="btnSelectLogImg" class="upload-btn">ğŸ–¼ï¸ ç‚¹å‡»é€‰æ‹©</div>
                <input type="file" id="upLogImg" accept="image/*" style="display:none;">
                <img id="logImgPreview" style="width:100%; max-height:150px; object-fit:contain; margin-top:10px; display:none; border-radius:10px;">
            </div>
        </div>
        <div class="section-card" style="flex: 1;">
            <div class="input-group" style="height: 100%;">
                <label>æ—¥å¿—æ­£æ–‡</label>
                <textarea id="logContent" class="textarea-field" style="height: 250px; resize: none;" placeholder="è®°å½•ä»Šå¤©çš„ç‚¹ç‚¹æ»´æ»´..."></textarea>
            </div>
        </div>
    </div>
</div>






<div id=editMeModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>ç¼–è¾‘ä¸ªäººèµ„æ–™</span>
            </div>
            <div class=modal-bdy style=padding:15px;>
                <div class=input-group>
                    <label>å¤´åƒ</label>
                    <div id=btnSetMeAvatar class=upload-btn>ğŸ–¼ï¸ ç‚¹å‡»ä¸Šä¼ ä½ çš„ä¸“å±å¤´åƒ</div>
                    <input type=file id=upMeAvatar accept=image/* style=display:none;>
                </div>
                <div class=input-group style=margin-top:10px;>
                    <label>æ˜µç§°</label>
                    <input type=text id=iptMeName class=input-field placeholder=è¾“å…¥ä½ çš„æ˜µç§°>
                </div>
                <div class=input-group style=margin-top:10px;>
                    <label>ä¸ªæ€§ç­¾å</label>
                    <input type=text id=iptMeBio class=input-field placeholder=è¾“å…¥ä¸ªæ€§ç­¾å>
                </div>
                <div class=flex-row style=margin-top:15px;>
                    <button id=btnCancelEditMe class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button>
                                        <button id=btnSaveEditMe class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id=addFriendModal class=modal-base>
        <div class=modal-ctx>
            <div class=modal-hdr>
                <span>æ·»åŠ æ–°è§’è‰²</span>
            </div>
            <div class=modal-bdy style=padding:15px;>
                <div class=input-group>
                    <label>è§’è‰²åç§°</label>
                    <input type=text id=newFriendName class=input-field placeholder=è¾“å…¥æ–°è§’è‰²çš„åå­—>
                </div>
                <div class=input-group style=margin-top:10px;>
                    <label>åˆå§‹äººè®¾</label>
                    <textarea id=newFriendPrompt class=textarea-field rows=3 placeholder=ç®€å•æè¿°TAçš„æ€§æ ¼></textarea>
                </div>
                <div class=flex-row style=margin-top:15px;>
                    <button id=btnCancelAddFriend class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button>
                    <button id=btnConfirmAddFriend class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ç¡®å®šæ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

</div>
    <div id="scrFav" class="scr-flex">
        <div class="room-header">
            <span id="btnFavBack" class="back-btn">ï¼œ</span>
            <span class="header-center">æˆ‘çš„æ”¶è—</span>
            <span class="empty-btn"></span>
        </div>
        <div id="favListContainer" class="list-content" style="padding: 15px; overflow-y: auto; background-color: #f5f6fa;"></div>
    </div>
    <div id="voiceModal" class="modal-base">
        <div class="modal-ctx" style="width:80%; max-width:300px; padding:20px; border-radius:20px; background:#fff; display:flex; flex-direction:column; align-items:center;">
            <h3 style="margin:0 0 15px 0; font-size:18px; color:#333;">å‘é€è¯­éŸ³</h3>
            <textarea id="voiceInputText" style="width:100%; height:120px; background:#f5f6fa; border:none; border-radius:15px; padding:15px; box-sizing:border-box; font-size:14px; resize:none; outline:none;" placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥è¯­éŸ³å†…å®¹..."></textarea>
            <div style="display:flex; width:100%; gap:15px; margin-top:20px;">
                <button id="btnCancelVoice" style="flex:1; padding:12px; border-radius:25px; border:none; background:#f0f2f5; color:#666; font-size:15px; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
                <button id="btnSendVoice" style="flex:1; padding:12px; border-radius:25px; border:none; background:#000; color:#fff; font-size:15px; font-weight:bold; cursor:pointer;">å‘é€</button>
            </div>
        </div>
    </div>

    

            



<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script>


const $ = id => document.getElementById(id);
let lock=$("scrLock"), home=$("scrHome"), list=$("scrList"), room=$("scrRoom"), setApi=$("scrSetApi"), setChat=$("scrSetChat"), scrWb=$("scrWb"), scrWbEdit=$("scrWbEdit"), scrMe=$("scrMe"), scrCharSticker=$("scrCharSticker"), scrSpace=$("scrSpace"), scrLogList=$("scrLogList"), scrLogEdit=$("scrLogEdit");
let iptMsg=$("iptMsg"), msgs=$("msgs"), modal=$("modal");
let stW=$("stW"), stC=$("stC"), stA=$("stA"), stT=$("stT");
let ls = localStorage;
let currentChatId = "default";
let originalSetItem = ls.setItem;
let isolatedKeys = ["chatHistory", "aiStatus", "bgI", "aiI", "cMP", "cN", "cR", "cAP", "cCtx", "cT", "cAMem", "cMemT", "cMemP", "linkedWb", "lastMemCount", "memories"];
ls.setItem = function(key, value) {
    // å…¨å±€æ‹¦æˆªï¼šåªè¦æ˜¯å­˜è¡¨æƒ…åŒ…å’Œæ—¥å¿—ï¼Œç»Ÿç»Ÿå¼ºåˆ¶æ‰”è¿›å¤§ä»“åº“ï¼Œä¿æŠ¤è€å†…å­˜ï¼
    if (key === "myPhoneStickers" || key === "charStickers" || key === "myLogs") {
        localforage.setItem(key, value);
        return;
    }
    if (isolatedKeys.includes(key)) {
        originalSetItem.call(this, key + "_" + currentChatId, value);
    } else {
        originalSetItem.call(this, key, value);
    }
};

let originalGetItem = ls.getItem;
ls.getItem = function(key) {
    if (isolatedKeys.includes(key)) {
        let spec = originalGetItem.call(this, key + "_" + currentChatId);
        if (spec) return spec;
        if (currentChatId === "default") return originalGetItem.call(this, key);
        return null;
    }
    return originalGetItem.call(this, key);
};
let originalRemoveItem = ls.removeItem;
ls.removeItem = function(key) {
    if (isolatedKeys.includes(key)) {
        originalRemoveItem.call(this, key + "_" + currentChatId);
    } else {
        originalRemoveItem.call(this, key);
    }
};
let history = ls.getItem("chatHistory") ? JSON.parse(ls.getItem("chatHistory")) : [];
let aiStatus = ls.getItem("aiStatus") ? JSON.parse(ls.getItem("aiStatus")) : {weather:"ç­‰å¾…è¿æ¥...",clothing:"ç­‰å¾…è¿æ¥...",action:"ç­‰å¾…è¿æ¥...",thought:"ç­‰å¾…è¿æ¥..."};
let wbData = ls.getItem(`wbData`) ? JSON.parse(ls.getItem(`wbData`)) : [];
let linkedWb = ls.getItem(`linkedWb`) ? JSON.parse(ls.getItem(`linkedWb`)) : [];
let pressTimer = null;

let selEl = null;
let currentQuote = "";
function showScreen(showId) {
    [lock, home, list, room, setApi, setChat, scrWb, scrWbEdit, scrMe, scrCharSticker, scrSpace, scrLogList, scrLogEdit, $("scrFav")].forEach(s => { if(s) s.style.display = "none"; });
    let target = $(showId);
    if(target) {
        if(showId === "scrRoom" || showId === "scrList" || showId === "scrSetApi" || showId === "scrSetChat" || showId === "scrWb" || showId === "scrWbEdit" || showId === "scrMe" || showId === "scrCharSticker" || showId === "scrSpace" || showId === "scrLogList" || showId === "scrLogEdit" || showId === "scrFav") {
            target.style.display = "flex";
        } else { target.style.display = "block"; }
    }
}





function updTime() {
    let d = new Date(), loc = d.getTime(), off = d.getTimezoneOffset() * 60000;
    let bj = new Date(loc + off + (3600000 * 8));
    $(`time`).innerText = bj.getHours().toString().padStart(2, `0`) + `:` + bj.getMinutes().toString().padStart(2, `0`);
    let days = [`æ—¥`,`ä¸€`,`äºŒ`,`ä¸‰`,`å››`,`äº”`,`å…­`];
    $(`date`).innerText = (bj.getMonth()+1) + `æœˆ` + bj.getDate() + `æ—¥ æ˜ŸæœŸ` + days[bj.getDay()];
    return bj;
}
setInterval(updTime, 1000);

if(ls.getItem(`pxy`)) $(`apiPxy`).value = ls.getItem(`pxy`);
if(ls.getItem(`key`)) $(`apiK`).value = ls.getItem(`key`);
if(ls.getItem(`mod`)) $(`apiMod`).value = ls.getItem(`mod`);
if(ls.getItem(`temp`)) { $(`apiTemp`).value = ls.getItem(`temp`); $(`tempVal`).innerText = ls.getItem(`temp`); }
$(`apiTemp`).oninput = function() { $(`tempVal`).innerText = this.value; };

if(ls.getItem(`cN`)) $(`cfgName`).value = ls.getItem(`cN`);
if(ls.getItem(`cR`)) $(`cfgRem`).value = ls.getItem(`cR`);
if(ls.getItem(`cMyN`)) $(`cfgMyName`).value = ls.getItem(`cMyN`);
if(ls.getItem(`cAP`)) $(`cfgAiP`).value = ls.getItem(`cAP`);
if(ls.getItem(`cMP`)) $(`cfgMyP`).value = ls.getItem(`cMP`);
if(ls.getItem(`cCtx`)) $(`cfgCtx`).value = ls.getItem(`cCtx`);
if(ls.getItem(`cT`) === `false`) $(`cfgTime`).checked = false;
if(ls.getItem(`cAMem`)) $(`cfgAutoMem`).checked = ls.getItem(`cAMem`) === `true`;
if(ls.getItem(`cMemT`)) $(`cfgMemTrig`).value = ls.getItem(`cMemT`);
if(ls.getItem(`cMemP`)) $(`cfgMemPmt`).value = ls.getItem(`cMemP`);

function getPreviewText(histArray) {
    if(!histArray || histArray.length === 0) return `ä½ ä»¬å·²æˆä¸ºå¥½å‹ï¼Œè¯·å¼€å§‹èŠå¤©å§ï¼`;
    let last = histArray[histArray.length - 1];
    let txt = last.content;
    if(last.role === `assistant`) {
        let rM = txt.match(/ã€å›å¤ã€‘([\s\S]*)$/);
        if(rM) {
            let out = rM[1].trim();
            let lns = out.split(/\n+/).filter(x => x.trim() !== ``);
            if(lns.length === 1 && out.length > 30) { lns = out.replace(/([ã€‚ï¼ï¼Ÿ!?])/g, `$1\n`).split(/\n+/).filter(x => x.trim() !== ``); }
            if(lns.length > 0) txt = lns[lns.length - 1]; else txt = out;
        } else {
            let lns = txt.split(/\n+/).filter(x => x.trim() !== ``);
            if(lns.length > 0) txt = lns[lns.length - 1];
        }
    }
    txt = txt.replace(/ã€Œå¼•ç”¨ï¼š.*?ã€\n/g, ``).replace(/ã€.*?ã€‘/g, ``).replace(/\[å›¾ç‰‡æ¶ˆæ¯ï¼š.*?\][\s\S]*/g, `[è¡¨æƒ…åŒ…]`).trim();
    return txt.length > 15 ? txt.substring(0, 15) + `...` : txt;
}
function updateListPreview() {
    let p = $(`chatPreview`);
    let rawHist = originalGetItem.call(ls, `chatHistory_default`) || originalGetItem.call(ls, `chatHistory`);
    let defHist = rawHist ? JSON.parse(rawHist) : [];
    if(currentChatId === `default`) defHist = history;
    if(p) p.innerText = getPreviewText(defHist);
    setTimeout(() => { try { if(typeof renderContacts === `function`) renderContacts(); } catch(e){} }, 50);
}
function applyVis() {
    let dn = $(`cfgRem`).value || $(`cfgName`).value || `ä¸“å±æ‹äºº`;
    $(`roomTitle`).innerText = dn;
    
    let defName = originalGetItem.call(ls, `cR_default`) || originalGetItem.call(ls, `cN_default`) || originalGetItem.call(ls, `cR`) || originalGetItem.call(ls, `cN`) || `ä¸“å±æ‹äºº`;
    if (currentChatId === `default`) defName = dn;
    $(`listName`).innerText = defName;
    
    let bg = ls.getItem(`bgI`);
    if(bg) { 
        room.style.backgroundImage = `url(${bg})`; 
        if($(`bgPreview`)) { $(`bgPreview`).style.backgroundImage = `url(${bg})`; $(`bgPreview`).innerText = ``; }
    } else { 
        room.style.backgroundImage = `none`; 
        if($(`bgPreview`)) { $(`bgPreview`).style.backgroundImage = `none`; $(`bgPreview`).innerText = `ğŸ–¼ï¸ ç‚¹å‡»é€‰æ‹©èƒŒæ™¯`; }
    }
    
    let defAiA = originalGetItem.call(ls, `aiI_default`) || originalGetItem.call(ls, `aiI`);
    if (currentChatId === `default`) defAiA = ls.getItem(`aiI`);
    if(defAiA) { $(`listAva`).style.backgroundImage = `url(${defAiA})`; $(`listAva`).innerText = ``; }
    else { $(`listAva`).style.backgroundImage = `none`; $(`listAva`).innerText = `ğŸ‘¤`; }
    
    let curAiA = ls.getItem(`aiI`);
    if(curAiA) {
        if($(`aiPreview`)) { $(`aiPreview`).style.backgroundImage = `url(${curAiA})`; $(`aiPreview`).innerText = ``; }
    } else {
        if($(`aiPreview`)) { $(`aiPreview`).style.backgroundImage = `none`; $(`aiPreview`).innerText = `ğŸ‘¤`; }
    }
    
    let myN = $(`cfgMyName`).value || `ä½ çš„åå­—`;
    if($(`meName`)) $(`meName`).innerText = myN;
    let myBio = ls.getItem(`myBio`) || `è¯·æ·»åŠ ä½ çš„ä¸ªæ€§ç­¾åå§ï¼`;
    if($(`meBio`)) $(`meBio`).innerText = myBio;
    
    let myA = ls.getItem(`myI`);
    if(myA) { 
        if($(`meAvatar`)) { $(`meAvatar`).style.backgroundImage = `url(${myA})`; $(`meAvatar`).innerHTML = ``; }
        if($(`spaceAvatar`)) { $(`spaceAvatar`).style.backgroundImage = `url(${myA})`; $(`spaceAvatar`).innerHTML = ``; }
        if($(`myPreview`)) { $(`myPreview`).style.backgroundImage = `url(${myA})`; $(`myPreview`).innerText = ``; }
    } else { 
        if($(`meAvatar`)) { $(`meAvatar`).style.backgroundImage = `none`; $(`meAvatar`).innerHTML = `<div style=width:100%;height:100%;display:flex;justify-content:center;align-items:center;font-size:35px;color:#999;>ğŸ‘¤</div>`; }
        if($(`spaceAvatar`)) { $(`spaceAvatar`).style.backgroundImage = `none`; $(`spaceAvatar`).innerHTML = `<div style=width:100%;height:100%;display:flex;justify-content:center;align-items:center;font-size:35px;color:#999;>ğŸ‘¤</div>`; }
        if($(`myPreview`)) { $(`myPreview`).style.backgroundImage = `none`; $(`myPreview`).innerText = `ğŸ‘¤`; }
    }
    
    if($(`spaceName`)) $(`spaceName`).innerText = myN;
    if($(`spaceBio`)) $(`spaceBio`).innerText = myBio;
    
    linkedWb = ls.getItem(`linkedWb`) ? JSON.parse(ls.getItem(`linkedWb`)) : [];
    updateListPreview();
}





applyVis();


function cmp(id, key) {
    $(id).onchange = e => {
        let f = e.target.files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = ev => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement(`canvas`), ctx = cvs.getContext(`2d`);
                let maxW = (key === 'bgI') ? 400 : 150; 
                let maxH = (key === 'bgI') ? 700 : 150;
                let w = img.width, h = img.height;
                if(w>h && w>maxW) { h*=maxW/w; w=maxW; } else if(h>maxH) { w*=maxH/h; h=maxH; }
                cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
                try {
                    ls.setItem(key, cvs.toDataURL(`image/webp`, 0.4));
                    applyVis(); alert(`åº”ç”¨æˆåŠŸï¼`);
                } catch(err) {
                    alert(`æœ¬åœ°ç©ºé—´ä¸è¶³å•¦ï¼è¯·å…ˆåˆ é™¤ä¸€äº›ä¸è¦çš„åŠ¨æ€æˆ–è¡¨æƒ…åŒ…å†è¯•è¯•ã€‚`);
                }
            };
            img.src = ev.target.result;
        }; r.readAsDataURL(f);
    };
}



$(`btnBgUp`).onclick = () => $(`upBg`).click();
$(`btnAiUp`).onclick = () => $(`upAi`).click();
$(`btnMyUp`).onclick = () => $(`upMy`).click();
cmp(`upBg`, `bgI`); cmp(`upAi`, `aiI`); cmp(`upMy`, `myI`);

lock.onclick = () => { showScreen(`scrHome`); };
$(`btnHomeChat`).onclick = () => showScreen(`scrList`);
$(`btnListBack`).onclick = () => showScreen(`scrHome`);
$(`btnHomeApi`).onclick = () => showScreen(`scrSetApi`);
$(`btnSetApiBack`).onclick = () => showScreen(`scrHome`);
$(`btnListToRoom`).onclick = () => { showScreen(`scrRoom`); msgs.scrollTop = msgs.scrollHeight; };
$(`btnRoomBack`).onclick = () => { showScreen(`scrList`); updateListPreview(); };
$(`btnRoomSet`).onclick = () => showScreen(`scrSetChat`);
$(`btnSetChatBack`).onclick = () => showScreen(`scrRoom`);
$(`btnHomeWb`).onclick = () => { showScreen(`scrWb`); renderWb(); };
$(`btnCloseModal`).onclick = () => modal.style.display=`none`;

$(`btnAddMenu`).onclick = () => { let m = $(`chatMenu`); m.style.display = m.style.display===`block`?`none`:`block`; };
let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
function renderContacts() {
    let listItems = document.querySelectorAll(`.chat-item`);
    for(let i=1; i<listItems.length; i++) listItems[i].remove();
    contacts.forEach(c => {
        let div = document.createElement(`div`);
        div.className = `chat-item`;
        
        let isoHistStr = originalGetItem.call(ls, `chatHistory_` + c.id);
        let isoHist = isoHistStr ? JSON.parse(isoHistStr) : [];
        if(currentChatId === c.id) isoHist = history;
        let prevTxt = getPreviewText(isoHist);

        let isoAiA = originalGetItem.call(ls, `aiI_` + c.id);
        let avaHtml = isoAiA ? `<div class=avatar-list style=background-image:url(`+isoAiA+`);font-size:0;></div>` : `<div class=avatar-list>ğŸ‘¤</div>`;
        let isoName = originalGetItem.call(ls, `cN_` + c.id) || c.name;
        
        div.innerHTML = avaHtml + `<div class=chat-info><div class=chat-name>` + isoName + `</div><div class=chat-preview>` + prevTxt + `</div></div>`;
        div.onclick = () => {
            currentChatId = c.id;
            $(`cfgName`).value = originalGetItem.call(ls, `cN_` + c.id) || c.name;
            $(`cfgRem`).value = originalGetItem.call(ls, `cR_` + c.id) || ``;
            $(`cfgAiP`).value = originalGetItem.call(ls, `cAP_` + c.id) || c.prompt;
            $(`cfgMyP`).value = originalGetItem.call(ls, `cMP_` + c.id) || ``;
            history = ls.getItem(`chatHistory`) ? JSON.parse(ls.getItem(`chatHistory`)) : [];
            aiStatus = ls.getItem(`aiStatus`) ? JSON.parse(ls.getItem(`aiStatus`)) : {weather:"ç­‰å¾…è¿æ¥...",clothing:"ç­‰å¾…è¿æ¥...",action:"ç­‰å¾…è¿æ¥...",thought:"ç­‰å¾…è¿æ¥..."};
            applyVis(); 
            redrawChat();
            showScreen(`scrRoom`);
            msgs.scrollTop = msgs.scrollHeight;
        };
        $(`listContent`).appendChild(div);
    });
}
renderContacts();


$(`btnListToRoom`).onclick = () => { 
    currentChatId = "default";
    $(`cfgName`).value = ls.getItem(`cN`) || `ä¸“å±æ‹äºº`;
    $(`cfgRem`).value = ls.getItem(`cR`) || ``;
    $(`cfgAiP`).value = ls.getItem(`cAP`) || ``;
    $(`cfgMyP`).value = ls.getItem(`cMP`) || ``;
    history = ls.getItem(`chatHistory`) ? JSON.parse(ls.getItem(`chatHistory`)) : [];
    aiStatus = ls.getItem(`aiStatus`) ? JSON.parse(ls.getItem(`aiStatus`)) : {weather:"ç­‰å¾…è¿æ¥...",clothing:"ç­‰å¾…è¿æ¥...",action:"ç­‰å¾…è¿æ¥...",thought:"ç­‰å¾…è¿æ¥..."};
    applyVis(); 
    redrawChat();
    showScreen(`scrRoom`); 
    msgs.scrollTop = msgs.scrollHeight; 
};


let menuItems = document.querySelectorAll(`.menu-item`);
menuItems[0].onclick = () => { $(`chatMenu`).style.display=`none`; $(`addFriendModal`).style.display=`flex`; };
for(let i=1; i<menuItems.length; i++) { menuItems[i].onclick = () => { alert(`åŠŸèƒ½å¼€å‘ä¸­ï¼`); $(`chatMenu`).style.display=`none`; }; }

$(`btnCancelAddFriend`).onclick = () => { $(`addFriendModal`).style.display=`none`; $(`newFriendName`).value=``; $(`newFriendPrompt`).value=``; };
$(`btnConfirmAddFriend`).onclick = () => {
    let n = $(`newFriendName`).value.trim();
    if(!n) { alert(`åå­—ä¸èƒ½ä¸ºç©ºå“¦ï¼`); return; }
    let p = $(`newFriendPrompt`).value.trim();
    contacts.push({ name: n, prompt: p, id: Date.now() });
    ls.setItem(`myContacts`, JSON.stringify(contacts));
    renderContacts();
    $(`addFriendModal`).style.display=`none`;
    $(`newFriendName`).value=``;
    $(`newFriendPrompt`).value=``;
    alert(`è§’è‰²æ·»åŠ æˆåŠŸï¼å»åˆ—è¡¨ç‚¹å‡»TAè¯•è¯•å§ã€‚`);
};

$(`btnClearChat`).onclick = () => { if(confirm(`ç¡®è®¤æ¸…ç©ºå½“å‰èŠå¤©ï¼Ÿ`)){ msgs.innerHTML=``; history=[]; ls.removeItem(`chatHistory`); ls.setItem(`lastMemCount`, `0`); updateListPreview(); alert(`å·²æ¸…ç©º`); } };
$(`btnBlock`).onclick = () => alert(`å·²å°†å¯¹æ–¹æ‹‰é»‘ã€‚`);
$(`btnDelFriend`).onclick = () => { alert(`å¥½å‹å·²åˆ é™¤ï¼`); showScreen(`scrHome`); };
let currWbTab = `global`;
let editingWbId = null;
function renderWb() {

    $(`wbListContainer`).innerHTML = ``;
    let arr = wbData.filter(x => x.type === currWbTab);
    arr.forEach(x => {
        let card = document.createElement(`div`); card.className = `wb-card`;
        card.innerHTML = `<div class=wb-title>${x.title}</div><div class=wb-prev>${x.content}</div><div class=flex-row style=margin-top:15px;><button class=tool-btn style=flex:1; onclick=editWb(${x.id})>ç¼–è¾‘</button><button class=clear-btn style=flex:none;width:60px; onclick=delWb(${x.id})>åˆ é™¤</button></div>`;
        $(`wbListContainer`).appendChild(card);
    });
}

window.editWb = id => {
    let strId = id.toString();
    let item = wbData.find(x => x.id === strId);
    if(!item) return;
    editingWbId = strId; $(`wbTitle`).value = item.title; $(`wbType`).value = item.type; $(`wbContent`).value = item.content;
    showScreen(`scrWbEdit`);
};

window.delWb = id => {
    let strId = id.toString();
    if(confirm(`çœŸçš„è¦çƒ§æ¯è¿™æœ¬ä¸–ç•Œä¹¦å—ï¼Ÿ`)) { wbData = wbData.filter(x => x.id !== strId); ls.setItem(`wbData`, JSON.stringify(wbData)); renderWb(); }
};

$(`btnWbBack`).onclick = () => showScreen(`scrHome`);
$(`tabGlobal`).onclick = () => { currWbTab = `global`; $(`tabGlobal`).className=`wb-active`; $(`tabGlobal`).style.background=`#6c5ce7`; $(`tabGlobal`).style.color=`white`; $(`tabLocal`).style.background=`#f0f2f5`; $(`tabLocal`).style.color=`#888`; renderWb(); };
$(`tabLocal`).onclick = () => { currWbTab = `local`; $(`tabLocal`).className=`wb-active`; $(`tabLocal`).style.background=`#6c5ce7`; $(`tabLocal`).style.color=`white`; $(`tabGlobal`).style.background=`#f0f2f5`; $(`tabGlobal`).style.color=`#888`; renderWb(); };
$(`btnWbAdd`).onclick = () => { editingWbId = null; $(`wbTitle`).value = ``; $(`wbType`).value = currWbTab; $(`wbContent`).value = ``; showScreen(`scrWbEdit`); };
$(`btnWbEditBack`).onclick = () => showScreen(`scrWb`);

$(`btnWbSave`).onclick = () => {
    let t = $(`wbTitle`).value, p = $(`wbType`).value, c = $(`wbContent`).value;
    if(!t || !c) { alert(`æ ‡é¢˜å’Œå†…å®¹éƒ½å¿…é¡»è¦å¡«å“¦ï¼`); return; }
    if(editingWbId) { let item = wbData.find(x => x.id === editingWbId); item.title = t; item.type = p; item.content = c; }
    else { wbData.push({ id: Date.now().toString(), title: t, type: p, content: c }); }
    ls.setItem(`wbData`, JSON.stringify(wbData)); alert(`æˆåŠŸè®°å½•è¿›ä¸–ç•Œä¹¦ï¼`); showScreen(`scrWb`); renderWb();
};

$(`btnOpenLinkWb`).onclick = () => {
    let list = $(`linkWbList`); list.innerHTML = ``;
    let locals = wbData.filter(x => x.type === `local`);
    if(locals.length === 0) list.innerHTML = `<div class=stat-txt>ä½ è¿˜æ²¡æœ‰ç¼–å†™ä»»ä½•å±€éƒ¨ä¸–ç•Œä¹¦å“¦ã€‚</div>`;
    else {
        locals.forEach(x => {
            let chk = linkedWb.includes(x.id) ? `checked` : ``;
            list.innerHTML += `<div class=flex-row style=margin-bottom:10px;padding:10px;background:#f0f2f5;border-radius:10px;><label style=font-size:14px;color:#333;>${x.title}</label><input type=checkbox value=${x.id} class=wb-check style=width:20px;height:20px; ${chk}></div>`;
        });
    }
    $(`linkWbModal`).style.display = `flex`;
};

$(`btnCloseLinkWb`).onclick = () => { $(`linkWbModal`).style.display = `none`; };

$(`btnSaveLinkWb`).onclick = () => {
    linkedWb = [];
    document.querySelectorAll(`.wb-check`).forEach(c => { if(c.checked) linkedWb.push(c.value); });
    ls.setItem(`linkedWb`, JSON.stringify(linkedWb));
    alert(`ä¸–ç•Œä¹¦å…³è”æˆåŠŸï¼`); $(`linkWbModal`).style.display = `none`;
};

async function runMemorySummary(isAuto = false) {
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) { if(!isAuto) alert(`è¯·å…ˆé…ç½®ç½‘ç»œã€‚`); return; }
    if(history.length < 2) { if(!isAuto) alert(`èŠå¤©è®°å½•å¤ªå°‘ï¼Œè¿˜ä¸å¤Ÿå†™æ€»ç»“å“¦ã€‚`); return; }
    
    let pmt = $(`cfgMemPmt`).value;
    let charName = $(`cfgName`).value || `å¯¹æ–¹`;
    let myName = $(`cfgMyName`).value || `æˆ‘`;
    pmt = pmt.replace(/\[å¯¹æ–¹\]/g, charName).replace(/\[æˆ‘\]/g, myName);
    
    let sys = `ä»»åŠ¡ï¼šæç®€æ€»ç»“èŠå¤©è®°å½•ã€‚\nè§„åˆ™ï¼š${pmt}\n\nè¿‘æœŸå¯¹è¯ï¼š\n`;
    let trig = parseInt($(`cfgMemTrig`).value) || 20;
    let recent = history.slice(-trig);
    recent.forEach(m => {
        let role = m.role === `user` ? myName : charName;
        let c = m.content;
        if(m.role === `assistant`) { let rM = c.match(/ã€å›å¤ã€‘([\s\S]*)$/); if(rM) c = rM[1].trim(); }
        sys += `${role}:${c}\n`;
    });
    
    if(!isAuto) $(`btnGenMem`).innerText = `æ­£åœ¨å›æƒ³...`;
    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, headers: {Authorization:`Bearer ${key}`, [`Content-Type`]:`application/json`},
            body: JSON.stringify({model:mod, messages:[{role:`user`, content:sys}], temperature:0.5})
        });
        let dat = await res.json();
        if(dat.choices && dat.choices.length > 0) {
            let diary = dat.choices[0].message.content;
            let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
            mems.push({ date: updTime().toLocaleString(), content: diary });
            ls.setItem(`memories`, JSON.stringify(mems));
            if(!isAuto) alert(`æ€»ç»“å®Œæˆï¼å·²å­˜å…¥ä¸“å±è®°å¿†åº“ã€‚`);
        }
    } catch(e) { if(!isAuto) alert(`ç”Ÿæˆå¤±è´¥ï¼š${e.message}`); }
    if(!isAuto) $(`btnGenMem`).innerText = `âœ¨ ç«‹å³æ‰‹åŠ¨æ€»ç»“`;
}

let isMemEditMode = false;
let selMems = new Set();
function renderMemList() {
    let list = $(`memList`); list.innerHTML = ``;
    let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
    if(mems.length === 0) {
        list.innerHTML = `<div class=stat-txt>è®°å¿†åº“ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»åˆ›é€ å›å¿†å§ï¼</div>`; 
        if($(`memActions`)) $(`memActions`).style.display = `none`;
        return;
    }
    if($(`memActions`)) $(`memActions`).style.display = isMemEditMode ? `flex` : `none`;
    let grouped = {};
    mems.forEach((m, idx) => {
        let d = m.date.split(` `)[0]; 
        if(!grouped[d]) grouped[d] = [];
        let cleanTxt = m.content.replace(/^[\s\S]*?(ï¼š|:)/, ``).replace(/^[0-9]+[ã€. *]+/, ``).replace(/\*/g, ``).trim();
        grouped[d].push({txt: cleanTxt, originalIndex: idx});
    });
    Object.keys(grouped).reverse().forEach(d => {
        let html = `<div class=stat-card><div class=stat-tag style=background:#6c5ce7;color:white;>${d}</div><div class=stat-txt style=display:flex;flex-direction:column;gap:8px;>`;
        grouped[d].forEach((item, idx) => {
            let border = (isMemEditMode && selMems.has(item.originalIndex)) ? `border-left:3px solid #ff4d4f;padding-left:5px;` : ``;
            let pointer = isMemEditMode ? `cursor:pointer;` : ``;
            html += `<div style="${border}${pointer}" onclick="toggleMemSel(${item.originalIndex})"><span style=color:#6c5ce7;font-weight:bold;margin-right:5px;>` + (idx+1) + `.</span>${item.txt}</div>`;
        });
        html += `</div></div>`;
        list.innerHTML += html;
    });
}
window.toggleMemSel = idx => {
    if(!isMemEditMode) return;
    if(selMems.has(idx)) selMems.delete(idx); else selMems.add(idx);
    renderMemList();
};
$(`btnViewMem`).onclick = () => {
    if(!$(`memActions`)) {
        let hdr = $(`memModal`).querySelector(`.modal-hdr`);
        let editBtn = document.createElement(`span`);
        editBtn.id = `btnEditMem`;
        editBtn.innerText = `ç®¡ç†`;
        editBtn.style.cssText = `cursor:pointer;font-size:14px;color:#ffeb3b;margin-right:15px;`;
        hdr.insertBefore(editBtn, $(`btnCloseMem`));
        
        let actions = document.createElement(`div`);
        actions.id = `memActions`;
        actions.style.cssText = `display:none;padding:10px 20px;background:#fff0f0;justify-content:space-between;align-items:center;border-bottom:1px solid #ffeeee;flex-shrink:0;`;
        actions.innerHTML = `<span id=btnSelAllMem style="color:#333;font-size:13px;cursor:pointer;font-weight:bold;">å…¨é€‰</span><span id=btnDelMem style="color:#ff7675;font-size:13px;font-weight:bold;cursor:pointer;">åˆ é™¤é€‰ä¸­</span>`;
        $(`memModal`).querySelector(`.modal-ctx`).insertBefore(actions, $(`memList`));
        
        $(`btnEditMem`).onclick = () => {
            isMemEditMode = !isMemEditMode;
            $(`btnEditMem`).innerText = isMemEditMode ? `å®Œæˆ` : `ç®¡ç†`;
            if(!isMemEditMode) selMems.clear();
            renderMemList();
        };
        $(`btnSelAllMem`).onclick = () => {
            let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
            if(selMems.size === mems.length) selMems.clear();
            else mems.forEach((_, i) => selMems.add(i));
            renderMemList();
        };
        $(`btnDelMem`).onclick = () => {
            if(selMems.size === 0) { alert(`è¯·å…ˆé€‰ä¸­è¦åˆ é™¤çš„è®°å¿†ï¼`); return; }
            if(confirm(`ç¡®å®šåˆ é™¤è¿™ ` + selMems.size + ` æ¡è®°å¿†å—ï¼Ÿ`)) {
                let mems = ls.getItem(`memories`) ? JSON.parse(ls.getItem(`memories`)) : [];
                mems = mems.filter((_, i) => !selMems.has(i));
                ls.setItem(`memories`, JSON.stringify(mems));
                selMems.clear();
                renderMemList();
            }
        };
    }
    isMemEditMode = false;
    if($(`btnEditMem`)) $(`btnEditMem`).innerText = `ç®¡ç†`;
    selMems.clear();
    renderMemList();
    $(`memModal`).style.display = `flex`;
};
$(`btnCloseMem`).onclick = () => { $(`memModal`).style.display = `none`; };

$(`btnGenMem`).onclick = () => { runMemorySummary(false); };

$(`btnSaveChat`).onclick = () => {
    ls.setItem(`cN`, $(`cfgName`).value); ls.setItem(`cR`, $(`cfgRem`).value);
    ls.setItem(`cMyN`, $(`cfgMyName`).value);
    ls.setItem(`cAP`, $(`cfgAiP`).value); ls.setItem(`cMP`, $(`cfgMyP`).value);
    ls.setItem(`cCtx`, $(`cfgCtx`).value); ls.setItem(`cT`, $(`cfgTime`).checked);
    ls.setItem(`cAMem`, $(`cfgAutoMem`).checked); ls.setItem(`cMemT`, $(`cfgMemTrig`).value); ls.setItem(`cMemP`, $(`cfgMemPmt`).value);
    applyVis(); alert(`é…ç½®å·²ä¿å­˜ï¼`); showScreen(`scrRoom`);
};

$(`btnSaveApi`).onclick = () => {
    ls.setItem(`pxy`, $(`apiPxy`).value); ls.setItem(`key`, $(`apiK`).value); 
    ls.setItem(`mod`, $(`apiMod`).value); ls.setItem(`temp`, $(`apiTemp`).value);
    alert(`ç½‘ç»œå·²ä¿å­˜ï¼`); showScreen(`scrHome`);
};

$(`btnPull`).onclick = async () => {
    let pxy = $(`apiPxy`).value, k = $(`apiK`).value;
    if(!pxy || !k) { alert(`è¯·å…ˆå¡«å†™åœ°å€å’Œå¯†é’¥ï¼`); return; }
    let url = pxy.includes(`chat/completions`) ? pxy.replace(`chat/completions`, ``) : pxy;
    if(!url.endsWith(`/`)) url += `/`;
    try {
        let r = await fetch(url+`models`, {headers:{Authorization:`Bearer ${k}`}});
        let d = await r.json();
        if(d.data && d.data.length>0){
            $(`apiModSel`).innerHTML=``;
            d.data.forEach(m => { let o=document.createElement(`option`); o.value=m.id; o.innerText=m.id; $(`apiModSel`).appendChild(o); });
            $(`apiModSel`).style.display=`block`; $(`apiMod`).style.display=`none`;
            $(`apiModSel`).onchange = function(){ $(`apiMod`).value = this.value; };
            $(`apiMod`).value = d.data[0].id; alert(`æ‹‰å–æˆåŠŸï¼Œè¯·åœ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ã€‚`);
        } else alert(`æ‹‰å–å¤±è´¥ï¼šæœªè·å–åˆ°åˆ—è¡¨ã€‚`);
    } catch(e) { alert(`æ‹‰å–å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ã€‚`); }
};
function redrawChat() {
    msgs.innerHTML = ``;
    let changed = false;
    history.forEach(msg => {
        if(msg.role === `user`) { mkBubSync(msg.content, `r`); } 
        else if(msg.role === `assistant`) {
            let txt = msg.content;
            let rM = txt.match(/ã€å›å¤ã€‘([\s\S]*)$/);
            let out = txt;
            if(rM) out = rM[1].trim();
                 
                        let voiceMatch = out.match(/\[è¯­éŸ³æ¶ˆæ¯[ï¼š:](\d+)ç§’\]/);
            if(voiceMatch) {
                let sec = voiceMatch[1];
                let pureText = out.replace(/\[è¯­éŸ³æ¶ˆæ¯[ï¼š:]\d+ç§’\]/g, ``).replace(/['""â€œâ€â€˜â€™]/g, ``).replace(/\s+/g, `ï¼Œ`).replace(/ï¼Œ+/g, `ï¼Œ`).replace(/([ã€‚ï¼ï¼Ÿ!?â€¦])ï¼Œ/g, `$1`).replace(/^ï¼Œ|ï¼Œ$/g, ``);
                if(pureText && !/[ã€‚ï¼ï¼Ÿ!?â€¦]$/.test(pureText)) pureText += `ã€‚`;
                let cleanVoice = `[è¯­éŸ³æ¶ˆæ¯ï¼š${sec}ç§’]` + pureText;
                
                if(out !== cleanVoice && rM) {
                    msg.content = txt.replace(rM[1], `\n` + cleanVoice);
                    changed = true;
                }
                mkBubSync(cleanVoice, `l`);
            } else {
                                let lns = out.split(/\n+/).filter(x => x.trim() !== ``);
                if(lns.length === 1 && out.length > 30) { lns = out.replace(/([ã€‚ï¼ï¼Ÿ!?])/g, `$1\n`).split(/\n+/).filter(x => x.trim() !== ``); }
                lns.forEach(line => mkBubSync(line, `l`));

            }

        }
    });
    if(changed) ls.setItem(`chatHistory`, JSON.stringify(history));
}


function showCtxMenu(x, y, el) {
    selEl = el;
    let m = $(`ctxMenu`);
    m.style.display = `grid`;
    let phoneRect = $(`phone`).getBoundingClientRect();
    let relX = x - phoneRect.left;
    let relY = y - phoneRect.top;
    let left = relX + 10;
    if (left + 260 > 320) left = 320 - 260 - 10;
    if (left < 10) left = 10;
    let top = relY + 10;
    if (top + 100 > 650) top = 650 - 110; 
    m.style.left = left + `px`;
    m.style.top = top + `px`;
}

document.onclick = e => { 
    if(!e.target.closest(`.bubble`) && !e.target.closest(`.ctx-menu`)) $(`ctxMenu`).style.display = `none`; 
};

function getCleanText(el) { 
    if (!el) return ``;
    if (el.dataset && el.dataset.raw) return el.dataset.raw;
    let span = el.querySelector(`span`);
    if (span && el.querySelector(`div`)) return span.innerText.trim();
    return el.innerText ? el.innerText.trim() : `[å›¾ç‰‡]`; 
}



let editingOldText = ``;
$(`ctxCopy`).onclick = () => { if(selEl) navigator.clipboard.writeText(getCleanText(selEl)).then(()=>{ alert(`å¤åˆ¶æˆåŠŸ`); $(`ctxMenu`).style.display = `none`; }); };
$(`ctxDel`).onclick = () => { 
    if(selEl) { 
        if(confirm(`ç¡®å®šè¦åˆ é™¤è¿™1æ¡ä¿¡æ¯å—ï¼Ÿ`)) {
            let imgEl = selEl.querySelector(`img`);
            let searchTarget = ``;
            if (imgEl) searchTarget = imgEl.getAttribute(`src`);
            else searchTarget = getCleanText(selEl);
            for(let i=history.length-1; i>=0; i--) {
                if(history[i].content.includes(searchTarget)) {
                    let newContent = history[i].content.replace(searchTarget, ``).trim();
                    newContent = newContent.replace(/^\n+|\n+$/g, ``).replace(/\n{2,}/g, `\n`);
                    let afterReply = newContent.split(`ã€å›å¤ã€‘`)[1];
                    if (newContent === `` || (newContent.includes(`ã€å›å¤ã€‘`) && (!afterReply || afterReply.trim() === ``))) {
                        history.splice(i, 1);
                        let lmc = parseInt(ls.getItem(`lastMemCount`)) || 0;
                        if(lmc > history.length) ls.setItem(`lastMemCount`, history.length.toString());
                    } else {
                        history[i].content = newContent;
                    }
                    ls.setItem(`chatHistory`, JSON.stringify(history));
                    break;
                }
            }
            redrawChat();
            if(typeof updateListPreview === `function`) updateListPreview();
        }
        $(`ctxMenu`).style.display = `none`; 
    } 
};






$(`ctxEdit`).onclick = () => { 
    if(selEl) { 
        editingOldText = getCleanText(selEl); 
        if(editingOldText === `[å›¾ç‰‡]`) { alert(`å›¾ç‰‡ä¸èƒ½ä¿®æ”¹å“¦`); $(`ctxMenu`).style.display = `none`; return; }
        $(`editMsgInput`).value = editingOldText; 
        $(`editMsgModal`).style.display = `flex`; 
        $(`ctxMenu`).style.display = `none`; 
    } 
};
$(`btnCancelEdit`).onclick = () => { $(`editMsgModal`).style.display = `none`; };
$(`btnConfirmEdit`).onclick = () => {
    let newTxt = $(`editMsgInput`).value;
    if(!newTxt) return;
    for(let i=history.length-1; i>=0; i--) {
        if(history[i].content.includes(editingOldText)) {
            history[i].content = history[i].content.replace(editingOldText, newTxt);
            ls.setItem(`chatHistory`, JSON.stringify(history));
            break;
        }
    }
    redrawChat();
    $(`editMsgModal`).style.display = `none`;
};

$(`ctxQuote`).onclick = () => {
    if(selEl) {
        currentQuote = getCleanText(selEl);
        $(`quoteText`).innerText = `å¼•ç”¨ï¼š` + currentQuote;
        $(`quoteBox`).style.display = `block`;
        $(`ctxMenu`).style.display = `none`;
    }
};
$(`btnCloseQuote`).onclick = () => { currentQuote = ``; $(`quoteBox`).style.display = `none`; };
$(`ctxFav`).onclick = () => { 
    if(selEl) {
        let bubble = selEl.querySelector(`.bubble`) || selEl;
        let imgEl = bubble.querySelector(`img`);
        let contentToSave = imgEl ? imgEl.getAttribute(`src`) : getCleanText(bubble);
        saveMsgToFav(contentToSave);
        alert(`æ”¶è—æˆåŠŸï¼å¿«å»æˆ‘çš„é¡µé¢æŸ¥çœ‹å§ã€‚`);
    }
    $(`ctxMenu`).style.display = `none`; 
};

$(`ctxMulti`).onclick = () => { 
    if(selEl) {
        let row = selEl.closest(`.msg-row`);
        let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
        let idx = allItems.indexOf(row);
        if(idx > -1) enterMultiSelectMode(idx);
    }
    $(`ctxMenu`).style.display = `none`; 
};


function bindPress(el) {
    el.oncontextmenu = e => { e.preventDefault(); showCtxMenu(e.clientX, e.clientY, el); };
    el.ontouchstart = e => { pressTimer = setTimeout(() => { let t = e.touches[0]; showCtxMenu(t.clientX, t.clientY, el); }, 500); };
    el.ontouchend = () => clearTimeout(pressTimer);
    el.ontouchmove = () => clearTimeout(pressTimer);
}

$(`btnRegen`).onclick = () => {
    if(history.length === 0) return;
    let last = history[history.length - 1];
    if(last.role === `assistant`) {
        history.pop();
        ls.setItem(`chatHistory`, JSON.stringify(history));
        redrawChat();
        $(`btnLemon`).click();
    } else { alert(`ä¸Šä¸€æ¡å¿…é¡»æ˜¯å¯¹æ–¹çš„å›å¤æ‰èƒ½é‡æ–°ç”Ÿæˆå“¦`); }
};

$(`btnPic`).onclick = () => alert(`å‘å›¾åŠŸèƒ½å¼€å‘ä¸­`);
$("btnMic").onclick = () => {
    if(!$("voiceModal")) return;
    $("voiceInputText").value = "";
    $("voiceModal").style.display = "flex";
};
if($("btnCancelVoice")) {
    $("btnCancelVoice").onclick = () => $("voiceModal").style.display = "none";
}
if($("btnSendVoice")) {
    $("btnSendVoice").onclick = () => {
        let txt = $("voiceInputText").value.trim();
        if(!txt) { alert("è¯·è¾“å…¥è¯­éŸ³å†…å®¹å“¦ï¼"); return; }
        let sec = Math.max(1, Math.min(60, Math.ceil(txt.length / 3)));
        let msgText = "[è¯­éŸ³æ¶ˆæ¯ï¼š" + sec + "ç§’]" + txt;
        mkBub(msgText, "r");
        history.push({role: "user", content: msgText});
        ls.setItem("chatHistory", JSON.stringify(history));
        if(typeof updateListPreview === "function") updateListPreview();
        $("voiceModal").style.display = "none";
    };
}



$(`btnSend`).onclick = () => {
    let t = iptMsg.value; if(!t && !currentQuote) return;
    if(currentQuote) t = `ã€Œå¼•ç”¨ï¼š` + currentQuote + `ã€\n` + t;
    mkBub(t, `r`); iptMsg.value = ``; $(`quoteBox`).style.display = `none`;
    currentQuote = ``;
    history.push({role: `user`, content: t});
    ls.setItem(`chatHistory`, JSON.stringify(history));
    updateListPreview();
};

$(`btnLemon`).onclick = async () => {
    let t = iptMsg.value;
    if(t || currentQuote) {
        if(currentQuote) t = `ã€Œå¼•ç”¨ï¼š` + currentQuote + `ã€\n` + t;
        mkBub(t, `r`); iptMsg.value = ``; $(`quoteBox`).style.display = `none`; currentQuote = ``;
        history.push({role: `user`, content: t}); ls.setItem(`chatHistory`, JSON.stringify(history)); updateListPreview();
    }
    if(history.length === 0) return;
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value, tp = parseFloat($(`apiTemp`).value)||0.8;
    if(!pxy || !key || !mod) { mkBub(`è¯·å…ˆé…ç½®ç½‘ç»œã€‚`, `l`); return; }
    if(!pxy.includes(`chat/completions`)) pxy = pxy.replace(/\/$/, ``) + `/chat/completions`;
    mkBub(`å¯¹æ–¹æ­£åœ¨è¾“å…¥...`, `l`, true);
    
    let sys = `ä¸¥æ ¼æŒ‰æ ¼å¼å›å¤ï¼Œå‹¿åŠ å¤šä½™å­—ç¬¦ã€‚å†…å®¹å¿…é¡»æè‡´ç”ŸåŠ¨ï¼š\nã€å®šä½ä¸å¤©æ°”ã€‘ï¼ˆ100å­—å†…ï¼Œé¦–å­—ä¸ºå¤©æ°”emojiï¼‰\nã€æœè£…ã€‘ï¼ˆ100å­—å†…ï¼‰\nã€è¡¨æƒ…ä¸åŠ¨ä½œã€‘ï¼ˆ100å­—å†…ï¼‰\nã€å¿ƒå£°ã€‘ï¼ˆ200å­—å†…ï¼‰\nã€å›å¤ã€‘ï¼ˆå¯¹æˆ‘è¯´çš„è¯ã€‚é‡è¦è§„åˆ™ï¼šå¦‚æœ‰å¤šå¥ï¼Œå¿…é¡»ç”¨å›è½¦æ¢è¡Œä¸¥æ ¼åˆ†æ®µï¼Œä¸¥ç¦åªå‘ä¸€æ®µï¼ï¼‰\n\n`;
    
    let globals = wbData.filter(x => x.type === `global`);
    let locals = wbData.filter(x => x.type === `local` && linkedWb.includes(x.id));
    let wbText = ``;
    globals.forEach(x => wbText += `ã€å…¨å±€ä¸–ç•Œè®¾å®šã€‘` + x.content + `\n`);
    locals.forEach(x => wbText += `ã€å½“å‰ä¸“å±å‰§æƒ…ã€‘` + x.content + `\n`);
    if(wbText) sys += wbText + `\n`;
    if($(`cfgName`).value) sys += `ä½ çš„åå­—ï¼š` + $(`cfgName`).value + `\n`;
    if($(`cfgAiP`).value) sys += `ä½ çš„è®¾å®šï¼š` + $(`cfgAiP`).value + `\n`;
    if($(`cfgMyName`).value) sys += `æˆ‘çš„åå­—ï¼š` + $(`cfgMyName`).value + `\n`;
    if($(`cfgMyP`).value) sys += `æˆ‘çš„è®¾å®šï¼š` + $(`cfgMyP`).value + `\n`;
    if($(`cfgTime`).checked) sys += `å½“å‰ç°å®æ—¶é—´ï¼š` + updTime().toLocaleString() + `ï¼Œè¯·ä¿æŒæ„ŸçŸ¥ã€‚\n`;
    
    let charStickers = [];
localforage.getItem(`charStickers`).then(res => {
    if(res) charStickers = JSON.parse(res);
    else if(ls.getItem(`charStickers`)) {
        charStickers = JSON.parse(ls.getItem(`charStickers`));
        localforage.setItem(`charStickers`, ls.getItem(`charStickers`));
    }
});

    if(charStickers.length > 0) {
        let names = charStickers.map(x => x.name).join(`ã€`);
        sys += `\nã€ä½ çš„ä¸“å±è¡¨æƒ…åŒ…åº“ã€‘å¦‚æœä½ æƒ³å‘è¡¨æƒ…é…åˆæƒ…ç»ªï¼Œè¯·åŠ¡å¿…åœ¨ã€å›å¤ã€‘ä¸­æ’å…¥ä»£ç â€œ[å‘é€è¡¨æƒ…ï¼šè¡¨æƒ…åç§°]â€ã€‚å½“å‰ä½ æ‹¥æœ‰çš„è¡¨æƒ…åç§°æœ‰ï¼š` + names + `ã€‚è­¦å‘Šï¼šç»å¯¹ä¸è¦æé€ åˆ—è¡¨å¤–çš„è¡¨æƒ…ï¼ä¸è¦å‘å¤šä½™çš„é“¾æ¥ï¼`;
    }

    let arr = sys ? [{role: `system`, content: sys}] : [];
    arr = arr.concat(history.slice(-(parseInt($(`cfgCtx`).value)||10)));
    
    try {
        let res = await fetch(pxy, { method:`POST`, headers:{Authorization:`Bearer `+key, [`Content-Type`]:`application/json`}, body:JSON.stringify({model:mod, messages:arr, temperature:tp}) });
        let dat = await res.json(); rmThk();
        if(dat.choices && dat.choices.length > 0) {
            let txt = dat.choices[0].message.content;
            
            let currentStickers = JSON.parse(ls.getItem(`charStickers`) || `[]`);
            txt = txt.replace(/\[å‘é€è¡¨æƒ…ï¼š(.*?)\]/g, (match, p1) => {
                let s = currentStickers.find(x => x.name === p1.trim());
                if(s) return `[å›¾ç‰‡æ¶ˆæ¯ï¼š` + s.url + `]`;
                return `[è¯•å›¾å‘é€è¡¨æƒ…ï¼š` + p1 + `]`; 
            });

            history.push({role: `assistant`, content: txt});
            ls.setItem(`chatHistory`, JSON.stringify(history));
            
            let out = txt, wM = txt.match(/ã€å®šä½ä¸å¤©æ°”ã€‘([\s\S]*?)ã€/), cM = txt.match(/ã€æœè£…ã€‘([\s\S]*?)ã€/), aM = txt.match(/ã€è¡¨æƒ…ä¸åŠ¨ä½œã€‘([\s\S]*?)ã€/), tM = txt.match(/ã€å¿ƒå£°ã€‘([\s\S]*?)ã€/), rM = txt.match(/ã€å›å¤ã€‘([\s\S]*)$/);
                        if(rM) {
                out = rM[1].trim();
                if(wM) aiStatus.weather = wM[1].trim(); if(cM) aiStatus.clothing = cM[1].trim();
                if(aM) aiStatus.action = aM[1].trim(); if(tM) aiStatus.thought = tM[1].trim();
                ls.setItem(`aiStatus`, JSON.stringify(aiStatus));
            }
            
                        let voiceMatch = out.match(/\[è¯­éŸ³æ¶ˆæ¯[ï¼š:](\d+)ç§’\]/);
            if(voiceMatch) {
                let sec = voiceMatch[1];
                let pureText = out.replace(/\[è¯­éŸ³æ¶ˆæ¯[ï¼š:]\d+ç§’\]/g, ``).replace(/['""â€œâ€â€˜â€™]/g, ``).replace(/\s+/g, `ï¼Œ`).replace(/ï¼Œ+/g, `ï¼Œ`).replace(/([ã€‚ï¼ï¼Ÿ!?â€¦])ï¼Œ/g, `$1`).replace(/^ï¼Œ|ï¼Œ$/g, ``);
                if(pureText && !/[ã€‚ï¼ï¼Ÿ!?â€¦]$/.test(pureText)) pureText += `ã€‚`;
                let voiceMsg = `[è¯­éŸ³æ¶ˆæ¯ï¼š${sec}ç§’]` + pureText;
                
                history[history.length-1].content = txt.replace(rM[1], `\n` + voiceMsg);
                ls.setItem(`chatHistory`, JSON.stringify(history));
                setTimeout(() => mkBub(voiceMsg, `l`), 0);
                setTimeout(updateListPreview, 500);
            } else {
                                let lns = out.split(/\n+/).filter(x => x.trim() !== ``);
                if(lns.length === 1 && out.length > 30) { lns = out.replace(/([ã€‚ï¼ï¼Ÿ!?])/g, `$1\n`).split(/\n+/).filter(x => x.trim() !== ``); }
                for(let i=0; i<lns.length; i++) setTimeout(() => mkBub(lns[i], `l`), i*1500);

                setTimeout(updateListPreview, lns.length*1500 + 500);
            }



            
                        let isAutoOn = ls.getItem(`cAMem`) === `true` || $(`cfgAutoMem`).checked;
            if(isAutoOn) {
                let trigCount = parseInt(ls.getItem(`cMemT`)) || parseInt($(`cfgMemTrig`).value) || 10;
                let lastMemCount = parseInt(ls.getItem(`lastMemCount`) || `0`);
                if((history.length - lastMemCount) >= trigCount && history.length > 0) {
                    ls.setItem(`lastMemCount`, history.length.toString());
                    runMemorySummary(true);

                }
            }
            
        } else mkBub(`æ¥å£å¼‚å¸¸ã€‚`, `l`);
    } catch(e) { rmThk(); mkBub(`è¿æ¥æ–­å¼€ã€‚`, `l`); }
};

function renderQuoteBlock(b, txt) {
    b.dataset.raw = txt;
    let voiceMatch = txt.match(/^\[è¯­éŸ³æ¶ˆæ¯ï¼š(\d+)ç§’\]([\s\S]*)$/);

    if(voiceMatch) {
        let sec = voiceMatch[1];
        let calcW = Math.min(70 + parseInt(sec)*3, 220);
        let p0 = `<s` + `vg width=16 height=16 viewBox="0 0 24 24" fill=#000><path d="M5 3l14 9-14 9V3z"/></s` + `vg>`;
        let p1 = `<s` + `vg width=24 height=24 viewBox="0 0 24 24" fill=none stroke=#000 stroke-width=2.5 stroke-linecap=round>`;
        let p2 = `<path class=w-1 d="M17 12h.01"/><path class=w-2 d="M13 8a6 6 0 0 0 0 8"/><path class=w-3 d="M9 4a12 12 0 0 0 0 16"/></s` + `vg>`;
        b.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between; width:${calcW}px; padding:8px 15px; background:#fff; border:2px solid #000; border-radius:25px; color:#000; font-weight:bold; cursor:pointer;" onclick="alert('æ–‡å­—å†…å®¹ï¼š\\n' + decodeURIComponent('${encodeURIComponent(voiceMatch[2])}'))">` + p0 + p1 + p2 + `</div>`;
        b.style.background = "transparent";
        b.style.boxShadow = "none";
        b.style.padding = "0";
        b.style.border = "none";
        return;
    }
    let imgMatch = txt.match(/\[å›¾ç‰‡æ¶ˆæ¯ï¼š(.*?)\]/);
    if(imgMatch) {
        b.innerHTML = `<img src="${imgMatch[1]}" style="max-width:150px;border-radius:10px;display:block;">`;
        b.style.background = "transparent";
        b.style.boxShadow = "none";
        b.style.padding = "0";
        return;
    }
    let qM = txt.match(/^ã€Œå¼•ç”¨ï¼š(.*?)ã€\n([\s\S]*)/);
    if(qM) {
        let qd = document.createElement(`div`);
        qd.style.cssText = `background:rgba(0,0,0,0.05); padding:6px 10px; border-radius:6px; font-size:12px; margin-bottom:6px; color:#666; border-left:3px solid #ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;`;
        qd.innerText = qM[1];
        let span = document.createElement(`span`);
        span.innerText = qM[2];
        b.appendChild(qd); b.appendChild(span);
    } else { 
        b.innerText = txt;
    }
}




function mkBub(txt, side, isT=false) {
    let row = document.createElement(`div`);
    row.className = `msg-row ` + (side===`l`?`row-left`:`row-right`);
    if(isT) row.id = `thk`;
    let b = document.createElement(`div`); b.className = `bubble ` + (side===`l`?`bub-left`:`bub-right`);
    if(!isT) { renderQuoteBlock(b, txt); bindPress(b); } else { b.innerText = txt; }
    
    if(side===`l`) {
        let a = document.createElement(`div`);
        a.className = `ava-sm ava-l`;
        let img = ls.getItem(`aiI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        if(!isT) a.onclick = () => { stW.innerText=aiStatus.weather; stC.innerText=aiStatus.clothing; stA.innerText=aiStatus.action; stT.innerText=aiStatus.thought; modal.style.display=`flex`; };
        row.appendChild(a); row.appendChild(b);
    } else {
        row.appendChild(b);
        let a = document.createElement(`div`); a.className = `ava-sm ava-r`;
        let img = ls.getItem(`myI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        row.appendChild(a);
    }
    msgs.appendChild(row); msgs.scrollTop = msgs.scrollHeight;
}

function mkBubSync(txt, side) {
    let row = document.createElement(`div`);
    row.className = `msg-row ` + (side===`l`?`row-left`:`row-right`);
    let b = document.createElement(`div`); b.className = `bubble ` + (side===`l`?`bub-left`:`bub-right`); 
    renderQuoteBlock(b, txt); bindPress(b);
    
    if(side===`l`) {
        let a = document.createElement(`div`); a.className = `ava-sm ava-l`;
        let img = ls.getItem(`aiI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        a.onclick = () => { stW.innerText=aiStatus.weather; stC.innerText=aiStatus.clothing; stA.innerText=aiStatus.action; stT.innerText=aiStatus.thought; modal.style.display=`flex`; };
        row.appendChild(a); row.appendChild(b);
    } else {
        row.appendChild(b);
        let a = document.createElement(`div`); a.className = `ava-sm ava-r`;
        let img = ls.getItem(`myI`);
        if(img) { a.style.backgroundImage = `url(`+img+`)`; a.innerText = ``; } else a.innerText = `ğŸ‘¤`;
        row.appendChild(a);
    }
    msgs.appendChild(row);
}

function rmThk() { let t = $(`thk`); if(t) t.remove(); }
let stickerData = [];
localforage.getItem(`myPhoneStickers`).then(res => {
    if(res) {
        stickerData = JSON.parse(res);
    } else if(ls.getItem(`myPhoneStickers`)) {
        stickerData = JSON.parse(ls.getItem(`myPhoneStickers`));
        localforage.setItem(`myPhoneStickers`, ls.getItem(`myPhoneStickers`));
    }
});

let isStickerEditMode = false;
let selectedStickers = new Set();

let isMenuDrawerOpen = false;
function toggleMenuDrawer(show) {
    let drawer = $(`newMenuDrawer`);
    if(drawer) {
        if(show) {
            drawer.classList.add(`show`);
            isMenuDrawerOpen = true;
            if(typeof toggleStickerDrawer === `function`) toggleStickerDrawer(false);
        } else {
            drawer.classList.remove(`show`);
            isMenuDrawerOpen = false;
        }
    }
}
$(`btnOpenSticker`).onclick = () => { toggleStickerDrawer(true); toggleMenuDrawer(false); };
$(`btnNewMenu`).onclick = () => toggleMenuDrawer(!isMenuDrawerOpen);
iptMsg.onfocus = () => {
    toggleMenuDrawer(false);
    if(typeof toggleStickerDrawer === `function`) toggleStickerDrawer(false);
};
iptMsg.onclick = () => {
    toggleMenuDrawer(false);
    if(typeof toggleStickerDrawer === `function`) toggleStickerDrawer(false);
};


$(`btnRegenNew`).onclick = () => {
    toggleMenuDrawer(false);
    if(history.length === 0) return;
    let last = history[history.length - 1];
    if(last.role === `assistant`) {
        history.pop();
        ls.setItem(`chatHistory`, JSON.stringify(history));
        redrawChat();
        $(`btnLemon`).click();
    } else { alert(`ä¸Šä¸€æ¡å¿…é¡»æ˜¯å¯¹æ–¹çš„å›å¤æ‰èƒ½é‡æ–°ç”Ÿæˆå“¦`); }
};

if(typeof msgs !== `undefined`) msgs.addEventListener(`click`, () => { if(isMenuDrawerOpen) toggleMenuDrawer(false); });

$(`btnCancelSticker`).onclick = () => toggleStickerDrawer(false);


$(`stickerEditBtn`).onclick = () => toggleStickerEditMode();
$(`btnAddBatchSticker`).onclick = () => toggleBatchModal(true);
$(`btnUploadStickerClick`).onclick = () => $(`stickerUploadInput`).click();
$(`btnCancelBatch`).onclick = () => toggleBatchModal(false);
$(`btnConfirmBatch`).onclick = () => confirmBatchStickers();
$(`stickerSearch`).oninput = () => renderStickers();

$(`stickerUploadInput`).onchange = e => {
    let file = e.target.files[0];
    if (!file) return;
    let name = file.name.split(".")[0];
    let reader = new FileReader();
    reader.onload = ev => {
        let img = new Image();
        img.onload = () => {
            let cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
            let w = img.width, h = img.height, maxW = 120, maxH = 120;
            if(w > h && w > maxW) { h *= maxW / w; w = maxW; } else if(h > maxH) { w *= maxH / h; h = maxH; }
            cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
            stickerData.push({ name: name, url: cvs.toDataURL("image/webp", 0.4) });
            localforage.setItem("myPhoneStickers", JSON.stringify(stickerData)).then(() => {
    renderStickers();
}).catch(err => {
    stickerData.pop();
    alert("ç³»ç»Ÿæç¤ºï¼šå¤§ä»“åº“å†™å…¥å¤±è´¥ï¼");
});

        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
    e.target.value = "";
};



function toggleStickerDrawer(show) {
    let drawer = $(`stickerDrawer`);
    if (show) { drawer.classList.add(`show`); renderStickers(); } 
    else { 
        drawer.classList.remove(`show`); 
        isStickerEditMode = false; 
        selectedStickers.clear(); 
        $(`stickerEditBtn`).innerText = `ç¼–è¾‘`; 
        $(`btnDelSelectedSticker`).style.display = `none`; 
        $(`btnSelectAllSticker`).style.display = `none`; 
        $(`btnAddBatchSticker`).style.display = `inline`; 
        $(`btnUploadStickerClick`).style.display = `inline`; 
        $(`stickerSearch`).value = ``; 
    }
}

$(`btnSelectAllSticker`).onclick = () => {
    if(selectedStickers.size === stickerData.length) selectedStickers.clear();
    else stickerData.forEach((_, i) => selectedStickers.add(i));
    renderStickers();
};

$(`btnDelSelectedSticker`).onclick = () => {
    if(selectedStickers.size === 0) { alert(`è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…å“¦`); return; }
    if(confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ` + selectedStickers.size + ` ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
        stickerData = stickerData.filter((_, i) => !selectedStickers.has(i));
        ls.setItem(`myPhoneStickers`, JSON.stringify(stickerData));
        selectedStickers.clear(); renderStickers();
    }
};

window.deleteSticker = (event, index) => {
    event.stopPropagation(); stickerData.splice(index, 1); ls.setItem(`myPhoneStickers`, JSON.stringify(stickerData));
    selectedStickers.clear(); renderStickers();
};

function sendSticker(url, name) {
    let t = `[å›¾ç‰‡æ¶ˆæ¯ï¼š` + url + `]\n(ç³»ç»Ÿæç¤ºï¼šæˆ‘å‘é€äº†ä¸€ä¸ªåä¸ºâ€œ` + name + `â€çš„è¡¨æƒ…åŒ…)`; 
    mkBub(t, `r`); history.push({role: `user`, content: t}); ls.setItem(`chatHistory`, JSON.stringify(history)); updateListPreview(); toggleStickerDrawer(false);
}

function renderStickers() {
    let grid = $(`stickerGrid`); let searchWord = $(`stickerSearch`).value.toLowerCase(); grid.innerHTML = ``;
    stickerData.forEach((sticker, index) => {
        if (sticker.name.toLowerCase().includes(searchWord)) {
            let item = document.createElement(`div`);
                        let isSel = selectedStickers.has(index);
            item.className = "sticker-item" + (isStickerEditMode ? " edit-mode" : "");
            if(isStickerEditMode && isSel) item.style.border = "2px solid #ff4d4f";
            item.innerHTML = `<div class="sticker-delete-btn" onclick="deleteSticker(event, ${index})">Ã—</div><img src="${sticker.url}"><div class="name">${sticker.name}</div>`;
            item.onclick = e => {

                if(isStickerEditMode) {
                    if(selectedStickers.has(index)) selectedStickers.delete(index); else selectedStickers.add(index);
                    renderStickers();
                } else { sendSticker(sticker.url, sticker.name); }
            };
            grid.appendChild(item);
        }
    });
}

function toggleStickerEditMode() {
    isStickerEditMode = !isStickerEditMode;
    if(!isStickerEditMode) selectedStickers.clear();
    $(`stickerEditBtn`).innerText = isStickerEditMode ? `å®Œæˆ` : `ç¼–è¾‘`;
    $(`btnDelSelectedSticker`).style.display = isStickerEditMode ? `inline` : `none`;
    $(`btnSelectAllSticker`).style.display = isStickerEditMode ? `inline` : `none`;
    $(`btnAddBatchSticker`).style.display = isStickerEditMode ? `none` : `inline`;
    $(`btnUploadStickerClick`).style.display = isStickerEditMode ? `none` : `inline`;
    renderStickers();
}

function toggleBatchModal(show) {
    let m = $(`batchModal`);
    if(show) {
        m.style.display = `flex`;
        $(`batchStickerInput`).value = ``;
    } else {
        m.style.display = `none`;
    }
}

function confirmBatchStickers() {
    let text = $(`batchStickerInput`).value;
    let lines = text.split(`\n`);
    let addedCount = 0;
    lines.forEach(line => {
        let str = line.trim();
        if(!str) return;
        let name = ``;
        let url = ``;
        let urlIdx = str.indexOf(`http`);
        if(urlIdx !== -1) {
            let prefix = str.substring(0, urlIdx).replace(/[ :ï¼š]+$/, ``).trim();
            url = str.substring(urlIdx).trim();
            if(prefix) name = prefix;
            else {
                let rawName = url.substring(url.lastIndexOf(`/`)+1).split(`.`)[0];
                try { rawName = decodeURIComponent(rawName); } catch(err) {}
                name = rawName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, ``);
            }
        } else {
            let parts = str.split(/\s+/);
            if(parts.length >= 2) { name = parts[0]; url = parts[1]; }
            else url = str;
        }
        if(!name) name = `è¡¨æƒ…` + Math.floor(Math.random()*1000);
        if(url) {
            stickerData.push({ name: name, url: url });
            addedCount++;
        }
    });
    
    try {
        ls.setItem(`myPhoneStickers`, JSON.stringify(stickerData));
        toggleBatchModal(false);
        renderStickers();
        if(addedCount > 0) alert(`æˆåŠŸæ·»åŠ  ` + addedCount + ` ä¸ªè¡¨æƒ…ï¼`);
    } catch(err) {
        for(let i=0; i<addedCount; i++) stickerData.pop();
        alert(`ç³»ç»Ÿæç¤ºï¼šå†…å­˜ç©ºé—´å·²æ»¡ï¼æ— æ³•æ·»åŠ æ–°è¡¨æƒ…ï¼Œè¯·å…ˆå»åˆ—è¡¨åˆ é™¤éƒ¨åˆ†æ—§è¡¨æƒ…ã€‚`);
    }
}



if(history.length > 0) redrawChat();

if($("navContact")) $("navContact").onclick = () => alert("ã€è§’è‰²ã€‘ç‰ˆå—æ­£åœ¨å…¨åŠ›å¼€å‘ä¸­...");
if($("navMoment")) $("navMoment").onclick = () => alert("ã€åŠ¨æ€ã€‘æœ‹å‹åœˆåŠŸèƒ½æ­£åœ¨å…¨åŠ›å¼€å‘ä¸­...");
if($("navMe")) $("navMe").onclick = () => showScreen("scrMe");

if($("navMeToMsg")) $("navMeToMsg").onclick = () => showScreen("scrList");
if($("navMeToContact")) $("navMeToContact").onclick = () => alert("ã€è§’è‰²ã€‘ç‰ˆå—æ­£åœ¨å…¨åŠ›å¼€å‘ä¸­...");
if($("navMeToMoment")) $("navMeToMoment").onclick = () => alert("ã€åŠ¨æ€ã€‘æœ‹å‹åœˆåŠŸèƒ½æ­£åœ¨å…¨åŠ›å¼€å‘ä¸­...");
if($("btnMeBack")) $("btnMeBack").onclick = () => showScreen("scrHome");

if($("btnEditMe")) $("btnEditMe").onclick = () => {
    $("iptMeName").value = $("cfgMyName").value || "ä½ çš„åå­—";
    $("iptMeBio").value = ls.getItem("myBio") || "";
    $("editMeModal").style.display = "flex";
};
if($("btnCancelEditMe")) $("btnCancelEditMe").onclick = () => $("editMeModal").style.display = "none";
if($("btnSaveEditMe")) $("btnSaveEditMe").onclick = () => {
    $("cfgMyName").value = $("iptMeName").value;
    ls.setItem("cMyN", $("iptMeName").value);
    ls.setItem("myBio", $("iptMeBio").value);
    applyVis();
    $("editMeModal").style.display = "none";
};
if($("btnSetMeAvatar")) $("btnSetMeAvatar").onclick = () => $("upMeAvatar").click();
cmp("upMeAvatar", "myI");

if($("btnOpenWallet")) $("btnOpenWallet").onclick = () => alert("ã€æˆ‘çš„é’±åŒ…ã€‘ç³»ç»Ÿç»“æ„æ‹¼è£…ä¸­ï¼Œå³å°†ä¸Šçº¿ï¼");

if($("btnHomeSpace")) $("btnHomeSpace").onclick = () => showScreen("scrSpace");
if($("btnSpaceBack")) $("btnSpaceBack").onclick = () => showScreen("scrHome");

if($("btnEditSpace")) $("btnEditSpace").onclick = () => {
    $("iptMeName").value = $("cfgMyName").value || "ä½ çš„åå­—";
    $("iptMeBio").value = ls.getItem("myBio") || "";
    $("editMeModal").style.display = "flex";
};

if($("btnSpaceLogs")) $("btnSpaceLogs").onclick = () => showScreen("scrLogList");
if($("btnLogListBack")) $("btnLogListBack").onclick = () => showScreen("scrSpace");
if($("btnWriteLog")) $("btnWriteLog").onclick = () => {
    $("logImgType").value = "none";
    $("logTextImgBlock").style.display = "none";
    $("logLocalImgBlock").style.display = "none";
    $("logImgDesc").value = "";
    $("logContent").value = "";
    $("logImgPreview").style.display = "none";
    showScreen("scrLogEdit");
};
if($("btnLogEditBack")) $("btnLogEditBack").onclick = () => showScreen("scrLogList");

if($("logImgType")) {
    $("logImgType").onchange = function() {
        let v = this.value;
        $("logTextImgBlock").style.display = v === "text" ? "flex" : "none";
        $("logLocalImgBlock").style.display = v === "local" ? "flex" : "none";
    };
}

if($("btnSpaceBoard")) $("btnSpaceBoard").onclick = () => alert("ã€ç•™è¨€æ¿ã€‘æ¨¡å—æ­£åœ¨æ‹¼è£…ä¸­...");
if($("btnSpaceMoments")) $("btnSpaceMoments").onclick = () => alert("ã€æˆ‘çš„è¯´è¯´ã€‘æ¨¡å—æ­£åœ¨æ‹¼è£…ä¸­...");


let charStickers = JSON.parse(ls.getItem(`charStickers`) || `[]`);
let isCharStickerEdit = false;
let selCharStickers = new Set();

function renderCharStickers() {
    let list = $(`charStickerList`); list.innerHTML = ``;
    if(charStickers.length === 0) { list.innerHTML = `<div style=grid-column:1/-1;color:#888;font-size:12px;text-align:center;>AIå¤§è„‘é‡Œè¿˜æ²¡è¡¨æƒ…åŒ…ï¼Œå¿«å»æ‰¹é‡ä¸Šä¼ è°ƒæ•™TAå§ï¼</div>`; return; }
        charStickers.forEach((s, i) => {
        let div = document.createElement("div"); 
        div.className = "sticker-item" + (isCharStickerEdit ? " edit-mode" : "");
        if(isCharStickerEdit && selCharStickers.has(i)) div.style.border = "2px solid #ff4d4f";
        
        div.innerHTML = `<img src="${s.url}"><div class="name">${s.name}</div>`;
        div.onclick = () => {

            if(isCharStickerEdit) {
                if(selCharStickers.has(i)) selCharStickers.delete(i); else selCharStickers.add(i);
                renderCharStickers();
            }
        };
        list.appendChild(div);
    });
}

$(`btnEditCharSticker`).onclick = () => {
    isCharStickerEdit = !isCharStickerEdit;
    $(`btnEditCharSticker`).innerText = isCharStickerEdit ? `å®Œæˆ` : `ç®¡ç†`;
    $(`charStickerActions`).style.display = isCharStickerEdit ? `flex` : `none`;
    selCharStickers.clear(); renderCharStickers();
};

$(`btnSelAllCharSticker`).onclick = () => {
    if(selCharStickers.size === charStickers.length) selCharStickers.clear();
    else charStickers.forEach((_, i) => selCharStickers.add(i));
    renderCharStickers();
};

$(`btnDelCharSticker`).onclick = () => {
    if(selCharStickers.size === 0) { alert(`è¯·å…ˆç‚¹å‡»å›¾ç‰‡é€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…ï¼`); return; }
    if(confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ` + selCharStickers.size + ` ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
        charStickers = charStickers.filter((_, i) => !selCharStickers.has(i));
        ls.setItem(`charStickers`, JSON.stringify(charStickers));
        selCharStickers.clear(); renderCharStickers();
    }
};

if($(`btnCharStickerBack`)) $(`btnCharStickerBack`).onclick = () => {
    isCharStickerEdit = false; $(`btnEditCharSticker`).innerText = `ç®¡ç†`; $(`charStickerActions`).style.display = `none`; selCharStickers.clear();
    showScreen(`scrMe`);
};
if($(`btnGoCharSticker`)) $(`btnGoCharSticker`).onclick = () => { showScreen(`scrCharSticker`); renderCharStickers(); };

if($(`btnUpCharSticker`)) $(`btnUpCharSticker`).onclick = () => $(`upCharSticker`).click();
if($(`upCharSticker`)) $(`upCharSticker`).onchange = e => {
    let files = e.target.files;
    if(!files || files.length === 0) return;
    for(let i=0; i<files.length; i++) {
        let f = files[i];
        let rawName = f.name.split(".")[0];
        let name = rawName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, "");
        if(!name) name = "è¡¨æƒ…" + Math.floor(Math.random()*1000);
        
        let reader = new FileReader();
        reader.onload = ev => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
                let w = img.width, h = img.height, maxW = 120, maxH = 120;
                if(w > h && w > maxW) { h *= maxW / w; w = maxW; } else if(h > maxH) { w *= maxH / h; h = maxH; }
                cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
                
                charStickers.push({name: name, url: cvs.toDataURL("image/webp", 0.4)});
                try {
                    ls.setItem("charStickers", JSON.stringify(charStickers));
                    renderCharStickers();
                } catch(err) {
                    charStickers.pop();
                    alert("ç³»ç»Ÿæç¤ºï¼šå†…å­˜ä¾ç„¶å·²æ»¡ï¼è¯·å…ˆåˆ é™¤ä¸€äº›ä¸è¦çš„è¡¨æƒ…åŒ…ã€‚");
                }
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(f);
    }
    e.target.value = "";
};


if($("btnAddCharSticker")) $("btnAddCharSticker").onclick = () => {
    let text = $("iptCharBatchUrl").value.trim();
    if(!text) return;
    let lines = text.split("\n");
    lines.forEach(line => {
        let str = line.trim();
        if(!str) return;
        let name = "";
        let url = "";
        let urlIdx = str.indexOf("http");
        if(urlIdx !== -1) {
            let prefix = str.substring(0, urlIdx).replace(/[ :ï¼š]+$/, "").trim();
            url = str.substring(urlIdx).trim();
            if(prefix) name = prefix;
            else {
                let rawName = url.substring(url.lastIndexOf("/")+1).split(".")[0];
                try { rawName = decodeURIComponent(rawName); } catch(err) {}
                name = rawName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, "");
            }
        } else {
            let parts = str.split(/\s+/);
            if(parts.length >= 2) { name = parts[0]; url = parts[1]; }
            else url = str;
        }
        if(!name) name = "è¡¨æƒ…" + Math.floor(Math.random()*1000);
        if(url) charStickers.push({ name: name, url: url });
    });
    try {
        ls.setItem("charStickers", JSON.stringify(charStickers));
        $("iptCharBatchUrl").value = "";
        renderCharStickers();
        alert("ç½‘ç»œè¡¨æƒ…å·²æ‰¹é‡å¯¼å…¥ï¼");
    } catch(err) {
        alert("ç³»ç»Ÿæç¤ºï¼šå†…å­˜å·²æ»¡ï¼å¯¼å…¥å¤±è´¥ã€‚è¯·å…ˆåˆ é™¤ä¸€äº›å¤šä½™å›¾ç‰‡ã€‚");
    }
};


// ===== ä¸“å±æ—¥å¿—ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ =====
let logsData = [];
localforage.getItem("myLogs").then(res => {
    if(res) logsData = JSON.parse(res);
    else if(ls.getItem("myLogs")) {
        logsData = JSON.parse(ls.getItem("myLogs"));
        localforage.setItem("myLogs", ls.getItem("myLogs"));
    }
    // æ¬è¿å®Œæ¯•åï¼Œå½»åº•æ¸…ç©ºè€å†…å­˜é‡Œå åœ°æ–¹çš„å¤§ä»¶åƒåœ¾ï¼
    setTimeout(() => {
        localStorage.removeItem("myPhoneStickers");
        localStorage.removeItem("charStickers");
        localStorage.removeItem("myLogs");
    }, 1500);
});

let currLogTab = "me";
let tempLogImgUrl = "";

// ä¿®å¤å†™æ—¥å¿—æŒ‰é’®ï¼Œæ¯æ¬¡ç‚¹å¼€è‡ªåŠ¨æ¸…ç©ºä¸Šä¸€æ¬¡æ®‹ç•™çš„å›¾ç‰‡
if($("btnWriteLog")) {
    $("btnWriteLog").onclick = () => {
        $("logImgType").value = "none";
        $("logTextImgBlock").style.display = "none";
        $("logLocalImgBlock").style.display = "none";
        $("logImgDesc").value = "";
        $("logContent").value = "";
        $("logImgPreview").style.display = "none";
        tempLogImgUrl = ""; 
        showScreen("scrLogEdit");
    };
}

// ç»‘å®šé¡¶éƒ¨åŒè·¯æ ‡ç­¾é¡µçš„åˆ‡æ¢åŠ¨ä½œ
if($("tabMyLogs")) {
    $("tabMyLogs").onclick = () => {
        currLogTab = "me";
        $("tabMyLogs").className = "log-tab log-tab-active";
        $("tabAiLogs").className = "log-tab";
        renderLogs();
    };
}
if($("tabAiLogs")) {
    $("tabAiLogs").onclick = () => {
        currLogTab = "ai";
        $("tabAiLogs").className = "log-tab log-tab-active";
        $("tabMyLogs").className = "log-tab";
        renderLogs();
    };
}

// å¤„ç†æœ¬åœ°å›¾ç‰‡çš„å‹ç¼©ä¸ä¸´æ—¶å­˜å‚¨
if($("btnSelectLogImg")) $("btnSelectLogImg").onclick = () => $("upLogImg").click();
if($("upLogImg")) {
    $("upLogImg").onchange = e => {
        let f = e.target.files[0];
        if(!f) return;
        let r = new FileReader();
        r.onload = ev => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement("canvas"), ctx = cvs.getContext("2d");
                let w = img.width, h = img.height, max = 350;
                if(w > h && w > max) { h *= max/w; w = max; } else if(h > max) { w *= max/h; h = max; }
                cvs.width = w; cvs.height = h; ctx.drawImage(img, 0, 0, w, h);
                tempLogImgUrl = cvs.toDataURL("image/webp", 0.5);
                $("logImgPreview").src = tempLogImgUrl;
                $("logImgPreview").style.display = "block";
            };
            img.src = ev.target.result;
        }; r.readAsDataURL(f);
        e.target.value = "";
    };
}


// æ ¸å¿ƒï¼šå‘è¡¨æ—¥å¿—å¹¶å­˜å…¥æœ¬åœ°æ•°æ®åº“
if($("btnPublishLog")) {
    $("btnPublishLog").onclick = () => {
        let type = $("logImgType").value;
        let desc = $("logImgDesc").value.trim();
        let content = $("logContent").value.trim();
        
        if(!content) { alert("å†™ç‚¹ä»€ä¹ˆå†å‘è¡¨å§ï¼"); return; }
        if(type === "text" && !desc) { alert("è„‘è¡¥æ¨¡å¼éœ€è¦å‘AIæè¿°ç”»é¢å†…å®¹å“¦ï¼"); return; }
        if(type === "local" && !tempLogImgUrl) { alert("å¸¸è§„æ¨¡å¼éœ€è¦å…ˆé€‰æ‹©æœ¬åœ°å›¾ç‰‡å“¦ï¼"); return; }

        logsData.push({
            id: Date.now(),
            author: "me",
            date: updTime().toLocaleString(),
            imgType: type,
            imgDesc: desc,
            imgUrl: type === "local" ? tempLogImgUrl : "",
            content: content,
            comments: []
        });
        ls.setItem("myLogs", JSON.stringify(logsData));
        alert("æ—¥å¿—å‘è¡¨æˆåŠŸï¼");
        showScreen("scrLogList");
        currLogTab = "me";
        $("tabMyLogs").className = "log-tab log-tab-active";
        $("tabAiLogs").className = "log-tab";
        renderLogs();
    };
}

// æ ¸å¿ƒï¼šåŠ¨æ€æ¸²æŸ“æ—¥å¿—åˆ—è¡¨é¢æ¿ä¸AIç”Ÿæˆé€»è¾‘
let currLogCharId = `default`;
window.switchLogChar = function(id) { currLogCharId = id; renderLogs(); };
window.deleteLog = function(id) {
    if(confirm(`ç¡®å®šåˆ é™¤è¿™ç¯‡æ—¥å¿—å—ï¼Ÿ`)) { 
        logsData = logsData.filter(x => x.id !== id); 
        ls.setItem(`myLogs`, JSON.stringify(logsData)); 
        renderLogs(); 
    }
};
window.editLogText = function(id) {
    let log = logsData.find(x => x.id === id);
    if(!log) return;
    let overlay = document.createElement(`div`);
    overlay.className = `modal-base`;
    overlay.style.display = `flex`;
    overlay.style.zIndex = `300`;
    overlay.innerHTML = `<div class=modal-ctx><div class=modal-hdr><span>ä¿®æ”¹æ—¥å¿—</span></div><div class=modal-bdy style=padding:15px;><textarea id=tmpEditLogText class=textarea-field style=height:200px;width:100%;box-sizing:border-box;></textarea><div class=flex-row style=margin-top:15px;><button id=tmpCancelEditLog class=clear-btn style=background:#f0f2f5;color:#333;border:none;>å–æ¶ˆ</button><button id=tmpSaveEditLog class=save-btn style=margin-top:0;flex:1;margin-left:10px;>ä¿å­˜</button></div></div></div>`;
    document.body.appendChild(overlay);
    document.getElementById(`tmpEditLogText`).value = log.content;
    document.getElementById(`tmpCancelEditLog`).onclick = () => overlay.remove();
    document.getElementById(`tmpSaveEditLog`).onclick = () => {
        let n = document.getElementById(`tmpEditLogText`).value.trim();
        if(n) {
            log.content = n; 
            ls.setItem(`myLogs`, JSON.stringify(logsData)); 
            renderLogs();
        }
        overlay.remove();
    };
};

window.activeReplyTarget = null;
window.showToast = function(msg) {
    if($(`sysToast`)) $(`sysToast`).remove();
    let t = document.createElement(`div`);
    t.id = `sysToast`;
    t.innerText = msg;
    t.style.cssText = `position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.8); color:white; padding:12px 24px; border-radius:8px; z-index:9999; font-size:14px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.3);`;
    document.body.appendChild(t);
    setTimeout(() => { if($(`sysToast`)) $(`sysToast`).remove(); }, 5000);
};
window.hideToast = function() {
    if($(`sysToast`)) $(`sysToast`).remove();
};

window.openReplyBox = function(logId, tName) {
    activeReplyTarget = {logId: logId, targetName: tName};
    renderLogs();
};

window.submitReply = async function(logId, targetName, charName) {
    let input = $(`replyInput_` + logId);
    if(!input || !input.value.trim()) return;
    let txt = input.value.trim();
    activeReplyTarget = null;

    let log = logsData.find(x => x.id === logId);
    if(!log) return;
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    if(!log.comments) log.comments = [];

    if(targetName === charName && !log.comments.find(c => c.name === targetName)) {
        log.comments.push({name: myN, content: txt});
    } else {
        log.comments.push({name: myN, content: `å›å¤ ` + targetName + `ï¼š` + txt});
    }
    ls.setItem(`myLogs`, JSON.stringify(logsData));
    renderLogs();

    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) return;

    showToast(`å¯¹æ–¹æ­£åœ¨å›å¤ä¸­...`);

    let histStr = log.comments.map(c => c.name + `ï¼š` + c.content).join(`\n`);
    let sys = ``;
    if (targetName === charName) {
         sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charName}ã€‚è¿™æ˜¯ä¸€ç¯‡ç¤¾äº¤å¹³å°åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nç›®å‰çš„è¯„è®ºåŒºè®°å½•ï¼š\n${histStr}\n\nç©å®¶ï¼ˆ${myN}ï¼‰åˆšåˆšå›å¤äº†ä½ ã€‚è¯·ä½ ä»¥${charName}çš„èº«ä»½å›å¤${myN}ï¼Œè¯­æ°”ç¬¦åˆæ€§æ ¼è®¾å®šã€‚è¦æ±‚ï¼šä½ å¯ä»¥å®Œç¾è¯†åˆ«ç©å®¶å‘é€çš„emojiã€‚è¯·ä¸¥æ ¼æ ¹æ®ä½ çš„æ€§æ ¼è®¾å®šå†³å®šæ˜¯å¦åœ¨å›å¤ä¸­ä½¿ç”¨emojiè¡¨æƒ…ä»¥åŠé¢‘ç‡ï¼ˆæ´»æ³¼å¼€æœ—å¯å¤šç”¨ï¼Œé«˜å†·ä¸¥è°¨è¯·å°‘ç”¨æˆ–ç»å¯¹ä¸ç”¨ï¼‰ã€‚ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼Œä¸è¦å¸¦å‰ç¼€å’Œä»»ä½•ä¿®é¥°ç¬¦å·ã€‚`;
    } else {
         sys = `è¿™æ˜¯ä¸€ç¯‡ç¤¾äº¤å¹³å°åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nç›®å‰çš„è¯„è®ºåŒºè®°å½•ï¼š\n${histStr}\n\nç©å®¶ï¼ˆ${myN}ï¼‰åˆšåˆšå›å¤äº†ä½ çš„è¯„è®ºã€‚è¯·ä½ æ‰®æ¼”ç½‘å‹ã€Œ${targetName}ã€å›å¤${myN}ï¼Œè¡¨ç°å‡ºç¬¦åˆè¯¥ç½‘å‹è®¾å®šçš„è‡ªç„¶è¯­æ°”ã€‚ä½ å¯ä»¥è¯†åˆ«ç©å®¶çš„emojiï¼Œå¹¶æ ¹æ®æ€§æ ¼é€‚åº¦ä½¿ç”¨emojiã€‚ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼Œä¸è¦å¸¦å‰ç¼€å’Œä»»ä½•ä¿®é¥°ç¬¦å·ã€‚`;
    }

    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
        });
        let dat = await res.json();
        hideToast();
        if(dat.choices && dat.choices.length > 0) {
            let reply = dat.choices[0].message.content.trim();
            let replierName = targetName === charName ? charName : targetName;
            log.comments.push({name: replierName, content: `å›å¤ ` + myN + `ï¼š` + reply});
            ls.setItem(`myLogs`, JSON.stringify(logsData));
            renderLogs();
        }
    } catch(e) { hideToast(); console.error(e); }
};

window.summonComments = async function(id, charName, btnEl) {
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) { alert(`è¯·å…ˆåœ¨ç½‘ç»œé…ç½®ä¸­å¡«å†™æ¥å£å’Œå¯†é’¥ã€‚`); return; }
    
    let log = logsData.find(x => x.id === id);
    if(!log) return;

    let origText = btnEl.innerText;
    btnEl.innerText = `å¬å”¤ä¸­...`;
    btnEl.style.pointerEvents = `none`;
    
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    let sys = ``;
    if(log.author === `me`) {
        sys = `ç©å®¶ï¼ˆåå­—ï¼š${myN}ï¼‰åœ¨ç¤¾äº¤å¹³å°å‘å¸ƒäº†åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nè¯·ä½ æ‰®æ¼”3ä¸ªä¸åŒçš„è®¿å®¢ç»™è¿™æ¡åŠ¨æ€å†™è¯„è®ºã€‚å…¶ä¸­å¿…é¡»æœ‰1æ¡æ¥è‡ªè§’è‰²ã€Œ${charName}ã€çš„è¯„è®ºï¼ˆç¬¦åˆTAçš„æ€§æ ¼ï¼‰ï¼Œå¦å¤–2æ¡æ¥è‡ªæ™®é€šç½‘å‹æˆ–åŒå­¦ï¼ˆéšæœºèµ·ä¸ªçœŸå®çš„ç½‘åï¼‰ã€‚\nè­¦å‘Šï¼šè¯„è®ºè€…çš„åå­—ç»å¯¹ä¸èƒ½æ˜¯â€œ${myN}â€ã€‚\nè¦æ±‚ï¼šå¯ä»¥è¯†åˆ«åŠ¨æ€ä¸­çš„emojiã€‚è¯·æ ¹æ®æ¯ä¸ªè¯„è®ºè€…çš„æ€§æ ¼ä¸¥æ ¼æ§åˆ¶æ˜¯å¦ä½¿ç”¨emojiï¼ˆé«˜å†·ä¸¥è°¨ç»å¯¹ä¸ç”¨ï¼Œæ´»æ³¼å¼€æœ—å¯ä»¥å¤šç”¨ï¼‰ã€‚\nå¿…é¡»è¿”å›ä¸¥æ ¼çš„çº¯JSONæ•°ç»„æ ¼å¼ï¼š\n[{"name":"åå­—","content":"å†…å®¹"}]`;
    } else {
        sys = `è§’è‰²ï¼ˆåå­—ï¼š${charName}ï¼‰åœ¨ç¤¾äº¤å¹³å°å‘å¸ƒäº†åŠ¨æ€ï¼š\næ­£æ–‡ï¼š${log.content}\n\nè¯·ä½ æ‰®æ¼”3ä¸ªä¸åŒçš„è®¿å®¢ï¼ˆæ¯”å¦‚åŒå­¦ã€è·¯äººç½‘å‹ã€å…±åŒå¥½å‹ç­‰ï¼Œè¯·ç»™ä»–ä»¬éšæœºèµ·çœŸå®çš„ç½‘åæˆ–æ˜µç§°ï¼‰ç»™è¿™æ¡åŠ¨æ€å†™è¯„è®ºã€‚\næåº¦é‡è¦è­¦å‘Šï¼š\n1. è¿™æ¡åŠ¨æ€çš„ä½œè€…æ˜¯${charName}ï¼è¯„è®ºå†…å®¹å¿…é¡»æ˜¯å¯¹${charName}è¯´çš„è¯ï¼Œç»å¯¹ä¸èƒ½æŠŠä½œè€…è¯¯è®¤ä¸ºæ˜¯${myN}ï¼\n2. è¯„è®ºè€…çš„åå­—ç»å¯¹ä¸èƒ½æ˜¯â€œ${charName}â€æœ¬äººï¼Œä¹Ÿç»å¯¹ä¸èƒ½æ˜¯â€œ${myN}â€ï¼\nè¦æ±‚ï¼šæ ¹æ®æ¯ä¸ªè®¿å®¢çš„æ€§æ ¼æ§åˆ¶emojiçš„ä½¿ç”¨é¢‘ç‡ã€‚\nå¿…é¡»è¿”å›ä¸¥æ ¼çš„çº¯JSONæ•°ç»„æ ¼å¼ï¼š\n[{"name":"åå­—","content":"å†…å®¹"}]`;
    }

    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
        });
        let dat = await res.json();
        if(dat.choices && dat.choices.length > 0) {
            let text = dat.choices[0].message.content.trim();
            text = text.replace(/```json/g, ``).replace(/```/g, ``).trim();
            let newComments = JSON.parse(text);
            if(!log.comments) log.comments = [];
            log.comments = log.comments.concat(newComments);
            ls.setItem(`myLogs`, JSON.stringify(logsData));
            renderLogs();
        } else { alert(`å¬å”¤å¤±è´¥ï¼Œæ¥å£è¿”å›å¼‚å¸¸ã€‚`); btnEl.innerText = origText; btnEl.style.pointerEvents = `auto`; }
    } catch(e) { 
        console.error(e); alert(`ç½‘ç»œæ³¢åŠ¨æˆ–å¤§æ¨¡å‹æ ¼å¼è§£æé”™è¯¯ï¼Œå†ç‚¹ä¸€æ¬¡è¯•è¯•çœ‹ï¼`); 
        btnEl.innerText = origText; btnEl.style.pointerEvents = `auto`; 
    }
};


function renderLogs() {
    let container = $(`logListContainer`);
    if(!container) return;
    container.innerHTML = ``;
    
    let tipHtml = `<div style="text-align:center; padding:8px 15px; background:#fff9e6; color:#d35400; font-size:12px; margin-bottom:10px; cursor:pointer; border-bottom:1px solid #fdebd0;" onclick="alert('ã€ç©æ³•æç¤ºã€‘\\nè¿™é‡Œçš„æ—¥å¿—ç›¸å½“äºå‘åœ¨å…¬å¼€ç©ºé—´çš„åŠ¨æ€å“¦ï¼\\nè§’è‰²ä»¬éƒ½ä¼šæŠ«ç€ç¤¾äº¤é©¬ç”²ï¼Œä¿æŒè‡ªå·±çš„äººè®¾ä¼ªè£…ï¼Œä¸ä¼šæŠŠæœ€æ·±å±‚çš„å¿ƒé‡Œè¯ç›´æ¥è¯´å‡ºæ¥ã€‚\\n\\nçœŸæ­£çš„ã€ç§å¯†æ—¥è®°ã€‘åŠŸèƒ½æ­£åœ¨å…¨åŠ›å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼')">â“ è¿™é‡Œçš„æ—¥å¿—å’Œç§å¯†æ—¥è®°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ(ç‚¹å‡»æŸ¥çœ‹)</div>`;
    container.innerHTML += tipHtml;
    
    let activeChar = $(`cfgName`).value || `ä¸“å±æ‹äºº`;
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    let myAva = ls.getItem(`myI`) || ``;
    let aiAva = originalGetItem.call(ls, `aiI_` + currLogCharId) || originalGetItem.call(ls, `aiI`) || ``;
    let npcAva = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23eee'/><text x='50%' y='50%' font-size='40' text-anchor='middle' dy='.3em' fill='%23999'>ğŸ‘¤</text></svg>`;

    function getAva(name, activeCharN) {
        if (name === myN) return myAva ? `<img src="${myAva}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid #eee;">` : `<div style="width:28px;height:28px;border-radius:50%;background:#eee;display:flex;justify-content:center;align-items:center;font-size:14px;flex-shrink:0;">ğŸ‘¤</div>`;
        if (name === activeCharN) return aiAva ? `<img src="${aiAva}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid #eee;">` : `<div style="width:28px;height:28px;border-radius:50%;background:#eee;display:flex;justify-content:center;align-items:center;font-size:14px;flex-shrink:0;">ğŸ‘¤</div>`;
        return `<img src="${npcAva}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid #eee;">`;
    }
    
    if(currLogTab === `ai`) {
        let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
        let allChars = [{id: `default`, name: originalGetItem.call(ls, `cN_default`) || originalGetItem.call(ls, `cN`) || `ä¸“å±æ‹äºº`}];
        contacts.forEach(c => allChars.push({id: c.id, name: originalGetItem.call(ls, `cN_` + c.id) || c.name}));
        
        if (!allChars.find(x => String(x.id) === String(currLogCharId))) currLogCharId = currentChatId || `default`;
        activeChar = allChars.find(x => String(x.id) === String(currLogCharId)).name;
        
        let selHtml = `<div style="padding:10px 15px; border-bottom:1px solid #eee; background:#fff;"><select class="input-field" style="width:100%; font-weight:bold; color:#6c5ce7; background:#eef2ff; border:1px solid #c7d2fe; outline:none;" onchange="switchLogChar(this.value)">`;
        allChars.forEach(c => {
            let isSel = String(c.id) === String(currLogCharId) ? `selected` : ``;
            selHtml += `<option value="${c.id}" ${isSel}>${c.name}</option>`;
        });
        selHtml += `</select></div>`;
        container.innerHTML += selHtml;
    }

    let filterLogs = logsData.filter(x => x.author === currLogTab);
    if(currLogTab === `ai`) {
        filterLogs = filterLogs.filter(x => x.charName === activeChar);
        container.innerHTML += `<div style="text-align:center; padding:15px; flex-shrink:0;"><button id="btnGenAiLog" class="save-btn" style="padding:10px 15px; font-size:13px; width:auto; display:inline-block;">âœ¨ è®© ${activeChar} æ ¹æ®è¿‘æœŸè®°å¿†å†™ä¸€ç¯‡æ–°æ—¥å¿—</button></div>`;
    }
    
    if(filterLogs.length === 0) {
        container.innerHTML += `<div style="text-align:center; color:#888; font-size:13px; margin-top:30px;">è¿˜æ²¡æœ‰å†™è¿‡æ—¥å¿—å“¦~</div>`;
    }

        filterLogs.slice().reverse().forEach(log => {
        let card = document.createElement(`div`); card.className = `log-card`;
        let imgHtml = ``;
        if(log.imgType === `text`) {
            imgHtml = `<div class="log-placeholder-img">è„‘è¡¥ç”»é¢ï¼š${log.imgDesc}</div>`;
        } else if(log.imgType === `local` && log.imgUrl) {
            imgHtml = `<img src="${log.imgUrl}" class="log-real-img">`;
        }
        
        let commentsHtml = ``;
        if(log.comments && log.comments.length > 0) {
            commentsHtml = `<div style="margin-top:10px; padding:12px; background:#f8f9fa; border-radius:12px; font-size:12px; display:flex; flex-direction:column; gap:12px;">`;
            log.comments.forEach(c => {
                let nColor = c.name === myN ? `#0984e3` : `#6c5ce7`;
                let replyBtn = c.name !== myN ? `<span onclick="openReplyBox(${log.id}, '${c.name}')" style="margin-left:8px; color:#a4b0be; cursor:pointer; font-size:11px; text-decoration:underline;">å›å¤</span>` : ``;
                let avaHtml = getAva(c.name, activeChar);
                commentsHtml += `<div style="display:flex; align-items:flex-start; gap:10px;">${avaHtml}<div style="flex:1; line-height:1.5;"><span style="font-weight:bold; color:${nColor};">${c.name}ï¼š</span><span style="color:#2f3542;">${c.content}</span>${replyBtn}</div></div>`;
            });
            commentsHtml += `</div>`;
        }

        let replyBoxHtml = ``;
        if(activeReplyTarget && activeReplyTarget.logId === log.id) {
            replyBoxHtml = `
            <div style="margin-top:10px; display:flex; gap:8px; background:#eef2ff; padding:10px; border-radius:12px; align-items:center;">
                <input type="text" id="replyInput_${log.id}" placeholder="å›å¤ ${activeReplyTarget.targetName}..." style="flex:1; border:1px solid #c7d2fe; border-radius:15px; padding:8px 12px; font-size:12px; outline:none;">
                <button onclick="submitReply(${log.id}, '${activeReplyTarget.targetName}', '${activeChar}')" style="background:#6c5ce7; color:white; border:none; border-radius:15px; padding:8px 15px; font-size:12px; cursor:pointer; font-weight:bold;">å‘é€</button>
                <button onclick="activeReplyTarget=null; renderLogs();" style="background:#dfe4ea; color:#2f3542; border:none; border-radius:15px; padding:8px 15px; font-size:12px; cursor:pointer; font-weight:bold;">å–æ¶ˆ</button>
            </div>`;
        }

        let writeBtnHtml = log.author === `ai` ? `<span onclick="openReplyBox(${log.id}, '${activeChar}')" style="font-size:13px; color:#0984e3; cursor:pointer; font-weight:bold;">å†™è¯„è®º</span>` : ``;

        let logAuthorName = log.author === `me` ? myN : log.charName;
        let authorAvaHtml = getAva(logAuthorName, activeChar);

        card.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                ${authorAvaHtml}
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; font-size:14px; color:#2c3e50;">${logAuthorName}</span>
                    <span class="log-card-time" style="margin:0; font-size:11px; color:#95a5a6;">${log.date}</span>
                </div>
            </div>
            ${imgHtml}
            <div class="log-card-content">${log.content.replace(/\n/g, `<br>`)}</div>
            ${commentsHtml}
            ${replyBoxHtml}
            <div style="display:flex; justify-content:flex-end; align-items:center; gap:15px; margin-top:12px; border-top:1px dashed #eee; padding-top:12px;">
                ${writeBtnHtml}
                <span onclick="editLogText(${log.id})" style="font-size:13px; color:#6c5ce7; cursor:pointer; font-weight:bold;">ç¼–è¾‘</span>
                <span onclick="deleteLog(${log.id})" style="font-size:13px; color:#ff7675; cursor:pointer; font-weight:bold;">åˆ é™¤</span>
                <div class="log-summon-btn" onclick="summonComments(${log.id}, '${activeChar}', this)" style="margin:0;">å¬å”¤è¯„è®º</div>
            </div>
        `;
        container.appendChild(card);
    });

    
    if($(`btnGenAiLog`)) $(`btnGenAiLog`).onclick = () => generateAiLog(activeChar);
}




async function generateAiLog(charN) {
    let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
    if(!pxy || !key || !mod) { alert(`è¯·å…ˆåœ¨ç½‘ç»œé…ç½®ä¸­å¡«å†™æ¥å£å’Œå¯†é’¥ã€‚`); return; }
    
    $(`btnGenAiLog`).innerText = `TAæ­£åœ¨æ„æ€ç©ºé—´åŠ¨æ€...`;
    
    let myN = $(`cfgMyName`).value || `æˆ‘`;
    let sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${charN}ã€‚è¯·ä½ æ ¹æ®æœ€è¿‘çš„èŠå¤©è®°å½•å’Œè®°å¿†åº“ï¼Œå†™ä¸€ç¯‡å‘å¸ƒåœ¨å…¬å¼€ç¤¾äº¤å¹³å°ï¼ˆç±»ä¼¼ç©ºé—´æ—¥å¿—ï¼‰çš„é•¿ç¯‡åŠ¨æ€ã€‚
è¦æ±‚ï¼š
1. è¯­æ°”å¿…é¡»å®Œå…¨ç¬¦åˆä½ çš„æ€§æ ¼è®¾å®šã€‚å› ä¸ºæ˜¯å…¬å¼€å¹³å°ï¼Œä½ ä¼šæœ‰ç¬¦åˆäººè®¾çš„ç¤¾äº¤ä¼ªè£…ã€‚
2. ä½ å¯ä»¥å®Œç¾è¯†åˆ«è¿‘æœŸèŠå¤©è®°å½•é‡Œçš„emojiã€‚åœ¨å†™è¿™ç¯‡åŠ¨æ€æ—¶ï¼Œè¯·å¿…é¡»ä¸¥æ ¼æ ¹æ®ä½ çš„æ€§æ ¼è®¾å®šæ¥å†³å®šæ˜¯å¦ä½¿ç”¨emojiè¡¨æƒ…ä»¥åŠä½¿ç”¨é¢‘ç‡ï¼ˆä¾‹å¦‚ï¼šæ´»æ³¼å¼€æœ—çš„æ€§æ ¼å¯ä»¥å¤šç”¨emojiï¼Œé«˜å†·ä¸¥è°¨çš„æ€§æ ¼è¯·å°‘ç”¨æˆ–ç»å¯¹ä¸ç”¨emojiï¼‰ã€‚
3. å†…å®¹å¯ä»¥æåŠè¿‘æœŸçš„äº‹ï¼Œå¯ä»¥æš—æˆ³æˆ³æåˆ°${myN}ã€‚
4. ä¸¥æ ¼åªè¾“å‡ºåŠ¨æ€æ­£æ–‡ã€‚å­—æ•°å¿…é¡»åœ¨150å­—åˆ°300å­—ä¹‹é—´ï¼Œè¯·å†™å¾—è¯¦ç»†ä¸°å¯Œä¸€äº›ï¼Œä¸è¦åƒçŸ­è¯´è¯´ä¸€æ ·ç®€ç•¥ã€‚`;

    let specHistStr = originalGetItem.call(ls, `chatHistory_${currLogCharId}`) || originalGetItem.call(ls, `chatHistory`);
    let specHist = specHistStr ? JSON.parse(specHistStr) : [];
    if(currLogCharId === currentChatId) specHist = history;

    let specMemStr = originalGetItem.call(ls, `memories_${currLogCharId}`) || originalGetItem.call(ls, `memories`);
    let specMem = specMemStr ? JSON.parse(specMemStr) : [];

    let recentChat = specHist.slice(-15).map(m => (m.role === `user` ? myN : charN) + `:` + m.content).join(`\n`);
    let memData = specMem.slice(-5).map(m => m.content).join(`\n`);
    sys += `\n\nã€è¿‘æœŸè®°å¿†ã€‘ï¼š\n${memData}\n\nã€è¿‘æœŸèŠå¤©è®°å½•ã€‘ï¼š\n${recentChat}`;
    
    try {
        let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
        let res = await fetch(url, {
            method: `POST`, 
            headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
            body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.8})
        });
        let dat = await res.json();
        if(dat.choices && dat.choices.length > 0) {
            let text = dat.choices[0].message.content.trim();
            logsData.push({
                id: Date.now(),
                author: `ai`,
                charName: charN,
                date: updTime().toLocaleString(),
                imgType: `none`,
                imgDesc: ``,
                imgUrl: ``,
                content: text,
                comments: []
            });
            ls.setItem(`myLogs`, JSON.stringify(logsData));
            alert(`TAçš„æ—¥å¿—å†™å®Œå•¦ï¼`);
            renderLogs();
        } else { alert(`æ¥å£è¿”å›å¼‚å¸¸ï¼ŒTAå†™æ—¥å¿—å¤±è´¥äº†ã€‚`); }
    } catch(e) { alert(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®ã€‚`); }
    if($(`btnGenAiLog`)) $(`btnGenAiLog`).innerText = `âœ¨ è®© ${charN} æ ¹æ®è¿‘æœŸè®°å¿†å†™ä¸€ç¯‡æ–°æ—¥å¿—`;
}




// ä¿è¯æ¯æ¬¡ä»ä¸»é¡µç‚¹è¿›æ—¥å¿—æœ¬æ—¶ï¼Œç”»é¢éƒ½æ˜¯æœ€æ–°çŠ¶æ€
if($("btnSpaceLogs")) {
    let oldClick = $("btnSpaceLogs").onclick;
    $("btnSpaceLogs").onclick = () => {
        if(oldClick) oldClick();
        renderLogs();
    };
}
// === æ ¸å¿ƒå¼ºåŒ–ï¼šå¤šé€‰äº¤äº’ä¸è‡ªåŠ¨æ€»ç»“ä¿®å¤ ===
let isMultiSelectMode = false;
let selectedMsgs = new Set();


function enterMultiSelectMode(initialIdx) {
    isMultiSelectMode = true;
    selectedMsgs.clear();
    selectedMsgs.add(initialIdx);
    let hdr = document.querySelector("#scrRoom .room-header");
    hdr.innerHTML = `
        <span onclick="exitMultiSelectMode()" style="color:#333; cursor:pointer; font-size:16px; font-weight:bold; flex:1;">å–æ¶ˆ</span>
        <span id="roomTitle" style="font-weight:bold; font-size:16px; color:#333; flex:2; text-align:center;">å·²é€‰ 1 æ¡</span>
        <div style="display:flex; gap:15px; flex:1; justify-content:flex-end;">
            <span onclick="saveSelectedToFav()" style="color:#1890ff; cursor:pointer; font-size:16px; font-weight:bold;">æ”¶è—</span>
            <span onclick="deleteSelectedMsgs()" style="color:#ff4d4f; cursor:pointer; font-size:16px; font-weight:bold;">åˆ é™¤</span>
        </div>
    `;
    renderMultiSelectVisuals();
}



function exitMultiSelectMode() {
    isMultiSelectMode = false;
    selectedMsgs.clear();
    let hdr = document.querySelector("#scrRoom .room-header");
    let dn = $("cfgRem").value || $("cfgName").value || "ä¸“å±æ‹äºº";
    hdr.innerHTML = `
        <span id="btnRoomBack" class="back-btn">ï¼œ</span>
        <span id="roomTitle" class="room-center">${dn}</span>
        <span id="btnRoomSet" class="settings-btn">âš™ï¸</span>
    `;
    $("btnRoomBack").onclick = () => { showScreen("scrList"); updateListPreview(); };
    $("btnRoomSet").onclick = () => showScreen("scrSetChat");
    if(typeof applyVis === 'function') applyVis();
    renderMultiSelectVisuals();
}


function deleteSelectedMsgs() {
    if(selectedMsgs.size === 0) return;
    if(confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ` + selectedMsgs.size + ` æ¡ä¿¡æ¯å—ï¼Ÿ`)) {
        let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
        let targetsToDelete = [];
        selectedMsgs.forEach(idx => {
            let el = allItems[idx];
            if (el) {
                let bubble = el.querySelector(`.bubble`); 
                let imgEl = el.querySelector(`img`);
                if (imgEl) targetsToDelete.push(imgEl.getAttribute(`src`));
                else targetsToDelete.push(getCleanText(bubble));
            }
        });
        targetsToDelete.forEach(searchTarget => {
            for(let i=history.length-1; i>=0; i--) {
                if(history[i].content.includes(searchTarget)) {
                    let newContent = history[i].content.replace(searchTarget, ``).trim();
                    newContent = newContent.replace(/^\n+|\n+$/g, ``).replace(/\n{2,}/g, `\n`);
                    let afterReply = newContent.split(`ã€å›å¤ã€‘`)[1];
                    if (newContent === `` || (newContent.includes(`ã€å›å¤ã€‘`) && (!afterReply || afterReply.trim() === ``))) {
                        history.splice(i, 1);
                        let lmc = parseInt(ls.getItem(`lastMemCount`)) || 0;
                        if(lmc > history.length) ls.setItem(`lastMemCount`, history.length.toString());
                    } else {
                        history[i].content = newContent;
                    }
                    break;
                }
            }
        });
        ls.setItem(`chatHistory`, JSON.stringify(history));
        exitMultiSelectMode();
        redrawChat();
        if(typeof updateListPreview === `function`) updateListPreview();
    }
}



function renderMultiSelectVisuals() {
    let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
    allItems.forEach((item, idx) => {
        let existingMask = item.querySelector(`.multi-select-mask`);
        if (isMultiSelectMode) {
            if (!existingMask) {
                item.style.position = `relative`;
                let mask = document.createElement(`div`);
                mask.className = `multi-select-mask`;
                let isLeft = item.classList.contains(`row-left`);
                let padLeft = isLeft ? `50px` : `15px`;
                mask.style.cssText = `position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.05);z-index:10;display:flex;align-items:center;padding:0 15px;padding-left:${padLeft};box-sizing:border-box;cursor:pointer;transition:background 0.2s;`;
                let cb = document.createElement(`div`);
                cb.className = `multi-select-cb`;
                cb.style.cssText = `width:22px;height:22px;border-radius:50%;border:2px solid #ccc;background:white;display:flex;justify-content:center;align-items:center;margin-right:10px;flex-shrink:0;`;
                mask.appendChild(cb);
                item.appendChild(mask);
                existingMask = mask;
            }
            let cb = existingMask.querySelector(`.multi-select-cb`);
            if (selectedMsgs.has(idx)) {
                existingMask.style.background = `rgba(108, 92, 231, 0.1)`;
                cb.style.borderColor = `#6c5ce7`;
                cb.innerHTML = `<div style="width:12px;height:12px;border-radius:50%;background:#6c5ce7;"></div>`;
            } else {
                existingMask.style.background = `transparent`;
                cb.style.borderColor = `#ccc`;
                cb.innerHTML = ``;
            }
        } else {
            if (existingMask) existingMask.remove();
        }
    });
}


// å…¨å±€åŠ«æŒï¼šç¡®ä¿å¤šé€‰çŠ¶æ€ä¸‹ç‚¹å‡»æ¶ˆæ¯æ˜¯é€‰ä¸­è€Œä¸æ˜¯åˆ«çš„æ“ä½œï¼ŒåŒæ—¶è‡ªåŠ¨æ€»ç»“ä¸€å®šèƒ½è¢«è§¦å‘
let oldRedrawChat = window.redrawChat || function(){};
window.redrawChat = function() {
    oldRedrawChat();
    if(isMultiSelectMode) {
        renderMultiSelectVisuals();
    } else {
        // åœ¨éå¤šé€‰çŠ¶æ€ä¸‹æ¯æ¬¡åˆ·æ–°èŠå¤©æ—¶ï¼Œåº•å±‚æ£€æŸ¥è‡ªåŠ¨æ€»ç»“ï¼ˆä¿®å¤ä¸è‡ªåŠ¨è§¦å‘çš„bugï¼‰
        setTimeout(forceCheckAutoMem, 1000);
    }
};

// å¼ºåŠ›ä¿®å¤ï¼šçœŸæ­£çš„é™é»˜è‡ªåŠ¨æ€»ç»“å¤§è„‘
window.forceCheckAutoMem = async function() {
    let am = ls.getItem(`cAMem`) === `true`;
    let mt = parseInt(ls.getItem(`cMemT`)) || 10;
    let lmc = parseInt(ls.getItem(`lastMemCount`)) || 0;
    
    if(am && history.length - lmc >= mt && history.length > 0) {
        ls.setItem(`lastMemCount`, history.length); // å…ˆæ›´æ–°è®¡æ•°ï¼Œé˜²æ­¢é‡å¤è§¦å‘
        
        let pxy = $(`apiPxy`).value, key = $(`apiK`).value, mod = $(`apiMod`).value;
        if(!pxy || !key || !mod) return;
        
        let cN = $(`cfgName`).value || `ä¸“å±æ‹äºº`;
        let myN = $(`cfgMyName`).value || `æˆ‘`;
        let promptCtx = ls.getItem(`cMemP`) || `æç‚¼å…³é”®äº‹å®ã€æƒ…ç»ªå˜åŒ–å’Œçº¦å®šã€‚`;
        let chatText = history.slice(-mt).map(m => (m.role === `user` ? myN : cN) + `ï¼š` + m.content).join(`\n`);
        let sys = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${cN}ã€‚è¯·ä»¥ä½ çš„ç¬¬ä¸€äººç§°è§†è§’ï¼Œæå–ä»¥ä¸‹èŠå¤©è®°å½•ä¸­çš„é‡è¦äº‹å®ã€æƒ…æ„Ÿå˜åŒ–å’Œçº¦å®šï¼Œæ€»ç»“ä¸ºç®€çŸ­çš„è®°å¿†ç‰‡æ®µã€‚è¦æ±‚ï¼š\n1. è¯­æ°”ç¬¦åˆæ€§æ ¼è®¾å®šã€‚\n2. éµå¾ªæå–ä¾§é‡ç‚¹ï¼š${promptCtx}\n3. çº¯æ–‡æœ¬ç›´æ¥è¾“å‡ºï¼Œç¦æ­¢åºŸè¯ã€‚\n\nã€è¿‘æœŸè®°å½•ã€‘ï¼š\n${chatText}`;
        
        try {
            let url = pxy.includes(`chat/completions`) ? pxy : pxy.replace(/\/$/, ``) + `/chat/completions`;
            let res = await fetch(url, {
                method: `POST`, headers: {Authorization: `Bearer ` + key, "Content-Type": `application/json`},
                body: JSON.stringify({model: mod, messages: [{role: `user`, content: sys}], temperature: 0.5})
            });
            let dat = await res.json();
            if(dat.choices && dat.choices.length > 0) {
                let out = dat.choices[0].message.content.trim();
                let memsStr = currentChatId === `default` ? ls.getItem(`memories`) : ls.getItem(`memories_` + currentChatId);
                let mems = memsStr ? JSON.parse(memsStr) : [];
                mems.push({ date: updTime().toLocaleString(), content: out });
                ls.setItem(currentChatId === `default` ? `memories` : `memories_` + currentChatId, JSON.stringify(mems));
                console.log(`[ç³»ç»Ÿ] è‡ªåŠ¨è®°å¿†æ€»ç»“å·²é™é»˜å®Œæˆ`);
            }
        } catch(e) { console.error(`è‡ªåŠ¨æ€»ç»“ç½‘ç»œé”™è¯¯`, e); }
    }
};

if(typeof msgs !== `undefined`) {
            msgs.addEventListener(`click`, (e) => {
        if(!isMultiSelectMode) return;
        let item = e.target.closest(`.msg-row`);
        if(!item) return;
        e.preventDefault();
        e.stopPropagation();
        let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
        let idx = allItems.indexOf(item);
        if(idx > -1) {
            if(selectedMsgs.has(idx)) selectedMsgs.delete(idx);
            else selectedMsgs.add(idx);
            $(`roomTitle`).innerText = `å·²é€‰ ` + selectedMsgs.size + ` æ¡`;
            renderMultiSelectVisuals();
        }
    }, true);
}
// ===== æ”¶è—å¤¹ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ =====
function saveMsgToFav(content) {
    let favs = ls.getItem(`myFavs`) ? JSON.parse(ls.getItem(`myFavs`)) : [];
    let cId = currentChatId || `default`;
    favs.push({
        id: Date.now() + Math.random(),
        chatId: cId,
        content: content,
        time: updTime().toLocaleString()
    });
    ls.setItem(`myFavs`, JSON.stringify(favs));
}

window.saveSelectedToFav = function() {
    if(selectedMsgs.size === 0) return;
    let allItems = Array.from(msgs.querySelectorAll(`.msg-row`));
    let sortedIndices = Array.from(selectedMsgs).sort((a, b) => a - b);
    
    sortedIndices.forEach(idx => {
        let el = allItems[idx];
        if (el) {
            let bubble = el.querySelector(`.bubble`); 
            let imgEl = el.querySelector(`img`);
            let contentToSave = imgEl ? imgEl.getAttribute(`src`) : getCleanText(bubble);
            saveMsgToFav(contentToSave);
        }
    });
    alert(`æˆåŠŸå°† ` + selectedMsgs.size + ` æ¡ä¿¡æ¯è£…è¿›æ”¶è—å¤¹ï¼`);
    exitMultiSelectMode();
};

let currFavChatId = `default`;
window.switchFavChar = function(id) { 
    currFavChatId = id; 
    renderFavs(); 
};

window.deleteFav = function(id) {
    if(confirm(`ç¡®å®šå–æ¶ˆæ”¶è—è¿™æ¡ä¿¡æ¯å—ï¼Ÿ`)) {
        let favs = ls.getItem(`myFavs`) ? JSON.parse(ls.getItem(`myFavs`)) : [];
        favs = favs.filter(x => x.id !== id);
        ls.setItem(`myFavs`, JSON.stringify(favs));
        renderFavs();
    }
};

function renderFavs() {
    let container = $(`favListContainer`);
    if(!container) return;
    container.innerHTML = ``;
    
    let contacts = ls.getItem(`myContacts`) ? JSON.parse(ls.getItem(`myContacts`)) : [];
    let allChars = [{id: `default`, name: originalGetItem.call(ls, `cN_default`) || originalGetItem.call(ls, `cN`) || `ä¸“å±æ‹äºº`}];
    contacts.forEach(c => allChars.push({id: c.id, name: originalGetItem.call(ls, `cN_` + c.id) || c.name}));
    
    let selHtml = `<div style="padding:10px 15px; border-bottom:1px solid #eee; background:#fff; margin:-15px -15px 15px -15px; position:sticky; top:0; z-index:10;"><select class="input-field" style="width:100%; font-weight:bold; color:#6c5ce7; background:#eef2ff; border:1px solid #c7d2fe; outline:none;" onchange="switchFavChar(this.value)">`;
    allChars.forEach(c => {
        let isSel = String(c.id) === String(currFavChatId) ? `selected` : ``;
        selHtml += `<option value="${c.id}" ${isSel}>${c.name} çš„çè´µç¢ç‰‡</option>`;
    });
    selHtml += `</select></div>`;
    container.innerHTML += selHtml;
    
    let favs = ls.getItem(`myFavs`) ? JSON.parse(ls.getItem(`myFavs`)) : [];
    let filterFavs = favs.filter(x => String(x.chatId) === String(currFavChatId));
    
    if(filterFavs.length === 0) {
        container.innerHTML += `<div style="text-align:center; color:#888; font-size:13px; margin-top:40px;">å½“å‰è§’è‰²è¿˜æ²¡æœ‰å­˜ä¸‹ä»»ä½•ç¢ç‰‡å“¦ã€‚</div>`;
        return;
    }
    
    filterFavs.forEach((fav, index) => {
        let card = document.createElement(`div`);
        card.className = `stat-card`;
        card.style.marginBottom = `15px`;
        
        let isImg = fav.content.startsWith(`data:image`) || fav.content.startsWith(`http`);
        let contentHtml = isImg ? `<img src="${fav.content}" style="max-width:100%; border-radius:8px; margin-top:8px;">` : `<div style="margin-top:8px; font-size:14px; color:#333; line-height:1.6; word-wrap:break-word;">${fav.content}</div>`;
        
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding-bottom:10px;">
                <span style="font-weight:bold; color:#6c5ce7; font-size:15px; background:#eef2ff; padding:2px 10px; border-radius:12px;">NO. ${index + 1}</span>
                <span style="font-size:11px; color:#999;">${fav.time || ``}</span>
            </div>
            ${contentHtml}
            <div style="text-align:right; margin-top:12px;">
                <span onclick="deleteFav(${fav.id})" style="font-size:12px; color:#ff7675; cursor:pointer; font-weight:bold; background:#fff0f0; padding:4px 10px; border-radius:8px;">å–æ¶ˆæ”¶è—</span>
            </div>
        `;
        container.appendChild(card);
    });
}

if($(`btnGoFav`)) {
    $(`btnGoFav`).onclick = () => {
        currFavChatId = currentChatId || `default`;
        renderFavs();
        showScreen(`scrFav`);
    };
}
if($(`btnFavBack`)) {
    $(`btnFavBack`).onclick = () => showScreen(`scrMe`);
}

</script>

</body>
</html>
